---
title: "Are any form of contact ( face-to-face/phone/mail/Internet communicators) with family members/relatives frequent (i.e. contact once a week or more often)?"
output:
  html_document:
    highlight: tango
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

<!-- ########################################################## --> 
<!-- # Installation, loading packages -->
```{r setup, include=FALSE}
source("../../setup_iago.r")
```
<!-- ########################################################## --> 
<!-- # Loading DS description -->
```{r main, child='../../_DS_Rmd/cont_relDS.Rmd'}
```
```{r global, echo=F}
source('../../_DS_Rmd/cont_relDS.R')
```



<!-- ########################################################## --> 

# Data process


## Mexico


### Wave 1

#### Study-specific variable description

The study-specific variable elected to be harmonised are:

* Name: `b10_2` **from table 'Mexican Health Aging Study.b_nores'**
* Label: `In the last 2 years, how often did you/your spouse contact nonresident child? (Period)`
* Categories:
    + `0 = never`
    + `1 = week`
    + `2 = month`
    + `3 = year`
    + `4 = less than once a year`
    + `5 = infrequently`
* Missings:
    + `8 = RF`
    + `9 = DK`
    
* Name: `f28b1` **from table 'Mexican Health Aging Study.MHAS-2001'**
* Label: `Period contact with mother`
* Categories:
    + `1 = week`
    + `2 = month`
    + `3 = year`
    + `4 = less than once a year`
    + `5 = never`
* Missings:
    + `8 = RF`
    + `9 = DK`

* Name: `f28b2` **from table 'Mexican Health Aging Study.MHAS-2001'**
* Label: `Period contact with father`
* Categories:
    + `1 = week`
    + `2 = month`
    + `3 = year`
    + `4 = less than once a year`
    + `5 = never`
* Missings:
    + `8 = RF`
    + `9 = DK`
    
* Name: `f28b3` **from table 'Mexican Health Aging Study.MHAS-2001'**
* Label: `Period contact with parents`
* Categories:
    + `1 = week`
    + `2 = month`
    + `3 = year`
    + `4 = less than once a year`
    + `5 = never`
* Missings:
    + `8 = RF`
    + `9 = DK`
    
* Name: `trh6`
* Label: `Relationship of household member to selected person`
* Categories:
    + `02 = spouse`
    + `03 = child`
    + `04 = stepchild`
    + `05 = adoptive child`
    + `06 = foster child`
    + `07 = parent`
    + `08 = parent-in-law`
    + `09 = grandparent`
    + `10 = grandchild`
    + `11 = great-grandchild`
    + `12 = child-in-law`
    + `13 = sibling/stepsibling`
    + `14 = sibling-in-law/cousin`
    + `15 = ancle/aunt`
    + `16 = nephew/niece`
    + `17 = other relative`
    + `18 = non-relative`
    + `66 = selected person died`
    + `00 = without spouse`
        

```{r assign1, echo=F}

opal.assign.table.tibble(o, 'MHAS_w1_cont_rel1','Mexican Health Aging Study.b_nores',  variables=list('b10_2','b1','unhhid'), missings = TRUE)
MHAS_w1_cont_rel1 <- opal.execute(o,'MHAS_w1_cont_rel1')
MHAS_w1_cont_rel1$unhhid <- as.character(MHAS_w1_cont_rel1$unhhid)

# JOIN (HH)ID TOGETHER WITH CODE NUMBER OF THE RESPONDENT
MHAS_w1_cont_rel1$newid <- paste0(substr(MHAS_w1_cont_rel1$unhhid,1,nchar(MHAS_w1_cont_rel1$unhhid)),as.character(MHAS_w1_cont_rel1$b1),"0.0")


opal.assign.table.tibble(o, 'MHAS_w1_cont_rel2','Mexican Health Aging Study.MHAS-2001', variables=list('f28b1','f28b2','f28b3'), missings = TRUE)
MHAS_w1_cont_rel2 <- opal.execute(o,'MHAS_w1_cont_rel2')



opal.assign.table.tibble(o, 'MHAS_w1_cont_rel3','Mexican Health Aging Study.sect_trh',  variables=list('trh6','unhhid','trh1'), missings = TRUE)
MHAS_w1_cont_rel3 <- opal.execute(o, 'MHAS_w1_cont_rel3')
MHAS_w1_cont_rel3$unhhid <- as.character(MHAS_w1_cont_rel3$unhhid)

# JOIN (HH)ID TOGETHER WITH CODE NUMBER OF THE RESPONDENT
MHAS_w1_cont_rel3$newid <- paste0(substr(MHAS_w1_cont_rel3$unhhid,1,nchar(MHAS_w1_cont_rel3$unhhid)),as.character(MHAS_w1_cont_rel3$trh1),"0.0")

```

```{r local1, echo=F}
vari <- MHAS_w1_cont_rel1$b10_2
kable(Categorical_summary(vari, missing_values = c(8,9))[3], caption = attributes(vari)$`spss::shortName`) 
kable(Categorical_summary(vari, missing_values = c(8,9))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(8,9))[2], caption = "Type of missing")
#Categorical_summary(var = MHAS_w1_cont_rel1$b10_2, missing_values = NA)
ggplot(MHAS_w1_cont_rel1, aes(x=factor(b10_2))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("In the last 2 years, how often did you/your spouse contact nonresident child? (Period)") + ylab("Frequency")

vari <- MHAS_w1_cont_rel2$f28b1
kable(Categorical_summary(vari, missing_values = c(8,9))[3], caption = attributes(vari)$`spss::shortName`) 
kable(Categorical_summary(vari, missing_values = c(8,9))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(8,9))[2], caption = "Type of missing")
#Categorical_summary(var = MHAS_w1_cont_rel2$f28b1, missing_values = NA)
ggplot(MHAS_w1_cont_rel2, aes(x=factor(f28b1))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Period contact with mother") + ylab("Frequency")

vari <- MHAS_w1_cont_rel2$f28b2
kable(Categorical_summary(vari, missing_values = c(8,9))[3], caption = attributes(vari)$`spss::shortName`) 
kable(Categorical_summary(vari, missing_values = c(8,9))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(8,9))[2], caption = "Type of missing")
#Categorical_summary(var = MHAS_w1_cont_rel2$f28b1, missing_values = NA)
ggplot(MHAS_w1_cont_rel2, aes(x=factor(f28b2))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Period contact with mother") + ylab("Frequency")

vari <- MHAS_w1_cont_rel2$f28b3
kable(Categorical_summary(vari, missing_values = c(8,9))[3], caption = attributes(vari)$`spss::shortName`) 
kable(Categorical_summary(vari, missing_values = c(8,9))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(8,9))[2], caption = "Type of missing")
#Categorical_summary(var = MHAS_w1_cont_rel2$f28b1, missing_values = NA)
ggplot(MHAS_w1_cont_rel2, aes(x=factor(f28b3))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Period contact with mother") + ylab("Frequency")


vari <- MHAS_w1_cont_rel3$trh6
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(MHAS_w1_cont_rel3, aes(x=factor(trh6))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Relationship of household member to selected person") + ylab("Frequency")

```

#### Harmonisation algorithm
To recode the harmonize variable from the study-specific variable it has to be recoded as follows:  


* `week into 1`
* `trh6 from 2 to 17 into 1 `
* `9 into 998`
* `8 into 997`
* `NA into 999`

**R script:**

```{r harmo1}

MHAS_w1_cont_rel <- MHAS_w1_cont_rel2

# In bnr we codify if respondent has contact (or not) with some non-resident children
MHAS_w1_cont_rel$bnr <- rep(999,length(MHAS_w1_cont_rel$id))

# Contact with some non-resident children is DK:
# sapply(MHAS_w1_cont_rel$id,function(x) 9 %in% MHAS_w1_cont_rel1$b10_2[which(MHAS_w1_cont_rel1$newid==x)])
MHAS_w1_cont_rel$bnr[which(sapply(MHAS_w1_cont_rel$id,function(x) 9 %in% MHAS_w1_cont_rel1$b10_2[which(MHAS_w1_cont_rel1$newid==x)]))] <- 9
# Contact with some non-resident children is RF:
# sapply(MHAS_w1_cont_rel$id,function(x) 8 %in% MHAS_w1_cont_rel1$b10_2[which(MHAS_w1_cont_rel1$newid==x)])
MHAS_w1_cont_rel$bnr[which(sapply(MHAS_w1_cont_rel$id,function(x) 8 %in% MHAS_w1_cont_rel1$b10_2[which(MHAS_w1_cont_rel1$newid==x)]))] <- 8
# Contact with some non-resident child is weekly:
#sapply(MHAS_w1_cont_rel$id,function(x) 1 %in% MHAS_w1_cont_rel1$b10_2[which(MHAS_w1_cont_rel1$newid==x)])
MHAS_w1_cont_rel$bnr[which(sapply(MHAS_w1_cont_rel$id,function(x) 1 %in% MHAS_w1_cont_rel1$b10_2[which(MHAS_w1_cont_rel1$newid==x)]))] <- 1
# Contact with all non-resident children is less than weekly:
#sapply(MHAS_w1_cont_rel$id, function(x)  sum(!HAS_w1_cont_rel1$b10_2[which(MHAS_w1_cont_rel1$newid==x)] %in% c(2,3,4)) == 0 )
MHAS_w1_cont_rel$bnr[which(sapply(MHAS_w1_cont_rel$id, function(x)  sum(!MHAS_w1_cont_rel1$b10_2[which(MHAS_w1_cont_rel1$newid==x)] %in% c(2,3,4)) == 0 ))] <- 0

# In trh we codify if some household habitual resident is relative of the respondent
MHAS_w1_cont_rel$trh <- rep(999,length(MHAS_w1_cont_rel$id))

# Some habitual household resident is relative
# sapply(MHAS_w1_cont_rel$id, function(x) length(intersect(2:17,MHAS_w1_cont_rel3$trh6[which(MHAS_w1_cont_rel3$newid==x)]))>=1)
MHAS_w1_cont_rel$trh[which(sapply(MHAS_w1_cont_rel$id, function(x) length(intersect(2:17,MHAS_w1_cont_rel3$trh6[which(MHAS_w1_cont_rel3$newid==x)]))>=1))] <- 1
# None habitual household resident is relative:
# sapply(MHAS_w1_cont_rel$id, function(x)  sum(!HAS_w1_cont_rel1$trh6[which(MHAS_w1_cont_rel1$newid==x)] %in% c(0,18,66)) == 0 )
MHAS_w1_cont_rel$trh[which(sapply(MHAS_w1_cont_rel$id, function(x)  sum(!MHAS_w1_cont_rel3$trh6[which(MHAS_w1_cont_rel3$newid==x)] %in% c(0,18,66)) == 0 ))] <- 0




MHAS_ds_w1 <- tibble(id=MHAS_w1_cont_rel$id)
MHAS_ds_w1$cont_rel <- rep(0,length(MHAS_ds_w1$id))
MHAS_ds_w1$cont_rel[which(is.na(MHAS_w1_cont_rel$f28b1) & is.na(MHAS_w1_cont_rel$f28b2) & is.na(MHAS_w1_cont_rel$f28b3) & MHAS_w1_cont_rel$bnr==999 & MHAS_w1_cont_rel$trh==999)] <- 999


MHAS_ds_w1$cont_rel[which(MHAS_w1_cont_rel$f28b1==8 | MHAS_w1_cont_rel$f28b2==8 | MHAS_w1_cont_rel$f28b3==8 | MHAS_w1_cont_rel$bnr==8)] <- 997
MHAS_ds_w1$cont_rel[which(MHAS_w1_cont_rel$f28b1==9 | MHAS_w1_cont_rel$f28b2==9 | MHAS_w1_cont_rel$f28b3==9 | MHAS_w1_cont_rel$bnr==9)] <- 998
MHAS_ds_w1$cont_rel[which(MHAS_w1_cont_rel$f28b1==1 | MHAS_w1_cont_rel$f28b2==1 | MHAS_w1_cont_rel$f28b3==1 | MHAS_w1_cont_rel$bnr==1 | MHAS_w1_cont_rel$trh==1)] <- 1



```

#### Statistics of the new harmonised variable
```{r descript1, echo=F}
vari <- MHAS_ds_w1$cont_rel
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3]) 
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
#Categorical_summary(var = MHAS_ds_w1$cont_rel, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(MHAS_ds_w1, aes(x=factor(cont_rel))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Are any form of contact ( face-to-face/phone/mail/Internet communicators) with family members/relatives frequent?") + ylab("Frequency")
```

#### Validation
```{r crosstabulation1, echo=F}

```




### Wave 2

#### Study-specific variable description

The study-specific variables elected to be harmonised are:

    
* Name: `f32_1b`
* Label: `Frequency of contact with mother - period`
* Categories:
    + `1 = week`
    + `2 = month`
    + `3 = year`
    + `4 = less than once a year`
    + `5 = never`
* Missings:
    + `8 = RF`
    + `9 = DK`

* Name: `f32_2b`
* Label: `Frequency of contact with father - period`
* Categories:
    + `1 = week`
    + `2 = month`
    + `3 = year`
    + `4 = less than once a year`
    + `5 = never`
* Missings:
    + `8 = RF`
    + `9 = DK`
    
* Name: `f32_3b`
* Label: `Frequency of contact with parents - period`
* Categories:
    + `1 = week`
    + `2 = month`
    + `3 = year`
    + `4 = less than once a year`
    + `5 = never`
* Missings:
    + `8 = RF`
    + `9 = DK`
    

    
* Name: `trh9`
* Label: `Relationship of household member to selected person`
* Categories:
    + `02 = child`
    + `03 = step child`
    + `04 = adopted child`
    + `05 = foster child`
    + `06 = mother/father`
    + `07 = parent-in-law`
    + `08 = grandparent`
    + `09 = grandchild`
    + `10 = great-grandchild`
    + `11 = son/daughter-in-law`
    + `12 = brother/sister, step B/S`
    + `13 = brother/sister-in-law/cousin`
    + `14 = ancle/aunt`
    + `15 = nephew/niece`
    + `16 = other relative`
    + `17 = non-relative`
    + `66 = without spouse`





```{r assign2, echo=F}

opal.assign.table.tibble(o, 'MHAS_w2_cont_rel','Mexican Health Aging Study.MHAS_2003', variables=list('f32_1b','f32_2b','f32_3b'), missings = TRUE)
MHAS_w2_cont_rel <- opal.execute(o,'MHAS_w2_cont_rel')

opal.assign.table.tibble(o, 'MHAS_w2_cont_rel1','Mexican Health Aging Study.sect_trh_2003', variables=list('trh9','trh1','cunicah'), missings = TRUE)
MHAS_w2_cont_rel1 <- opal.execute(o,'MHAS_w2_cont_rel1')
MHAS_w2_cont_rel1$tid <- car::recode(MHAS_w2_cont_rel1$trh1, "1=10;2=20;3=11;4=21;103:hi=NA")
MHAS_w2_cont_rel1$cunicah <- as.character(MHAS_w2_cont_rel1$cunicah)

# JOIN (HH)ID TOGETHER WITH CODE NUMBER OF THE RESPONDENT
MHAS_w2_cont_rel1$newid <- paste0(substr(MHAS_w2_cont_rel1$cunicah,1,nchar(MHAS_w2_cont_rel1$cunicah)),as.character(MHAS_w2_cont_rel1$tid),".0")

```

```{r local2, echo=F}

vari <- MHAS_w2_cont_rel$f32_1b
kable(Categorical_summary(vari, missing_values = c(8,9))[3], caption = attributes(vari)$`spss::shortName`) 
kable(Categorical_summary(vari, missing_values = c(8,9))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(8,9))[2], caption = "Type of missing")
#Categorical_summary(var = MHAS_w2_cont_rel$f32_1b, missing_values = NA)
ggplot(MHAS_w2_cont_rel, aes(x=factor(f32_1b))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Frequency of contact with mother - period") + ylab("Frequency")

vari <- MHAS_w2_cont_rel$f32_2b
kable(Categorical_summary(vari, missing_values = c(8,9))[3], caption = attributes(vari)$`spss::shortName`) 
kable(Categorical_summary(vari, missing_values = c(8,9))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(8,9))[2], caption = "Type of missing")
#Categorical_summary(var = MHAS_w2_cont_rel$f32_1b, missing_values = NA)
ggplot(MHAS_w2_cont_rel, aes(x=factor(f32_2b))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Frequency of contact with father - period") + ylab("Frequency")

vari <- MHAS_w2_cont_rel$f32_3b
kable(Categorical_summary(vari, missing_values = c(8,9))[3], caption = attributes(vari)$`spss::shortName`) 
kable(Categorical_summary(vari, missing_values = c(8,9))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(8,9))[2], caption = "Type of missing")
#Categorical_summary(var = MHAS_w2_cont_rel$f32_1b, missing_values = NA)
ggplot(MHAS_w2_cont_rel, aes(x=factor(f32_3b))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Frequency of contact with parents - period") + ylab("Frequency")

vari <- MHAS_w2_cont_rel1$trh9
kable(Categorical_summary(vari, missing_values = c(8,9))[3], caption = attributes(vari)$`spss::shortName`) 
kable(Categorical_summary(vari, missing_values = c(8,9))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(8,9))[2], caption = "Type of missing")
ggplot(MHAS_w2_cont_rel1, aes(x=factor(trh9))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vari)) + ylab("Frequency")

```

#### Harmonisation algorithm
To recode the harmonize variable from the study-specific variable it has to be recoded as follows:  

* `week into 1`
* `NA into 999`

**R script:**

```{r harmo2}

# In trh we codify if some household habitual resident is relative of the respondent
MHAS_w2_cont_rel$trh <- rep(999,length(MHAS_w2_cont_rel$id))

# Some habitual household resident is relative
MHAS_w2_cont_rel$trh[which(sapply(MHAS_w2_cont_rel$id, function(x) length(intersect(2:16,MHAS_w2_cont_rel1$trh9[which(MHAS_w2_cont_rel1$newid==x)]))>=1))] <- 1
# None habitual household resident is relative:
MHAS_w2_cont_rel$trh[which(sapply(MHAS_w2_cont_rel$id, function(x)  sum(!MHAS_w2_cont_rel1$trh9[which(MHAS_w2_cont_rel1$newid==x)] %in% c(17,66)) == 0 ))] <- 0

MHAS_ds_w2 <- tibble(id=MHAS_w2_cont_rel$id)
MHAS_ds_w2$cont_rel <- rep(0,length(MHAS_ds_w2$id))
MHAS_ds_w2$cont_rel[which(is.na(MHAS_w2_cont_rel$f32_1b) & is.na(MHAS_w2_cont_rel$f32_2b) & is.na(MHAS_w2_cont_rel$f32_3b) & MHAS_w2_cont_rel$trh==999)] <- 999
MHAS_ds_w2$cont_rel[which(MHAS_w2_cont_rel$f32_1b==8 | MHAS_w2_cont_rel$f32_2b==8 | MHAS_w2_cont_rel$f32_3b==8)] <- 997
MHAS_ds_w2$cont_rel[which(MHAS_w2_cont_rel$f32_1b==9 | MHAS_w2_cont_rel$f32_2b==9 | MHAS_w2_cont_rel$f32_3b==9)] <- 998
MHAS_ds_w2$cont_rel[which(MHAS_w2_cont_rel$f32_1b==1 | MHAS_w2_cont_rel$f32_2b==1 | MHAS_w2_cont_rel$f32_3b==1 | MHAS_w2_cont_rel$trh==1)] <- 1


```

#### Statistics of the new harmonised variable
```{r descript2, echo=F}
vari <- MHAS_ds_w2$cont_rel
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3]) 
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
ggplot(MHAS_ds_w2, aes(x=factor(cont_rel))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Are any form of contact ( face-to-face/phone/mail/Internet communicators) with family members/relatives frequent?") + ylab("Frequency")
```

#### Validation
```{r crosstabulation2, echo=F}

```



### Wave 3

#### Study-specific variable description

The study-specific variables elected to be harmonised are:
  
  
* Name: `f32_1_2_12`
* Label: `Last 2 years: respondent's period to report contact with mother`
* Categories:
    + `1 = week`
    + `2 = month`
    + `3 = year`
    + `4 = less than once a year`
    + `5 = never`
* Missings:
    + `8 = RF`
    + `9 = DK`

* Name: `f32_2_2_12`
* Label: `Last 2 years: respondent's period to report contact with father`
* Categories:
    + `1 = week`
    + `2 = month`
    + `3 = year`
    + `4 = less than once a year`
    + `5 = never`
* Missings:
    + `8 = RF`
    + `9 = DK`


* Name: `f32_3_2_12`
* Label: `Last 2 years: respondent's period to report contact with parents`
* Categories:
    + `1 = week`
    + `2 = month`
    + `3 = year`
    + `4 = less than once a year`
    + `5 = never`
* Missings:
    + `8 = RF`
    + `9 = DK`


* Name: `trh9_12` **from "sect_trh_follow_up_2012"**
* Label: `Resident's relationship to respondent`
* Categories:
    + `02 = child`
    + `03 = step child`
    + `04 = adopted child`
    + `05 = foster child`
    + `06 = mother/father`
    + `07 = parent-in-law`
    + `08 = grandparent`
    + `09 = grandchild`
    + `10 = great-grandchild`
    + `11 = son/daughter-in-law`
    + `12 = brother/sister, step B/S`
    + `13 = brother/sister-in-law/cousin`
    + `14 = ancle/aunt`
    + `15 = nephew/niece`
    + `16 = other relative`
    + `17 = non-relative`


* Name: `ntrh6_12` **from "sect_trh_new_sample_2012"**
* Label: `Resident's relationship to respondent`
* Categories:
    + `03 = child`
    + `04 = step child`
    + `05 = adopted child`
    + `06 = foster child`
    + `07 = mother/father`
    + `08 = parent-in-law`
    + `09 = grandparent`
    + `10 = grandchild`
    + `11 = great-grandchild`
    + `12 = son/daughter-in-law`
    + `13 = brother/sister, step B/S`
    + `14 = brother/sister-in-law/cousin`
    + `15 = ancle/aunt`
    + `16 = nephew/niece`
    + `17 = other relative`
    + `18 = non-relative`


```{r assign3, echo=F}

opal.assign.table.tibble(o, 'MHAS_w3_cont_rel','Mexican Health Aging Study.MHAS_2012_new', variables=list('f32_1_2_12','f32_2_2_12','f32_3_2_12','subhog_12','subhog_01','subhog_03','cunicah'), missings = TRUE)
MHAS_w3_cont_rel <- opal.execute(o,'MHAS_w3_cont_rel')
MHAS_w3_cont_rel$cunicah <- as.character(MHAS_w3_cont_rel$cunicah)

# 'cunicah' = substr(MHAS_w3_cont_rel$id,1,nchar(MHAS_w3_cont_rel$id)-4)
# 'tid' = substr(MHAS_w3_cont_rel$id,nchar(MHAS_w3_cont_rel$id)-3,nchar(MHAS_w3_cont_rel$id)-2)

opal.assign.table.tibble(o, 'MHAS_w3_cont_rel1','Mexican Health Aging Study.sect_trh_follow_up_2012', variables=list('trh9_12','subhog_12','cunicah'), missings = TRUE)
MHAS_w3_cont_rel1 <- opal.execute(o,'MHAS_w3_cont_rel1')
MHAS_w3_cont_rel1$cunicah <- as.character(MHAS_w3_cont_rel1$cunicah)

opal.assign.table.tibble(o, 'MHAS_w3_cont_rel2','Mexican Health Aging Study.sect_trh_new_sample_2012',variables=list('ntrh6_12','subhog_12','cunicah'), missings = TRUE)
MHAS_w3_cont_rel2 <- opal.execute(o,'MHAS_w3_cont_rel2')
MHAS_w3_cont_rel2$cunicah <- as.character(MHAS_w3_cont_rel2$cunicah)


```

```{r local3, echo=F}

vari <- MHAS_w3_cont_rel$f32_1_2_12
kable(Categorical_summary(vari, missing_values = c(8,9))[3], caption = attributes(vari)$`spss::shortName`) 
kable(Categorical_summary(vari, missing_values = c(8,9))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(8,9))[2], caption = "Type of missing")
#Categorical_summary(var = MHAS_w3_cont_rel$f32_1_2_12, missing_values = NA)
ggplot(MHAS_w3_cont_rel, aes(x=factor(f32_1_2_12))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Last 2 years: respondent's period to report contact with mother") + ylab("Frequency")


vari <- MHAS_w3_cont_rel$f32_2_2_12
kable(Categorical_summary(vari, missing_values = c(8,9))[3], caption = attributes(vari)$`spss::shortName`) 
kable(Categorical_summary(vari, missing_values = c(8,9))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(8,9))[2], caption = "Type of missing")
#Categorical_summary(var = MHAS_w3_cont_rel$f32_1_2_12, missing_values = NA)
ggplot(MHAS_w3_cont_rel, aes(x=factor(f32_2_2_12))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Last 2 years: respondent's period to report contact with father") + ylab("Frequency")


vari <- MHAS_w3_cont_rel$f32_3_2_12
kable(Categorical_summary(vari, missing_values = c(8,9))[3], caption = attributes(vari)$`spss::shortName`) 
kable(Categorical_summary(vari, missing_values = c(8,9))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(8,9))[2], caption = "Type of missing")
#Categorical_summary(var = MHAS_w3_cont_rel$f32_1_2_12, missing_values = NA)
ggplot(MHAS_w3_cont_rel, aes(x=factor(f32_3_2_12))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Last 2 years: respondent's period to report contact with parents") + ylab("Frequency")


vari <- MHAS_w3_cont_rel1$trh9_12
kable(Categorical_summary(vari, missing_values = c(8,9))[3], caption = attributes(vari)$`spss::shortName`) 
kable(Categorical_summary(vari, missing_values = c(8,9))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(8,9))[2], caption = "Type of missing")
#Categorical_summary(var = MHAS_w3_cont_rel$f32_1_2_12, missing_values = NA)
ggplot(MHAS_w3_cont_rel1, aes(x=factor(trh9_12))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Resident's relationship to respondent") + ylab("Frequency")


vari <- MHAS_w3_cont_rel2$ntrh6_12
kable(Categorical_summary(vari, missing_values = c(8,9))[3], caption = attributes(vari)$`spss::shortName`) 
kable(Categorical_summary(vari, missing_values = c(8,9))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(8,9))[2], caption = "Type of missing")
#Categorical_summary(var = MHAS_w3_cont_rel$f32_1_2_12, missing_values = NA)
ggplot(MHAS_w3_cont_rel2, aes(x=factor(ntrh6_12))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Resident's relationship to respondent") + ylab("Frequency")

```

#### Harmonisation algorithm
To recode the harmonize variable from the study-specific variable it has to be recoded as follows:  
  
* `week into 1`
* `if trh9_12 in 2:16 or ntrh6_12 in 3:17 then 1`
* `NA into 999`

**R script:**
  
```{r harmo3}

# In futrh we codify if some household habitual resident from the follow up sample is relative of the respondent
MHAS_w3_cont_rel$futrh <- rep(999,length(MHAS_w3_cont_rel$id))

# Some habitual household resident is relative
MHAS_w3_cont_rel$futrh[which(sapply(1:length(MHAS_w3_cont_rel$id), function(x) length(intersect(2:16,MHAS_w3_cont_rel1$trh9_12[which(MHAS_w3_cont_rel1$cunicah==MHAS_w3_cont_rel$cunicah[x] & MHAS_w3_cont_rel1$subhog_12==MHAS_w3_cont_rel$subhog_12[x])]))>=1))] <- 1
# None habitual household resident is relative:
MHAS_w3_cont_rel$futrh[which(sapply(1:length(MHAS_w3_cont_rel$id), function(x)  sum(!MHAS_w3_cont_rel1$trh9_12[which(MHAS_w3_cont_rel1$cunicah==MHAS_w3_cont_rel$cunicah[x] & MHAS_w3_cont_rel1$subhog_12==MHAS_w3_cont_rel$subhog_12[x])] %in% c(17)) == 0 ))] <- 0


# In nstrh we codify if some household habitual resident from the new sample is relative of the respondent
MHAS_w3_cont_rel$nstrh <- rep(999,length(MHAS_w3_cont_rel$id))

# Some habitual household resident is relative
MHAS_w3_cont_rel$nstrh[which(sapply(1:length(MHAS_w3_cont_rel$id), function(x) length(intersect(3:17,MHAS_w3_cont_rel2$ntrh6_12[which(MHAS_w3_cont_rel2$cunicah==MHAS_w3_cont_rel$cunicah[x] & MHAS_w3_cont_rel2$subhog_12==MHAS_w3_cont_rel$subhog_12[x])]))>=1))] <- 1
# None habitual household resident is relative:
MHAS_w3_cont_rel$nstrh[which(sapply(1:length(MHAS_w3_cont_rel$id), function(x)  sum(!MHAS_w3_cont_rel2$ntrh6_12[which(MHAS_w3_cont_rel2$cunicah==MHAS_w3_cont_rel$cunicah[x] & MHAS_w3_cont_rel2$subhog_12==MHAS_w3_cont_rel$subhog_12[x])] %in% c(18)) == 0 ))] <- 0


MHAS_ds_w3 <- tibble(id=MHAS_w3_cont_rel$id)

MHAS_ds_w3$cont_rel <- rep(0,length(MHAS_ds_w3$id))

MHAS_ds_w3$cont_rel[which(is.na(MHAS_w3_cont_rel$f32_1_2_12) & is.na(MHAS_w3_cont_rel$f32_2_2_12) & is.na(MHAS_w3_cont_rel$f32_3_2_12) & MHAS_w3_cont_rel$futrh==999 & MHAS_w3_cont_rel$nstrh==999)] <- 999
MHAS_ds_w3$cont_rel[which(MHAS_w3_cont_rel$f32_1_2_12==8 | MHAS_w3_cont_rel$f32_2_2_12==8 | MHAS_w3_cont_rel$f32_3_2_12==8)] <- 997
MHAS_ds_w3$cont_rel[which(MHAS_w3_cont_rel$f32_1_2_12==9 | MHAS_w3_cont_rel$f32_2_2_12==9 | MHAS_w3_cont_rel$f32_3_2_12==9)] <- 998
MHAS_ds_w3$cont_rel[which(MHAS_w3_cont_rel$f32_1_2_12==1 | MHAS_w3_cont_rel$f32_2_2_12==1 | MHAS_w3_cont_rel$f32_3_2_12==1 | MHAS_w3_cont_rel$futrh==1 | MHAS_w3_cont_rel$nstrh==1)] <- 1


```


#### Statistics of the new harmonised variable

```{r descript3, echo=F}

vari <- MHAS_ds_w3$cont_rel
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3]) 
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
#Categorical_summary(var = MHAS_ds_w1$cont_rel, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(MHAS_ds_w3, aes(x=factor(cont_rel))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Are any form of contact ( face-to-face/phone/mail/Internet communicators) with family members/relatives frequent?") + ylab("Frequency")

```

#### Validation
```{r crosstabulation3, echo=F}

```










```{r final, echo=F}

l.hds <- list(w1 = MHAS_ds_w1, w2 = MHAS_ds_w2, w3 = MHAS_ds_w3)

for(name in names(l.hds)) {
  aux_object <- l.hds[[name]]
  label(l.hds[[name]][[2]]) <- label(aux_object[[2]]) <- ds_label # Text value assigned at the DS description, at the top
  l.hds[[name]][[2]] <- labelled(l.hds[[name]][[2]], labels = cat_label)
  aux_object[[2]] <- car::recode(aux_object[[2]], "miss_values_vector=NA")
  aux_object[[2]] <- labelled(aux_object[[2]], labels = cat_label[1:2])
  m_name <- paste0("MHAS_m_ds_",name)
  assign(m_name, aux_object)
  rm(aux_object)
}

```

## Summary of descriptive statistics of the harmonised variable accross populations and waves

Two tables are generated: 

1. Percentages of categories in each harmonised variable.

2. Frequencies and percentages of individuals with different trajectories.


```{r summ}

t.hds <- frq(l.hds[[1]][2])[[1]][,c(1,2)] 
for (i in seq_along(l.hds)){
  t.hds[2+i] <- frq(l.hds[[i]][2])[[1]][,4] 
}
t.hds[13,] <- c("n", "sample size", sapply(l.hds,function(wave) length(wave[[1]]))
             )
names(t.hds)<-c("val", "label",names(l.hds))
kable(t.hds)

dbb <- get(paste0("MHAS_m_ds_",names(l.hds)[1]))[,c("id","cont_rel")]
for(ind in 2:length(l.hds)){
  dbb <- merge(dbb, get(paste0("MHAS_m_ds_",names(l.hds)[ind]))[,c("id","cont_rel")], by = "id", suffixes = c("", paste0(".",names(l.hds)[ind])), all = T)
}
names(dbb) <- c("id", names(l.hds))

v.dbb <- dbb[,2]
for(ind in 2:length(l.hds)){
  v.dbb <- paste(v.dbb,dbb[,ind+1],sep="")
}
f.dbb <- frq(v.dbb)[[1]][,c(1,2,4)]
kable(f.dbb)

```


# Quality estimation
[Comments on the quality of the new harmonised variable.]


<!-- ########################################################## --> 
<!-- # Save -->
```{r save, include=FALSE, echo=F}


for(index in seq_along(l.hds)){
  cont_rel <- l.hds[[index]]
  save(cont_rel, file = paste0(datafolder,names(l.hds)[index],"/cont_rel.RData"))
}

```
<!-- ########################################################## --> 



<!-- ########################################################## -->
<!--- # Close OPAL R Session -->
```{r closeRsession, echo=FALSE}
opal.logout(o)
```
