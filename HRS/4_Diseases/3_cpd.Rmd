---
title: "Chronic pulmonary disorders"
output:
  html_document:
    highlight: tango
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

<!-- ########################################################## --> 
<!-- # Installation, loading packages -->
```{r setup, include=FALSE}
source("../../setup.r")
```
<!-- ########################################################## --> 
<!-- # Loading DS description -->
```{r main, child='../../_DS_Rmd/cpdDS.Rmd'}
```
```{r global, echo=F}
source('../../_DS_Rmd/cpdDS.R')
```


# Data process



## HRS

### Wave 1

#### Study-specific variable description

| **Name** | `R1LUNGE` |
|-|-|
| **Label** | `R1LUNGE:W1 R ever had lung disease`|
| **Table name**  | `HRS-HRS-w1`|
| **Categories** | `0 = no`<br/>`1 = yes` |
| **Missings** | `NA` |
| **Description** |  |

```{r assign hrs_w1, echo=F}

opal.assign.table.tibble(o, 'HRS_hrs_w1','HRS.HRS-HRS-w1',variables=list('R1LUNGE'), missings = T)
HRS_hrs_w1 <- opal.execute(o,'HRS_hrs_w1')

```

```{r local hrs_w1, echo=F}

vbl <- HRS_hrs_w1$R1LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_hrs_w1)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_hrs_w1, aes(x=factor(R1LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `keep up 1 into 1`
* `keep up 0 into 0`
* `NA into 999`

Age of diagnosis cannot be harmonized.

**R script:**

```{r harmo hrs_w1}

# Categorical variable harmonization
HRS_ds_hrs_w1 <- tibble(id=HRS_hrs_w1$id)
HRS_ds_hrs_w1$h_cpd <- car::recode(HRS_hrs_w1$R1LUNGE, "NA=999")

# We build a global table in order to have updated the status of all the individuals through the different waves
HRS_ds_hrs <- HRS_ds_hrs_w1
HRS_ds_hrs$h_cpd_age <- rep(999,length(HRS_ds_hrs$id))

```


#### Statistics of the new harmonized variable

```{r descript hrs_w1, echo=F}

vbl <- HRS_ds_hrs_w1$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_hrs_w1, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

```


#### Validation

```{r crosstabulation hrs_w1, echo=F}

AfterH <- table(HRS_ds_hrs_w1$h_cpd, useNA = "ifany")
BeforeH <- table(HRS_hrs_w1$R1LUNGE, useNA = "ifany")
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)
rm(HRS_hrs_w1)

```



### Wave 2

#### Study-specific variable description

| **Name** | `R2LUNGE` |`ybirth`|`yintw (hrs_w1)`|`yintw (hrs_w2)`|
|-|-|-|-|-|
| **Label** | `R2LUNGE:W2 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-HRS-w2`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`| `999 = Missing` |  |  |
| **Description** |  |  |  |  |

```{r assign hrs_w2, echo=F}

opal.assign.table.tibble(o, 'HRS_hrs_w2','HRS.HRS-HRS-w2',variables=list('R2LUNGE'), missings = T)
HRS_hrs_w2 <- opal.execute(o,'HRS_hrs_w2')
load(paste0(datafolder,"hrs_w2/ybirth.RData"))
HRS_hrs_w2 <- left_join(HRS_hrs_w2,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"hrs_w1/yintw.RData"))
HRS_hrs_w2 <- left_join(HRS_hrs_w2,yintw, by="id")
names(HRS_hrs_w2)[4] <- "yintw_hrs_w1"
rm(yintw)
load(paste0(datafolder,"hrs_w2/yintw.RData"))
HRS_hrs_w2 <- left_join(HRS_hrs_w2,yintw, by="id")
names(HRS_hrs_w2)[5] <- "yintw_hrs_w2"
rm(yintw)

```

```{r local hrs_w2, echo=F}

vbl <- HRS_hrs_w2$R2LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_hrs_w2)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_hrs_w2, aes(x=factor(R2LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w2$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w2)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_hrs_w2 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w2$yintw_hrs_w1
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w2)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w2, aes(x=factor(yintw_hrs_w1))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w2$yintw_hrs_w2
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w2)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w2, aes(x=factor(yintw_hrs_w2))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R1LUNGE == 0 and R2LUNGE == 0 into 0`
* `R1LUNGE == 1 or R2LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w2 and 0 in w1, h_cpd_age = (year of interview w2-year of interview w1)/2+(year of interview w1 -ybirth)`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo hrs_w2}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_hrs_w2 <- left_join(HRS_hrs_w2, HRS_ds_hrs, by = "id")

# Categorical variable harmonization
HRS_ds_hrs_w2 <- tibble(id=HRS_hrs_w2$id)
HRS_ds_hrs_w2$h_cpd <- rep(999,length(HRS_hrs_w2$id))
HRS_ds_hrs_w2$h_cpd[which(((!is.na(HRS_hrs_w2$R2LUNGE)) & HRS_hrs_w2$R2LUNGE == 0) & (HRS_hrs_w2$h_cpd != 1))] <- 0
HRS_ds_hrs_w2$h_cpd[which(((!is.na(HRS_hrs_w2$R2LUNGE)) & HRS_hrs_w2$R2LUNGE == 1) | ((!is.na(HRS_hrs_w2$h_cpd)) & (!is.na(HRS_hrs_w2$R2LUNGE)) & HRS_hrs_w2$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_hrs_w2$h_cpd_age <- rep(999,length(HRS_hrs_w2$id))
HRS_ds_hrs_w2$h_cpd_age[which(HRS_ds_hrs_w2$h_cpd == 0)] <- 996
HRS_ds_hrs_w2$h_cpd_age[which(HRS_ds_hrs_w2$h_cpd == 1 & HRS_hrs_w2$h_cpd==0 & !HRS_hrs_w2$ybirth %in% miss_values_vector & !(HRS_hrs_w2$yintw_hrs_w2 %in% miss_values_vector | HRS_hrs_w2$yintw_hrs_w1 %in% miss_values_vector))] <- floor((HRS_hrs_w2$yintw_hrs_w2[which(HRS_ds_hrs_w2$h_cpd == 1 & HRS_hrs_w2$h_cpd==0 & !HRS_hrs_w2$ybirth %in% miss_values_vector & !(HRS_hrs_w2$yintw_hrs_w2 %in% miss_values_vector | HRS_hrs_w2$yintw_hrs_w1 %in% miss_values_vector))]+HRS_hrs_w2$yintw_hrs_w1[which(HRS_ds_hrs_w2$h_cpd == 1 & HRS_hrs_w2$h_cpd==0 & !HRS_hrs_w2$ybirth %in% miss_values_vector & !(HRS_hrs_w2$yintw_hrs_w2 %in% miss_values_vector | HRS_hrs_w2$yintw_hrs_w1 %in% miss_values_vector))])/2-HRS_hrs_w2$ybirth[which(HRS_ds_hrs_w2$h_cpd == 1 & HRS_hrs_w2$h_cpd==0 & !HRS_hrs_w2$ybirth %in% miss_values_vector & !(HRS_hrs_w2$yintw_hrs_w2 %in% miss_values_vector | HRS_hrs_w2$yintw_hrs_w1 %in% miss_values_vector))])

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_hrs[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_hrs_w2,log_vec=(HRS_ds_prov$id %in% HRS_ds_hrs_w2$id),col_end_index = 2, col_st_index = 3)
HRS_ds_hrs$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_hrs$h_cpd_age[which((HRS_ds_hrs$id %in% HRS_ds_hrs_w2$id) & (HRS_ds_hrs$h_cpd != 999))] <- HRS_ds_hrs_w2$h_cpd_age[which(HRS_ds_hrs_w2$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript hrs_w2, echo=F}

vbl <- HRS_ds_hrs_w2$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_hrs_w2, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_hrs_w2$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_hrs_w2 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation hrs_w2, echo=F, results='asis'}

AfterH <- table(HRS_ds_hrs_w2$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_hrs_w2$R2LUNGE)) & HRS_hrs_w2$R2LUNGE == 0) & (HRS_hrs_w2$h_cpd != 1)),
  sum(((!is.na(HRS_hrs_w2$R2LUNGE)) & HRS_hrs_w2$R2LUNGE == 1) | ((!is.na(HRS_hrs_w2$h_cpd)) & (!is.na(HRS_hrs_w2$R2LUNGE)) & HRS_hrs_w2$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_hrs_w2$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_hrs_w2)

```




### Wave 3

#### Study-specific variable description

| **Name** | `R3LUNGE` |`ybirth`|`yintw (hrs_w2)`|`yintw (hrs_w3)`|
|-|-|-|-|-|
| **Label** | `R3LUNGE:W3 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-HRS-w3`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`| `999 = Missing` |  |  |
| **Description** |  |  |  |  |

```{r assign hrs_w3, echo=F}

opal.assign.table.tibble(o, 'HRS_hrs_w3','HRS.HRS-HRS-w3',variables=list('R3LUNGE'), missings = T)
HRS_hrs_w3 <- opal.execute(o,'HRS_hrs_w3')
load(paste0(datafolder,"hrs_w3/ybirth.RData"))
HRS_hrs_w3 <- left_join(HRS_hrs_w3,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"hrs_w2/yintw.RData"))
HRS_hrs_w3 <- left_join(HRS_hrs_w3,yintw, by="id")
names(HRS_hrs_w3)[4] <- "yintw_hrs_w2"
rm(yintw)
load(paste0(datafolder,"hrs_w3/yintw.RData"))
HRS_hrs_w3 <- left_join(HRS_hrs_w3,yintw, by="id")
names(HRS_hrs_w3)[5] <- "yintw_hrs_w3"
rm(yintw)

```

```{r local hrs_w3, echo=F}

vbl <- HRS_hrs_w3$R3LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_hrs_w3)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_hrs_w3, aes(x=factor(R3LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w3$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w3)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_hrs_w3 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w3$yintw_hrs_w2
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w3)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w3, aes(x=factor(yintw_hrs_w2))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w3$yintw_hrs_w3
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w3)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w3, aes(x=factor(yintw_hrs_w3))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R1LUNGE == 0 and R2LUNGE == 0 and R3LUNGE == 0 into 0`
* `R1LUNGE == 1 or R2LUNGE == 1 or R3LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w3 and 0 in w2, h_cpd_age = (year of interview w3-year of interview w2)/2+(year of interview w2 -ybirth)`
* `if h_cpd == 1 in w3 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo hrs_w3}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_hrs_w3 <- left_join(HRS_hrs_w3, HRS_ds_hrs, by = "id")

# Categorical variable harmonization
HRS_ds_hrs_w3 <- tibble(id=HRS_hrs_w3$id)
HRS_ds_hrs_w3$h_cpd <- rep(999,length(HRS_hrs_w3$id))
HRS_ds_hrs_w3$h_cpd[which(((!is.na(HRS_hrs_w3$R3LUNGE)) & HRS_hrs_w3$R3LUNGE == 0) & (HRS_hrs_w3$h_cpd != 1))] <- 0
HRS_ds_hrs_w3$h_cpd[which(((!is.na(HRS_hrs_w3$R3LUNGE)) & HRS_hrs_w3$R3LUNGE == 1) | ((!is.na(HRS_hrs_w3$h_cpd)) & (!is.na(HRS_hrs_w3$R3LUNGE)) & HRS_hrs_w3$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_hrs_w3$h_cpd_age <- rep(999,length(HRS_hrs_w3$id))
HRS_ds_hrs_w3$h_cpd_age[which(HRS_ds_hrs_w3$h_cpd == 0)] <- 996
HRS_ds_hrs_w3$h_cpd_age[which(HRS_ds_hrs_w3$h_cpd == 1 & HRS_hrs_w3$h_cpd==0 & !HRS_hrs_w3$ybirth %in% miss_values_vector & !(HRS_hrs_w3$yintw_hrs_w3 %in% miss_values_vector | HRS_hrs_w3$yintw_hrs_w2 %in% miss_values_vector))] <- floor((HRS_hrs_w3$yintw_hrs_w3[which(HRS_ds_hrs_w3$h_cpd == 1 & HRS_hrs_w3$h_cpd==0 & !HRS_hrs_w3$ybirth %in% miss_values_vector & !(HRS_hrs_w3$yintw_hrs_w3 %in% miss_values_vector | HRS_hrs_w3$yintw_hrs_w2 %in% miss_values_vector))]+HRS_hrs_w3$yintw_hrs_w2[which(HRS_ds_hrs_w3$h_cpd == 1 & HRS_hrs_w3$h_cpd==0 & !HRS_hrs_w3$ybirth %in% miss_values_vector & !(HRS_hrs_w3$yintw_hrs_w3 %in% miss_values_vector | HRS_hrs_w3$yintw_hrs_w2 %in% miss_values_vector))])/2-HRS_hrs_w3$ybirth[which(HRS_ds_hrs_w3$h_cpd == 1 & HRS_hrs_w3$h_cpd==0 & !HRS_hrs_w3$ybirth %in% miss_values_vector & !(HRS_hrs_w3$yintw_hrs_w3 %in% miss_values_vector | HRS_hrs_w3$yintw_hrs_w2 %in% miss_values_vector))])
HRS_ds_hrs_w3$h_cpd_age[which(HRS_ds_hrs_w3$h_cpd == 1 & !HRS_hrs_w3$h_cpd_age %in% miss_values_vector)] <- HRS_hrs_w3$h_cpd_age[which(HRS_ds_hrs_w3$h_cpd == 1 & !HRS_hrs_w3$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_hrs[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_hrs_w3,log_vec=(HRS_ds_prov$id %in% HRS_ds_hrs_w3$id),col_end_index = 2, col_st_index = 3)
HRS_ds_hrs$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_hrs$h_cpd_age[which((HRS_ds_hrs$id %in% HRS_ds_hrs_w3$id) & (HRS_ds_hrs$h_cpd != 999))] <- HRS_ds_hrs_w3$h_cpd_age[which(HRS_ds_hrs_w3$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript hrs_w3, echo=F}

vbl <- HRS_ds_hrs_w3$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_hrs_w3, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_hrs_w3$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_hrs_w3 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation hrs_w3, echo=F, results='asis'}

AfterH <- table(HRS_ds_hrs_w3$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_hrs_w3$R3LUNGE)) & HRS_hrs_w3$R3LUNGE == 0) & (HRS_hrs_w3$h_cpd != 1)),
  sum(((!is.na(HRS_hrs_w3$R3LUNGE)) & HRS_hrs_w3$R3LUNGE == 1) | ((!is.na(HRS_hrs_w3$h_cpd)) & (!is.na(HRS_hrs_w3$R3LUNGE)) & HRS_hrs_w3$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_hrs_w3$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_hrs_w3)

```




### Wave 4

#### Study-specific variable description

| **Name** | `R4LUNGE` |`ybirth`|`yintw (hrs_w4)`|`yintw (hrs_w3)`|
|-|-|-|-|-|
| **Label** | `R4LUNGE:W4 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-HRS-w4`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`| `999 = Missing` |  |  |
| **Description** |  |  |  |  |

```{r assign hrs_w4, echo=F}

opal.assign.table.tibble(o, 'HRS_hrs_w4','HRS.HRS-HRS-w4',variables=list('R4LUNGE'), missings = T)
HRS_hrs_w4 <- opal.execute(o,'HRS_hrs_w4')
load(paste0(datafolder,"hrs_w4/ybirth.RData"))
HRS_hrs_w4 <- left_join(HRS_hrs_w4,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"hrs_w3/yintw.RData"))
HRS_hrs_w4 <- left_join(HRS_hrs_w4,yintw, by="id")
names(HRS_hrs_w4)[4] <- "yintw_hrs_w3"
rm(yintw)
load(paste0(datafolder,"hrs_w4/yintw.RData"))
HRS_hrs_w4 <- left_join(HRS_hrs_w4,yintw, by="id")
names(HRS_hrs_w4)[5] <- "yintw_hrs_w4"
rm(yintw)

```

```{r local hrs_w4, echo=F}

vbl <- HRS_hrs_w4$R4LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_hrs_w4)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_hrs_w4, aes(x=factor(R4LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w4$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w4)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_hrs_w4 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w4$yintw_hrs_w3
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w4)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w4, aes(x=factor(yintw_hrs_w3))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w4$yintw_hrs_w4
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w4)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w4, aes(x=factor(yintw_hrs_w4))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R1LUNGE == 0 and R2LUNGE == 0 and R3LUNGE == 0 and R4LUNGE == 0 into 0`
* `R1LUNGE == 1 or R2LUNGE == 1 or R3LUNGE == 1 or R4LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w4 and 0 in w3, h_cpd_age = (year of interview w4-year of interview w3)/2+(year of interview w3 -ybirth)`
* `if h_cpd == 1 in w4 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo hrs_w4}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_hrs_w4 <- left_join(HRS_hrs_w4, HRS_ds_hrs, by = "id")

# Categorical variable harmonization
HRS_ds_hrs_w4 <- tibble(id=HRS_hrs_w4$id)
HRS_ds_hrs_w4$h_cpd <- rep(999,length(HRS_hrs_w4$id))
HRS_ds_hrs_w4$h_cpd[which(((!is.na(HRS_hrs_w4$R4LUNGE)) & HRS_hrs_w4$R4LUNGE == 0) & (HRS_hrs_w4$h_cpd != 1))] <- 0
HRS_ds_hrs_w4$h_cpd[which(((!is.na(HRS_hrs_w4$R4LUNGE)) & HRS_hrs_w4$R4LUNGE == 1) | ((!is.na(HRS_hrs_w4$h_cpd)) & (!is.na(HRS_hrs_w4$R4LUNGE)) & HRS_hrs_w4$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_hrs_w4$h_cpd_age <- rep(999,length(HRS_hrs_w4$id))
HRS_ds_hrs_w4$h_cpd_age[which(HRS_ds_hrs_w4$h_cpd == 0)] <- 996
HRS_ds_hrs_w4$h_cpd_age[which(HRS_ds_hrs_w4$h_cpd == 1 & HRS_hrs_w4$h_cpd==0 & !HRS_hrs_w4$ybirth %in% miss_values_vector & !(HRS_hrs_w4$yintw_hrs_w4 %in% miss_values_vector | HRS_hrs_w4$yintw_hrs_w3 %in% miss_values_vector))] <- floor((HRS_hrs_w4$yintw_hrs_w4[which(HRS_ds_hrs_w4$h_cpd == 1 & HRS_hrs_w4$h_cpd==0 & !HRS_hrs_w4$ybirth %in% miss_values_vector & !(HRS_hrs_w4$yintw_hrs_w4 %in% miss_values_vector | HRS_hrs_w4$yintw_hrs_w3 %in% miss_values_vector))]+HRS_hrs_w4$yintw_hrs_w3[which(HRS_ds_hrs_w4$h_cpd == 1 & HRS_hrs_w4$h_cpd==0 & !HRS_hrs_w4$ybirth %in% miss_values_vector & !(HRS_hrs_w4$yintw_hrs_w4 %in% miss_values_vector | HRS_hrs_w4$yintw_hrs_w3 %in% miss_values_vector))])/2-HRS_hrs_w4$ybirth[which(HRS_ds_hrs_w4$h_cpd == 1 & HRS_hrs_w4$h_cpd==0 & !HRS_hrs_w4$ybirth %in% miss_values_vector & !(HRS_hrs_w4$yintw_hrs_w4 %in% miss_values_vector | HRS_hrs_w4$yintw_hrs_w3 %in% miss_values_vector))])
HRS_ds_hrs_w4$h_cpd_age[which(HRS_ds_hrs_w4$h_cpd == 1 & !HRS_hrs_w4$h_cpd_age %in% miss_values_vector)] <- HRS_hrs_w4$h_cpd_age[which(HRS_ds_hrs_w4$h_cpd == 1 & !HRS_hrs_w4$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_hrs[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_hrs_w4,log_vec=(HRS_ds_prov$id %in% HRS_ds_hrs_w4$id),col_end_index = 2, col_st_index = 3)
HRS_ds_hrs$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_hrs$h_cpd_age[which((HRS_ds_hrs$id %in% HRS_ds_hrs_w4$id) & (HRS_ds_hrs$h_cpd != 999))] <- HRS_ds_hrs_w4$h_cpd_age[which(HRS_ds_hrs_w4$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript hrs_w4, echo=F}

vbl <- HRS_ds_hrs_w4$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_hrs_w4, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_hrs_w4$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_hrs_w4 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation hrs_w4, echo=F, results='asis'}

AfterH <- table(HRS_ds_hrs_w4$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_hrs_w4$R4LUNGE)) & HRS_hrs_w4$R4LUNGE == 0) & (HRS_hrs_w4$h_cpd != 1)),
  sum(((!is.na(HRS_hrs_w4$R4LUNGE)) & HRS_hrs_w4$R4LUNGE == 1) | ((!is.na(HRS_hrs_w4$h_cpd)) & (!is.na(HRS_hrs_w4$R4LUNGE)) & HRS_hrs_w4$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_hrs_w4$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_hrs_w4)

```



### Wave 5

#### Study-specific variable description

| **Name** | `R5LUNGE` |`ybirth`|`yintw (hrs_w5)`|`yintw (hrs_w4)`|
|-|-|-|-|-|
| **Label** | `R5LUNGE:W5 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-HRS-w5`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`| `999 = Missing` |  |  |
| **Description** |  |  |  |  |

```{r assign hrs_w5, echo=F}

opal.assign.table.tibble(o, 'HRS_hrs_w5','HRS.HRS-HRS-w5',variables=list('R5LUNGE'), missings = T)
HRS_hrs_w5 <- opal.execute(o,'HRS_hrs_w5')
load(paste0(datafolder,"hrs_w5/ybirth.RData"))
HRS_hrs_w5 <- left_join(HRS_hrs_w5,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"hrs_w4/yintw.RData"))
HRS_hrs_w5 <- left_join(HRS_hrs_w5,yintw, by="id")
names(HRS_hrs_w5)[4] <- "yintw_hrs_w4"
rm(yintw)
load(paste0(datafolder,"hrs_w5/yintw.RData"))
HRS_hrs_w5 <- left_join(HRS_hrs_w5,yintw, by="id")
names(HRS_hrs_w5)[5] <- "yintw_hrs_w5"
rm(yintw)

```

```{r local hrs_w5, echo=F}

vbl <- HRS_hrs_w5$R5LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_hrs_w5)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_hrs_w5, aes(x=factor(R5LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w5$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w5)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_hrs_w5 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w5$yintw_hrs_w4
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w5)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w5, aes(x=factor(yintw_hrs_w4))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w5$yintw_hrs_w5
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w5)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w5, aes(x=factor(yintw_hrs_w5))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R1LUNGE == 0 and R2LUNGE == 0 and R3LUNGE == 0 and R4LUNGE == 0 and R5LUNGE == 0 into 0`
* `R1LUNGE == 1 or R2LUNGE == 1 or R3LUNGE == 1 or R4LUNGE == 1 or R5LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w5 and 0 in w4, h_cpd_age = (year of interview w5-year of interview w4)/2+(year of interview w4 -ybirth)`
* `if h_cpd == 1 in w5 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo hrs_w5}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_hrs_w5 <- left_join(HRS_hrs_w5, HRS_ds_hrs, by = "id")

# Categorical variable harmonization
HRS_ds_hrs_w5 <- tibble(id=HRS_hrs_w5$id)
HRS_ds_hrs_w5$h_cpd <- rep(999,length(HRS_hrs_w5$id))
HRS_ds_hrs_w5$h_cpd[which(((!is.na(HRS_hrs_w5$R5LUNGE)) & HRS_hrs_w5$R5LUNGE == 0) & (HRS_hrs_w5$h_cpd != 1))] <- 0
HRS_ds_hrs_w5$h_cpd[which(((!is.na(HRS_hrs_w5$R5LUNGE)) & HRS_hrs_w5$R5LUNGE == 1) | ((!is.na(HRS_hrs_w5$h_cpd)) & (!is.na(HRS_hrs_w5$R5LUNGE)) & HRS_hrs_w5$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_hrs_w5$h_cpd_age <- rep(999,length(HRS_hrs_w5$id))
HRS_ds_hrs_w5$h_cpd_age[which(HRS_ds_hrs_w5$h_cpd == 0)] <- 996
HRS_ds_hrs_w5$h_cpd_age[which(HRS_ds_hrs_w5$h_cpd == 1 & HRS_hrs_w5$h_cpd==0 & !HRS_hrs_w5$ybirth %in% miss_values_vector & !(HRS_hrs_w5$yintw_hrs_w5 %in% miss_values_vector | HRS_hrs_w5$yintw_hrs_w4 %in% miss_values_vector))] <- floor((HRS_hrs_w5$yintw_hrs_w5[which(HRS_ds_hrs_w5$h_cpd == 1 & HRS_hrs_w5$h_cpd==0 & !HRS_hrs_w5$ybirth %in% miss_values_vector & !(HRS_hrs_w5$yintw_hrs_w5 %in% miss_values_vector | HRS_hrs_w5$yintw_hrs_w4 %in% miss_values_vector))]+HRS_hrs_w5$yintw_hrs_w4[which(HRS_ds_hrs_w5$h_cpd == 1 & HRS_hrs_w5$h_cpd==0 & !HRS_hrs_w5$ybirth %in% miss_values_vector & !(HRS_hrs_w5$yintw_hrs_w5 %in% miss_values_vector | HRS_hrs_w5$yintw_hrs_w4 %in% miss_values_vector))])/2-HRS_hrs_w5$ybirth[which(HRS_ds_hrs_w5$h_cpd == 1 & HRS_hrs_w5$h_cpd==0 & !HRS_hrs_w5$ybirth %in% miss_values_vector & !(HRS_hrs_w5$yintw_hrs_w5 %in% miss_values_vector | HRS_hrs_w5$yintw_hrs_w4 %in% miss_values_vector))])
HRS_ds_hrs_w5$h_cpd_age[which(HRS_ds_hrs_w5$h_cpd == 1 & !HRS_hrs_w5$h_cpd_age %in% miss_values_vector)] <- HRS_hrs_w5$h_cpd_age[which(HRS_ds_hrs_w5$h_cpd == 1 & !HRS_hrs_w5$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_hrs[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_hrs_w5,log_vec=(HRS_ds_prov$id %in% HRS_ds_hrs_w5$id),col_end_index = 2, col_st_index = 3)
HRS_ds_hrs$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_hrs$h_cpd_age[which((HRS_ds_hrs$id %in% HRS_ds_hrs_w5$id) & (HRS_ds_hrs$h_cpd != 999))] <- HRS_ds_hrs_w5$h_cpd_age[which(HRS_ds_hrs_w5$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript hrs_w5, echo=F}

vbl <- HRS_ds_hrs_w5$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_hrs_w5, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_hrs_w5$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_hrs_w5 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation hrs_w5, echo=F, results='asis'}

AfterH <- table(HRS_ds_hrs_w5$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_hrs_w5$R5LUNGE)) & HRS_hrs_w5$R5LUNGE == 0) & (HRS_hrs_w5$h_cpd != 1)),
  sum(((!is.na(HRS_hrs_w5$R5LUNGE)) & HRS_hrs_w5$R5LUNGE == 1) | ((!is.na(HRS_hrs_w5$h_cpd)) & (!is.na(HRS_hrs_w5$R5LUNGE)) & HRS_hrs_w5$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_hrs_w5$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_hrs_w5)

```



### Wave 6

#### Study-specific variable description

| **Name** | `R6LUNGE` |`ybirth`|`yintw (hrs_w6)`|`yintw (hrs_w5)`|
|-|-|-|-|-|
| **Label** | `R6LUNGE:W6 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-HRS-w6`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`| `999 = Missing` |  |  |
| **Description** |  |  |  |  |

```{r assign hrs_w6, echo=F}

opal.assign.table.tibble(o, 'HRS_hrs_w6','HRS.HRS-HRS-w6',variables=list('R6LUNGE'), missings = T)
HRS_hrs_w6 <- opal.execute(o,'HRS_hrs_w6')
load(paste0(datafolder,"hrs_w6/ybirth.RData"))
HRS_hrs_w6 <- left_join(HRS_hrs_w6,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"hrs_w5/yintw.RData"))
HRS_hrs_w6 <- left_join(HRS_hrs_w6,yintw, by="id")
names(HRS_hrs_w6)[4] <- "yintw_hrs_w5"
rm(yintw)
load(paste0(datafolder,"hrs_w6/yintw.RData"))
HRS_hrs_w6 <- left_join(HRS_hrs_w6,yintw, by="id")
names(HRS_hrs_w6)[5] <- "yintw_hrs_w6"
rm(yintw)

```

```{r local hrs_w6, echo=F}

vbl <- HRS_hrs_w6$R6LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_hrs_w6)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_hrs_w6, aes(x=factor(R6LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w6$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w6)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_hrs_w6 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w6$yintw_hrs_w5
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w6)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w6, aes(x=factor(yintw_hrs_w5))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w6$yintw_hrs_w6
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w6)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w6, aes(x=factor(yintw_hrs_w6))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R1LUNGE == 0 and R2LUNGE == 0 and R3LUNGE == 0 and R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 into 0`
* `R1LUNGE == 1 or R2LUNGE == 1 or R3LUNGE == 1 or R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w6 and 0 in w5, h_cpd_age = (year of interview w6-year of interview w5)/2+(year of interview w5 -ybirth)`
* `if h_cpd == 1 in w6 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo hrs_w6}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_hrs_w6 <- left_join(HRS_hrs_w6, HRS_ds_hrs, by = "id")

# Categorical variable harmonization
HRS_ds_hrs_w6 <- tibble(id=HRS_hrs_w6$id)
HRS_ds_hrs_w6$h_cpd <- rep(999,length(HRS_hrs_w6$id))
HRS_ds_hrs_w6$h_cpd[which(((!is.na(HRS_hrs_w6$R6LUNGE)) & HRS_hrs_w6$R6LUNGE == 0) & (HRS_hrs_w6$h_cpd != 1))] <- 0
HRS_ds_hrs_w6$h_cpd[which(((!is.na(HRS_hrs_w6$R6LUNGE)) & HRS_hrs_w6$R6LUNGE == 1) | ((!is.na(HRS_hrs_w6$h_cpd)) & (!is.na(HRS_hrs_w6$R6LUNGE)) & HRS_hrs_w6$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_hrs_w6$h_cpd_age <- rep(999,length(HRS_hrs_w6$id))
HRS_ds_hrs_w6$h_cpd_age[which(HRS_ds_hrs_w6$h_cpd == 0)] <- 996
HRS_ds_hrs_w6$h_cpd_age[which(HRS_ds_hrs_w6$h_cpd == 1 & HRS_hrs_w6$h_cpd==0 & !HRS_hrs_w6$ybirth %in% miss_values_vector & !(HRS_hrs_w6$yintw_hrs_w6 %in% miss_values_vector | HRS_hrs_w6$yintw_hrs_w5 %in% miss_values_vector))] <- floor((HRS_hrs_w6$yintw_hrs_w6[which(HRS_ds_hrs_w6$h_cpd == 1 & HRS_hrs_w6$h_cpd==0 & !HRS_hrs_w6$ybirth %in% miss_values_vector & !(HRS_hrs_w6$yintw_hrs_w6 %in% miss_values_vector | HRS_hrs_w6$yintw_hrs_w5 %in% miss_values_vector))]+HRS_hrs_w6$yintw_hrs_w5[which(HRS_ds_hrs_w6$h_cpd == 1 & HRS_hrs_w6$h_cpd==0 & !HRS_hrs_w6$ybirth %in% miss_values_vector & !(HRS_hrs_w6$yintw_hrs_w6 %in% miss_values_vector | HRS_hrs_w6$yintw_hrs_w5 %in% miss_values_vector))])/2-HRS_hrs_w6$ybirth[which(HRS_ds_hrs_w6$h_cpd == 1 & HRS_hrs_w6$h_cpd==0 & !HRS_hrs_w6$ybirth %in% miss_values_vector & !(HRS_hrs_w6$yintw_hrs_w6 %in% miss_values_vector | HRS_hrs_w6$yintw_hrs_w5 %in% miss_values_vector))])
HRS_ds_hrs_w6$h_cpd_age[which(HRS_ds_hrs_w6$h_cpd == 1 & !HRS_hrs_w6$h_cpd_age %in% miss_values_vector)] <- HRS_hrs_w6$h_cpd_age[which(HRS_ds_hrs_w6$h_cpd == 1 & !HRS_hrs_w6$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_hrs[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_hrs_w6,log_vec=(HRS_ds_prov$id %in% HRS_ds_hrs_w6$id),col_end_index = 2, col_st_index = 3)
HRS_ds_hrs$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_hrs$h_cpd_age[which((HRS_ds_hrs$id %in% HRS_ds_hrs_w6$id) & (HRS_ds_hrs$h_cpd != 999))] <- HRS_ds_hrs_w6$h_cpd_age[which(HRS_ds_hrs_w6$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript hrs_w6, echo=F}

vbl <- HRS_ds_hrs_w6$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_hrs_w6, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_hrs_w6$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_hrs_w6 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation hrs_w6, echo=F, results='asis'}

AfterH <- table(HRS_ds_hrs_w6$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_hrs_w6$R6LUNGE)) & HRS_hrs_w6$R6LUNGE == 0) & (HRS_hrs_w6$h_cpd != 1)),
  sum(((!is.na(HRS_hrs_w6$R6LUNGE)) & HRS_hrs_w6$R6LUNGE == 1) | ((!is.na(HRS_hrs_w6$h_cpd)) & (!is.na(HRS_hrs_w6$R6LUNGE)) & HRS_hrs_w6$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_hrs_w6$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_hrs_w6)

```




### Wave 7

#### Study-specific variable description

| **Name** | `R7LUNGE` |`ybirth`|`yintw (hrs_w7)`|`yintw (hrs_w6)`|
|-|-|-|-|-|
| **Label** | `R7LUNGE:W7 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-HRS-w7`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`| `999 = Missing` |  |  |
| **Description** |  |  |  |  |

```{r assign hrs_w7, echo=F}

opal.assign.table.tibble(o, 'HRS_hrs_w7','HRS.HRS-HRS-w7',variables=list('R7LUNGE'), missings = T)
HRS_hrs_w7 <- opal.execute(o,'HRS_hrs_w7')
load(paste0(datafolder,"hrs_w7/ybirth.RData"))
HRS_hrs_w7 <- left_join(HRS_hrs_w7,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"hrs_w6/yintw.RData"))
HRS_hrs_w7 <- left_join(HRS_hrs_w7,yintw, by="id")
names(HRS_hrs_w7)[4] <- "yintw_hrs_w6"
rm(yintw)
load(paste0(datafolder,"hrs_w7/yintw.RData"))
HRS_hrs_w7 <- left_join(HRS_hrs_w7,yintw, by="id")
names(HRS_hrs_w7)[5] <- "yintw_hrs_w7"
rm(yintw)

```

```{r local hrs_w7, echo=F}

vbl <- HRS_hrs_w7$R7LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_hrs_w7)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_hrs_w7, aes(x=factor(R7LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w7$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w7)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_hrs_w7 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w7$yintw_hrs_w6
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w7)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w7, aes(x=factor(yintw_hrs_w6))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w7$yintw_hrs_w7
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w7)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w7, aes(x=factor(yintw_hrs_w7))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R1LUNGE == 0 and R2LUNGE == 0 and R3LUNGE == 0 and R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 into 0`
* `R1LUNGE == 1 or R2LUNGE == 1 or R3LUNGE == 1 or R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w7 and 0 in w6, h_cpd_age = (year of interview w7-year of interview w6)/2+(year of interview w6 -ybirth)`
* `if h_cpd == 1 in w7 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo hrs_w7}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_hrs_w7 <- left_join(HRS_hrs_w7, HRS_ds_hrs, by = "id")

# Categorical variable harmonization
HRS_ds_hrs_w7 <- tibble(id=HRS_hrs_w7$id)
HRS_ds_hrs_w7$h_cpd <- rep(999,length(HRS_hrs_w7$id))
HRS_ds_hrs_w7$h_cpd[which(((!is.na(HRS_hrs_w7$R7LUNGE)) & HRS_hrs_w7$R7LUNGE == 0) & (HRS_hrs_w7$h_cpd != 1))] <- 0
HRS_ds_hrs_w7$h_cpd[which(((!is.na(HRS_hrs_w7$R7LUNGE)) & HRS_hrs_w7$R7LUNGE == 1) | ((!is.na(HRS_hrs_w7$h_cpd)) & (!is.na(HRS_hrs_w7$R7LUNGE)) & HRS_hrs_w7$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_hrs_w7$h_cpd_age <- rep(999,length(HRS_hrs_w7$id))
HRS_ds_hrs_w7$h_cpd_age[which(HRS_ds_hrs_w7$h_cpd == 0)] <- 996
HRS_ds_hrs_w7$h_cpd_age[which(HRS_ds_hrs_w7$h_cpd == 1 & HRS_hrs_w7$h_cpd==0 & !HRS_hrs_w7$ybirth %in% miss_values_vector & !(HRS_hrs_w7$yintw_hrs_w7 %in% miss_values_vector | HRS_hrs_w7$yintw_hrs_w6 %in% miss_values_vector))] <- floor((HRS_hrs_w7$yintw_hrs_w7[which(HRS_ds_hrs_w7$h_cpd == 1 & HRS_hrs_w7$h_cpd==0 & !HRS_hrs_w7$ybirth %in% miss_values_vector & !(HRS_hrs_w7$yintw_hrs_w7 %in% miss_values_vector | HRS_hrs_w7$yintw_hrs_w6 %in% miss_values_vector))]+HRS_hrs_w7$yintw_hrs_w6[which(HRS_ds_hrs_w7$h_cpd == 1 & HRS_hrs_w7$h_cpd==0 & !HRS_hrs_w7$ybirth %in% miss_values_vector & !(HRS_hrs_w7$yintw_hrs_w7 %in% miss_values_vector | HRS_hrs_w7$yintw_hrs_w6 %in% miss_values_vector))])/2-HRS_hrs_w7$ybirth[which(HRS_ds_hrs_w7$h_cpd == 1 & HRS_hrs_w7$h_cpd==0 & !HRS_hrs_w7$ybirth %in% miss_values_vector & !(HRS_hrs_w7$yintw_hrs_w7 %in% miss_values_vector | HRS_hrs_w7$yintw_hrs_w6 %in% miss_values_vector))])
HRS_ds_hrs_w7$h_cpd_age[which(HRS_ds_hrs_w7$h_cpd == 1 & !HRS_hrs_w7$h_cpd_age %in% miss_values_vector)] <- HRS_hrs_w7$h_cpd_age[which(HRS_ds_hrs_w7$h_cpd == 1 & !HRS_hrs_w7$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_hrs[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_hrs_w7,log_vec=(HRS_ds_prov$id %in% HRS_ds_hrs_w7$id),col_end_index = 2, col_st_index = 3)
HRS_ds_hrs$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_hrs$h_cpd_age[which((HRS_ds_hrs$id %in% HRS_ds_hrs_w7$id) & (HRS_ds_hrs$h_cpd != 999))] <- HRS_ds_hrs_w7$h_cpd_age[which(HRS_ds_hrs_w7$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript hrs_w7, echo=F}

vbl <- HRS_ds_hrs_w7$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_hrs_w7, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_hrs_w7$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_hrs_w7 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation hrs_w7, echo=F, results='asis'}

AfterH <- table(HRS_ds_hrs_w7$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_hrs_w7$R7LUNGE)) & HRS_hrs_w7$R7LUNGE == 0) & (HRS_hrs_w7$h_cpd != 1)),
  sum(((!is.na(HRS_hrs_w7$R7LUNGE)) & HRS_hrs_w7$R7LUNGE == 1) | ((!is.na(HRS_hrs_w7$h_cpd)) & (!is.na(HRS_hrs_w7$R7LUNGE)) & HRS_hrs_w7$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_hrs_w7$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_hrs_w7)

```



### Wave 8

#### Study-specific variable description

| **Name** | `R8LUNGE` |`ybirth`|`yintw (hrs_w8)`|`yintw (hrs_w7)`|
|-|-|-|-|-|
| **Label** | `R8LUNGE:W8 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-HRS-w8`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`| `999 = Missing` |  |  |
| **Description** |  |  |  |  |

```{r assign hrs_w8, echo=F}

opal.assign.table.tibble(o, 'HRS_hrs_w8','HRS.HRS-HRS-w8',variables=list('R8LUNGE'), missings = T)
HRS_hrs_w8 <- opal.execute(o,'HRS_hrs_w8')
load(paste0(datafolder,"hrs_w8/ybirth.RData"))
HRS_hrs_w8 <- left_join(HRS_hrs_w8,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"hrs_w7/yintw.RData"))
HRS_hrs_w8 <- left_join(HRS_hrs_w8,yintw, by="id")
names(HRS_hrs_w8)[4] <- "yintw_hrs_w7"
rm(yintw)
load(paste0(datafolder,"hrs_w8/yintw.RData"))
HRS_hrs_w8 <- left_join(HRS_hrs_w8,yintw, by="id")
names(HRS_hrs_w8)[5] <- "yintw_hrs_w8"
rm(yintw)

```

```{r local hrs_w8, echo=F}

vbl <- HRS_hrs_w8$R8LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_hrs_w8)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_hrs_w8, aes(x=factor(R8LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w8$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w8)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_hrs_w8 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w8$yintw_hrs_w7
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w8)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w8, aes(x=factor(yintw_hrs_w7))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w8$yintw_hrs_w8
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w8)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w8, aes(x=factor(yintw_hrs_w8))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R1LUNGE == 0 and R2LUNGE == 0 and R3LUNGE == 0 and R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 and R8LUNGE == 0 into 0`
* `R1LUNGE == 1 or R2LUNGE == 1 or R3LUNGE == 1 or R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 or R8LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w8 and 0 in w7, h_cpd_age = (year of interview w8-year of interview w7)/2+(year of interview w7 -ybirth)`
* `if h_cpd == 1 in w8 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo hrs_w8}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_hrs_w8 <- left_join(HRS_hrs_w8, HRS_ds_hrs, by = "id")

# Categorical variable harmonization
HRS_ds_hrs_w8 <- tibble(id=HRS_hrs_w8$id)
HRS_ds_hrs_w8$h_cpd <- rep(999,length(HRS_hrs_w8$id))
HRS_ds_hrs_w8$h_cpd[which(((!is.na(HRS_hrs_w8$R8LUNGE)) & HRS_hrs_w8$R8LUNGE == 0) & (HRS_hrs_w8$h_cpd != 1))] <- 0
HRS_ds_hrs_w8$h_cpd[which(((!is.na(HRS_hrs_w8$R8LUNGE)) & HRS_hrs_w8$R8LUNGE == 1) | ((!is.na(HRS_hrs_w8$h_cpd)) & (!is.na(HRS_hrs_w8$R8LUNGE)) & HRS_hrs_w8$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_hrs_w8$h_cpd_age <- rep(999,length(HRS_hrs_w8$id))
HRS_ds_hrs_w8$h_cpd_age[which(HRS_ds_hrs_w8$h_cpd == 0)] <- 996
HRS_ds_hrs_w8$h_cpd_age[which(HRS_ds_hrs_w8$h_cpd == 1 & HRS_hrs_w8$h_cpd==0 & !HRS_hrs_w8$ybirth %in% miss_values_vector & !(HRS_hrs_w8$yintw_hrs_w8 %in% miss_values_vector | HRS_hrs_w8$yintw_hrs_w7 %in% miss_values_vector))] <- floor((HRS_hrs_w8$yintw_hrs_w8[which(HRS_ds_hrs_w8$h_cpd == 1 & HRS_hrs_w8$h_cpd==0 & !HRS_hrs_w8$ybirth %in% miss_values_vector & !(HRS_hrs_w8$yintw_hrs_w8 %in% miss_values_vector | HRS_hrs_w8$yintw_hrs_w7 %in% miss_values_vector))]+HRS_hrs_w8$yintw_hrs_w7[which(HRS_ds_hrs_w8$h_cpd == 1 & HRS_hrs_w8$h_cpd==0 & !HRS_hrs_w8$ybirth %in% miss_values_vector & !(HRS_hrs_w8$yintw_hrs_w8 %in% miss_values_vector | HRS_hrs_w8$yintw_hrs_w7 %in% miss_values_vector))])/2-HRS_hrs_w8$ybirth[which(HRS_ds_hrs_w8$h_cpd == 1 & HRS_hrs_w8$h_cpd==0 & !HRS_hrs_w8$ybirth %in% miss_values_vector & !(HRS_hrs_w8$yintw_hrs_w8 %in% miss_values_vector | HRS_hrs_w8$yintw_hrs_w7 %in% miss_values_vector))])
HRS_ds_hrs_w8$h_cpd_age[which(HRS_ds_hrs_w8$h_cpd == 1 & !HRS_hrs_w8$h_cpd_age %in% miss_values_vector)] <- HRS_hrs_w8$h_cpd_age[which(HRS_ds_hrs_w8$h_cpd == 1 & !HRS_hrs_w8$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_hrs[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_hrs_w8,log_vec=(HRS_ds_prov$id %in% HRS_ds_hrs_w8$id),col_end_index = 2, col_st_index = 3)
HRS_ds_hrs$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_hrs$h_cpd_age[which((HRS_ds_hrs$id %in% HRS_ds_hrs_w8$id) & (HRS_ds_hrs$h_cpd != 999))] <- HRS_ds_hrs_w8$h_cpd_age[which(HRS_ds_hrs_w8$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript hrs_w8, echo=F}

vbl <- HRS_ds_hrs_w8$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_hrs_w8, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_hrs_w8$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_hrs_w8 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation hrs_w8, echo=F, results='asis'}

AfterH <- table(HRS_ds_hrs_w8$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_hrs_w8$R8LUNGE)) & HRS_hrs_w8$R8LUNGE == 0) & (HRS_hrs_w8$h_cpd != 1)),
  sum(((!is.na(HRS_hrs_w8$R8LUNGE)) & HRS_hrs_w8$R8LUNGE == 1) | ((!is.na(HRS_hrs_w8$h_cpd)) & (!is.na(HRS_hrs_w8$R8LUNGE)) & HRS_hrs_w8$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_hrs_w8$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_hrs_w8)

```



### Wave 9

#### Study-specific variable description

| **Name** | `R9LUNGE` |`ybirth`|`yintw (hrs_w9)`|`yintw (hrs_w8)`|
|-|-|-|-|-|
| **Label** | `R9LUNGE:W9 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-HRS-w9`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`| `999 = Missing` |  |  |
| **Description** |  |  |  |  |

```{r assign hrs_w9, echo=F}

opal.assign.table.tibble(o, 'HRS_hrs_w9','HRS.HRS-HRS-w9',variables=list('R9LUNGE'), missings = T)
HRS_hrs_w9 <- opal.execute(o,'HRS_hrs_w9')
load(paste0(datafolder,"hrs_w9/ybirth.RData"))
HRS_hrs_w9 <- left_join(HRS_hrs_w9,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"hrs_w8/yintw.RData"))
HRS_hrs_w9 <- left_join(HRS_hrs_w9,yintw, by="id")
names(HRS_hrs_w9)[4] <- "yintw_hrs_w8"
rm(yintw)
load(paste0(datafolder,"hrs_w9/yintw.RData"))
HRS_hrs_w9 <- left_join(HRS_hrs_w9,yintw, by="id")
names(HRS_hrs_w9)[5] <- "yintw_hrs_w9"
rm(yintw)

```

```{r local hrs_w9, echo=F}

vbl <- HRS_hrs_w9$R9LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_hrs_w9)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_hrs_w9, aes(x=factor(R9LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w9$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w9)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_hrs_w9 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w9$yintw_hrs_w8
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w9)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w9, aes(x=factor(yintw_hrs_w8))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w9$yintw_hrs_w9
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w9)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w9, aes(x=factor(yintw_hrs_w9))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R1LUNGE == 0 and R2LUNGE == 0 and R3LUNGE == 0 and R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 and R8LUNGE == 0 and R9LUNGE == 0 into 0`
* `R1LUNGE == 1 or R2LUNGE == 1 or R3LUNGE == 1 or R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 or R8LUNGE == 1 or R9LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w9 and 0 in w8, h_cpd_age = (year of interview w9-year of interview w8)/2+(year of interview w8 -ybirth)`
* `if h_cpd == 1 in w9 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo hrs_w9}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_hrs_w9 <- left_join(HRS_hrs_w9, HRS_ds_hrs, by = "id")

# Categorical variable harmonization
HRS_ds_hrs_w9 <- tibble(id=HRS_hrs_w9$id)
HRS_ds_hrs_w9$h_cpd <- rep(999,length(HRS_hrs_w9$id))
HRS_ds_hrs_w9$h_cpd[which(((!is.na(HRS_hrs_w9$R9LUNGE)) & HRS_hrs_w9$R9LUNGE == 0) & (HRS_hrs_w9$h_cpd != 1))] <- 0
HRS_ds_hrs_w9$h_cpd[which(((!is.na(HRS_hrs_w9$R9LUNGE)) & HRS_hrs_w9$R9LUNGE == 1) | ((!is.na(HRS_hrs_w9$h_cpd)) & (!is.na(HRS_hrs_w9$R9LUNGE)) & HRS_hrs_w9$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_hrs_w9$h_cpd_age <- rep(999,length(HRS_hrs_w9$id))
HRS_ds_hrs_w9$h_cpd_age[which(HRS_ds_hrs_w9$h_cpd == 0)] <- 996
HRS_ds_hrs_w9$h_cpd_age[which(HRS_ds_hrs_w9$h_cpd == 1 & HRS_hrs_w9$h_cpd==0 & !HRS_hrs_w9$ybirth %in% miss_values_vector & !(HRS_hrs_w9$yintw_hrs_w9 %in% miss_values_vector | HRS_hrs_w9$yintw_hrs_w8 %in% miss_values_vector))] <- floor((HRS_hrs_w9$yintw_hrs_w9[which(HRS_ds_hrs_w9$h_cpd == 1 & HRS_hrs_w9$h_cpd==0 & !HRS_hrs_w9$ybirth %in% miss_values_vector & !(HRS_hrs_w9$yintw_hrs_w9 %in% miss_values_vector | HRS_hrs_w9$yintw_hrs_w8 %in% miss_values_vector))]+HRS_hrs_w9$yintw_hrs_w8[which(HRS_ds_hrs_w9$h_cpd == 1 & HRS_hrs_w9$h_cpd==0 & !HRS_hrs_w9$ybirth %in% miss_values_vector & !(HRS_hrs_w9$yintw_hrs_w9 %in% miss_values_vector | HRS_hrs_w9$yintw_hrs_w8 %in% miss_values_vector))])/2-HRS_hrs_w9$ybirth[which(HRS_ds_hrs_w9$h_cpd == 1 & HRS_hrs_w9$h_cpd==0 & !HRS_hrs_w9$ybirth %in% miss_values_vector & !(HRS_hrs_w9$yintw_hrs_w9 %in% miss_values_vector | HRS_hrs_w9$yintw_hrs_w8 %in% miss_values_vector))])
HRS_ds_hrs_w9$h_cpd_age[which(HRS_ds_hrs_w9$h_cpd == 1 & !HRS_hrs_w9$h_cpd_age %in% miss_values_vector)] <- HRS_hrs_w9$h_cpd_age[which(HRS_ds_hrs_w9$h_cpd == 1 & !HRS_hrs_w9$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_hrs[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_hrs_w9,log_vec=(HRS_ds_prov$id %in% HRS_ds_hrs_w9$id),col_end_index = 2, col_st_index = 3)
HRS_ds_hrs$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_hrs$h_cpd_age[which((HRS_ds_hrs$id %in% HRS_ds_hrs_w9$id) & (HRS_ds_hrs$h_cpd != 999))] <- HRS_ds_hrs_w9$h_cpd_age[which(HRS_ds_hrs_w9$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript hrs_w9, echo=F}

vbl <- HRS_ds_hrs_w9$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_hrs_w9, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_hrs_w9$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_hrs_w9 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation hrs_w9, echo=F, results='asis'}

AfterH <- table(HRS_ds_hrs_w9$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_hrs_w9$R9LUNGE)) & HRS_hrs_w9$R9LUNGE == 0) & (HRS_hrs_w9$h_cpd != 1)),
  sum(((!is.na(HRS_hrs_w9$R9LUNGE)) & HRS_hrs_w9$R9LUNGE == 1) | ((!is.na(HRS_hrs_w9$h_cpd)) & (!is.na(HRS_hrs_w9$R9LUNGE)) & HRS_hrs_w9$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_hrs_w9$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_hrs_w9)

```




### Wave 10

#### Study-specific variable description

| **Name** | `R10LUNGE` |`ybirth`|`yintw (hrs_w10)`|`yintw (hrs_w9)`|
|-|-|-|-|-|
| **Label** | `R10LUNGE:W10 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-HRS-w10`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`| `999 = Missing` |  |  |
| **Description** |  |  |  |  |

```{r assign hrs_w10, echo=F}

opal.assign.table.tibble(o, 'HRS_hrs_w10','HRS.HRS-HRS-w10',variables=list('R10LUNGE'), missings = T)
HRS_hrs_w10 <- opal.execute(o,'HRS_hrs_w10')
load(paste0(datafolder,"hrs_w10/ybirth.RData"))
HRS_hrs_w10 <- left_join(HRS_hrs_w10,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"hrs_w9/yintw.RData"))
HRS_hrs_w10 <- left_join(HRS_hrs_w10,yintw, by="id")
names(HRS_hrs_w10)[4] <- "yintw_hrs_w9"
rm(yintw)
load(paste0(datafolder,"hrs_w10/yintw.RData"))
HRS_hrs_w10 <- left_join(HRS_hrs_w10,yintw, by="id")
names(HRS_hrs_w10)[5] <- "yintw_hrs_w10"
rm(yintw)

```

```{r local hrs_w10, echo=F}

vbl <- HRS_hrs_w10$R10LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_hrs_w10)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_hrs_w10, aes(x=factor(R10LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w10$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w10)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_hrs_w10 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w10$yintw_hrs_w9
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w10)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w10, aes(x=factor(yintw_hrs_w9))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w10$yintw_hrs_w10
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w10)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w10, aes(x=factor(yintw_hrs_w10))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R1LUNGE == 0 and R2LUNGE == 0 and R3LUNGE == 0 and R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 and R8LUNGE == 0 and R9LUNGE == 0 and R10LUNGE == 0 into 0`
* `R1LUNGE == 1 or R2LUNGE == 1 or R3LUNGE == 1 or R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 or R8LUNGE == 1 or R9LUNGE == 1 or R10LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w10 and 0 in w9, h_cpd_age = (year of interview w10-year of interview w9)/2+(year of interview w9 -ybirth)`
* `if h_cpd == 1 in w10 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo hrs_w10}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_hrs_w10 <- left_join(HRS_hrs_w10, HRS_ds_hrs, by = "id")

# Categorical variable harmonization
HRS_ds_hrs_w10 <- tibble(id=HRS_hrs_w10$id)
HRS_ds_hrs_w10$h_cpd <- rep(999,length(HRS_hrs_w10$id))
HRS_ds_hrs_w10$h_cpd[which(((!is.na(HRS_hrs_w10$R10LUNGE)) & HRS_hrs_w10$R10LUNGE == 0) & (HRS_hrs_w10$h_cpd != 1))] <- 0
HRS_ds_hrs_w10$h_cpd[which(((!is.na(HRS_hrs_w10$R10LUNGE)) & HRS_hrs_w10$R10LUNGE == 1) | ((!is.na(HRS_hrs_w10$h_cpd)) & (!is.na(HRS_hrs_w10$R10LUNGE)) & HRS_hrs_w10$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_hrs_w10$h_cpd_age <- rep(999,length(HRS_hrs_w10$id))
HRS_ds_hrs_w10$h_cpd_age[which(HRS_ds_hrs_w10$h_cpd == 0)] <- 996
HRS_ds_hrs_w10$h_cpd_age[which(HRS_ds_hrs_w10$h_cpd == 1 & HRS_hrs_w10$h_cpd==0 & !HRS_hrs_w10$ybirth %in% miss_values_vector & !(HRS_hrs_w10$yintw_hrs_w10 %in% miss_values_vector | HRS_hrs_w10$yintw_hrs_w9 %in% miss_values_vector))] <- floor((HRS_hrs_w10$yintw_hrs_w10[which(HRS_ds_hrs_w10$h_cpd == 1 & HRS_hrs_w10$h_cpd==0 & !HRS_hrs_w10$ybirth %in% miss_values_vector & !(HRS_hrs_w10$yintw_hrs_w10 %in% miss_values_vector | HRS_hrs_w10$yintw_hrs_w9 %in% miss_values_vector))]+HRS_hrs_w10$yintw_hrs_w9[which(HRS_ds_hrs_w10$h_cpd == 1 & HRS_hrs_w10$h_cpd==0 & !HRS_hrs_w10$ybirth %in% miss_values_vector & !(HRS_hrs_w10$yintw_hrs_w10 %in% miss_values_vector | HRS_hrs_w10$yintw_hrs_w9 %in% miss_values_vector))])/2-HRS_hrs_w10$ybirth[which(HRS_ds_hrs_w10$h_cpd == 1 & HRS_hrs_w10$h_cpd==0 & !HRS_hrs_w10$ybirth %in% miss_values_vector & !(HRS_hrs_w10$yintw_hrs_w10 %in% miss_values_vector | HRS_hrs_w10$yintw_hrs_w9 %in% miss_values_vector))])
HRS_ds_hrs_w10$h_cpd_age[which(HRS_ds_hrs_w10$h_cpd == 1 & !HRS_hrs_w10$h_cpd_age %in% miss_values_vector)] <- HRS_hrs_w10$h_cpd_age[which(HRS_ds_hrs_w10$h_cpd == 1 & !HRS_hrs_w10$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_hrs[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_hrs_w10,log_vec=(HRS_ds_prov$id %in% HRS_ds_hrs_w10$id),col_end_index = 2, col_st_index = 3)
HRS_ds_hrs$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_hrs$h_cpd_age[which((HRS_ds_hrs$id %in% HRS_ds_hrs_w10$id) & (HRS_ds_hrs$h_cpd != 999))] <- HRS_ds_hrs_w10$h_cpd_age[which(HRS_ds_hrs_w10$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript hrs_w10, echo=F}

vbl <- HRS_ds_hrs_w10$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_hrs_w10, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_hrs_w10$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_hrs_w10 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation hrs_w10, echo=F, results='asis'}

AfterH <- table(HRS_ds_hrs_w10$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_hrs_w10$R10LUNGE)) & HRS_hrs_w10$R10LUNGE == 0) & (HRS_hrs_w10$h_cpd != 1)),
  sum(((!is.na(HRS_hrs_w10$R10LUNGE)) & HRS_hrs_w10$R10LUNGE == 1) | ((!is.na(HRS_hrs_w10$h_cpd)) & (!is.na(HRS_hrs_w10$R10LUNGE)) & HRS_hrs_w10$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_hrs_w10$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_hrs_w10)

```



### Wave 11

#### Study-specific variable description

| **Name** | `R11LUNGE` |`ybirth`|`yintw (hrs_w11)`|`yintw (hrs_w10)`|
|-|-|-|-|-|
| **Label** | `R11LUNGE:W11 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-HRS-w11`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`| `999 = Missing` |  |  |
| **Description** |  |  |  |  |

```{r assign hrs_w11, echo=F}

opal.assign.table.tibble(o, 'HRS_hrs_w11','HRS.HRS-HRS-w11',variables=list('R11LUNGE'), missings = T)
HRS_hrs_w11 <- opal.execute(o,'HRS_hrs_w11')
load(paste0(datafolder,"hrs_w11/ybirth.RData"))
HRS_hrs_w11 <- left_join(HRS_hrs_w11,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"hrs_w10/yintw.RData"))
HRS_hrs_w11 <- left_join(HRS_hrs_w11,yintw, by="id")
names(HRS_hrs_w11)[4] <- "yintw_hrs_w10"
rm(yintw)
load(paste0(datafolder,"hrs_w11/yintw.RData"))
HRS_hrs_w11 <- left_join(HRS_hrs_w11,yintw, by="id")
names(HRS_hrs_w11)[5] <- "yintw_hrs_w11"
rm(yintw)

```

```{r local hrs_w11, echo=F}

vbl <- HRS_hrs_w11$R11LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_hrs_w11)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_hrs_w11, aes(x=factor(R11LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w11$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w11)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_hrs_w11 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w11$yintw_hrs_w10
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w11)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w11, aes(x=factor(yintw_hrs_w10))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_hrs_w11$yintw_hrs_w11
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_hrs_w11)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_hrs_w11, aes(x=factor(yintw_hrs_w11))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R1LUNGE == 0 and R2LUNGE == 0 and R3LUNGE == 0 and R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 and R8LUNGE == 0 and R9LUNGE == 0 and R10LUNGE == 0 and R11LUNGE == 0 into 0`
* `R1LUNGE == 1 or R2LUNGE == 1 or R3LUNGE == 1 or R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 or R8LUNGE == 1 or R9LUNGE == 1 or R10LUNGE == 1 or R11LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w11 and 0 in w10, h_cpd_age = (year of interview w11-year of interview w10)/2+(year of interview w10 -ybirth)`
* `if h_cpd == 1 in w11 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo hrs_w11}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_hrs_w11 <- left_join(HRS_hrs_w11, HRS_ds_hrs, by = "id")

# Categorical variable harmonization
HRS_ds_hrs_w11 <- tibble(id=HRS_hrs_w11$id)
HRS_ds_hrs_w11$h_cpd <- rep(999,length(HRS_hrs_w11$id))
HRS_ds_hrs_w11$h_cpd[which(((!is.na(HRS_hrs_w11$R11LUNGE)) & HRS_hrs_w11$R11LUNGE == 0) & (HRS_hrs_w11$h_cpd != 1))] <- 0
HRS_ds_hrs_w11$h_cpd[which(((!is.na(HRS_hrs_w11$R11LUNGE)) & HRS_hrs_w11$R11LUNGE == 1) | ((!is.na(HRS_hrs_w11$h_cpd)) & (!is.na(HRS_hrs_w11$R11LUNGE)) & HRS_hrs_w11$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_hrs_w11$h_cpd_age <- rep(999,length(HRS_hrs_w11$id))
HRS_ds_hrs_w11$h_cpd_age[which(HRS_ds_hrs_w11$h_cpd == 0)] <- 996
HRS_ds_hrs_w11$h_cpd_age[which(HRS_ds_hrs_w11$h_cpd == 1 & HRS_hrs_w11$h_cpd==0 & !HRS_hrs_w11$ybirth %in% miss_values_vector & !(HRS_hrs_w11$yintw_hrs_w11 %in% miss_values_vector | HRS_hrs_w11$yintw_hrs_w10 %in% miss_values_vector))] <- floor((HRS_hrs_w11$yintw_hrs_w11[which(HRS_ds_hrs_w11$h_cpd == 1 & HRS_hrs_w11$h_cpd==0 & !HRS_hrs_w11$ybirth %in% miss_values_vector & !(HRS_hrs_w11$yintw_hrs_w11 %in% miss_values_vector | HRS_hrs_w11$yintw_hrs_w10 %in% miss_values_vector))]+HRS_hrs_w11$yintw_hrs_w10[which(HRS_ds_hrs_w11$h_cpd == 1 & HRS_hrs_w11$h_cpd==0 & !HRS_hrs_w11$ybirth %in% miss_values_vector & !(HRS_hrs_w11$yintw_hrs_w11 %in% miss_values_vector | HRS_hrs_w11$yintw_hrs_w10 %in% miss_values_vector))])/2-HRS_hrs_w11$ybirth[which(HRS_ds_hrs_w11$h_cpd == 1 & HRS_hrs_w11$h_cpd==0 & !HRS_hrs_w11$ybirth %in% miss_values_vector & !(HRS_hrs_w11$yintw_hrs_w11 %in% miss_values_vector | HRS_hrs_w11$yintw_hrs_w10 %in% miss_values_vector))])
HRS_ds_hrs_w11$h_cpd_age[which(HRS_ds_hrs_w11$h_cpd == 1 & !HRS_hrs_w11$h_cpd_age %in% miss_values_vector)] <- HRS_hrs_w11$h_cpd_age[which(HRS_ds_hrs_w11$h_cpd == 1 & !HRS_hrs_w11$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
rm(HRS_ds_hrs)

```


#### Statistics of the new harmonized variable

```{r descript hrs_w11, echo=F}

vbl <- HRS_ds_hrs_w11$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_hrs_w11, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_hrs_w11$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_hrs_w11 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation hrs_w11, echo=F, results='asis'}

AfterH <- table(HRS_ds_hrs_w11$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_hrs_w11$R11LUNGE)) & HRS_hrs_w11$R11LUNGE == 0) & (HRS_hrs_w11$h_cpd != 1)),
  sum(((!is.na(HRS_hrs_w11$R11LUNGE)) & HRS_hrs_w11$R11LUNGE == 1) | ((!is.na(HRS_hrs_w11$h_cpd)) & (!is.na(HRS_hrs_w11$R11LUNGE)) & HRS_hrs_w11$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_hrs_w11$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_hrs_w11)

```



## AHEAD


### Wave 2

#### Study-specific variable description

| **Name** | `R2LUNGE` |
|-|-|
| **Label** | `R2LUNGE:W2 R ever had lung disease`|
| **Table name**  | `HRS-AHEAD-w2`|
| **Categories** | `0 = no`<br/>`1 = yes` |
| **Missings** | `NA` |
| **Description** |  |

```{r assign ahead_w2, echo=F}

opal.assign.table.tibble(o, 'HRS_ahead_w2','HRS.HRS-AHEAD-w2',variables=list('R2LUNGE'), missings = T)
HRS_ahead_w2 <- opal.execute(o,'HRS_ahead_w2')

```

```{r local ahead_w2, echo=F}

vbl <- HRS_ahead_w2$R2LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_ahead_w2)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_ahead_w2, aes(x=factor(R2LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `keep up 1 into 1`
* `keep up 0 into 0`
* `NA into 999`

Age of diagnosis cannot be harmonized.

**R script:**

```{r harmo ahead_w2}

# Categorical variable harmonization
HRS_ds_ahead_w2 <- tibble(id=HRS_ahead_w2$id)
HRS_ds_ahead_w2$h_cpd <- car::recode(HRS_ahead_w2$R2LUNGE, "NA=999")

# We build a global table in order to have updated the status of all the individuals through the different waves
HRS_ds_ahead <- HRS_ds_ahead_w2
HRS_ds_ahead$h_cpd_age <- rep(999,length(HRS_ds_ahead$id))

```


#### Statistics of the new harmonized variable

```{r descript ahead_w2, echo=F}

vbl <- HRS_ds_ahead_w2$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_ahead_w2, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

```


#### Validation

```{r crosstabulation ahead_w2, echo=F}

AfterH <- table(HRS_ds_ahead_w2$h_cpd, useNA = "ifany")
BeforeH <- table(HRS_ahead_w2$R2LUNGE, useNA = "ifany")
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)
rm(HRS_ahead_w2)

```



### Wave 3

#### Study-specific variable description

| **Name** | `R3LUNGE` |`ybirth`|`yintw (ahead_w2)`|`yintw (ahead_w3)`|
|-|-|-|-|-|
| **Label** | `R3LUNGE:W3 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-AHEAD-w3`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign ahead_w3, echo=F}

opal.assign.table.tibble(o, 'HRS_ahead_w3','HRS.HRS-AHEAD-w3',variables=list('R3LUNGE'), missings = T)
HRS_ahead_w3 <- opal.execute(o,'HRS_ahead_w3')
load(paste0(datafolder,"ahead_w3/ybirth.RData"))
HRS_ahead_w3 <- left_join(HRS_ahead_w3,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"ahead_w2/yintw.RData"))
HRS_ahead_w3 <- left_join(HRS_ahead_w3,yintw, by="id")
names(HRS_ahead_w3)[4] <- "yintw_ahead_w2"
rm(yintw)
load(paste0(datafolder,"ahead_w3/yintw.RData"))
HRS_ahead_w3 <- left_join(HRS_ahead_w3,yintw, by="id")
names(HRS_ahead_w3)[5] <- "yintw_ahead_w3"
rm(yintw)

```

```{r local ahead_w3, echo=F}

vbl <- HRS_ahead_w3$R3LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_ahead_w3)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_ahead_w3, aes(x=factor(R3LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w3$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w3)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ahead_w3 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w3$yintw_ahead_w2
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w3)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ahead_w3, aes(x=factor(yintw_ahead_w2))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w3$yintw_ahead_w3
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w3)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ahead_w3, aes(x=factor(yintw_ahead_w3))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R2LUNGE == 0 and R3LUNGE == 0 into 0`
* `R2LUNGE == 1 or R3LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w3 and 0 in w2, h_cpd_age = (year of interview w3-year of interview w2)/2+(year of interview w2 -ybirth)`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo ahead_w3}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_ahead_w3 <- left_join(HRS_ahead_w3, HRS_ds_ahead, by = "id")

# Categorical variable harmonization
HRS_ds_ahead_w3 <- tibble(id=HRS_ahead_w3$id)
HRS_ds_ahead_w3$h_cpd <- rep(999,length(HRS_ahead_w3$id))
HRS_ds_ahead_w3$h_cpd[which(((!is.na(HRS_ahead_w3$R3LUNGE)) & HRS_ahead_w3$R3LUNGE == 0) & (HRS_ahead_w3$h_cpd != 1))] <- 0
HRS_ds_ahead_w3$h_cpd[which(((!is.na(HRS_ahead_w3$R3LUNGE)) & HRS_ahead_w3$R3LUNGE == 1) | ((!is.na(HRS_ahead_w3$h_cpd)) & (!is.na(HRS_ahead_w3$R3LUNGE)) & HRS_ahead_w3$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_ahead_w3$h_cpd_age <- rep(999,length(HRS_ahead_w3$id))
HRS_ds_ahead_w3$h_cpd_age[which(HRS_ds_ahead_w3$h_cpd == 0)] <- 996
HRS_ds_ahead_w3$h_cpd_age[which(HRS_ds_ahead_w3$h_cpd == 1 & HRS_ahead_w3$h_cpd==0 & !HRS_ahead_w3$ybirth %in% miss_values_vector & !(HRS_ahead_w3$yintw_ahead_w3 %in% miss_values_vector | HRS_ahead_w3$yintw_ahead_w2 %in% miss_values_vector))] <- floor((HRS_ahead_w3$yintw_ahead_w3[which(HRS_ds_ahead_w3$h_cpd == 1 & HRS_ahead_w3$h_cpd==0 & !HRS_ahead_w3$ybirth %in% miss_values_vector & !(HRS_ahead_w3$yintw_ahead_w3 %in% miss_values_vector | HRS_ahead_w3$yintw_ahead_w2 %in% miss_values_vector))]+HRS_ahead_w3$yintw_ahead_w2[which(HRS_ds_ahead_w3$h_cpd == 1 & HRS_ahead_w3$h_cpd==0 & !HRS_ahead_w3$ybirth %in% miss_values_vector & !(HRS_ahead_w3$yintw_ahead_w3 %in% miss_values_vector | HRS_ahead_w3$yintw_ahead_w2 %in% miss_values_vector))])/2-HRS_ahead_w3$ybirth[which(HRS_ds_ahead_w3$h_cpd == 1 & HRS_ahead_w3$h_cpd==0 & !HRS_ahead_w3$ybirth %in% miss_values_vector & !(HRS_ahead_w3$yintw_ahead_w3 %in% miss_values_vector | HRS_ahead_w3$yintw_ahead_w2 %in% miss_values_vector))])

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_ahead[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_ahead_w3,log_vec=(HRS_ds_prov$id %in% HRS_ds_ahead_w3$id),col_end_index = 2, col_st_index = 3)
HRS_ds_ahead$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_ahead$h_cpd_age[which((HRS_ds_ahead$id %in% HRS_ds_ahead_w3$id) & (HRS_ds_ahead$h_cpd != 999))] <- HRS_ds_ahead_w3$h_cpd_age[which(HRS_ds_ahead_w3$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript ahead_w3, echo=F}

vbl <- HRS_ds_ahead_w3$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_ahead_w3, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_ahead_w3$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_ahead_w3 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation ahead_w3, echo=F, results='asis'}

AfterH <- table(HRS_ds_ahead_w3$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_ahead_w3$R3LUNGE)) & HRS_ahead_w3$R3LUNGE == 0) & (HRS_ahead_w3$h_cpd != 1)),
  sum(((!is.na(HRS_ahead_w3$R3LUNGE)) & HRS_ahead_w3$R3LUNGE == 1) | ((!is.na(HRS_ahead_w3$h_cpd)) & (!is.na(HRS_ahead_w3$R3LUNGE)) & HRS_ahead_w3$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_ahead_w3$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_ahead_w3)

```




### Wave 4

#### Study-specific variable description

| **Name** | `R4LUNGE` |`ybirth`|`yintw (ahead_w3)`|`yintw (ahead_w4)`|
|-|-|-|-|-|
| **Label** | `R4LUNGE:W4 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-AHEAD-w4`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign ahead_w4, echo=F}

opal.assign.table.tibble(o, 'HRS_ahead_w4','HRS.HRS-AHEAD-w4',variables=list('R4LUNGE'), missings = T)
HRS_ahead_w4 <- opal.execute(o,'HRS_ahead_w4')
load(paste0(datafolder,"ahead_w4/ybirth.RData"))
HRS_ahead_w4 <- left_join(HRS_ahead_w4,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"ahead_w3/yintw.RData"))
HRS_ahead_w4 <- left_join(HRS_ahead_w4,yintw, by="id")
names(HRS_ahead_w4)[4] <- "yintw_ahead_w3"
rm(yintw)
load(paste0(datafolder,"ahead_w4/yintw.RData"))
HRS_ahead_w4 <- left_join(HRS_ahead_w4,yintw, by="id")
names(HRS_ahead_w4)[5] <- "yintw_ahead_w4"
rm(yintw)

```

```{r local ahead_w4, echo=F}

vbl <- HRS_ahead_w4$R4LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_ahead_w4)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_ahead_w4, aes(x=factor(R4LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w4$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w4)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ahead_w4 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w4$yintw_ahead_w3
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w4)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ahead_w4, aes(x=factor(yintw_ahead_w3))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w4$yintw_ahead_w4
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w4)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ahead_w4, aes(x=factor(yintw_ahead_w4))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R2LUNGE == 0 and R3LUNGE == 0 and R4LUNGE == 0 into 0`
* `R2LUNGE == 1 or R3LUNGE == 1 or R4LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w4 and 0 in w3, h_cpd_age = (year of interview w4-year of interview w3)/2+(year of interview w3 -ybirth)`
* `if h_cpd == 1 in w4 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo ahead_w4}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_ahead_w4 <- left_join(HRS_ahead_w4, HRS_ds_ahead, by = "id")

# Categorical variable harmonization
HRS_ds_ahead_w4 <- tibble(id=HRS_ahead_w4$id)
HRS_ds_ahead_w4$h_cpd <- rep(999,length(HRS_ahead_w4$id))
HRS_ds_ahead_w4$h_cpd[which(((!is.na(HRS_ahead_w4$R4LUNGE)) & HRS_ahead_w4$R4LUNGE == 0) & (HRS_ahead_w4$h_cpd != 1))] <- 0
HRS_ds_ahead_w4$h_cpd[which(((!is.na(HRS_ahead_w4$R4LUNGE)) & HRS_ahead_w4$R4LUNGE == 1) | ((!is.na(HRS_ahead_w4$h_cpd)) & (!is.na(HRS_ahead_w4$R4LUNGE)) & HRS_ahead_w4$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_ahead_w4$h_cpd_age <- rep(999,length(HRS_ahead_w4$id))
HRS_ds_ahead_w4$h_cpd_age[which(HRS_ds_ahead_w4$h_cpd == 0)] <- 996
HRS_ds_ahead_w4$h_cpd_age[which(HRS_ds_ahead_w4$h_cpd == 1 & HRS_ahead_w4$h_cpd==0 & !HRS_ahead_w4$ybirth %in% miss_values_vector & !(HRS_ahead_w4$yintw_ahead_w4 %in% miss_values_vector | HRS_ahead_w4$yintw_ahead_w3 %in% miss_values_vector))] <- floor((HRS_ahead_w4$yintw_ahead_w4[which(HRS_ds_ahead_w4$h_cpd == 1 & HRS_ahead_w4$h_cpd==0 & !HRS_ahead_w4$ybirth %in% miss_values_vector & !(HRS_ahead_w4$yintw_ahead_w4 %in% miss_values_vector | HRS_ahead_w4$yintw_ahead_w3 %in% miss_values_vector))]+HRS_ahead_w4$yintw_ahead_w3[which(HRS_ds_ahead_w4$h_cpd == 1 & HRS_ahead_w4$h_cpd==0 & !HRS_ahead_w4$ybirth %in% miss_values_vector & !(HRS_ahead_w4$yintw_ahead_w4 %in% miss_values_vector | HRS_ahead_w4$yintw_ahead_w3 %in% miss_values_vector))])/2-HRS_ahead_w4$ybirth[which(HRS_ds_ahead_w4$h_cpd == 1 & HRS_ahead_w4$h_cpd==0 & !HRS_ahead_w4$ybirth %in% miss_values_vector & !(HRS_ahead_w4$yintw_ahead_w4 %in% miss_values_vector | HRS_ahead_w4$yintw_ahead_w3 %in% miss_values_vector))])
HRS_ds_ahead_w4$h_cpd_age[which(HRS_ds_ahead_w4$h_cpd == 1 & !HRS_ahead_w4$h_cpd_age %in% miss_values_vector)] <- HRS_ahead_w4$h_cpd_age[which(HRS_ds_ahead_w4$h_cpd == 1 & !HRS_ahead_w4$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_ahead[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_ahead_w4,log_vec=(HRS_ds_prov$id %in% HRS_ds_ahead_w4$id),col_end_index = 2, col_st_index = 3)
HRS_ds_ahead$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_ahead$h_cpd_age[which((HRS_ds_ahead$id %in% HRS_ds_ahead_w4$id) & (HRS_ds_ahead$h_cpd != 999))] <- HRS_ds_ahead_w4$h_cpd_age[which(HRS_ds_ahead_w4$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript ahead_w4, echo=F}

vbl <- HRS_ds_ahead_w4$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_ahead_w4, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_ahead_w4$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_ahead_w4 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation ahead_w4, echo=F, results='asis'}

AfterH <- table(HRS_ds_ahead_w4$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_ahead_w4$R4LUNGE)) & HRS_ahead_w4$R4LUNGE == 0) & (HRS_ahead_w4$h_cpd != 1)),
  sum(((!is.na(HRS_ahead_w4$R4LUNGE)) & HRS_ahead_w4$R4LUNGE == 1) | ((!is.na(HRS_ahead_w4$h_cpd)) & (!is.na(HRS_ahead_w4$R4LUNGE)) & HRS_ahead_w4$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_ahead_w4$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_ahead_w4)

```




### Wave 5

#### Study-specific variable description

| **Name** | `R5LUNGE` |`ybirth`|`yintw (ahead_w5)`|`yintw (ahead_w4)`|
|-|-|-|-|-|
| **Label** | `R5LUNGE:W5 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-AHEAD-w5`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign ahead_w5, echo=F}

opal.assign.table.tibble(o, 'HRS_ahead_w5','HRS.HRS-AHEAD-w5',variables=list('R5LUNGE'), missings = T)
HRS_ahead_w5 <- opal.execute(o,'HRS_ahead_w5')
load(paste0(datafolder,"ahead_w5/ybirth.RData"))
HRS_ahead_w5 <- left_join(HRS_ahead_w5,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"ahead_w4/yintw.RData"))
HRS_ahead_w5 <- left_join(HRS_ahead_w5,yintw, by="id")
names(HRS_ahead_w5)[4] <- "yintw_ahead_w4"
rm(yintw)
load(paste0(datafolder,"ahead_w5/yintw.RData"))
HRS_ahead_w5 <- left_join(HRS_ahead_w5,yintw, by="id")
names(HRS_ahead_w5)[5] <- "yintw_ahead_w5"
rm(yintw)

```

```{r local ahead_w5, echo=F}

vbl <- HRS_ahead_w5$R5LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_ahead_w5)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_ahead_w5, aes(x=factor(R5LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w5$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w5)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ahead_w5 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w5$yintw_ahead_w4
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w5)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ahead_w5, aes(x=factor(yintw_ahead_w4))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w5$yintw_ahead_w5
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w5)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ahead_w5, aes(x=factor(yintw_ahead_w5))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R2LUNGE == 0 and R3LUNGE == 0 and R4LUNGE == 0 and R5LUNGE == 0 into 0`
* `R2LUNGE == 1 or R3LUNGE == 1 or R4LUNGE == 1 or R5LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w5 and 0 in w4, h_cpd_age = (year of interview w5-year of interview w4)/2+(year of interview w4 -ybirth)`
* `if h_cpd == 1 in w5 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo ahead_w5}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_ahead_w5 <- left_join(HRS_ahead_w5, HRS_ds_ahead, by = "id")

# Categorical variable harmonization
HRS_ds_ahead_w5 <- tibble(id=HRS_ahead_w5$id)
HRS_ds_ahead_w5$h_cpd <- rep(999,length(HRS_ahead_w5$id))
HRS_ds_ahead_w5$h_cpd[which(((!is.na(HRS_ahead_w5$R5LUNGE)) & HRS_ahead_w5$R5LUNGE == 0) & (HRS_ahead_w5$h_cpd != 1))] <- 0
HRS_ds_ahead_w5$h_cpd[which(((!is.na(HRS_ahead_w5$R5LUNGE)) & HRS_ahead_w5$R5LUNGE == 1) | ((!is.na(HRS_ahead_w5$h_cpd)) & (!is.na(HRS_ahead_w5$R5LUNGE)) & HRS_ahead_w5$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_ahead_w5$h_cpd_age <- rep(999,length(HRS_ahead_w5$id))
HRS_ds_ahead_w5$h_cpd_age[which(HRS_ds_ahead_w5$h_cpd == 0)] <- 996
HRS_ds_ahead_w5$h_cpd_age[which(HRS_ds_ahead_w5$h_cpd == 1 & HRS_ahead_w5$h_cpd==0 & !HRS_ahead_w5$ybirth %in% miss_values_vector & !(HRS_ahead_w5$yintw_ahead_w5 %in% miss_values_vector | HRS_ahead_w5$yintw_ahead_w4 %in% miss_values_vector))] <- floor((HRS_ahead_w5$yintw_ahead_w5[which(HRS_ds_ahead_w5$h_cpd == 1 & HRS_ahead_w5$h_cpd==0 & !HRS_ahead_w5$ybirth %in% miss_values_vector & !(HRS_ahead_w5$yintw_ahead_w5 %in% miss_values_vector | HRS_ahead_w5$yintw_ahead_w4 %in% miss_values_vector))]+HRS_ahead_w5$yintw_ahead_w4[which(HRS_ds_ahead_w5$h_cpd == 1 & HRS_ahead_w5$h_cpd==0 & !HRS_ahead_w5$ybirth %in% miss_values_vector & !(HRS_ahead_w5$yintw_ahead_w5 %in% miss_values_vector | HRS_ahead_w5$yintw_ahead_w4 %in% miss_values_vector))])/2-HRS_ahead_w5$ybirth[which(HRS_ds_ahead_w5$h_cpd == 1 & HRS_ahead_w5$h_cpd==0 & !HRS_ahead_w5$ybirth %in% miss_values_vector & !(HRS_ahead_w5$yintw_ahead_w5 %in% miss_values_vector | HRS_ahead_w5$yintw_ahead_w4 %in% miss_values_vector))])
HRS_ds_ahead_w5$h_cpd_age[which(HRS_ds_ahead_w5$h_cpd == 1 & !HRS_ahead_w5$h_cpd_age %in% miss_values_vector)] <- HRS_ahead_w5$h_cpd_age[which(HRS_ds_ahead_w5$h_cpd == 1 & !HRS_ahead_w5$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_ahead[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_ahead_w5,log_vec=(HRS_ds_prov$id %in% HRS_ds_ahead_w5$id),col_end_index = 2, col_st_index = 3)
HRS_ds_ahead$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_ahead$h_cpd_age[which((HRS_ds_ahead$id %in% HRS_ds_ahead_w5$id) & (HRS_ds_ahead$h_cpd != 999))] <- HRS_ds_ahead_w5$h_cpd_age[which(HRS_ds_ahead_w5$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript ahead_w5, echo=F}

vbl <- HRS_ds_ahead_w5$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_ahead_w5, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_ahead_w5$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_ahead_w5 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation ahead_w5, echo=F, results='asis'}

AfterH <- table(HRS_ds_ahead_w5$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_ahead_w5$R5LUNGE)) & HRS_ahead_w5$R5LUNGE == 0) & (HRS_ahead_w5$h_cpd != 1)),
  sum(((!is.na(HRS_ahead_w5$R5LUNGE)) & HRS_ahead_w5$R5LUNGE == 1) | ((!is.na(HRS_ahead_w5$h_cpd)) & (!is.na(HRS_ahead_w5$R5LUNGE)) & HRS_ahead_w5$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_ahead_w5$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_ahead_w5)

```



### Wave 6

#### Study-specific variable description

| **Name** | `R6LUNGE` |`ybirth`|`yintw (ahead_w6)`|`yintw (ahead_w5)`|
|-|-|-|-|-|
| **Label** | `R6LUNGE:W6 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-AHEAD-w6`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign ahead_w6, echo=F}

opal.assign.table.tibble(o, 'HRS_ahead_w6','HRS.HRS-AHEAD-w6',variables=list('R6LUNGE'), missings = T)
HRS_ahead_w6 <- opal.execute(o,'HRS_ahead_w6')
load(paste0(datafolder,"ahead_w6/ybirth.RData"))
HRS_ahead_w6 <- left_join(HRS_ahead_w6,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"ahead_w5/yintw.RData"))
HRS_ahead_w6 <- left_join(HRS_ahead_w6,yintw, by="id")
names(HRS_ahead_w6)[4] <- "yintw_ahead_w5"
rm(yintw)
load(paste0(datafolder,"ahead_w6/yintw.RData"))
HRS_ahead_w6 <- left_join(HRS_ahead_w6,yintw, by="id")
names(HRS_ahead_w6)[5] <- "yintw_ahead_w6"
rm(yintw)

```

```{r local ahead_w6, echo=F}

vbl <- HRS_ahead_w6$R6LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_ahead_w6)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_ahead_w6, aes(x=factor(R6LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w6$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w6)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ahead_w6 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w6$yintw_ahead_w5
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w6)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ahead_w6, aes(x=factor(yintw_ahead_w5))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w6$yintw_ahead_w6
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w6)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ahead_w6, aes(x=factor(yintw_ahead_w6))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R2LUNGE == 0 and R3LUNGE == 0 and R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 into 0`
* `R2LUNGE == 1 or R3LUNGE == 1 or R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w6 and 0 in w5, h_cpd_age = (year of interview w6-year of interview w5)/2+(year of interview w5 -ybirth)`
* `if h_cpd == 1 in w6 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo ahead_w6}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_ahead_w6 <- left_join(HRS_ahead_w6, HRS_ds_ahead, by = "id")

# Categorical variable harmonization
HRS_ds_ahead_w6 <- tibble(id=HRS_ahead_w6$id)
HRS_ds_ahead_w6$h_cpd <- rep(999,length(HRS_ahead_w6$id))
HRS_ds_ahead_w6$h_cpd[which(((!is.na(HRS_ahead_w6$R6LUNGE)) & HRS_ahead_w6$R6LUNGE == 0) & (HRS_ahead_w6$h_cpd != 1))] <- 0
HRS_ds_ahead_w6$h_cpd[which(((!is.na(HRS_ahead_w6$R6LUNGE)) & HRS_ahead_w6$R6LUNGE == 1) | ((!is.na(HRS_ahead_w6$h_cpd)) & (!is.na(HRS_ahead_w6$R6LUNGE)) & HRS_ahead_w6$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_ahead_w6$h_cpd_age <- rep(999,length(HRS_ahead_w6$id))
HRS_ds_ahead_w6$h_cpd_age[which(HRS_ds_ahead_w6$h_cpd == 0)] <- 996
HRS_ds_ahead_w6$h_cpd_age[which(HRS_ds_ahead_w6$h_cpd == 1 & HRS_ahead_w6$h_cpd==0 & !HRS_ahead_w6$ybirth %in% miss_values_vector & !(HRS_ahead_w6$yintw_ahead_w6 %in% miss_values_vector | HRS_ahead_w6$yintw_ahead_w5 %in% miss_values_vector))] <- floor((HRS_ahead_w6$yintw_ahead_w6[which(HRS_ds_ahead_w6$h_cpd == 1 & HRS_ahead_w6$h_cpd==0 & !HRS_ahead_w6$ybirth %in% miss_values_vector & !(HRS_ahead_w6$yintw_ahead_w6 %in% miss_values_vector | HRS_ahead_w6$yintw_ahead_w5 %in% miss_values_vector))]+HRS_ahead_w6$yintw_ahead_w5[which(HRS_ds_ahead_w6$h_cpd == 1 & HRS_ahead_w6$h_cpd==0 & !HRS_ahead_w6$ybirth %in% miss_values_vector & !(HRS_ahead_w6$yintw_ahead_w6 %in% miss_values_vector | HRS_ahead_w6$yintw_ahead_w5 %in% miss_values_vector))])/2-HRS_ahead_w6$ybirth[which(HRS_ds_ahead_w6$h_cpd == 1 & HRS_ahead_w6$h_cpd==0 & !HRS_ahead_w6$ybirth %in% miss_values_vector & !(HRS_ahead_w6$yintw_ahead_w6 %in% miss_values_vector | HRS_ahead_w6$yintw_ahead_w5 %in% miss_values_vector))])
HRS_ds_ahead_w6$h_cpd_age[which(HRS_ds_ahead_w6$h_cpd == 1 & !HRS_ahead_w6$h_cpd_age %in% miss_values_vector)] <- HRS_ahead_w6$h_cpd_age[which(HRS_ds_ahead_w6$h_cpd == 1 & !HRS_ahead_w6$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_ahead[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_ahead_w6,log_vec=(HRS_ds_prov$id %in% HRS_ds_ahead_w6$id),col_end_index = 2, col_st_index = 3)
HRS_ds_ahead$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_ahead$h_cpd_age[which((HRS_ds_ahead$id %in% HRS_ds_ahead_w6$id) & (HRS_ds_ahead$h_cpd != 999))] <- HRS_ds_ahead_w6$h_cpd_age[which(HRS_ds_ahead_w6$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript ahead_w6, echo=F}

vbl <- HRS_ds_ahead_w6$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_ahead_w6, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_ahead_w6$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_ahead_w6 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation ahead_w6, echo=F, results='asis'}

AfterH <- table(HRS_ds_ahead_w6$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_ahead_w6$R6LUNGE)) & HRS_ahead_w6$R6LUNGE == 0) & (HRS_ahead_w6$h_cpd != 1)),
  sum(((!is.na(HRS_ahead_w6$R6LUNGE)) & HRS_ahead_w6$R6LUNGE == 1) | ((!is.na(HRS_ahead_w6$h_cpd)) & (!is.na(HRS_ahead_w6$R6LUNGE)) & HRS_ahead_w6$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_ahead_w6$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_ahead_w6)

```



### Wave 7

#### Study-specific variable description

| **Name** | `R7LUNGE` |`ybirth`|`yintw (ahead_w7)`|`yintw (ahead_w6)`|
|-|-|-|-|-|
| **Label** | `R7LUNGE:W7 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-AHEAD-w7`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign ahead_w7, echo=F}

opal.assign.table.tibble(o, 'HRS_ahead_w7','HRS.HRS-AHEAD-w7',variables=list('R7LUNGE'), missings = T)
HRS_ahead_w7 <- opal.execute(o,'HRS_ahead_w7')
load(paste0(datafolder,"ahead_w7/ybirth.RData"))
HRS_ahead_w7 <- left_join(HRS_ahead_w7,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"ahead_w6/yintw.RData"))
HRS_ahead_w7 <- left_join(HRS_ahead_w7,yintw, by="id")
names(HRS_ahead_w7)[4] <- "yintw_ahead_w6"
rm(yintw)
load(paste0(datafolder,"ahead_w7/yintw.RData"))
HRS_ahead_w7 <- left_join(HRS_ahead_w7,yintw, by="id")
names(HRS_ahead_w7)[5] <- "yintw_ahead_w7"
rm(yintw)

```

```{r local ahead_w7, echo=F}

vbl <- HRS_ahead_w7$R7LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_ahead_w7)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_ahead_w7, aes(x=factor(R7LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w7$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w7)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ahead_w7 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w7$yintw_ahead_w6
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w7)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ahead_w7, aes(x=factor(yintw_ahead_w6))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w7$yintw_ahead_w7
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w7)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ahead_w7, aes(x=factor(yintw_ahead_w7))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R2LUNGE == 0 and R3LUNGE == 0 and R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 into 0`
* `R2LUNGE == 1 or R3LUNGE == 1 or R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w7 and 0 in w6, h_cpd_age = (year of interview w7-year of interview w6)/2+(year of interview w6 -ybirth)`
* `if h_cpd == 1 in w7 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo ahead_w7}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_ahead_w7 <- left_join(HRS_ahead_w7, HRS_ds_ahead, by = "id")

# Categorical variable harmonization
HRS_ds_ahead_w7 <- tibble(id=HRS_ahead_w7$id)
HRS_ds_ahead_w7$h_cpd <- rep(999,length(HRS_ahead_w7$id))
HRS_ds_ahead_w7$h_cpd[which(((!is.na(HRS_ahead_w7$R7LUNGE)) & HRS_ahead_w7$R7LUNGE == 0) & (HRS_ahead_w7$h_cpd != 1))] <- 0
HRS_ds_ahead_w7$h_cpd[which(((!is.na(HRS_ahead_w7$R7LUNGE)) & HRS_ahead_w7$R7LUNGE == 1) | ((!is.na(HRS_ahead_w7$h_cpd)) & (!is.na(HRS_ahead_w7$R7LUNGE)) & HRS_ahead_w7$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_ahead_w7$h_cpd_age <- rep(999,length(HRS_ahead_w7$id))
HRS_ds_ahead_w7$h_cpd_age[which(HRS_ds_ahead_w7$h_cpd == 0)] <- 996
HRS_ds_ahead_w7$h_cpd_age[which(HRS_ds_ahead_w7$h_cpd == 1 & HRS_ahead_w7$h_cpd==0 & !HRS_ahead_w7$ybirth %in% miss_values_vector & !(HRS_ahead_w7$yintw_ahead_w7 %in% miss_values_vector | HRS_ahead_w7$yintw_ahead_w6 %in% miss_values_vector))] <- floor((HRS_ahead_w7$yintw_ahead_w7[which(HRS_ds_ahead_w7$h_cpd == 1 & HRS_ahead_w7$h_cpd==0 & !HRS_ahead_w7$ybirth %in% miss_values_vector & !(HRS_ahead_w7$yintw_ahead_w7 %in% miss_values_vector | HRS_ahead_w7$yintw_ahead_w6 %in% miss_values_vector))]+HRS_ahead_w7$yintw_ahead_w6[which(HRS_ds_ahead_w7$h_cpd == 1 & HRS_ahead_w7$h_cpd==0 & !HRS_ahead_w7$ybirth %in% miss_values_vector & !(HRS_ahead_w7$yintw_ahead_w7 %in% miss_values_vector | HRS_ahead_w7$yintw_ahead_w6 %in% miss_values_vector))])/2-HRS_ahead_w7$ybirth[which(HRS_ds_ahead_w7$h_cpd == 1 & HRS_ahead_w7$h_cpd==0 & !HRS_ahead_w7$ybirth %in% miss_values_vector & !(HRS_ahead_w7$yintw_ahead_w7 %in% miss_values_vector | HRS_ahead_w7$yintw_ahead_w6 %in% miss_values_vector))])
HRS_ds_ahead_w7$h_cpd_age[which(HRS_ds_ahead_w7$h_cpd == 1 & !HRS_ahead_w7$h_cpd_age %in% miss_values_vector)] <- HRS_ahead_w7$h_cpd_age[which(HRS_ds_ahead_w7$h_cpd == 1 & !HRS_ahead_w7$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_ahead[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_ahead_w7,log_vec=(HRS_ds_prov$id %in% HRS_ds_ahead_w7$id),col_end_index = 2, col_st_index = 3)
HRS_ds_ahead$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_ahead$h_cpd_age[which((HRS_ds_ahead$id %in% HRS_ds_ahead_w7$id) & (HRS_ds_ahead$h_cpd != 999))] <- HRS_ds_ahead_w7$h_cpd_age[which(HRS_ds_ahead_w7$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript ahead_w7, echo=F}

vbl <- HRS_ds_ahead_w7$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_ahead_w7, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_ahead_w7$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_ahead_w7 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation ahead_w7, echo=F, results='asis'}

AfterH <- table(HRS_ds_ahead_w7$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_ahead_w7$R7LUNGE)) & HRS_ahead_w7$R7LUNGE == 0) & (HRS_ahead_w7$h_cpd != 1)),
  sum(((!is.na(HRS_ahead_w7$R7LUNGE)) & HRS_ahead_w7$R7LUNGE == 1) | ((!is.na(HRS_ahead_w7$h_cpd)) & (!is.na(HRS_ahead_w7$R7LUNGE)) & HRS_ahead_w7$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_ahead_w7$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_ahead_w7)

```




### Wave 8

#### Study-specific variable description

| **Name** | `R8LUNGE` |`ybirth`|`yintw (ahead_w8)`|`yintw (ahead_w7)`|
|-|-|-|-|-|
| **Label** | `R8LUNGE:W8 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-AHEAD-w8`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign ahead_w8, echo=F}

opal.assign.table.tibble(o, 'HRS_ahead_w8','HRS.HRS-AHEAD-w8',variables=list('R8LUNGE'), missings = T)
HRS_ahead_w8 <- opal.execute(o,'HRS_ahead_w8')
load(paste0(datafolder,"ahead_w8/ybirth.RData"))
HRS_ahead_w8 <- left_join(HRS_ahead_w8,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"ahead_w7/yintw.RData"))
HRS_ahead_w8 <- left_join(HRS_ahead_w8,yintw, by="id")
names(HRS_ahead_w8)[4] <- "yintw_ahead_w7"
rm(yintw)
load(paste0(datafolder,"ahead_w8/yintw.RData"))
HRS_ahead_w8 <- left_join(HRS_ahead_w8,yintw, by="id")
names(HRS_ahead_w8)[5] <- "yintw_ahead_w8"
rm(yintw)

```

```{r local ahead_w8, echo=F}

vbl <- HRS_ahead_w8$R8LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_ahead_w8)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_ahead_w8, aes(x=factor(R8LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w8$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w8)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ahead_w8 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w8$yintw_ahead_w7
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w8)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ahead_w8, aes(x=factor(yintw_ahead_w7))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w8$yintw_ahead_w8
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w8)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ahead_w8, aes(x=factor(yintw_ahead_w8))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R2LUNGE == 0 and R3LUNGE == 0 and R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 and R8LUNGE == 0 into 0`
* `R2LUNGE == 1 or R3LUNGE == 1 or R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 or R8LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w8 and 0 in w7, h_cpd_age = (year of interview w8-year of interview w7)/2+(year of interview w7 -ybirth)`
* `if h_cpd == 1 in w8 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo ahead_w8}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_ahead_w8 <- left_join(HRS_ahead_w8, HRS_ds_ahead, by = "id")

# Categorical variable harmonization
HRS_ds_ahead_w8 <- tibble(id=HRS_ahead_w8$id)
HRS_ds_ahead_w8$h_cpd <- rep(999,length(HRS_ahead_w8$id))
HRS_ds_ahead_w8$h_cpd[which(((!is.na(HRS_ahead_w8$R8LUNGE)) & HRS_ahead_w8$R8LUNGE == 0) & (HRS_ahead_w8$h_cpd != 1))] <- 0
HRS_ds_ahead_w8$h_cpd[which(((!is.na(HRS_ahead_w8$R8LUNGE)) & HRS_ahead_w8$R8LUNGE == 1) | ((!is.na(HRS_ahead_w8$h_cpd)) & (!is.na(HRS_ahead_w8$R8LUNGE)) & HRS_ahead_w8$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_ahead_w8$h_cpd_age <- rep(999,length(HRS_ahead_w8$id))
HRS_ds_ahead_w8$h_cpd_age[which(HRS_ds_ahead_w8$h_cpd == 0)] <- 996
HRS_ds_ahead_w8$h_cpd_age[which(HRS_ds_ahead_w8$h_cpd == 1 & HRS_ahead_w8$h_cpd==0 & !HRS_ahead_w8$ybirth %in% miss_values_vector & !(HRS_ahead_w8$yintw_ahead_w8 %in% miss_values_vector | HRS_ahead_w8$yintw_ahead_w7 %in% miss_values_vector))] <- floor((HRS_ahead_w8$yintw_ahead_w8[which(HRS_ds_ahead_w8$h_cpd == 1 & HRS_ahead_w8$h_cpd==0 & !HRS_ahead_w8$ybirth %in% miss_values_vector & !(HRS_ahead_w8$yintw_ahead_w8 %in% miss_values_vector | HRS_ahead_w8$yintw_ahead_w7 %in% miss_values_vector))]+HRS_ahead_w8$yintw_ahead_w7[which(HRS_ds_ahead_w8$h_cpd == 1 & HRS_ahead_w8$h_cpd==0 & !HRS_ahead_w8$ybirth %in% miss_values_vector & !(HRS_ahead_w8$yintw_ahead_w8 %in% miss_values_vector | HRS_ahead_w8$yintw_ahead_w7 %in% miss_values_vector))])/2-HRS_ahead_w8$ybirth[which(HRS_ds_ahead_w8$h_cpd == 1 & HRS_ahead_w8$h_cpd==0 & !HRS_ahead_w8$ybirth %in% miss_values_vector & !(HRS_ahead_w8$yintw_ahead_w8 %in% miss_values_vector | HRS_ahead_w8$yintw_ahead_w7 %in% miss_values_vector))])
HRS_ds_ahead_w8$h_cpd_age[which(HRS_ds_ahead_w8$h_cpd == 1 & !HRS_ahead_w8$h_cpd_age %in% miss_values_vector)] <- HRS_ahead_w8$h_cpd_age[which(HRS_ds_ahead_w8$h_cpd == 1 & !HRS_ahead_w8$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_ahead[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_ahead_w8,log_vec=(HRS_ds_prov$id %in% HRS_ds_ahead_w8$id),col_end_index = 2, col_st_index = 3)
HRS_ds_ahead$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_ahead$h_cpd_age[which((HRS_ds_ahead$id %in% HRS_ds_ahead_w8$id) & (HRS_ds_ahead$h_cpd != 999))] <- HRS_ds_ahead_w8$h_cpd_age[which(HRS_ds_ahead_w8$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript ahead_w8, echo=F}

vbl <- HRS_ds_ahead_w8$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_ahead_w8, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_ahead_w8$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_ahead_w8 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation ahead_w8, echo=F, results='asis'}

AfterH <- table(HRS_ds_ahead_w8$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_ahead_w8$R8LUNGE)) & HRS_ahead_w8$R8LUNGE == 0) & (HRS_ahead_w8$h_cpd != 1)),
  sum(((!is.na(HRS_ahead_w8$R8LUNGE)) & HRS_ahead_w8$R8LUNGE == 1) | ((!is.na(HRS_ahead_w8$h_cpd)) & (!is.na(HRS_ahead_w8$R8LUNGE)) & HRS_ahead_w8$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_ahead_w8$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_ahead_w8)

```



### Wave 9

#### Study-specific variable description

| **Name** | `R9LUNGE` |`ybirth`|`yintw (ahead_w9)`|`yintw (ahead_w8)`|
|-|-|-|-|-|
| **Label** | `R9LUNGE:W9 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-AHEAD-w9`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign ahead_w9, echo=F}

opal.assign.table.tibble(o, 'HRS_ahead_w9','HRS.HRS-AHEAD-w9',variables=list('R9LUNGE'), missings = T)
HRS_ahead_w9 <- opal.execute(o,'HRS_ahead_w9')
load(paste0(datafolder,"ahead_w9/ybirth.RData"))
HRS_ahead_w9 <- left_join(HRS_ahead_w9,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"ahead_w8/yintw.RData"))
HRS_ahead_w9 <- left_join(HRS_ahead_w9,yintw, by="id")
names(HRS_ahead_w9)[4] <- "yintw_ahead_w8"
rm(yintw)
load(paste0(datafolder,"ahead_w9/yintw.RData"))
HRS_ahead_w9 <- left_join(HRS_ahead_w9,yintw, by="id")
names(HRS_ahead_w9)[5] <- "yintw_ahead_w9"
rm(yintw)

```

```{r local ahead_w9, echo=F}

vbl <- HRS_ahead_w9$R9LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_ahead_w9)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_ahead_w9, aes(x=factor(R9LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w9$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w9)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ahead_w9 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w9$yintw_ahead_w8
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w9)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ahead_w9, aes(x=factor(yintw_ahead_w8))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w9$yintw_ahead_w9
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w9)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ahead_w9, aes(x=factor(yintw_ahead_w9))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R2LUNGE == 0 and R3LUNGE == 0 and R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 and R8LUNGE == 0 and R9LUNGE == 0 into 0`
* `R2LUNGE == 1 or R3LUNGE == 1 or R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 or R8LUNGE == 1 or R9LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w9 and 0 in w8, h_cpd_age = (year of interview w9-year of interview w8)/2+(year of interview w8 -ybirth)`
* `if h_cpd == 1 in w9 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo ahead_w9}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_ahead_w9 <- left_join(HRS_ahead_w9, HRS_ds_ahead, by = "id")

# Categorical variable harmonization
HRS_ds_ahead_w9 <- tibble(id=HRS_ahead_w9$id)
HRS_ds_ahead_w9$h_cpd <- rep(999,length(HRS_ahead_w9$id))
HRS_ds_ahead_w9$h_cpd[which(((!is.na(HRS_ahead_w9$R9LUNGE)) & HRS_ahead_w9$R9LUNGE == 0) & (HRS_ahead_w9$h_cpd != 1))] <- 0
HRS_ds_ahead_w9$h_cpd[which(((!is.na(HRS_ahead_w9$R9LUNGE)) & HRS_ahead_w9$R9LUNGE == 1) | ((!is.na(HRS_ahead_w9$h_cpd)) & (!is.na(HRS_ahead_w9$R9LUNGE)) & HRS_ahead_w9$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_ahead_w9$h_cpd_age <- rep(999,length(HRS_ahead_w9$id))
HRS_ds_ahead_w9$h_cpd_age[which(HRS_ds_ahead_w9$h_cpd == 0)] <- 996
HRS_ds_ahead_w9$h_cpd_age[which(HRS_ds_ahead_w9$h_cpd == 1 & HRS_ahead_w9$h_cpd==0 & !HRS_ahead_w9$ybirth %in% miss_values_vector & !(HRS_ahead_w9$yintw_ahead_w9 %in% miss_values_vector | HRS_ahead_w9$yintw_ahead_w8 %in% miss_values_vector))] <- floor((HRS_ahead_w9$yintw_ahead_w9[which(HRS_ds_ahead_w9$h_cpd == 1 & HRS_ahead_w9$h_cpd==0 & !HRS_ahead_w9$ybirth %in% miss_values_vector & !(HRS_ahead_w9$yintw_ahead_w9 %in% miss_values_vector | HRS_ahead_w9$yintw_ahead_w8 %in% miss_values_vector))]+HRS_ahead_w9$yintw_ahead_w8[which(HRS_ds_ahead_w9$h_cpd == 1 & HRS_ahead_w9$h_cpd==0 & !HRS_ahead_w9$ybirth %in% miss_values_vector & !(HRS_ahead_w9$yintw_ahead_w9 %in% miss_values_vector | HRS_ahead_w9$yintw_ahead_w8 %in% miss_values_vector))])/2-HRS_ahead_w9$ybirth[which(HRS_ds_ahead_w9$h_cpd == 1 & HRS_ahead_w9$h_cpd==0 & !HRS_ahead_w9$ybirth %in% miss_values_vector & !(HRS_ahead_w9$yintw_ahead_w9 %in% miss_values_vector | HRS_ahead_w9$yintw_ahead_w8 %in% miss_values_vector))])
HRS_ds_ahead_w9$h_cpd_age[which(HRS_ds_ahead_w9$h_cpd == 1 & !HRS_ahead_w9$h_cpd_age %in% miss_values_vector)] <- HRS_ahead_w9$h_cpd_age[which(HRS_ds_ahead_w9$h_cpd == 1 & !HRS_ahead_w9$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_ahead[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_ahead_w9,log_vec=(HRS_ds_prov$id %in% HRS_ds_ahead_w9$id),col_end_index = 2, col_st_index = 3)
HRS_ds_ahead$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_ahead$h_cpd_age[which((HRS_ds_ahead$id %in% HRS_ds_ahead_w9$id) & (HRS_ds_ahead$h_cpd != 999))] <- HRS_ds_ahead_w9$h_cpd_age[which(HRS_ds_ahead_w9$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript ahead_w9, echo=F}

vbl <- HRS_ds_ahead_w9$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_ahead_w9, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_ahead_w9$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_ahead_w9 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation ahead_w9, echo=F, results='asis'}

AfterH <- table(HRS_ds_ahead_w9$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_ahead_w9$R9LUNGE)) & HRS_ahead_w9$R9LUNGE == 0) & (HRS_ahead_w9$h_cpd != 1)),
  sum(((!is.na(HRS_ahead_w9$R9LUNGE)) & HRS_ahead_w9$R9LUNGE == 1) | ((!is.na(HRS_ahead_w9$h_cpd)) & (!is.na(HRS_ahead_w9$R9LUNGE)) & HRS_ahead_w9$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_ahead_w9$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_ahead_w9)

```



### Wave 10

#### Study-specific variable description

| **Name** | `R10LUNGE` |`ybirth`|`yintw (ahead_w10)`|`yintw (ahead_w9)`|
|-|-|-|-|-|
| **Label** | `R10LUNGE:W10 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-AHEAD-w10`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign ahead_w10, echo=F}

opal.assign.table.tibble(o, 'HRS_ahead_w10','HRS.HRS-AHEAD-w10',variables=list('R10LUNGE'), missings = T)
HRS_ahead_w10 <- opal.execute(o,'HRS_ahead_w10')
load(paste0(datafolder,"ahead_w10/ybirth.RData"))
HRS_ahead_w10 <- left_join(HRS_ahead_w10,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"ahead_w9/yintw.RData"))
HRS_ahead_w10 <- left_join(HRS_ahead_w10,yintw, by="id")
names(HRS_ahead_w10)[4] <- "yintw_ahead_w9"
rm(yintw)
load(paste0(datafolder,"ahead_w10/yintw.RData"))
HRS_ahead_w10 <- left_join(HRS_ahead_w10,yintw, by="id")
names(HRS_ahead_w10)[5] <- "yintw_ahead_w10"
rm(yintw)

```

```{r local ahead_w10, echo=F}

vbl <- HRS_ahead_w10$R10LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_ahead_w10)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_ahead_w10, aes(x=factor(R10LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w10$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w10)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ahead_w10 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w10$yintw_ahead_w9
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w10)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ahead_w10, aes(x=factor(yintw_ahead_w9))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w10$yintw_ahead_w10
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w10)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ahead_w10, aes(x=factor(yintw_ahead_w10))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R2LUNGE == 0 and R3LUNGE == 0 and R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 and R8LUNGE == 0 and R9LUNGE == 0 and R10LUNGE == 0 into 0`
* `R2LUNGE == 1 or R3LUNGE == 1 or R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 or R8LUNGE == 1 or R9LUNGE == 1 or R10LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w10 and 0 in w9, h_cpd_age = (year of interview w10-year of interview w9)/2+(year of interview w9 -ybirth)`
* `if h_cpd == 1 in w10 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo ahead_w10}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_ahead_w10 <- left_join(HRS_ahead_w10, HRS_ds_ahead, by = "id")

# Categorical variable harmonization
HRS_ds_ahead_w10 <- tibble(id=HRS_ahead_w10$id)
HRS_ds_ahead_w10$h_cpd <- rep(999,length(HRS_ahead_w10$id))
HRS_ds_ahead_w10$h_cpd[which(((!is.na(HRS_ahead_w10$R10LUNGE)) & HRS_ahead_w10$R10LUNGE == 0) & (HRS_ahead_w10$h_cpd != 1))] <- 0
HRS_ds_ahead_w10$h_cpd[which(((!is.na(HRS_ahead_w10$R10LUNGE)) & HRS_ahead_w10$R10LUNGE == 1) | ((!is.na(HRS_ahead_w10$h_cpd)) & (!is.na(HRS_ahead_w10$R10LUNGE)) & HRS_ahead_w10$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_ahead_w10$h_cpd_age <- rep(999,length(HRS_ahead_w10$id))
HRS_ds_ahead_w10$h_cpd_age[which(HRS_ds_ahead_w10$h_cpd == 0)] <- 996
HRS_ds_ahead_w10$h_cpd_age[which(HRS_ds_ahead_w10$h_cpd == 1 & HRS_ahead_w10$h_cpd==0 & !HRS_ahead_w10$ybirth %in% miss_values_vector & !(HRS_ahead_w10$yintw_ahead_w10 %in% miss_values_vector | HRS_ahead_w10$yintw_ahead_w9 %in% miss_values_vector))] <- floor((HRS_ahead_w10$yintw_ahead_w10[which(HRS_ds_ahead_w10$h_cpd == 1 & HRS_ahead_w10$h_cpd==0 & !HRS_ahead_w10$ybirth %in% miss_values_vector & !(HRS_ahead_w10$yintw_ahead_w10 %in% miss_values_vector | HRS_ahead_w10$yintw_ahead_w9 %in% miss_values_vector))]+HRS_ahead_w10$yintw_ahead_w9[which(HRS_ds_ahead_w10$h_cpd == 1 & HRS_ahead_w10$h_cpd==0 & !HRS_ahead_w10$ybirth %in% miss_values_vector & !(HRS_ahead_w10$yintw_ahead_w10 %in% miss_values_vector | HRS_ahead_w10$yintw_ahead_w9 %in% miss_values_vector))])/2-HRS_ahead_w10$ybirth[which(HRS_ds_ahead_w10$h_cpd == 1 & HRS_ahead_w10$h_cpd==0 & !HRS_ahead_w10$ybirth %in% miss_values_vector & !(HRS_ahead_w10$yintw_ahead_w10 %in% miss_values_vector | HRS_ahead_w10$yintw_ahead_w9 %in% miss_values_vector))])
HRS_ds_ahead_w10$h_cpd_age[which(HRS_ds_ahead_w10$h_cpd == 1 & !HRS_ahead_w10$h_cpd_age %in% miss_values_vector)] <- HRS_ahead_w10$h_cpd_age[which(HRS_ds_ahead_w10$h_cpd == 1 & !HRS_ahead_w10$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_ahead[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_ahead_w10,log_vec=(HRS_ds_prov$id %in% HRS_ds_ahead_w10$id),col_end_index = 2, col_st_index = 3)
HRS_ds_ahead$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_ahead$h_cpd_age[which((HRS_ds_ahead$id %in% HRS_ds_ahead_w10$id) & (HRS_ds_ahead$h_cpd != 999))] <- HRS_ds_ahead_w10$h_cpd_age[which(HRS_ds_ahead_w10$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript ahead_w10, echo=F}

vbl <- HRS_ds_ahead_w10$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_ahead_w10, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_ahead_w10$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_ahead_w10 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation ahead_w10, echo=F, results='asis'}

AfterH <- table(HRS_ds_ahead_w10$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_ahead_w10$R10LUNGE)) & HRS_ahead_w10$R10LUNGE == 0) & (HRS_ahead_w10$h_cpd != 1)),
  sum(((!is.na(HRS_ahead_w10$R10LUNGE)) & HRS_ahead_w10$R10LUNGE == 1) | ((!is.na(HRS_ahead_w10$h_cpd)) & (!is.na(HRS_ahead_w10$R10LUNGE)) & HRS_ahead_w10$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_ahead_w10$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_ahead_w10)

```




### Wave 11

#### Study-specific variable description

| **Name** | `R11LUNGE` |`ybirth`|`yintw (ahead_w11)`|`yintw (ahead_w10)`|
|-|-|-|-|-|
| **Label** | `R11LUNGE:W11 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-AHEAD-w11`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign ahead_w11, echo=F}

opal.assign.table.tibble(o, 'HRS_ahead_w11','HRS.HRS-AHEAD-w11',variables=list('R11LUNGE'), missings = T)
HRS_ahead_w11 <- opal.execute(o,'HRS_ahead_w11')
load(paste0(datafolder,"ahead_w11/ybirth.RData"))
HRS_ahead_w11 <- left_join(HRS_ahead_w11,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"ahead_w10/yintw.RData"))
HRS_ahead_w11 <- left_join(HRS_ahead_w11,yintw, by="id")
names(HRS_ahead_w11)[4] <- "yintw_ahead_w10"
rm(yintw)
load(paste0(datafolder,"ahead_w11/yintw.RData"))
HRS_ahead_w11 <- left_join(HRS_ahead_w11,yintw, by="id")
names(HRS_ahead_w11)[5] <- "yintw_ahead_w11"
rm(yintw)

```

```{r local ahead_w11, echo=F}

vbl <- HRS_ahead_w11$R11LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_ahead_w11)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_ahead_w11, aes(x=factor(R11LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w11$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w11)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ahead_w11 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w11$yintw_ahead_w10
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w11)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ahead_w11, aes(x=factor(yintw_ahead_w10))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ahead_w11$yintw_ahead_w11
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ahead_w11)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ahead_w11, aes(x=factor(yintw_ahead_w11))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R2LUNGE == 0 and R3LUNGE == 0 and R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 and R8LUNGE == 0 and R9LUNGE == 0 and R10LUNGE == 0 and R11LUNGE == 0 into 0`
* `R2LUNGE == 1 or R3LUNGE == 1 or R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 or R8LUNGE == 1 or R9LUNGE == 1 or R10LUNGE == 1 or R11LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w11 and 0 in w10, h_cpd_age = (year of interview w11-year of interview w10)/2+(year of interview w10 -ybirth)`
* `if h_cpd == 1 in w11 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo ahead_w11}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_ahead_w11 <- left_join(HRS_ahead_w11, HRS_ds_ahead, by = "id")

# Categorical variable harmonization
HRS_ds_ahead_w11 <- tibble(id=HRS_ahead_w11$id)
HRS_ds_ahead_w11$h_cpd <- rep(999,length(HRS_ahead_w11$id))
HRS_ds_ahead_w11$h_cpd[which(((!is.na(HRS_ahead_w11$R11LUNGE)) & HRS_ahead_w11$R11LUNGE == 0) & (HRS_ahead_w11$h_cpd != 1))] <- 0
HRS_ds_ahead_w11$h_cpd[which(((!is.na(HRS_ahead_w11$R11LUNGE)) & HRS_ahead_w11$R11LUNGE == 1) | ((!is.na(HRS_ahead_w11$h_cpd)) & (!is.na(HRS_ahead_w11$R11LUNGE)) & HRS_ahead_w11$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_ahead_w11$h_cpd_age <- rep(999,length(HRS_ahead_w11$id))
HRS_ds_ahead_w11$h_cpd_age[which(HRS_ds_ahead_w11$h_cpd == 0)] <- 996
HRS_ds_ahead_w11$h_cpd_age[which(HRS_ds_ahead_w11$h_cpd == 1 & HRS_ahead_w11$h_cpd==0 & !HRS_ahead_w11$ybirth %in% miss_values_vector & !(HRS_ahead_w11$yintw_ahead_w11 %in% miss_values_vector | HRS_ahead_w11$yintw_ahead_w10 %in% miss_values_vector))] <- floor((HRS_ahead_w11$yintw_ahead_w11[which(HRS_ds_ahead_w11$h_cpd == 1 & HRS_ahead_w11$h_cpd==0 & !HRS_ahead_w11$ybirth %in% miss_values_vector & !(HRS_ahead_w11$yintw_ahead_w11 %in% miss_values_vector | HRS_ahead_w11$yintw_ahead_w10 %in% miss_values_vector))]+HRS_ahead_w11$yintw_ahead_w10[which(HRS_ds_ahead_w11$h_cpd == 1 & HRS_ahead_w11$h_cpd==0 & !HRS_ahead_w11$ybirth %in% miss_values_vector & !(HRS_ahead_w11$yintw_ahead_w11 %in% miss_values_vector | HRS_ahead_w11$yintw_ahead_w10 %in% miss_values_vector))])/2-HRS_ahead_w11$ybirth[which(HRS_ds_ahead_w11$h_cpd == 1 & HRS_ahead_w11$h_cpd==0 & !HRS_ahead_w11$ybirth %in% miss_values_vector & !(HRS_ahead_w11$yintw_ahead_w11 %in% miss_values_vector | HRS_ahead_w11$yintw_ahead_w10 %in% miss_values_vector))])
HRS_ds_ahead_w11$h_cpd_age[which(HRS_ds_ahead_w11$h_cpd == 1 & !HRS_ahead_w11$h_cpd_age %in% miss_values_vector)] <- HRS_ahead_w11$h_cpd_age[which(HRS_ds_ahead_w11$h_cpd == 1 & !HRS_ahead_w11$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
rm(HRS_ds_ahead)

```


#### Statistics of the new harmonized variable

```{r descript ahead_w11, echo=F}

vbl <- HRS_ds_ahead_w11$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_ahead_w11, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_ahead_w11$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_ahead_w11 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation ahead_w11, echo=F, results='asis'}

AfterH <- table(HRS_ds_ahead_w11$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_ahead_w11$R11LUNGE)) & HRS_ahead_w11$R11LUNGE == 0) & (HRS_ahead_w11$h_cpd != 1)),
  sum(((!is.na(HRS_ahead_w11$R11LUNGE)) & HRS_ahead_w11$R11LUNGE == 1) | ((!is.na(HRS_ahead_w11$h_cpd)) & (!is.na(HRS_ahead_w11$R11LUNGE)) & HRS_ahead_w11$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_ahead_w11$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_ahead_w11)

```



## CODA

### Wave 4

#### Study-specific variable description

| **Name** | `R4LUNGE` |
|-|-|
| **Label** | `R4LUNGE:W4 R ever had lung disease`|
| **Table name**  | `HRS-CODA-w4`|
| **Categories** | `0 = no`<br/>`1 = yes` |
| **Missings** | `NA` |
| **Description** |  |

```{r assign coda_w4, echo=F}

opal.assign.table.tibble(o, 'HRS_coda_w4','HRS.HRS-CODA-w4',variables=list('R4LUNGE'), missings = T)
HRS_coda_w4 <- opal.execute(o,'HRS_coda_w4')

```

```{r local coda_w4, echo=F}

vbl <- HRS_coda_w4$R4LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_coda_w4)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_coda_w4, aes(x=factor(R4LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `keep up 1 into 1`
* `keep up 0 into 0`
* `NA into 999`

Age of diagnosis cannot be harmonized.

**R script:**

```{r harmo coda_w4}

# Categorical variable harmonization
HRS_ds_coda_w4 <- tibble(id=HRS_coda_w4$id)
HRS_ds_coda_w4$h_cpd <- car::recode(HRS_coda_w4$R4LUNGE, "NA=999")

# We build a global table in order to have updated the status of all the individuals through the different waves
HRS_ds_coda <- HRS_ds_coda_w4
HRS_ds_coda$h_cpd_age <- rep(999,length(HRS_ds_coda$id))

```


#### Statistics of the new harmonized variable

```{r descript coda_w4, echo=F}

vbl <- HRS_ds_coda_w4$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_coda_w4, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

```


#### Validation

```{r crosstabulation coda_w4, echo=F}

AfterH <- table(HRS_ds_coda_w4$h_cpd, useNA = "ifany")
BeforeH <- table(HRS_coda_w4$R4LUNGE, useNA = "ifany")
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)
rm(HRS_coda_w4)

```



### Wave 5

#### Study-specific variable description

| **Name** | `R5LUNGE` |`ybirth`|`yintw (coda_w4)`|`yintw (coda_w5)`|
|-|-|-|-|-|
| **Label** | `R5LUNGE:W5 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-CODA-w5`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign coda_w5, echo=F}

opal.assign.table.tibble(o, 'HRS_coda_w5','HRS.HRS-CODA-w5',variables=list('R5LUNGE'), missings = T)
HRS_coda_w5 <- opal.execute(o,'HRS_coda_w5')
load(paste0(datafolder,"coda_w5/ybirth.RData"))
HRS_coda_w5 <- left_join(HRS_coda_w5,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"coda_w4/yintw.RData"))
HRS_coda_w5 <- left_join(HRS_coda_w5,yintw, by="id")
names(HRS_coda_w5)[4] <- "yintw_coda_w4"
rm(yintw)
load(paste0(datafolder,"coda_w5/yintw.RData"))
HRS_coda_w5 <- left_join(HRS_coda_w5,yintw, by="id")
names(HRS_coda_w5)[5] <- "yintw_coda_w5"
rm(yintw)

```

```{r local coda_w5, echo=F}

vbl <- HRS_coda_w5$R5LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_coda_w5)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_coda_w5, aes(x=factor(R5LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w5$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w5)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_coda_w5 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w5$yintw_coda_w4
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w5)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_coda_w5, aes(x=factor(yintw_coda_w4))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w5$yintw_coda_w5
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w5)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_coda_w5, aes(x=factor(yintw_coda_w5))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R4LUNGE == 0 and R5LUNGE == 0 into 0`
* `R4LUNGE == 1 or R5LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w5 and 0 in w4, h_cpd_age = (year of interview w5-year of interview w4)/2+(year of interview w4 -ybirth)`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo coda_w5}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_coda_w5 <- left_join(HRS_coda_w5, HRS_ds_coda, by = "id")

# Categorical variable harmonization
HRS_ds_coda_w5 <- tibble(id=HRS_coda_w5$id)
HRS_ds_coda_w5$h_cpd <- rep(999,length(HRS_coda_w5$id))
HRS_ds_coda_w5$h_cpd[which(((!is.na(HRS_coda_w5$R5LUNGE)) & HRS_coda_w5$R5LUNGE == 0) & (HRS_coda_w5$h_cpd != 1))] <- 0
HRS_ds_coda_w5$h_cpd[which(((!is.na(HRS_coda_w5$R5LUNGE)) & HRS_coda_w5$R5LUNGE == 1) | ((!is.na(HRS_coda_w5$h_cpd)) & (!is.na(HRS_coda_w5$R5LUNGE)) & HRS_coda_w5$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_coda_w5$h_cpd_age <- rep(999,length(HRS_coda_w5$id))
HRS_ds_coda_w5$h_cpd_age[which(HRS_ds_coda_w5$h_cpd == 0)] <- 996
HRS_ds_coda_w5$h_cpd_age[which(HRS_ds_coda_w5$h_cpd == 1 & HRS_coda_w5$h_cpd==0 & !HRS_coda_w5$ybirth %in% miss_values_vector & !(HRS_coda_w5$yintw_coda_w5 %in% miss_values_vector | HRS_coda_w5$yintw_coda_w4 %in% miss_values_vector))] <- floor((HRS_coda_w5$yintw_coda_w5[which(HRS_ds_coda_w5$h_cpd == 1 & HRS_coda_w5$h_cpd==0 & !HRS_coda_w5$ybirth %in% miss_values_vector & !(HRS_coda_w5$yintw_coda_w5 %in% miss_values_vector | HRS_coda_w5$yintw_coda_w4 %in% miss_values_vector))]+HRS_coda_w5$yintw_coda_w4[which(HRS_ds_coda_w5$h_cpd == 1 & HRS_coda_w5$h_cpd==0 & !HRS_coda_w5$ybirth %in% miss_values_vector & !(HRS_coda_w5$yintw_coda_w5 %in% miss_values_vector | HRS_coda_w5$yintw_coda_w4 %in% miss_values_vector))])/2-HRS_coda_w5$ybirth[which(HRS_ds_coda_w5$h_cpd == 1 & HRS_coda_w5$h_cpd==0 & !HRS_coda_w5$ybirth %in% miss_values_vector & !(HRS_coda_w5$yintw_coda_w5 %in% miss_values_vector | HRS_coda_w5$yintw_coda_w4 %in% miss_values_vector))])

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_coda[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_coda_w5,log_vec=(HRS_ds_prov$id %in% HRS_ds_coda_w5$id),col_end_index = 2, col_st_index = 3)
HRS_ds_coda$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_coda$h_cpd_age[which((HRS_ds_coda$id %in% HRS_ds_coda_w5$id) & (HRS_ds_coda$h_cpd != 999))] <- HRS_ds_coda_w5$h_cpd_age[which(HRS_ds_coda_w5$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript coda_w5, echo=F}

vbl <- HRS_ds_coda_w5$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_coda_w5, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_coda_w5$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_coda_w5 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation coda_w5, echo=F, results='asis'}

AfterH <- table(HRS_ds_coda_w5$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_coda_w5$R5LUNGE)) & HRS_coda_w5$R5LUNGE == 0) & (HRS_coda_w5$h_cpd != 1)),
  sum(((!is.na(HRS_coda_w5$R5LUNGE)) & HRS_coda_w5$R5LUNGE == 1) | ((!is.na(HRS_coda_w5$h_cpd)) & (!is.na(HRS_coda_w5$R5LUNGE)) & HRS_coda_w5$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_coda_w5$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_coda_w5)

```




### Wave 6

#### Study-specific variable description

| **Name** | `R6LUNGE` |`ybirth`|`yintw (coda_w5)`|`yintw (coda_w6)`|
|-|-|-|-|-|
| **Label** | `R6LUNGE:W6 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-CODA-w6`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign coda_w6, echo=F}

opal.assign.table.tibble(o, 'HRS_coda_w6','HRS.HRS-CODA-w6',variables=list('R6LUNGE'), missings = T)
HRS_coda_w6 <- opal.execute(o,'HRS_coda_w6')
load(paste0(datafolder,"coda_w6/ybirth.RData"))
HRS_coda_w6 <- left_join(HRS_coda_w6,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"coda_w5/yintw.RData"))
HRS_coda_w6 <- left_join(HRS_coda_w6,yintw, by="id")
names(HRS_coda_w6)[4] <- "yintw_coda_w5"
rm(yintw)
load(paste0(datafolder,"coda_w6/yintw.RData"))
HRS_coda_w6 <- left_join(HRS_coda_w6,yintw, by="id")
names(HRS_coda_w6)[5] <- "yintw_coda_w6"
rm(yintw)

```

```{r local coda_w6, echo=F}

vbl <- HRS_coda_w6$R6LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_coda_w6)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_coda_w6, aes(x=factor(R6LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w6$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w6)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_coda_w6 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w6$yintw_coda_w5
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w6)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_coda_w6, aes(x=factor(yintw_coda_w5))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w6$yintw_coda_w6
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w6)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_coda_w6, aes(x=factor(yintw_coda_w6))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 into 0`
* `R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w6 and 0 in w5, h_cpd_age = (year of interview w6-year of interview w5)/2+(year of interview w5 -ybirth)`
* `if h_cpd == 1 in w6 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo coda_w6}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_coda_w6 <- left_join(HRS_coda_w6, HRS_ds_coda, by = "id")

# Categorical variable harmonization
HRS_ds_coda_w6 <- tibble(id=HRS_coda_w6$id)
HRS_ds_coda_w6$h_cpd <- rep(999,length(HRS_coda_w6$id))
HRS_ds_coda_w6$h_cpd[which(((!is.na(HRS_coda_w6$R6LUNGE)) & HRS_coda_w6$R6LUNGE == 0) & (HRS_coda_w6$h_cpd != 1))] <- 0
HRS_ds_coda_w6$h_cpd[which(((!is.na(HRS_coda_w6$R6LUNGE)) & HRS_coda_w6$R6LUNGE == 1) | ((!is.na(HRS_coda_w6$h_cpd)) & (!is.na(HRS_coda_w6$R6LUNGE)) & HRS_coda_w6$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_coda_w6$h_cpd_age <- rep(999,length(HRS_coda_w6$id))
HRS_ds_coda_w6$h_cpd_age[which(HRS_ds_coda_w6$h_cpd == 0)] <- 996
HRS_ds_coda_w6$h_cpd_age[which(HRS_ds_coda_w6$h_cpd == 1 & HRS_coda_w6$h_cpd==0 & !HRS_coda_w6$ybirth %in% miss_values_vector & !(HRS_coda_w6$yintw_coda_w6 %in% miss_values_vector | HRS_coda_w6$yintw_coda_w5 %in% miss_values_vector))] <- floor((HRS_coda_w6$yintw_coda_w6[which(HRS_ds_coda_w6$h_cpd == 1 & HRS_coda_w6$h_cpd==0 & !HRS_coda_w6$ybirth %in% miss_values_vector & !(HRS_coda_w6$yintw_coda_w6 %in% miss_values_vector | HRS_coda_w6$yintw_coda_w5 %in% miss_values_vector))]+HRS_coda_w6$yintw_coda_w5[which(HRS_ds_coda_w6$h_cpd == 1 & HRS_coda_w6$h_cpd==0 & !HRS_coda_w6$ybirth %in% miss_values_vector & !(HRS_coda_w6$yintw_coda_w6 %in% miss_values_vector | HRS_coda_w6$yintw_coda_w5 %in% miss_values_vector))])/2-HRS_coda_w6$ybirth[which(HRS_ds_coda_w6$h_cpd == 1 & HRS_coda_w6$h_cpd==0 & !HRS_coda_w6$ybirth %in% miss_values_vector & !(HRS_coda_w6$yintw_coda_w6 %in% miss_values_vector | HRS_coda_w6$yintw_coda_w5 %in% miss_values_vector))])
HRS_ds_coda_w6$h_cpd_age[which(HRS_ds_coda_w6$h_cpd == 1 & !HRS_coda_w6$h_cpd_age %in% miss_values_vector)] <- HRS_coda_w6$h_cpd_age[which(HRS_ds_coda_w6$h_cpd == 1 & !HRS_coda_w6$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_coda[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_coda_w6,log_vec=(HRS_ds_prov$id %in% HRS_ds_coda_w6$id),col_end_index = 2, col_st_index = 3)
HRS_ds_coda$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_coda$h_cpd_age[which((HRS_ds_coda$id %in% HRS_ds_coda_w6$id) & (HRS_ds_coda$h_cpd != 999))] <- HRS_ds_coda_w6$h_cpd_age[which(HRS_ds_coda_w6$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript coda_w6, echo=F}

vbl <- HRS_ds_coda_w6$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_coda_w6, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_coda_w6$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_coda_w6 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation coda_w6, echo=F, results='asis'}

AfterH <- table(HRS_ds_coda_w6$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_coda_w6$R6LUNGE)) & HRS_coda_w6$R6LUNGE == 0) & (HRS_coda_w6$h_cpd != 1)),
  sum(((!is.na(HRS_coda_w6$R6LUNGE)) & HRS_coda_w6$R6LUNGE == 1) | ((!is.na(HRS_coda_w6$h_cpd)) & (!is.na(HRS_coda_w6$R6LUNGE)) & HRS_coda_w6$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_coda_w6$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_coda_w6)

```




### Wave 7

#### Study-specific variable description

| **Name** | `R7LUNGE` |`ybirth`|`yintw (coda_w7)`|`yintw (coda_w6)`|
|-|-|-|-|-|
| **Label** | `R7LUNGE:W7 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-CODA-w7`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign coda_w7, echo=F}

opal.assign.table.tibble(o, 'HRS_coda_w7','HRS.HRS-CODA-w7',variables=list('R7LUNGE'), missings = T)
HRS_coda_w7 <- opal.execute(o,'HRS_coda_w7')
load(paste0(datafolder,"coda_w7/ybirth.RData"))
HRS_coda_w7 <- left_join(HRS_coda_w7,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"coda_w6/yintw.RData"))
HRS_coda_w7 <- left_join(HRS_coda_w7,yintw, by="id")
names(HRS_coda_w7)[4] <- "yintw_coda_w6"
rm(yintw)
load(paste0(datafolder,"coda_w7/yintw.RData"))
HRS_coda_w7 <- left_join(HRS_coda_w7,yintw, by="id")
names(HRS_coda_w7)[5] <- "yintw_coda_w7"
rm(yintw)

```

```{r local coda_w7, echo=F}

vbl <- HRS_coda_w7$R7LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_coda_w7)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_coda_w7, aes(x=factor(R7LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w7$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w7)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_coda_w7 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w7$yintw_coda_w6
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w7)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_coda_w7, aes(x=factor(yintw_coda_w6))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w7$yintw_coda_w7
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w7)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_coda_w7, aes(x=factor(yintw_coda_w7))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 into 0`
* `R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w7 and 0 in w6, h_cpd_age = (year of interview w7-year of interview w6)/2+(year of interview w6 -ybirth)`
* `if h_cpd == 1 in w7 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo coda_w7}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_coda_w7 <- left_join(HRS_coda_w7, HRS_ds_coda, by = "id")

# Categorical variable harmonization
HRS_ds_coda_w7 <- tibble(id=HRS_coda_w7$id)
HRS_ds_coda_w7$h_cpd <- rep(999,length(HRS_coda_w7$id))
HRS_ds_coda_w7$h_cpd[which(((!is.na(HRS_coda_w7$R7LUNGE)) & HRS_coda_w7$R7LUNGE == 0) & (HRS_coda_w7$h_cpd != 1))] <- 0
HRS_ds_coda_w7$h_cpd[which(((!is.na(HRS_coda_w7$R7LUNGE)) & HRS_coda_w7$R7LUNGE == 1) | ((!is.na(HRS_coda_w7$h_cpd)) & (!is.na(HRS_coda_w7$R7LUNGE)) & HRS_coda_w7$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_coda_w7$h_cpd_age <- rep(999,length(HRS_coda_w7$id))
HRS_ds_coda_w7$h_cpd_age[which(HRS_ds_coda_w7$h_cpd == 0)] <- 996
HRS_ds_coda_w7$h_cpd_age[which(HRS_ds_coda_w7$h_cpd == 1 & HRS_coda_w7$h_cpd==0 & !HRS_coda_w7$ybirth %in% miss_values_vector & !(HRS_coda_w7$yintw_coda_w7 %in% miss_values_vector | HRS_coda_w7$yintw_coda_w6 %in% miss_values_vector))] <- floor((HRS_coda_w7$yintw_coda_w7[which(HRS_ds_coda_w7$h_cpd == 1 & HRS_coda_w7$h_cpd==0 & !HRS_coda_w7$ybirth %in% miss_values_vector & !(HRS_coda_w7$yintw_coda_w7 %in% miss_values_vector | HRS_coda_w7$yintw_coda_w6 %in% miss_values_vector))]+HRS_coda_w7$yintw_coda_w6[which(HRS_ds_coda_w7$h_cpd == 1 & HRS_coda_w7$h_cpd==0 & !HRS_coda_w7$ybirth %in% miss_values_vector & !(HRS_coda_w7$yintw_coda_w7 %in% miss_values_vector | HRS_coda_w7$yintw_coda_w6 %in% miss_values_vector))])/2-HRS_coda_w7$ybirth[which(HRS_ds_coda_w7$h_cpd == 1 & HRS_coda_w7$h_cpd==0 & !HRS_coda_w7$ybirth %in% miss_values_vector & !(HRS_coda_w7$yintw_coda_w7 %in% miss_values_vector | HRS_coda_w7$yintw_coda_w6 %in% miss_values_vector))])
HRS_ds_coda_w7$h_cpd_age[which(HRS_ds_coda_w7$h_cpd == 1 & !HRS_coda_w7$h_cpd_age %in% miss_values_vector)] <- HRS_coda_w7$h_cpd_age[which(HRS_ds_coda_w7$h_cpd == 1 & !HRS_coda_w7$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_coda[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_coda_w7,log_vec=(HRS_ds_prov$id %in% HRS_ds_coda_w7$id),col_end_index = 2, col_st_index = 3)
HRS_ds_coda$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_coda$h_cpd_age[which((HRS_ds_coda$id %in% HRS_ds_coda_w7$id) & (HRS_ds_coda$h_cpd != 999))] <- HRS_ds_coda_w7$h_cpd_age[which(HRS_ds_coda_w7$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript coda_w7, echo=F}

vbl <- HRS_ds_coda_w7$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_coda_w7, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_coda_w7$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_coda_w7 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation coda_w7, echo=F, results='asis'}

AfterH <- table(HRS_ds_coda_w7$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_coda_w7$R7LUNGE)) & HRS_coda_w7$R7LUNGE == 0) & (HRS_coda_w7$h_cpd != 1)),
  sum(((!is.na(HRS_coda_w7$R7LUNGE)) & HRS_coda_w7$R7LUNGE == 1) | ((!is.na(HRS_coda_w7$h_cpd)) & (!is.na(HRS_coda_w7$R7LUNGE)) & HRS_coda_w7$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_coda_w7$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_coda_w7)

```



### Wave 8

#### Study-specific variable description

| **Name** | `R8LUNGE` |`ybirth`|`yintw (coda_w8)`|`yintw (coda_w7)`|
|-|-|-|-|-|
| **Label** | `R8LUNGE:W8 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-CODA-w8`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign coda_w8, echo=F}

opal.assign.table.tibble(o, 'HRS_coda_w8','HRS.HRS-CODA-w8',variables=list('R8LUNGE'), missings = T)
HRS_coda_w8 <- opal.execute(o,'HRS_coda_w8')
load(paste0(datafolder,"coda_w8/ybirth.RData"))
HRS_coda_w8 <- left_join(HRS_coda_w8,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"coda_w7/yintw.RData"))
HRS_coda_w8 <- left_join(HRS_coda_w8,yintw, by="id")
names(HRS_coda_w8)[4] <- "yintw_coda_w7"
rm(yintw)
load(paste0(datafolder,"coda_w8/yintw.RData"))
HRS_coda_w8 <- left_join(HRS_coda_w8,yintw, by="id")
names(HRS_coda_w8)[5] <- "yintw_coda_w8"
rm(yintw)

```

```{r local coda_w8, echo=F}

vbl <- HRS_coda_w8$R8LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_coda_w8)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_coda_w8, aes(x=factor(R8LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w8$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w8)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_coda_w8 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w8$yintw_coda_w7
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w8)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_coda_w8, aes(x=factor(yintw_coda_w7))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w8$yintw_coda_w8
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w8)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_coda_w8, aes(x=factor(yintw_coda_w8))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 and R8LUNGE == 0 into 0`
* `R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 or R8LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w8 and 0 in w7, h_cpd_age = (year of interview w8-year of interview w7)/2+(year of interview w7 -ybirth)`
* `if h_cpd == 1 in w8 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo coda_w8}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_coda_w8 <- left_join(HRS_coda_w8, HRS_ds_coda, by = "id")

# Categorical variable harmonization
HRS_ds_coda_w8 <- tibble(id=HRS_coda_w8$id)
HRS_ds_coda_w8$h_cpd <- rep(999,length(HRS_coda_w8$id))
HRS_ds_coda_w8$h_cpd[which(((!is.na(HRS_coda_w8$R8LUNGE)) & HRS_coda_w8$R8LUNGE == 0) & (HRS_coda_w8$h_cpd != 1))] <- 0
HRS_ds_coda_w8$h_cpd[which(((!is.na(HRS_coda_w8$R8LUNGE)) & HRS_coda_w8$R8LUNGE == 1) | ((!is.na(HRS_coda_w8$h_cpd)) & (!is.na(HRS_coda_w8$R8LUNGE)) & HRS_coda_w8$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_coda_w8$h_cpd_age <- rep(999,length(HRS_coda_w8$id))
HRS_ds_coda_w8$h_cpd_age[which(HRS_ds_coda_w8$h_cpd == 0)] <- 996
HRS_ds_coda_w8$h_cpd_age[which(HRS_ds_coda_w8$h_cpd == 1 & HRS_coda_w8$h_cpd==0 & !HRS_coda_w8$ybirth %in% miss_values_vector & !(HRS_coda_w8$yintw_coda_w8 %in% miss_values_vector | HRS_coda_w8$yintw_coda_w7 %in% miss_values_vector))] <- floor((HRS_coda_w8$yintw_coda_w8[which(HRS_ds_coda_w8$h_cpd == 1 & HRS_coda_w8$h_cpd==0 & !HRS_coda_w8$ybirth %in% miss_values_vector & !(HRS_coda_w8$yintw_coda_w8 %in% miss_values_vector | HRS_coda_w8$yintw_coda_w7 %in% miss_values_vector))]+HRS_coda_w8$yintw_coda_w7[which(HRS_ds_coda_w8$h_cpd == 1 & HRS_coda_w8$h_cpd==0 & !HRS_coda_w8$ybirth %in% miss_values_vector & !(HRS_coda_w8$yintw_coda_w8 %in% miss_values_vector | HRS_coda_w8$yintw_coda_w7 %in% miss_values_vector))])/2-HRS_coda_w8$ybirth[which(HRS_ds_coda_w8$h_cpd == 1 & HRS_coda_w8$h_cpd==0 & !HRS_coda_w8$ybirth %in% miss_values_vector & !(HRS_coda_w8$yintw_coda_w8 %in% miss_values_vector | HRS_coda_w8$yintw_coda_w7 %in% miss_values_vector))])
HRS_ds_coda_w8$h_cpd_age[which(HRS_ds_coda_w8$h_cpd == 1 & !HRS_coda_w8$h_cpd_age %in% miss_values_vector)] <- HRS_coda_w8$h_cpd_age[which(HRS_ds_coda_w8$h_cpd == 1 & !HRS_coda_w8$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_coda[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_coda_w8,log_vec=(HRS_ds_prov$id %in% HRS_ds_coda_w8$id),col_end_index = 2, col_st_index = 3)
HRS_ds_coda$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_coda$h_cpd_age[which((HRS_ds_coda$id %in% HRS_ds_coda_w8$id) & (HRS_ds_coda$h_cpd != 999))] <- HRS_ds_coda_w8$h_cpd_age[which(HRS_ds_coda_w8$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript coda_w8, echo=F}

vbl <- HRS_ds_coda_w8$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_coda_w8, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_coda_w8$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_coda_w8 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation coda_w8, echo=F, results='asis'}

AfterH <- table(HRS_ds_coda_w8$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_coda_w8$R8LUNGE)) & HRS_coda_w8$R8LUNGE == 0) & (HRS_coda_w8$h_cpd != 1)),
  sum(((!is.na(HRS_coda_w8$R8LUNGE)) & HRS_coda_w8$R8LUNGE == 1) | ((!is.na(HRS_coda_w8$h_cpd)) & (!is.na(HRS_coda_w8$R8LUNGE)) & HRS_coda_w8$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_coda_w8$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_coda_w8)

```



### Wave 9

#### Study-specific variable description

| **Name** | `R9LUNGE` |`ybirth`|`yintw (coda_w9)`|`yintw (coda_w8)`|
|-|-|-|-|-|
| **Label** | `R9LUNGE:W9 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-CODA-w9`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign coda_w9, echo=F}

opal.assign.table.tibble(o, 'HRS_coda_w9','HRS.HRS-CODA-w9',variables=list('R9LUNGE'), missings = T)
HRS_coda_w9 <- opal.execute(o,'HRS_coda_w9')
load(paste0(datafolder,"coda_w9/ybirth.RData"))
HRS_coda_w9 <- left_join(HRS_coda_w9,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"coda_w8/yintw.RData"))
HRS_coda_w9 <- left_join(HRS_coda_w9,yintw, by="id")
names(HRS_coda_w9)[4] <- "yintw_coda_w8"
rm(yintw)
load(paste0(datafolder,"coda_w9/yintw.RData"))
HRS_coda_w9 <- left_join(HRS_coda_w9,yintw, by="id")
names(HRS_coda_w9)[5] <- "yintw_coda_w9"
rm(yintw)

```

```{r local coda_w9, echo=F}

vbl <- HRS_coda_w9$R9LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_coda_w9)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_coda_w9, aes(x=factor(R9LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w9$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w9)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_coda_w9 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w9$yintw_coda_w8
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w9)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_coda_w9, aes(x=factor(yintw_coda_w8))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w9$yintw_coda_w9
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w9)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_coda_w9, aes(x=factor(yintw_coda_w9))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 and R8LUNGE == 0 and R9LUNGE == 0 into 0`
* `R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 or R8LUNGE == 1 or R9LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w9 and 0 in w8, h_cpd_age = (year of interview w9-year of interview w8)/2+(year of interview w8 -ybirth)`
* `if h_cpd == 1 in w9 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo coda_w9}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_coda_w9 <- left_join(HRS_coda_w9, HRS_ds_coda, by = "id")

# Categorical variable harmonization
HRS_ds_coda_w9 <- tibble(id=HRS_coda_w9$id)
HRS_ds_coda_w9$h_cpd <- rep(999,length(HRS_coda_w9$id))
HRS_ds_coda_w9$h_cpd[which(((!is.na(HRS_coda_w9$R9LUNGE)) & HRS_coda_w9$R9LUNGE == 0) & (HRS_coda_w9$h_cpd != 1))] <- 0
HRS_ds_coda_w9$h_cpd[which(((!is.na(HRS_coda_w9$R9LUNGE)) & HRS_coda_w9$R9LUNGE == 1) | ((!is.na(HRS_coda_w9$h_cpd)) & (!is.na(HRS_coda_w9$R9LUNGE)) & HRS_coda_w9$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_coda_w9$h_cpd_age <- rep(999,length(HRS_coda_w9$id))
HRS_ds_coda_w9$h_cpd_age[which(HRS_ds_coda_w9$h_cpd == 0)] <- 996
HRS_ds_coda_w9$h_cpd_age[which(HRS_ds_coda_w9$h_cpd == 1 & HRS_coda_w9$h_cpd==0 & !HRS_coda_w9$ybirth %in% miss_values_vector & !(HRS_coda_w9$yintw_coda_w9 %in% miss_values_vector | HRS_coda_w9$yintw_coda_w8 %in% miss_values_vector))] <- floor((HRS_coda_w9$yintw_coda_w9[which(HRS_ds_coda_w9$h_cpd == 1 & HRS_coda_w9$h_cpd==0 & !HRS_coda_w9$ybirth %in% miss_values_vector & !(HRS_coda_w9$yintw_coda_w9 %in% miss_values_vector | HRS_coda_w9$yintw_coda_w8 %in% miss_values_vector))]+HRS_coda_w9$yintw_coda_w8[which(HRS_ds_coda_w9$h_cpd == 1 & HRS_coda_w9$h_cpd==0 & !HRS_coda_w9$ybirth %in% miss_values_vector & !(HRS_coda_w9$yintw_coda_w9 %in% miss_values_vector | HRS_coda_w9$yintw_coda_w8 %in% miss_values_vector))])/2-HRS_coda_w9$ybirth[which(HRS_ds_coda_w9$h_cpd == 1 & HRS_coda_w9$h_cpd==0 & !HRS_coda_w9$ybirth %in% miss_values_vector & !(HRS_coda_w9$yintw_coda_w9 %in% miss_values_vector | HRS_coda_w9$yintw_coda_w8 %in% miss_values_vector))])
HRS_ds_coda_w9$h_cpd_age[which(HRS_ds_coda_w9$h_cpd == 1 & !HRS_coda_w9$h_cpd_age %in% miss_values_vector)] <- HRS_coda_w9$h_cpd_age[which(HRS_ds_coda_w9$h_cpd == 1 & !HRS_coda_w9$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_coda[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_coda_w9,log_vec=(HRS_ds_prov$id %in% HRS_ds_coda_w9$id),col_end_index = 2, col_st_index = 3)
HRS_ds_coda$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_coda$h_cpd_age[which((HRS_ds_coda$id %in% HRS_ds_coda_w9$id) & (HRS_ds_coda$h_cpd != 999))] <- HRS_ds_coda_w9$h_cpd_age[which(HRS_ds_coda_w9$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript coda_w9, echo=F}

vbl <- HRS_ds_coda_w9$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_coda_w9, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_coda_w9$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_coda_w9 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation coda_w9, echo=F, results='asis'}

AfterH <- table(HRS_ds_coda_w9$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_coda_w9$R9LUNGE)) & HRS_coda_w9$R9LUNGE == 0) & (HRS_coda_w9$h_cpd != 1)),
  sum(((!is.na(HRS_coda_w9$R9LUNGE)) & HRS_coda_w9$R9LUNGE == 1) | ((!is.na(HRS_coda_w9$h_cpd)) & (!is.na(HRS_coda_w9$R9LUNGE)) & HRS_coda_w9$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_coda_w9$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_coda_w9)

```




### Wave 10

#### Study-specific variable description

| **Name** | `R10LUNGE` |`ybirth`|`yintw (coda_w10)`|`yintw (coda_w9)`|
|-|-|-|-|-|
| **Label** | `R10LUNGE:W10 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-CODA-w10`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign coda_w10, echo=F}

opal.assign.table.tibble(o, 'HRS_coda_w10','HRS.HRS-CODA-w10',variables=list('R10LUNGE'), missings = T)
HRS_coda_w10 <- opal.execute(o,'HRS_coda_w10')
load(paste0(datafolder,"coda_w10/ybirth.RData"))
HRS_coda_w10 <- left_join(HRS_coda_w10,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"coda_w9/yintw.RData"))
HRS_coda_w10 <- left_join(HRS_coda_w10,yintw, by="id")
names(HRS_coda_w10)[4] <- "yintw_coda_w9"
rm(yintw)
load(paste0(datafolder,"coda_w10/yintw.RData"))
HRS_coda_w10 <- left_join(HRS_coda_w10,yintw, by="id")
names(HRS_coda_w10)[5] <- "yintw_coda_w10"
rm(yintw)

```

```{r local coda_w10, echo=F}

vbl <- HRS_coda_w10$R10LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_coda_w10)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_coda_w10, aes(x=factor(R10LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w10$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w10)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_coda_w10 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w10$yintw_coda_w9
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w10)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_coda_w10, aes(x=factor(yintw_coda_w9))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w10$yintw_coda_w10
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w10)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_coda_w10, aes(x=factor(yintw_coda_w10))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 and R8LUNGE == 0 and R9LUNGE == 0 and R10LUNGE == 0 into 0`
* `R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 or R8LUNGE == 1 or R9LUNGE == 1 or R10LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w10 and 0 in w9, h_cpd_age = (year of interview w10-year of interview w9)/2+(year of interview w9 -ybirth)`
* `if h_cpd == 1 in w10 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo coda_w10}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_coda_w10 <- left_join(HRS_coda_w10, HRS_ds_coda, by = "id")

# Categorical variable harmonization
HRS_ds_coda_w10 <- tibble(id=HRS_coda_w10$id)
HRS_ds_coda_w10$h_cpd <- rep(999,length(HRS_coda_w10$id))
HRS_ds_coda_w10$h_cpd[which(((!is.na(HRS_coda_w10$R10LUNGE)) & HRS_coda_w10$R10LUNGE == 0) & (HRS_coda_w10$h_cpd != 1))] <- 0
HRS_ds_coda_w10$h_cpd[which(((!is.na(HRS_coda_w10$R10LUNGE)) & HRS_coda_w10$R10LUNGE == 1) | ((!is.na(HRS_coda_w10$h_cpd)) & (!is.na(HRS_coda_w10$R10LUNGE)) & HRS_coda_w10$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_coda_w10$h_cpd_age <- rep(999,length(HRS_coda_w10$id))
HRS_ds_coda_w10$h_cpd_age[which(HRS_ds_coda_w10$h_cpd == 0)] <- 996
HRS_ds_coda_w10$h_cpd_age[which(HRS_ds_coda_w10$h_cpd == 1 & HRS_coda_w10$h_cpd==0 & !HRS_coda_w10$ybirth %in% miss_values_vector & !(HRS_coda_w10$yintw_coda_w10 %in% miss_values_vector | HRS_coda_w10$yintw_coda_w9 %in% miss_values_vector))] <- floor((HRS_coda_w10$yintw_coda_w10[which(HRS_ds_coda_w10$h_cpd == 1 & HRS_coda_w10$h_cpd==0 & !HRS_coda_w10$ybirth %in% miss_values_vector & !(HRS_coda_w10$yintw_coda_w10 %in% miss_values_vector | HRS_coda_w10$yintw_coda_w9 %in% miss_values_vector))]+HRS_coda_w10$yintw_coda_w9[which(HRS_ds_coda_w10$h_cpd == 1 & HRS_coda_w10$h_cpd==0 & !HRS_coda_w10$ybirth %in% miss_values_vector & !(HRS_coda_w10$yintw_coda_w10 %in% miss_values_vector | HRS_coda_w10$yintw_coda_w9 %in% miss_values_vector))])/2-HRS_coda_w10$ybirth[which(HRS_ds_coda_w10$h_cpd == 1 & HRS_coda_w10$h_cpd==0 & !HRS_coda_w10$ybirth %in% miss_values_vector & !(HRS_coda_w10$yintw_coda_w10 %in% miss_values_vector | HRS_coda_w10$yintw_coda_w9 %in% miss_values_vector))])
HRS_ds_coda_w10$h_cpd_age[which(HRS_ds_coda_w10$h_cpd == 1 & !HRS_coda_w10$h_cpd_age %in% miss_values_vector)] <- HRS_coda_w10$h_cpd_age[which(HRS_ds_coda_w10$h_cpd == 1 & !HRS_coda_w10$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_coda[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_coda_w10,log_vec=(HRS_ds_prov$id %in% HRS_ds_coda_w10$id),col_end_index = 2, col_st_index = 3)
HRS_ds_coda$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_coda$h_cpd_age[which((HRS_ds_coda$id %in% HRS_ds_coda_w10$id) & (HRS_ds_coda$h_cpd != 999))] <- HRS_ds_coda_w10$h_cpd_age[which(HRS_ds_coda_w10$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript coda_w10, echo=F}

vbl <- HRS_ds_coda_w10$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_coda_w10, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_coda_w10$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_coda_w10 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation coda_w10, echo=F, results='asis'}

AfterH <- table(HRS_ds_coda_w10$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_coda_w10$R10LUNGE)) & HRS_coda_w10$R10LUNGE == 0) & (HRS_coda_w10$h_cpd != 1)),
  sum(((!is.na(HRS_coda_w10$R10LUNGE)) & HRS_coda_w10$R10LUNGE == 1) | ((!is.na(HRS_coda_w10$h_cpd)) & (!is.na(HRS_coda_w10$R10LUNGE)) & HRS_coda_w10$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_coda_w10$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_coda_w10)

```



### Wave 11

#### Study-specific variable description

| **Name** | `R11LUNGE` |`ybirth`|`yintw (coda_w11)`|`yintw (coda_w10)`|
|-|-|-|-|-|
| **Label** | `R11LUNGE:W11 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-CODA-w11`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign coda_w11, echo=F}

opal.assign.table.tibble(o, 'HRS_coda_w11','HRS.HRS-CODA-w11',variables=list('R11LUNGE'), missings = T)
HRS_coda_w11 <- opal.execute(o,'HRS_coda_w11')
load(paste0(datafolder,"coda_w11/ybirth.RData"))
HRS_coda_w11 <- left_join(HRS_coda_w11,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"coda_w10/yintw.RData"))
HRS_coda_w11 <- left_join(HRS_coda_w11,yintw, by="id")
names(HRS_coda_w11)[4] <- "yintw_coda_w10"
rm(yintw)
load(paste0(datafolder,"coda_w11/yintw.RData"))
HRS_coda_w11 <- left_join(HRS_coda_w11,yintw, by="id")
names(HRS_coda_w11)[5] <- "yintw_coda_w11"
rm(yintw)

```

```{r local coda_w11, echo=F}

vbl <- HRS_coda_w11$R11LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_coda_w11)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_coda_w11, aes(x=factor(R11LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w11$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w11)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_coda_w11 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w11$yintw_coda_w10
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w11)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_coda_w11, aes(x=factor(yintw_coda_w10))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_coda_w11$yintw_coda_w11
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_coda_w11)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_coda_w11, aes(x=factor(yintw_coda_w11))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 and R8LUNGE == 0 and R9LUNGE == 0 and R10LUNGE == 0 and R11LUNGE == 0 into 0`
* `R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 or R8LUNGE == 1 or R9LUNGE == 1 or R10LUNGE == 1 or R11LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w11 and 0 in w10, h_cpd_age = (year of interview w11-year of interview w10)/2+(year of interview w10 -ybirth)`
* `if h_cpd == 1 in w11 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo coda_w11}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_coda_w11 <- left_join(HRS_coda_w11, HRS_ds_coda, by = "id")

# Categorical variable harmonization
HRS_ds_coda_w11 <- tibble(id=HRS_coda_w11$id)
HRS_ds_coda_w11$h_cpd <- rep(999,length(HRS_coda_w11$id))
HRS_ds_coda_w11$h_cpd[which(((!is.na(HRS_coda_w11$R11LUNGE)) & HRS_coda_w11$R11LUNGE == 0) & (HRS_coda_w11$h_cpd != 1))] <- 0
HRS_ds_coda_w11$h_cpd[which(((!is.na(HRS_coda_w11$R11LUNGE)) & HRS_coda_w11$R11LUNGE == 1) | ((!is.na(HRS_coda_w11$h_cpd)) & (!is.na(HRS_coda_w11$R11LUNGE)) & HRS_coda_w11$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_coda_w11$h_cpd_age <- rep(999,length(HRS_coda_w11$id))
HRS_ds_coda_w11$h_cpd_age[which(HRS_ds_coda_w11$h_cpd == 0)] <- 996
HRS_ds_coda_w11$h_cpd_age[which(HRS_ds_coda_w11$h_cpd == 1 & HRS_coda_w11$h_cpd==0 & !HRS_coda_w11$ybirth %in% miss_values_vector & !(HRS_coda_w11$yintw_coda_w11 %in% miss_values_vector | HRS_coda_w11$yintw_coda_w10 %in% miss_values_vector))] <- floor((HRS_coda_w11$yintw_coda_w11[which(HRS_ds_coda_w11$h_cpd == 1 & HRS_coda_w11$h_cpd==0 & !HRS_coda_w11$ybirth %in% miss_values_vector & !(HRS_coda_w11$yintw_coda_w11 %in% miss_values_vector | HRS_coda_w11$yintw_coda_w10 %in% miss_values_vector))]+HRS_coda_w11$yintw_coda_w10[which(HRS_ds_coda_w11$h_cpd == 1 & HRS_coda_w11$h_cpd==0 & !HRS_coda_w11$ybirth %in% miss_values_vector & !(HRS_coda_w11$yintw_coda_w11 %in% miss_values_vector | HRS_coda_w11$yintw_coda_w10 %in% miss_values_vector))])/2-HRS_coda_w11$ybirth[which(HRS_ds_coda_w11$h_cpd == 1 & HRS_coda_w11$h_cpd==0 & !HRS_coda_w11$ybirth %in% miss_values_vector & !(HRS_coda_w11$yintw_coda_w11 %in% miss_values_vector | HRS_coda_w11$yintw_coda_w10 %in% miss_values_vector))])
HRS_ds_coda_w11$h_cpd_age[which(HRS_ds_coda_w11$h_cpd == 1 & !HRS_coda_w11$h_cpd_age %in% miss_values_vector)] <- HRS_coda_w11$h_cpd_age[which(HRS_ds_coda_w11$h_cpd == 1 & !HRS_coda_w11$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
rm(HRS_ds_coda)

```


#### Statistics of the new harmonized variable

```{r descript coda_w11, echo=F}

vbl <- HRS_ds_coda_w11$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_coda_w11, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_coda_w11$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_coda_w11 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation coda_w11, echo=F, results='asis'}

AfterH <- table(HRS_ds_coda_w11$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_coda_w11$R11LUNGE)) & HRS_coda_w11$R11LUNGE == 0) & (HRS_coda_w11$h_cpd != 1)),
  sum(((!is.na(HRS_coda_w11$R11LUNGE)) & HRS_coda_w11$R11LUNGE == 1) | ((!is.na(HRS_coda_w11$h_cpd)) & (!is.na(HRS_coda_w11$R11LUNGE)) & HRS_coda_w11$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_coda_w11$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_coda_w11)

```



## WB

### Wave 4

#### Study-specific variable description

| **Name** | `R4LUNGE` |
|-|-|
| **Label** | `R4LUNGE:W4 R ever had lung disease`|
| **Table name**  | `HRS-WB-w4`|
| **Categories** | `0 = no`<br/>`1 = yes` |
| **Missings** | `NA` |
| **Description** |  |

```{r assign wb_w4, echo=F}

opal.assign.table.tibble(o, 'HRS_wb_w4','HRS.HRS-WB-w4',variables=list('R4LUNGE'), missings = T)
HRS_wb_w4 <- opal.execute(o,'HRS_wb_w4')

```

```{r local wb_w4, echo=F}

vbl <- HRS_wb_w4$R4LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_wb_w4)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_wb_w4, aes(x=factor(R4LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `keep up 1 into 1`
* `keep up 0 into 0`
* `NA into 999`

Age of diagnosis cannot be harmonized.

**R script:**

```{r harmo wb_w4}

# Categorical variable harmonization
HRS_ds_wb_w4 <- tibble(id=HRS_wb_w4$id)
HRS_ds_wb_w4$h_cpd <- car::recode(HRS_wb_w4$R4LUNGE, "NA=999")

# We build a global table in order to have updated the status of all the individuals through the different waves
HRS_ds_wb <- HRS_ds_wb_w4
HRS_ds_wb$h_cpd_age <- rep(999,length(HRS_ds_wb$id))

```


#### Statistics of the new harmonized variable

```{r descript wb_w4, echo=F}

vbl <- HRS_ds_wb_w4$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_wb_w4, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

```


#### Validation

```{r crosstabulation wb_w4, echo=F}

AfterH <- table(HRS_ds_wb_w4$h_cpd, useNA = "ifany")
BeforeH <- table(HRS_wb_w4$R4LUNGE, useNA = "ifany")
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)
rm(HRS_wb_w4)

```



### Wave 5

#### Study-specific variable description

| **Name** | `R5LUNGE` |`ybirth`|`yintw (wb_w4)`|`yintw (wb_w5)`|
|-|-|-|-|-|
| **Label** | `R5LUNGE:W5 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-WB-w5`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign wb_w5, echo=F}

opal.assign.table.tibble(o, 'HRS_wb_w5','HRS.HRS-WB-w5',variables=list('R5LUNGE'), missings = T)
HRS_wb_w5 <- opal.execute(o,'HRS_wb_w5')
load(paste0(datafolder,"wb_w5/ybirth.RData"))
HRS_wb_w5 <- left_join(HRS_wb_w5,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"wb_w4/yintw.RData"))
HRS_wb_w5 <- left_join(HRS_wb_w5,yintw, by="id")
names(HRS_wb_w5)[4] <- "yintw_wb_w4"
rm(yintw)
load(paste0(datafolder,"wb_w5/yintw.RData"))
HRS_wb_w5 <- left_join(HRS_wb_w5,yintw, by="id")
names(HRS_wb_w5)[5] <- "yintw_wb_w5"
rm(yintw)

```

```{r local wb_w5, echo=F}

vbl <- HRS_wb_w5$R5LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_wb_w5)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_wb_w5, aes(x=factor(R5LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w5$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w5)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_wb_w5 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w5$yintw_wb_w4
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w5)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_wb_w5, aes(x=factor(yintw_wb_w4))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w5$yintw_wb_w5
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w5)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_wb_w5, aes(x=factor(yintw_wb_w5))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R4LUNGE == 0 and R5LUNGE == 0 into 0`
* `R4LUNGE == 1 or R5LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w5 and 0 in w4, h_cpd_age = (year of interview w5-year of interview w4)/2+(year of interview w4 -ybirth)`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo wb_w5}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_wb_w5 <- left_join(HRS_wb_w5, HRS_ds_wb, by = "id")

# Categorical variable harmonization
HRS_ds_wb_w5 <- tibble(id=HRS_wb_w5$id)
HRS_ds_wb_w5$h_cpd <- rep(999,length(HRS_wb_w5$id))
HRS_ds_wb_w5$h_cpd[which(((!is.na(HRS_wb_w5$R5LUNGE)) & HRS_wb_w5$R5LUNGE == 0) & (HRS_wb_w5$h_cpd != 1))] <- 0
HRS_ds_wb_w5$h_cpd[which(((!is.na(HRS_wb_w5$R5LUNGE)) & HRS_wb_w5$R5LUNGE == 1) | ((!is.na(HRS_wb_w5$h_cpd)) & (!is.na(HRS_wb_w5$R5LUNGE)) & HRS_wb_w5$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_wb_w5$h_cpd_age <- rep(999,length(HRS_wb_w5$id))
HRS_ds_wb_w5$h_cpd_age[which(HRS_ds_wb_w5$h_cpd == 0)] <- 996
HRS_ds_wb_w5$h_cpd_age[which(HRS_ds_wb_w5$h_cpd == 1 & HRS_wb_w5$h_cpd==0 & !HRS_wb_w5$ybirth %in% miss_values_vector & !(HRS_wb_w5$yintw_wb_w5 %in% miss_values_vector | HRS_wb_w5$yintw_wb_w4 %in% miss_values_vector))] <- floor((HRS_wb_w5$yintw_wb_w5[which(HRS_ds_wb_w5$h_cpd == 1 & HRS_wb_w5$h_cpd==0 & !HRS_wb_w5$ybirth %in% miss_values_vector & !(HRS_wb_w5$yintw_wb_w5 %in% miss_values_vector | HRS_wb_w5$yintw_wb_w4 %in% miss_values_vector))]+HRS_wb_w5$yintw_wb_w4[which(HRS_ds_wb_w5$h_cpd == 1 & HRS_wb_w5$h_cpd==0 & !HRS_wb_w5$ybirth %in% miss_values_vector & !(HRS_wb_w5$yintw_wb_w5 %in% miss_values_vector | HRS_wb_w5$yintw_wb_w4 %in% miss_values_vector))])/2-HRS_wb_w5$ybirth[which(HRS_ds_wb_w5$h_cpd == 1 & HRS_wb_w5$h_cpd==0 & !HRS_wb_w5$ybirth %in% miss_values_vector & !(HRS_wb_w5$yintw_wb_w5 %in% miss_values_vector | HRS_wb_w5$yintw_wb_w4 %in% miss_values_vector))])

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_wb[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_wb_w5,log_vec=(HRS_ds_prov$id %in% HRS_ds_wb_w5$id),col_end_index = 2, col_st_index = 3)
HRS_ds_wb$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_wb$h_cpd_age[which((HRS_ds_wb$id %in% HRS_ds_wb_w5$id) & (HRS_ds_wb$h_cpd != 999))] <- HRS_ds_wb_w5$h_cpd_age[which(HRS_ds_wb_w5$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript wb_w5, echo=F}

vbl <- HRS_ds_wb_w5$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_wb_w5, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_wb_w5$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_wb_w5 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation wb_w5, echo=F, results='asis'}

AfterH <- table(HRS_ds_wb_w5$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_wb_w5$R5LUNGE)) & HRS_wb_w5$R5LUNGE == 0) & (HRS_wb_w5$h_cpd != 1)),
  sum(((!is.na(HRS_wb_w5$R5LUNGE)) & HRS_wb_w5$R5LUNGE == 1) | ((!is.na(HRS_wb_w5$h_cpd)) & (!is.na(HRS_wb_w5$R5LUNGE)) & HRS_wb_w5$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_wb_w5$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_wb_w5)

```




### Wave 6

#### Study-specific variable description

| **Name** | `R6LUNGE` |`ybirth`|`yintw (wb_w5)`|`yintw (wb_w6)`|
|-|-|-|-|-|
| **Label** | `R6LUNGE:W6 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-WB-w6`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign wb_w6, echo=F}

opal.assign.table.tibble(o, 'HRS_wb_w6','HRS.HRS-WB-w6',variables=list('R6LUNGE'), missings = T)
HRS_wb_w6 <- opal.execute(o,'HRS_wb_w6')
load(paste0(datafolder,"wb_w6/ybirth.RData"))
HRS_wb_w6 <- left_join(HRS_wb_w6,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"wb_w5/yintw.RData"))
HRS_wb_w6 <- left_join(HRS_wb_w6,yintw, by="id")
names(HRS_wb_w6)[4] <- "yintw_wb_w5"
rm(yintw)
load(paste0(datafolder,"wb_w6/yintw.RData"))
HRS_wb_w6 <- left_join(HRS_wb_w6,yintw, by="id")
names(HRS_wb_w6)[5] <- "yintw_wb_w6"
rm(yintw)

```

```{r local wb_w6, echo=F}

vbl <- HRS_wb_w6$R6LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_wb_w6)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_wb_w6, aes(x=factor(R6LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w6$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w6)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_wb_w6 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w6$yintw_wb_w5
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w6)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_wb_w6, aes(x=factor(yintw_wb_w5))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w6$yintw_wb_w6
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w6)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_wb_w6, aes(x=factor(yintw_wb_w6))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 into 0`
* `R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w6 and 0 in w5, h_cpd_age = (year of interview w6-year of interview w5)/2+(year of interview w5 -ybirth)`
* `if h_cpd == 1 in w6 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo wb_w6}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_wb_w6 <- left_join(HRS_wb_w6, HRS_ds_wb, by = "id")

# Categorical variable harmonization
HRS_ds_wb_w6 <- tibble(id=HRS_wb_w6$id)
HRS_ds_wb_w6$h_cpd <- rep(999,length(HRS_wb_w6$id))
HRS_ds_wb_w6$h_cpd[which(((!is.na(HRS_wb_w6$R6LUNGE)) & HRS_wb_w6$R6LUNGE == 0) & (HRS_wb_w6$h_cpd != 1))] <- 0
HRS_ds_wb_w6$h_cpd[which(((!is.na(HRS_wb_w6$R6LUNGE)) & HRS_wb_w6$R6LUNGE == 1) | ((!is.na(HRS_wb_w6$h_cpd)) & (!is.na(HRS_wb_w6$R6LUNGE)) & HRS_wb_w6$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_wb_w6$h_cpd_age <- rep(999,length(HRS_wb_w6$id))
HRS_ds_wb_w6$h_cpd_age[which(HRS_ds_wb_w6$h_cpd == 0)] <- 996
HRS_ds_wb_w6$h_cpd_age[which(HRS_ds_wb_w6$h_cpd == 1 & HRS_wb_w6$h_cpd==0 & !HRS_wb_w6$ybirth %in% miss_values_vector & !(HRS_wb_w6$yintw_wb_w6 %in% miss_values_vector | HRS_wb_w6$yintw_wb_w5 %in% miss_values_vector))] <- floor((HRS_wb_w6$yintw_wb_w6[which(HRS_ds_wb_w6$h_cpd == 1 & HRS_wb_w6$h_cpd==0 & !HRS_wb_w6$ybirth %in% miss_values_vector & !(HRS_wb_w6$yintw_wb_w6 %in% miss_values_vector | HRS_wb_w6$yintw_wb_w5 %in% miss_values_vector))]+HRS_wb_w6$yintw_wb_w5[which(HRS_ds_wb_w6$h_cpd == 1 & HRS_wb_w6$h_cpd==0 & !HRS_wb_w6$ybirth %in% miss_values_vector & !(HRS_wb_w6$yintw_wb_w6 %in% miss_values_vector | HRS_wb_w6$yintw_wb_w5 %in% miss_values_vector))])/2-HRS_wb_w6$ybirth[which(HRS_ds_wb_w6$h_cpd == 1 & HRS_wb_w6$h_cpd==0 & !HRS_wb_w6$ybirth %in% miss_values_vector & !(HRS_wb_w6$yintw_wb_w6 %in% miss_values_vector | HRS_wb_w6$yintw_wb_w5 %in% miss_values_vector))])
HRS_ds_wb_w6$h_cpd_age[which(HRS_ds_wb_w6$h_cpd == 1 & !HRS_wb_w6$h_cpd_age %in% miss_values_vector)] <- HRS_wb_w6$h_cpd_age[which(HRS_ds_wb_w6$h_cpd == 1 & !HRS_wb_w6$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_wb[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_wb_w6,log_vec=(HRS_ds_prov$id %in% HRS_ds_wb_w6$id),col_end_index = 2, col_st_index = 3)
HRS_ds_wb$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_wb$h_cpd_age[which((HRS_ds_wb$id %in% HRS_ds_wb_w6$id) & (HRS_ds_wb$h_cpd != 999))] <- HRS_ds_wb_w6$h_cpd_age[which(HRS_ds_wb_w6$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript wb_w6, echo=F}

vbl <- HRS_ds_wb_w6$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_wb_w6, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_wb_w6$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_wb_w6 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation wb_w6, echo=F, results='asis'}

AfterH <- table(HRS_ds_wb_w6$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_wb_w6$R6LUNGE)) & HRS_wb_w6$R6LUNGE == 0) & (HRS_wb_w6$h_cpd != 1)),
  sum(((!is.na(HRS_wb_w6$R6LUNGE)) & HRS_wb_w6$R6LUNGE == 1) | ((!is.na(HRS_wb_w6$h_cpd)) & (!is.na(HRS_wb_w6$R6LUNGE)) & HRS_wb_w6$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_wb_w6$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_wb_w6)

```




### Wave 7

#### Study-specific variable description

| **Name** | `R7LUNGE` |`ybirth`|`yintw (wb_w7)`|`yintw (wb_w6)`|
|-|-|-|-|-|
| **Label** | `R7LUNGE:W7 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-WB-w7`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign wb_w7, echo=F}

opal.assign.table.tibble(o, 'HRS_wb_w7','HRS.HRS-WB-w7',variables=list('R7LUNGE'), missings = T)
HRS_wb_w7 <- opal.execute(o,'HRS_wb_w7')
load(paste0(datafolder,"wb_w7/ybirth.RData"))
HRS_wb_w7 <- left_join(HRS_wb_w7,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"wb_w6/yintw.RData"))
HRS_wb_w7 <- left_join(HRS_wb_w7,yintw, by="id")
names(HRS_wb_w7)[4] <- "yintw_wb_w6"
rm(yintw)
load(paste0(datafolder,"wb_w7/yintw.RData"))
HRS_wb_w7 <- left_join(HRS_wb_w7,yintw, by="id")
names(HRS_wb_w7)[5] <- "yintw_wb_w7"
rm(yintw)

```

```{r local wb_w7, echo=F}

vbl <- HRS_wb_w7$R7LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_wb_w7)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_wb_w7, aes(x=factor(R7LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w7$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w7)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_wb_w7 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w7$yintw_wb_w6
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w7)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_wb_w7, aes(x=factor(yintw_wb_w6))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w7$yintw_wb_w7
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w7)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_wb_w7, aes(x=factor(yintw_wb_w7))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 into 0`
* `R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w7 and 0 in w6, h_cpd_age = (year of interview w7-year of interview w6)/2+(year of interview w6 -ybirth)`
* `if h_cpd == 1 in w7 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo wb_w7}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_wb_w7 <- left_join(HRS_wb_w7, HRS_ds_wb, by = "id")

# Categorical variable harmonization
HRS_ds_wb_w7 <- tibble(id=HRS_wb_w7$id)
HRS_ds_wb_w7$h_cpd <- rep(999,length(HRS_wb_w7$id))
HRS_ds_wb_w7$h_cpd[which(((!is.na(HRS_wb_w7$R7LUNGE)) & HRS_wb_w7$R7LUNGE == 0) & (HRS_wb_w7$h_cpd != 1))] <- 0
HRS_ds_wb_w7$h_cpd[which(((!is.na(HRS_wb_w7$R7LUNGE)) & HRS_wb_w7$R7LUNGE == 1) | ((!is.na(HRS_wb_w7$h_cpd)) & (!is.na(HRS_wb_w7$R7LUNGE)) & HRS_wb_w7$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_wb_w7$h_cpd_age <- rep(999,length(HRS_wb_w7$id))
HRS_ds_wb_w7$h_cpd_age[which(HRS_ds_wb_w7$h_cpd == 0)] <- 996
HRS_ds_wb_w7$h_cpd_age[which(HRS_ds_wb_w7$h_cpd == 1 & HRS_wb_w7$h_cpd==0 & !HRS_wb_w7$ybirth %in% miss_values_vector & !(HRS_wb_w7$yintw_wb_w7 %in% miss_values_vector | HRS_wb_w7$yintw_wb_w6 %in% miss_values_vector))] <- floor((HRS_wb_w7$yintw_wb_w7[which(HRS_ds_wb_w7$h_cpd == 1 & HRS_wb_w7$h_cpd==0 & !HRS_wb_w7$ybirth %in% miss_values_vector & !(HRS_wb_w7$yintw_wb_w7 %in% miss_values_vector | HRS_wb_w7$yintw_wb_w6 %in% miss_values_vector))]+HRS_wb_w7$yintw_wb_w6[which(HRS_ds_wb_w7$h_cpd == 1 & HRS_wb_w7$h_cpd==0 & !HRS_wb_w7$ybirth %in% miss_values_vector & !(HRS_wb_w7$yintw_wb_w7 %in% miss_values_vector | HRS_wb_w7$yintw_wb_w6 %in% miss_values_vector))])/2-HRS_wb_w7$ybirth[which(HRS_ds_wb_w7$h_cpd == 1 & HRS_wb_w7$h_cpd==0 & !HRS_wb_w7$ybirth %in% miss_values_vector & !(HRS_wb_w7$yintw_wb_w7 %in% miss_values_vector | HRS_wb_w7$yintw_wb_w6 %in% miss_values_vector))])
HRS_ds_wb_w7$h_cpd_age[which(HRS_ds_wb_w7$h_cpd == 1 & !HRS_wb_w7$h_cpd_age %in% miss_values_vector)] <- HRS_wb_w7$h_cpd_age[which(HRS_ds_wb_w7$h_cpd == 1 & !HRS_wb_w7$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_wb[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_wb_w7,log_vec=(HRS_ds_prov$id %in% HRS_ds_wb_w7$id),col_end_index = 2, col_st_index = 3)
HRS_ds_wb$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_wb$h_cpd_age[which((HRS_ds_wb$id %in% HRS_ds_wb_w7$id) & (HRS_ds_wb$h_cpd != 999))] <- HRS_ds_wb_w7$h_cpd_age[which(HRS_ds_wb_w7$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript wb_w7, echo=F}

vbl <- HRS_ds_wb_w7$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_wb_w7, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_wb_w7$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_wb_w7 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation wb_w7, echo=F, results='asis'}

AfterH <- table(HRS_ds_wb_w7$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_wb_w7$R7LUNGE)) & HRS_wb_w7$R7LUNGE == 0) & (HRS_wb_w7$h_cpd != 1)),
  sum(((!is.na(HRS_wb_w7$R7LUNGE)) & HRS_wb_w7$R7LUNGE == 1) | ((!is.na(HRS_wb_w7$h_cpd)) & (!is.na(HRS_wb_w7$R7LUNGE)) & HRS_wb_w7$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_wb_w7$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_wb_w7)

```



### Wave 8

#### Study-specific variable description

| **Name** | `R8LUNGE` |`ybirth`|`yintw (wb_w8)`|`yintw (wb_w7)`|
|-|-|-|-|-|
| **Label** | `R8LUNGE:W8 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-WB-w8`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign wb_w8, echo=F}

opal.assign.table.tibble(o, 'HRS_wb_w8','HRS.HRS-WB-w8',variables=list('R8LUNGE'), missings = T)
HRS_wb_w8 <- opal.execute(o,'HRS_wb_w8')
load(paste0(datafolder,"wb_w8/ybirth.RData"))
HRS_wb_w8 <- left_join(HRS_wb_w8,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"wb_w7/yintw.RData"))
HRS_wb_w8 <- left_join(HRS_wb_w8,yintw, by="id")
names(HRS_wb_w8)[4] <- "yintw_wb_w7"
rm(yintw)
load(paste0(datafolder,"wb_w8/yintw.RData"))
HRS_wb_w8 <- left_join(HRS_wb_w8,yintw, by="id")
names(HRS_wb_w8)[5] <- "yintw_wb_w8"
rm(yintw)

```

```{r local wb_w8, echo=F}

vbl <- HRS_wb_w8$R8LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_wb_w8)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_wb_w8, aes(x=factor(R8LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w8$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w8)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_wb_w8 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w8$yintw_wb_w7
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w8)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_wb_w8, aes(x=factor(yintw_wb_w7))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w8$yintw_wb_w8
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w8)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_wb_w8, aes(x=factor(yintw_wb_w8))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 and R8LUNGE == 0 into 0`
* `R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 or R8LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w8 and 0 in w7, h_cpd_age = (year of interview w8-year of interview w7)/2+(year of interview w7 -ybirth)`
* `if h_cpd == 1 in w8 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo wb_w8}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_wb_w8 <- left_join(HRS_wb_w8, HRS_ds_wb, by = "id")

# Categorical variable harmonization
HRS_ds_wb_w8 <- tibble(id=HRS_wb_w8$id)
HRS_ds_wb_w8$h_cpd <- rep(999,length(HRS_wb_w8$id))
HRS_ds_wb_w8$h_cpd[which(((!is.na(HRS_wb_w8$R8LUNGE)) & HRS_wb_w8$R8LUNGE == 0) & (HRS_wb_w8$h_cpd != 1))] <- 0
HRS_ds_wb_w8$h_cpd[which(((!is.na(HRS_wb_w8$R8LUNGE)) & HRS_wb_w8$R8LUNGE == 1) | ((!is.na(HRS_wb_w8$h_cpd)) & (!is.na(HRS_wb_w8$R8LUNGE)) & HRS_wb_w8$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_wb_w8$h_cpd_age <- rep(999,length(HRS_wb_w8$id))
HRS_ds_wb_w8$h_cpd_age[which(HRS_ds_wb_w8$h_cpd == 0)] <- 996
HRS_ds_wb_w8$h_cpd_age[which(HRS_ds_wb_w8$h_cpd == 1 & HRS_wb_w8$h_cpd==0 & !HRS_wb_w8$ybirth %in% miss_values_vector & !(HRS_wb_w8$yintw_wb_w8 %in% miss_values_vector | HRS_wb_w8$yintw_wb_w7 %in% miss_values_vector))] <- floor((HRS_wb_w8$yintw_wb_w8[which(HRS_ds_wb_w8$h_cpd == 1 & HRS_wb_w8$h_cpd==0 & !HRS_wb_w8$ybirth %in% miss_values_vector & !(HRS_wb_w8$yintw_wb_w8 %in% miss_values_vector | HRS_wb_w8$yintw_wb_w7 %in% miss_values_vector))]+HRS_wb_w8$yintw_wb_w7[which(HRS_ds_wb_w8$h_cpd == 1 & HRS_wb_w8$h_cpd==0 & !HRS_wb_w8$ybirth %in% miss_values_vector & !(HRS_wb_w8$yintw_wb_w8 %in% miss_values_vector | HRS_wb_w8$yintw_wb_w7 %in% miss_values_vector))])/2-HRS_wb_w8$ybirth[which(HRS_ds_wb_w8$h_cpd == 1 & HRS_wb_w8$h_cpd==0 & !HRS_wb_w8$ybirth %in% miss_values_vector & !(HRS_wb_w8$yintw_wb_w8 %in% miss_values_vector | HRS_wb_w8$yintw_wb_w7 %in% miss_values_vector))])
HRS_ds_wb_w8$h_cpd_age[which(HRS_ds_wb_w8$h_cpd == 1 & !HRS_wb_w8$h_cpd_age %in% miss_values_vector)] <- HRS_wb_w8$h_cpd_age[which(HRS_ds_wb_w8$h_cpd == 1 & !HRS_wb_w8$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_wb[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_wb_w8,log_vec=(HRS_ds_prov$id %in% HRS_ds_wb_w8$id),col_end_index = 2, col_st_index = 3)
HRS_ds_wb$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_wb$h_cpd_age[which((HRS_ds_wb$id %in% HRS_ds_wb_w8$id) & (HRS_ds_wb$h_cpd != 999))] <- HRS_ds_wb_w8$h_cpd_age[which(HRS_ds_wb_w8$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript wb_w8, echo=F}

vbl <- HRS_ds_wb_w8$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_wb_w8, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_wb_w8$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_wb_w8 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation wb_w8, echo=F, results='asis'}

AfterH <- table(HRS_ds_wb_w8$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_wb_w8$R8LUNGE)) & HRS_wb_w8$R8LUNGE == 0) & (HRS_wb_w8$h_cpd != 1)),
  sum(((!is.na(HRS_wb_w8$R8LUNGE)) & HRS_wb_w8$R8LUNGE == 1) | ((!is.na(HRS_wb_w8$h_cpd)) & (!is.na(HRS_wb_w8$R8LUNGE)) & HRS_wb_w8$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_wb_w8$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_wb_w8)

```



### Wave 9

#### Study-specific variable description

| **Name** | `R9LUNGE` |`ybirth`|`yintw (wb_w9)`|`yintw (wb_w8)`|
|-|-|-|-|-|
| **Label** | `R9LUNGE:W9 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-WB-w9`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign wb_w9, echo=F}

opal.assign.table.tibble(o, 'HRS_wb_w9','HRS.HRS-WB-w9',variables=list('R9LUNGE'), missings = T)
HRS_wb_w9 <- opal.execute(o,'HRS_wb_w9')
load(paste0(datafolder,"wb_w9/ybirth.RData"))
HRS_wb_w9 <- left_join(HRS_wb_w9,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"wb_w8/yintw.RData"))
HRS_wb_w9 <- left_join(HRS_wb_w9,yintw, by="id")
names(HRS_wb_w9)[4] <- "yintw_wb_w8"
rm(yintw)
load(paste0(datafolder,"wb_w9/yintw.RData"))
HRS_wb_w9 <- left_join(HRS_wb_w9,yintw, by="id")
names(HRS_wb_w9)[5] <- "yintw_wb_w9"
rm(yintw)

```

```{r local wb_w9, echo=F}

vbl <- HRS_wb_w9$R9LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_wb_w9)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_wb_w9, aes(x=factor(R9LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w9$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w9)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_wb_w9 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w9$yintw_wb_w8
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w9)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_wb_w9, aes(x=factor(yintw_wb_w8))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w9$yintw_wb_w9
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w9)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_wb_w9, aes(x=factor(yintw_wb_w9))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 and R8LUNGE == 0 and R9LUNGE == 0 into 0`
* `R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 or R8LUNGE == 1 or R9LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w9 and 0 in w8, h_cpd_age = (year of interview w9-year of interview w8)/2+(year of interview w8 -ybirth)`
* `if h_cpd == 1 in w9 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo wb_w9}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_wb_w9 <- left_join(HRS_wb_w9, HRS_ds_wb, by = "id")

# Categorical variable harmonization
HRS_ds_wb_w9 <- tibble(id=HRS_wb_w9$id)
HRS_ds_wb_w9$h_cpd <- rep(999,length(HRS_wb_w9$id))
HRS_ds_wb_w9$h_cpd[which(((!is.na(HRS_wb_w9$R9LUNGE)) & HRS_wb_w9$R9LUNGE == 0) & (HRS_wb_w9$h_cpd != 1))] <- 0
HRS_ds_wb_w9$h_cpd[which(((!is.na(HRS_wb_w9$R9LUNGE)) & HRS_wb_w9$R9LUNGE == 1) | ((!is.na(HRS_wb_w9$h_cpd)) & (!is.na(HRS_wb_w9$R9LUNGE)) & HRS_wb_w9$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_wb_w9$h_cpd_age <- rep(999,length(HRS_wb_w9$id))
HRS_ds_wb_w9$h_cpd_age[which(HRS_ds_wb_w9$h_cpd == 0)] <- 996
HRS_ds_wb_w9$h_cpd_age[which(HRS_ds_wb_w9$h_cpd == 1 & HRS_wb_w9$h_cpd==0 & !HRS_wb_w9$ybirth %in% miss_values_vector & !(HRS_wb_w9$yintw_wb_w9 %in% miss_values_vector | HRS_wb_w9$yintw_wb_w8 %in% miss_values_vector))] <- floor((HRS_wb_w9$yintw_wb_w9[which(HRS_ds_wb_w9$h_cpd == 1 & HRS_wb_w9$h_cpd==0 & !HRS_wb_w9$ybirth %in% miss_values_vector & !(HRS_wb_w9$yintw_wb_w9 %in% miss_values_vector | HRS_wb_w9$yintw_wb_w8 %in% miss_values_vector))]+HRS_wb_w9$yintw_wb_w8[which(HRS_ds_wb_w9$h_cpd == 1 & HRS_wb_w9$h_cpd==0 & !HRS_wb_w9$ybirth %in% miss_values_vector & !(HRS_wb_w9$yintw_wb_w9 %in% miss_values_vector | HRS_wb_w9$yintw_wb_w8 %in% miss_values_vector))])/2-HRS_wb_w9$ybirth[which(HRS_ds_wb_w9$h_cpd == 1 & HRS_wb_w9$h_cpd==0 & !HRS_wb_w9$ybirth %in% miss_values_vector & !(HRS_wb_w9$yintw_wb_w9 %in% miss_values_vector | HRS_wb_w9$yintw_wb_w8 %in% miss_values_vector))])
HRS_ds_wb_w9$h_cpd_age[which(HRS_ds_wb_w9$h_cpd == 1 & !HRS_wb_w9$h_cpd_age %in% miss_values_vector)] <- HRS_wb_w9$h_cpd_age[which(HRS_ds_wb_w9$h_cpd == 1 & !HRS_wb_w9$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_wb[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_wb_w9,log_vec=(HRS_ds_prov$id %in% HRS_ds_wb_w9$id),col_end_index = 2, col_st_index = 3)
HRS_ds_wb$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_wb$h_cpd_age[which((HRS_ds_wb$id %in% HRS_ds_wb_w9$id) & (HRS_ds_wb$h_cpd != 999))] <- HRS_ds_wb_w9$h_cpd_age[which(HRS_ds_wb_w9$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript wb_w9, echo=F}

vbl <- HRS_ds_wb_w9$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_wb_w9, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_wb_w9$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_wb_w9 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation wb_w9, echo=F, results='asis'}

AfterH <- table(HRS_ds_wb_w9$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_wb_w9$R9LUNGE)) & HRS_wb_w9$R9LUNGE == 0) & (HRS_wb_w9$h_cpd != 1)),
  sum(((!is.na(HRS_wb_w9$R9LUNGE)) & HRS_wb_w9$R9LUNGE == 1) | ((!is.na(HRS_wb_w9$h_cpd)) & (!is.na(HRS_wb_w9$R9LUNGE)) & HRS_wb_w9$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_wb_w9$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_wb_w9)

```




### Wave 10

#### Study-specific variable description

| **Name** | `R10LUNGE` |`ybirth`|`yintw (wb_w10)`|`yintw (wb_w9)`|
|-|-|-|-|-|
| **Label** | `R10LUNGE:W10 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-WB-w10`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign wb_w10, echo=F}

opal.assign.table.tibble(o, 'HRS_wb_w10','HRS.HRS-WB-w10',variables=list('R10LUNGE'), missings = T)
HRS_wb_w10 <- opal.execute(o,'HRS_wb_w10')
load(paste0(datafolder,"wb_w10/ybirth.RData"))
HRS_wb_w10 <- left_join(HRS_wb_w10,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"wb_w9/yintw.RData"))
HRS_wb_w10 <- left_join(HRS_wb_w10,yintw, by="id")
names(HRS_wb_w10)[4] <- "yintw_wb_w9"
rm(yintw)
load(paste0(datafolder,"wb_w10/yintw.RData"))
HRS_wb_w10 <- left_join(HRS_wb_w10,yintw, by="id")
names(HRS_wb_w10)[5] <- "yintw_wb_w10"
rm(yintw)

```

```{r local wb_w10, echo=F}

vbl <- HRS_wb_w10$R10LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_wb_w10)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_wb_w10, aes(x=factor(R10LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w10$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w10)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_wb_w10 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w10$yintw_wb_w9
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w10)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_wb_w10, aes(x=factor(yintw_wb_w9))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w10$yintw_wb_w10
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w10)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_wb_w10, aes(x=factor(yintw_wb_w10))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 and R8LUNGE == 0 and R9LUNGE == 0 and R10LUNGE == 0 into 0`
* `R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 or R8LUNGE == 1 or R9LUNGE == 1 or R10LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w10 and 0 in w9, h_cpd_age = (year of interview w10-year of interview w9)/2+(year of interview w9 -ybirth)`
* `if h_cpd == 1 in w10 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo wb_w10}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_wb_w10 <- left_join(HRS_wb_w10, HRS_ds_wb, by = "id")

# Categorical variable harmonization
HRS_ds_wb_w10 <- tibble(id=HRS_wb_w10$id)
HRS_ds_wb_w10$h_cpd <- rep(999,length(HRS_wb_w10$id))
HRS_ds_wb_w10$h_cpd[which(((!is.na(HRS_wb_w10$R10LUNGE)) & HRS_wb_w10$R10LUNGE == 0) & (HRS_wb_w10$h_cpd != 1))] <- 0
HRS_ds_wb_w10$h_cpd[which(((!is.na(HRS_wb_w10$R10LUNGE)) & HRS_wb_w10$R10LUNGE == 1) | ((!is.na(HRS_wb_w10$h_cpd)) & (!is.na(HRS_wb_w10$R10LUNGE)) & HRS_wb_w10$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_wb_w10$h_cpd_age <- rep(999,length(HRS_wb_w10$id))
HRS_ds_wb_w10$h_cpd_age[which(HRS_ds_wb_w10$h_cpd == 0)] <- 996
HRS_ds_wb_w10$h_cpd_age[which(HRS_ds_wb_w10$h_cpd == 1 & HRS_wb_w10$h_cpd==0 & !HRS_wb_w10$ybirth %in% miss_values_vector & !(HRS_wb_w10$yintw_wb_w10 %in% miss_values_vector | HRS_wb_w10$yintw_wb_w9 %in% miss_values_vector))] <- floor((HRS_wb_w10$yintw_wb_w10[which(HRS_ds_wb_w10$h_cpd == 1 & HRS_wb_w10$h_cpd==0 & !HRS_wb_w10$ybirth %in% miss_values_vector & !(HRS_wb_w10$yintw_wb_w10 %in% miss_values_vector | HRS_wb_w10$yintw_wb_w9 %in% miss_values_vector))]+HRS_wb_w10$yintw_wb_w9[which(HRS_ds_wb_w10$h_cpd == 1 & HRS_wb_w10$h_cpd==0 & !HRS_wb_w10$ybirth %in% miss_values_vector & !(HRS_wb_w10$yintw_wb_w10 %in% miss_values_vector | HRS_wb_w10$yintw_wb_w9 %in% miss_values_vector))])/2-HRS_wb_w10$ybirth[which(HRS_ds_wb_w10$h_cpd == 1 & HRS_wb_w10$h_cpd==0 & !HRS_wb_w10$ybirth %in% miss_values_vector & !(HRS_wb_w10$yintw_wb_w10 %in% miss_values_vector | HRS_wb_w10$yintw_wb_w9 %in% miss_values_vector))])
HRS_ds_wb_w10$h_cpd_age[which(HRS_ds_wb_w10$h_cpd == 1 & !HRS_wb_w10$h_cpd_age %in% miss_values_vector)] <- HRS_wb_w10$h_cpd_age[which(HRS_ds_wb_w10$h_cpd == 1 & !HRS_wb_w10$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_wb[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_wb_w10,log_vec=(HRS_ds_prov$id %in% HRS_ds_wb_w10$id),col_end_index = 2, col_st_index = 3)
HRS_ds_wb$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_wb$h_cpd_age[which((HRS_ds_wb$id %in% HRS_ds_wb_w10$id) & (HRS_ds_wb$h_cpd != 999))] <- HRS_ds_wb_w10$h_cpd_age[which(HRS_ds_wb_w10$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript wb_w10, echo=F}

vbl <- HRS_ds_wb_w10$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_wb_w10, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_wb_w10$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_wb_w10 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation wb_w10, echo=F, results='asis'}

AfterH <- table(HRS_ds_wb_w10$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_wb_w10$R10LUNGE)) & HRS_wb_w10$R10LUNGE == 0) & (HRS_wb_w10$h_cpd != 1)),
  sum(((!is.na(HRS_wb_w10$R10LUNGE)) & HRS_wb_w10$R10LUNGE == 1) | ((!is.na(HRS_wb_w10$h_cpd)) & (!is.na(HRS_wb_w10$R10LUNGE)) & HRS_wb_w10$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_wb_w10$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_wb_w10)

```



### Wave 11

#### Study-specific variable description

| **Name** | `R11LUNGE` |`ybirth`|`yintw (wb_w11)`|`yintw (wb_w10)`|
|-|-|-|-|-|
| **Label** | `R11LUNGE:W11 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-WB-w11`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign wb_w11, echo=F}

opal.assign.table.tibble(o, 'HRS_wb_w11','HRS.HRS-WB-w11',variables=list('R11LUNGE'), missings = T)
HRS_wb_w11 <- opal.execute(o,'HRS_wb_w11')
load(paste0(datafolder,"wb_w11/ybirth.RData"))
HRS_wb_w11 <- left_join(HRS_wb_w11,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"wb_w10/yintw.RData"))
HRS_wb_w11 <- left_join(HRS_wb_w11,yintw, by="id")
names(HRS_wb_w11)[4] <- "yintw_wb_w10"
rm(yintw)
load(paste0(datafolder,"wb_w11/yintw.RData"))
HRS_wb_w11 <- left_join(HRS_wb_w11,yintw, by="id")
names(HRS_wb_w11)[5] <- "yintw_wb_w11"
rm(yintw)

```

```{r local wb_w11, echo=F}

vbl <- HRS_wb_w11$R11LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_wb_w11)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_wb_w11, aes(x=factor(R11LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w11$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w11)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_wb_w11 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w11$yintw_wb_w10
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w11)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_wb_w11, aes(x=factor(yintw_wb_w10))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_wb_w11$yintw_wb_w11
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_wb_w11)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_wb_w11, aes(x=factor(yintw_wb_w11))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R4LUNGE == 0 and R5LUNGE == 0 and R6LUNGE == 0 and R7LUNGE == 0 and R8LUNGE == 0 and R9LUNGE == 0 and R10LUNGE == 0 and R11LUNGE == 0 into 0`
* `R4LUNGE == 1 or R5LUNGE == 1 or R6LUNGE == 1 or R7LUNGE == 1 or R8LUNGE == 1 or R9LUNGE == 1 or R10LUNGE == 1 or R11LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w11 and 0 in w10, h_cpd_age = (year of interview w11-year of interview w10)/2+(year of interview w10 -ybirth)`
* `if h_cpd == 1 in w11 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo wb_w11}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_wb_w11 <- left_join(HRS_wb_w11, HRS_ds_wb, by = "id")

# Categorical variable harmonization
HRS_ds_wb_w11 <- tibble(id=HRS_wb_w11$id)
HRS_ds_wb_w11$h_cpd <- rep(999,length(HRS_wb_w11$id))
HRS_ds_wb_w11$h_cpd[which(((!is.na(HRS_wb_w11$R11LUNGE)) & HRS_wb_w11$R11LUNGE == 0) & (HRS_wb_w11$h_cpd != 1))] <- 0
HRS_ds_wb_w11$h_cpd[which(((!is.na(HRS_wb_w11$R11LUNGE)) & HRS_wb_w11$R11LUNGE == 1) | ((!is.na(HRS_wb_w11$h_cpd)) & (!is.na(HRS_wb_w11$R11LUNGE)) & HRS_wb_w11$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_wb_w11$h_cpd_age <- rep(999,length(HRS_wb_w11$id))
HRS_ds_wb_w11$h_cpd_age[which(HRS_ds_wb_w11$h_cpd == 0)] <- 996
HRS_ds_wb_w11$h_cpd_age[which(HRS_ds_wb_w11$h_cpd == 1 & HRS_wb_w11$h_cpd==0 & !HRS_wb_w11$ybirth %in% miss_values_vector & !(HRS_wb_w11$yintw_wb_w11 %in% miss_values_vector | HRS_wb_w11$yintw_wb_w10 %in% miss_values_vector))] <- floor((HRS_wb_w11$yintw_wb_w11[which(HRS_ds_wb_w11$h_cpd == 1 & HRS_wb_w11$h_cpd==0 & !HRS_wb_w11$ybirth %in% miss_values_vector & !(HRS_wb_w11$yintw_wb_w11 %in% miss_values_vector | HRS_wb_w11$yintw_wb_w10 %in% miss_values_vector))]+HRS_wb_w11$yintw_wb_w10[which(HRS_ds_wb_w11$h_cpd == 1 & HRS_wb_w11$h_cpd==0 & !HRS_wb_w11$ybirth %in% miss_values_vector & !(HRS_wb_w11$yintw_wb_w11 %in% miss_values_vector | HRS_wb_w11$yintw_wb_w10 %in% miss_values_vector))])/2-HRS_wb_w11$ybirth[which(HRS_ds_wb_w11$h_cpd == 1 & HRS_wb_w11$h_cpd==0 & !HRS_wb_w11$ybirth %in% miss_values_vector & !(HRS_wb_w11$yintw_wb_w11 %in% miss_values_vector | HRS_wb_w11$yintw_wb_w10 %in% miss_values_vector))])
HRS_ds_wb_w11$h_cpd_age[which(HRS_ds_wb_w11$h_cpd == 1 & !HRS_wb_w11$h_cpd_age %in% miss_values_vector)] <- HRS_wb_w11$h_cpd_age[which(HRS_ds_wb_w11$h_cpd == 1 & !HRS_wb_w11$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
rm(HRS_ds_wb)

```


#### Statistics of the new harmonized variable

```{r descript wb_w11, echo=F}

vbl <- HRS_ds_wb_w11$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_wb_w11, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_wb_w11$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_wb_w11 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation wb_w11, echo=F, results='asis'}

AfterH <- table(HRS_ds_wb_w11$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_wb_w11$R11LUNGE)) & HRS_wb_w11$R11LUNGE == 0) & (HRS_wb_w11$h_cpd != 1)),
  sum(((!is.na(HRS_wb_w11$R11LUNGE)) & HRS_wb_w11$R11LUNGE == 1) | ((!is.na(HRS_wb_w11$h_cpd)) & (!is.na(HRS_wb_w11$R11LUNGE)) & HRS_wb_w11$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_wb_w11$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_wb_w11)

```



## EBB


### Wave 7

#### Study-specific variable description

| **Name** | `R7LUNGE` |
|-|-|
| **Label** | `R7LUNGE:W7 R ever had lung disease`|
| **Table name**  | `HRS-EBB-w7`|
| **Categories** | `0 = no`<br/>`1 = yes` |
| **Missings** | `NA` |
| **Description** |  |

```{r assign ebb_w7, echo=F}

opal.assign.table.tibble(o, 'HRS_ebb_w7','HRS.HRS-EBB-w7',variables=list('R7LUNGE'), missings = T)
HRS_ebb_w7 <- opal.execute(o,'HRS_ebb_w7')

```

```{r local ebb_w7, echo=F}

vbl <- HRS_ebb_w7$R7LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_ebb_w7)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_ebb_w7, aes(x=factor(R7LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `keep up 1 into 1`
* `keep up 0 into 0`
* `NA into 999`

Age of diagnosis cannot be harmonized.

**R script:**

```{r harmo ebb_w7}

# Categorical variable harmonization
HRS_ds_ebb_w7 <- tibble(id=HRS_ebb_w7$id)
HRS_ds_ebb_w7$h_cpd <- car::recode(HRS_ebb_w7$R7LUNGE, "NA=999")

# We build a global table in order to have updated the status of all the individuals through the different waves
HRS_ds_ebb <- HRS_ds_ebb_w7
HRS_ds_ebb$h_cpd_age <- rep(999,length(HRS_ds_ebb$id))

```


#### Statistics of the new harmonized variable

```{r descript ebb_w7, echo=F}

vbl <- HRS_ds_ebb_w7$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_ebb_w7, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

```


#### Validation

```{r crosstabulation ebb_w7, echo=F}

AfterH <- table(HRS_ds_ebb_w7$h_cpd, useNA = "ifany")
BeforeH <- table(HRS_ebb_w7$R7LUNGE, useNA = "ifany")
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)
rm(HRS_ebb_w7)

```



### Wave 8

#### Study-specific variable description

| **Name** | `R8LUNGE` |`ybirth`|`yintw (ebb_w7)`|`yintw (ebb_w8)`|
|-|-|-|-|-|
| **Label** | `R8LUNGE:W8 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-EBB-w8`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign ebb_w8, echo=F}

opal.assign.table.tibble(o, 'HRS_ebb_w8','HRS.HRS-EBB-w8',variables=list('R8LUNGE'), missings = T)
HRS_ebb_w8 <- opal.execute(o,'HRS_ebb_w8')
load(paste0(datafolder,"ebb_w8/ybirth.RData"))
HRS_ebb_w8 <- left_join(HRS_ebb_w8,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"ebb_w7/yintw.RData"))
HRS_ebb_w8 <- left_join(HRS_ebb_w8,yintw, by="id")
names(HRS_ebb_w8)[4] <- "yintw_ebb_w7"
rm(yintw)
load(paste0(datafolder,"ebb_w8/yintw.RData"))
HRS_ebb_w8 <- left_join(HRS_ebb_w8,yintw, by="id")
names(HRS_ebb_w8)[5] <- "yintw_ebb_w8"
rm(yintw)

```

```{r local ebb_w8, echo=F}

vbl <- HRS_ebb_w8$R8LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_ebb_w8)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_ebb_w8, aes(x=factor(R8LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ebb_w8$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ebb_w8)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ebb_w8 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ebb_w8$yintw_ebb_w7
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ebb_w8)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ebb_w8, aes(x=factor(yintw_ebb_w7))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ebb_w8$yintw_ebb_w8
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ebb_w8)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ebb_w8, aes(x=factor(yintw_ebb_w8))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R7LUNGE == 0 and R8LUNGE == 0 into 0`
* `R7LUNGE == 1 or R8LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w8 and 0 in w7, h_cpd_age = (year of interview w8-year of interview w7)/2+(year of interview w7 -ybirth)`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo ebb_w8}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_ebb_w8 <- left_join(HRS_ebb_w8, HRS_ds_ebb, by = "id")

# Categorical variable harmonization
HRS_ds_ebb_w8 <- tibble(id=HRS_ebb_w8$id)
HRS_ds_ebb_w8$h_cpd <- rep(999,length(HRS_ebb_w8$id))
HRS_ds_ebb_w8$h_cpd[which(((!is.na(HRS_ebb_w8$R8LUNGE)) & HRS_ebb_w8$R8LUNGE == 0) & (HRS_ebb_w8$h_cpd != 1))] <- 0
HRS_ds_ebb_w8$h_cpd[which(((!is.na(HRS_ebb_w8$R8LUNGE)) & HRS_ebb_w8$R8LUNGE == 1) | ((!is.na(HRS_ebb_w8$h_cpd)) & (!is.na(HRS_ebb_w8$R8LUNGE)) & HRS_ebb_w8$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_ebb_w8$h_cpd_age <- rep(999,length(HRS_ebb_w8$id))
HRS_ds_ebb_w8$h_cpd_age[which(HRS_ds_ebb_w8$h_cpd == 0)] <- 996
HRS_ds_ebb_w8$h_cpd_age[which(HRS_ds_ebb_w8$h_cpd == 1 & HRS_ebb_w8$h_cpd==0 & !HRS_ebb_w8$ybirth %in% miss_values_vector & !(HRS_ebb_w8$yintw_ebb_w8 %in% miss_values_vector | HRS_ebb_w8$yintw_ebb_w7 %in% miss_values_vector))] <- floor((HRS_ebb_w8$yintw_ebb_w8[which(HRS_ds_ebb_w8$h_cpd == 1 & HRS_ebb_w8$h_cpd==0 & !HRS_ebb_w8$ybirth %in% miss_values_vector & !(HRS_ebb_w8$yintw_ebb_w8 %in% miss_values_vector | HRS_ebb_w8$yintw_ebb_w7 %in% miss_values_vector))]+HRS_ebb_w8$yintw_ebb_w7[which(HRS_ds_ebb_w8$h_cpd == 1 & HRS_ebb_w8$h_cpd==0 & !HRS_ebb_w8$ybirth %in% miss_values_vector & !(HRS_ebb_w8$yintw_ebb_w8 %in% miss_values_vector | HRS_ebb_w8$yintw_ebb_w7 %in% miss_values_vector))])/2-HRS_ebb_w8$ybirth[which(HRS_ds_ebb_w8$h_cpd == 1 & HRS_ebb_w8$h_cpd==0 & !HRS_ebb_w8$ybirth %in% miss_values_vector & !(HRS_ebb_w8$yintw_ebb_w8 %in% miss_values_vector | HRS_ebb_w8$yintw_ebb_w7 %in% miss_values_vector))])

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_ebb[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_ebb_w8,log_vec=(HRS_ds_prov$id %in% HRS_ds_ebb_w8$id),col_end_index = 2, col_st_index = 3)
HRS_ds_ebb$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_ebb$h_cpd_age[which((HRS_ds_ebb$id %in% HRS_ds_ebb_w8$id) & (HRS_ds_ebb$h_cpd != 999))] <- HRS_ds_ebb_w8$h_cpd_age[which(HRS_ds_ebb_w8$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript ebb_w8, echo=F}

vbl <- HRS_ds_ebb_w8$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_ebb_w8, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_ebb_w8$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_ebb_w8 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation ebb_w8, echo=F, results='asis'}

AfterH <- table(HRS_ds_ebb_w8$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_ebb_w8$R8LUNGE)) & HRS_ebb_w8$R8LUNGE == 0) & (HRS_ebb_w8$h_cpd != 1)),
  sum(((!is.na(HRS_ebb_w8$R8LUNGE)) & HRS_ebb_w8$R8LUNGE == 1) | ((!is.na(HRS_ebb_w8$h_cpd)) & (!is.na(HRS_ebb_w8$R8LUNGE)) & HRS_ebb_w8$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_ebb_w8$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_ebb_w8)

```




### Wave 9

#### Study-specific variable description

| **Name** | `R9LUNGE` |`ybirth`|`yintw (ebb_w8)`|`yintw (ebb_w9)`|
|-|-|-|-|-|
| **Label** | `R9LUNGE:W9 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-EBB-w9`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign ebb_w9, echo=F}

opal.assign.table.tibble(o, 'HRS_ebb_w9','HRS.HRS-EBB-w9',variables=list('R9LUNGE'), missings = T)
HRS_ebb_w9 <- opal.execute(o,'HRS_ebb_w9')
load(paste0(datafolder,"ebb_w9/ybirth.RData"))
HRS_ebb_w9 <- left_join(HRS_ebb_w9,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"ebb_w8/yintw.RData"))
HRS_ebb_w9 <- left_join(HRS_ebb_w9,yintw, by="id")
names(HRS_ebb_w9)[4] <- "yintw_ebb_w8"
rm(yintw)
load(paste0(datafolder,"ebb_w9/yintw.RData"))
HRS_ebb_w9 <- left_join(HRS_ebb_w9,yintw, by="id")
names(HRS_ebb_w9)[5] <- "yintw_ebb_w9"
rm(yintw)

```

```{r local ebb_w9, echo=F}

vbl <- HRS_ebb_w9$R9LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_ebb_w9)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_ebb_w9, aes(x=factor(R9LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ebb_w9$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ebb_w9)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ebb_w9 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ebb_w9$yintw_ebb_w8
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ebb_w9)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ebb_w9, aes(x=factor(yintw_ebb_w8))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ebb_w9$yintw_ebb_w9
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ebb_w9)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ebb_w9, aes(x=factor(yintw_ebb_w9))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R7LUNGE == 0 and R8LUNGE == 0 and R9LUNGE == 0 into 0`
* `R7LUNGE == 1 or R8LUNGE == 1 or R9LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w9 and 0 in w8, h_cpd_age = (year of interview w9-year of interview w8)/2+(year of interview w8 -ybirth)`
* `if h_cpd == 1 in w9 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo ebb_w9}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_ebb_w9 <- left_join(HRS_ebb_w9, HRS_ds_ebb, by = "id")

# Categorical variable harmonization
HRS_ds_ebb_w9 <- tibble(id=HRS_ebb_w9$id)
HRS_ds_ebb_w9$h_cpd <- rep(999,length(HRS_ebb_w9$id))
HRS_ds_ebb_w9$h_cpd[which(((!is.na(HRS_ebb_w9$R9LUNGE)) & HRS_ebb_w9$R9LUNGE == 0) & (HRS_ebb_w9$h_cpd != 1))] <- 0
HRS_ds_ebb_w9$h_cpd[which(((!is.na(HRS_ebb_w9$R9LUNGE)) & HRS_ebb_w9$R9LUNGE == 1) | ((!is.na(HRS_ebb_w9$h_cpd)) & (!is.na(HRS_ebb_w9$R9LUNGE)) & HRS_ebb_w9$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_ebb_w9$h_cpd_age <- rep(999,length(HRS_ebb_w9$id))
HRS_ds_ebb_w9$h_cpd_age[which(HRS_ds_ebb_w9$h_cpd == 0)] <- 996
HRS_ds_ebb_w9$h_cpd_age[which(HRS_ds_ebb_w9$h_cpd == 1 & HRS_ebb_w9$h_cpd==0 & !HRS_ebb_w9$ybirth %in% miss_values_vector & !(HRS_ebb_w9$yintw_ebb_w9 %in% miss_values_vector | HRS_ebb_w9$yintw_ebb_w8 %in% miss_values_vector))] <- floor((HRS_ebb_w9$yintw_ebb_w9[which(HRS_ds_ebb_w9$h_cpd == 1 & HRS_ebb_w9$h_cpd==0 & !HRS_ebb_w9$ybirth %in% miss_values_vector & !(HRS_ebb_w9$yintw_ebb_w9 %in% miss_values_vector | HRS_ebb_w9$yintw_ebb_w8 %in% miss_values_vector))]+HRS_ebb_w9$yintw_ebb_w8[which(HRS_ds_ebb_w9$h_cpd == 1 & HRS_ebb_w9$h_cpd==0 & !HRS_ebb_w9$ybirth %in% miss_values_vector & !(HRS_ebb_w9$yintw_ebb_w9 %in% miss_values_vector | HRS_ebb_w9$yintw_ebb_w8 %in% miss_values_vector))])/2-HRS_ebb_w9$ybirth[which(HRS_ds_ebb_w9$h_cpd == 1 & HRS_ebb_w9$h_cpd==0 & !HRS_ebb_w9$ybirth %in% miss_values_vector & !(HRS_ebb_w9$yintw_ebb_w9 %in% miss_values_vector | HRS_ebb_w9$yintw_ebb_w8 %in% miss_values_vector))])
HRS_ds_ebb_w9$h_cpd_age[which(HRS_ds_ebb_w9$h_cpd == 1 & !HRS_ebb_w9$h_cpd_age %in% miss_values_vector)] <- HRS_ebb_w9$h_cpd_age[which(HRS_ds_ebb_w9$h_cpd == 1 & !HRS_ebb_w9$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_ebb[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_ebb_w9,log_vec=(HRS_ds_prov$id %in% HRS_ds_ebb_w9$id),col_end_index = 2, col_st_index = 3)
HRS_ds_ebb$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_ebb$h_cpd_age[which((HRS_ds_ebb$id %in% HRS_ds_ebb_w9$id) & (HRS_ds_ebb$h_cpd != 999))] <- HRS_ds_ebb_w9$h_cpd_age[which(HRS_ds_ebb_w9$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript ebb_w9, echo=F}

vbl <- HRS_ds_ebb_w9$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_ebb_w9, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_ebb_w9$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_ebb_w9 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation ebb_w9, echo=F, results='asis'}

AfterH <- table(HRS_ds_ebb_w9$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_ebb_w9$R9LUNGE)) & HRS_ebb_w9$R9LUNGE == 0) & (HRS_ebb_w9$h_cpd != 1)),
  sum(((!is.na(HRS_ebb_w9$R9LUNGE)) & HRS_ebb_w9$R9LUNGE == 1) | ((!is.na(HRS_ebb_w9$h_cpd)) & (!is.na(HRS_ebb_w9$R9LUNGE)) & HRS_ebb_w9$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_ebb_w9$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_ebb_w9)

```




### Wave 10

#### Study-specific variable description

| **Name** | `R10LUNGE` |`ybirth`|`yintw (ebb_w10)`|`yintw (ebb_w9)`|
|-|-|-|-|-|
| **Label** | `R10LUNGE:W10 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-EBB-w10`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign ebb_w10, echo=F}

opal.assign.table.tibble(o, 'HRS_ebb_w10','HRS.HRS-EBB-w10',variables=list('R10LUNGE'), missings = T)
HRS_ebb_w10 <- opal.execute(o,'HRS_ebb_w10')
load(paste0(datafolder,"ebb_w10/ybirth.RData"))
HRS_ebb_w10 <- left_join(HRS_ebb_w10,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"ebb_w9/yintw.RData"))
HRS_ebb_w10 <- left_join(HRS_ebb_w10,yintw, by="id")
names(HRS_ebb_w10)[4] <- "yintw_ebb_w9"
rm(yintw)
load(paste0(datafolder,"ebb_w10/yintw.RData"))
HRS_ebb_w10 <- left_join(HRS_ebb_w10,yintw, by="id")
names(HRS_ebb_w10)[5] <- "yintw_ebb_w10"
rm(yintw)

```

```{r local ebb_w10, echo=F}

vbl <- HRS_ebb_w10$R10LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_ebb_w10)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_ebb_w10, aes(x=factor(R10LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ebb_w10$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ebb_w10)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ebb_w10 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ebb_w10$yintw_ebb_w9
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ebb_w10)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ebb_w10, aes(x=factor(yintw_ebb_w9))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ebb_w10$yintw_ebb_w10
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ebb_w10)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ebb_w10, aes(x=factor(yintw_ebb_w10))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R7LUNGE == 0 and R8LUNGE == 0 and R9LUNGE == 0 and R10LUNGE == 0 into 0`
* `R7LUNGE == 1 or R8LUNGE == 1 or R9LUNGE == 1 or R10LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w10 and 0 in w9, h_cpd_age = (year of interview w10-year of interview w9)/2+(year of interview w9 -ybirth)`
* `if h_cpd == 1 in w10 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo ebb_w10}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_ebb_w10 <- left_join(HRS_ebb_w10, HRS_ds_ebb, by = "id")

# Categorical variable harmonization
HRS_ds_ebb_w10 <- tibble(id=HRS_ebb_w10$id)
HRS_ds_ebb_w10$h_cpd <- rep(999,length(HRS_ebb_w10$id))
HRS_ds_ebb_w10$h_cpd[which(((!is.na(HRS_ebb_w10$R10LUNGE)) & HRS_ebb_w10$R10LUNGE == 0) & (HRS_ebb_w10$h_cpd != 1))] <- 0
HRS_ds_ebb_w10$h_cpd[which(((!is.na(HRS_ebb_w10$R10LUNGE)) & HRS_ebb_w10$R10LUNGE == 1) | ((!is.na(HRS_ebb_w10$h_cpd)) & (!is.na(HRS_ebb_w10$R10LUNGE)) & HRS_ebb_w10$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_ebb_w10$h_cpd_age <- rep(999,length(HRS_ebb_w10$id))
HRS_ds_ebb_w10$h_cpd_age[which(HRS_ds_ebb_w10$h_cpd == 0)] <- 996
HRS_ds_ebb_w10$h_cpd_age[which(HRS_ds_ebb_w10$h_cpd == 1 & HRS_ebb_w10$h_cpd==0 & !HRS_ebb_w10$ybirth %in% miss_values_vector & !(HRS_ebb_w10$yintw_ebb_w10 %in% miss_values_vector | HRS_ebb_w10$yintw_ebb_w9 %in% miss_values_vector))] <- floor((HRS_ebb_w10$yintw_ebb_w10[which(HRS_ds_ebb_w10$h_cpd == 1 & HRS_ebb_w10$h_cpd==0 & !HRS_ebb_w10$ybirth %in% miss_values_vector & !(HRS_ebb_w10$yintw_ebb_w10 %in% miss_values_vector | HRS_ebb_w10$yintw_ebb_w9 %in% miss_values_vector))]+HRS_ebb_w10$yintw_ebb_w9[which(HRS_ds_ebb_w10$h_cpd == 1 & HRS_ebb_w10$h_cpd==0 & !HRS_ebb_w10$ybirth %in% miss_values_vector & !(HRS_ebb_w10$yintw_ebb_w10 %in% miss_values_vector | HRS_ebb_w10$yintw_ebb_w9 %in% miss_values_vector))])/2-HRS_ebb_w10$ybirth[which(HRS_ds_ebb_w10$h_cpd == 1 & HRS_ebb_w10$h_cpd==0 & !HRS_ebb_w10$ybirth %in% miss_values_vector & !(HRS_ebb_w10$yintw_ebb_w10 %in% miss_values_vector | HRS_ebb_w10$yintw_ebb_w9 %in% miss_values_vector))])
HRS_ds_ebb_w10$h_cpd_age[which(HRS_ds_ebb_w10$h_cpd == 1 & !HRS_ebb_w10$h_cpd_age %in% miss_values_vector)] <- HRS_ebb_w10$h_cpd_age[which(HRS_ds_ebb_w10$h_cpd == 1 & !HRS_ebb_w10$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
assign_merge <- function(endtib,sttib,log_vec=c(T),col_end_index=NULL,col_st_index=NULL){
  newtib <- left_join(endtib,sttib,by="id")
  newtib[log_vec,col_end_index] <- newtib[log_vec,col_st_index]
  id_ind <- match("id",names(newtib))
  newtib <- newtib[,c(id_ind,col_end_index)]
  names(newtib)[2] <- "x"
  newtib$x <- car::recode(newtib$x,"NA=999")
  names(newtib)[2] <- names(endtib)[col_end_index]
  newtib
}
HRS_ds_prov <- HRS_ds_ebb[,c(1,2)]
HRS_ds_prov <- assign_merge(HRS_ds_prov,HRS_ds_ebb_w10,log_vec=(HRS_ds_prov$id %in% HRS_ds_ebb_w10$id),col_end_index = 2, col_st_index = 3)
HRS_ds_ebb$h_cpd <- HRS_ds_prov$h_cpd
rm(HRS_ds_prov)
HRS_ds_ebb$h_cpd_age[which((HRS_ds_ebb$id %in% HRS_ds_ebb_w10$id) & (HRS_ds_ebb$h_cpd != 999))] <- HRS_ds_ebb_w10$h_cpd_age[which(HRS_ds_ebb_w10$h_cpd != 999)]

```


#### Statistics of the new harmonized variable

```{r descript ebb_w10, echo=F}

vbl <- HRS_ds_ebb_w10$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_ebb_w10, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_ebb_w10$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_ebb_w10 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation ebb_w10, echo=F, results='asis'}

AfterH <- table(HRS_ds_ebb_w10$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_ebb_w10$R10LUNGE)) & HRS_ebb_w10$R10LUNGE == 0) & (HRS_ebb_w10$h_cpd != 1)),
  sum(((!is.na(HRS_ebb_w10$R10LUNGE)) & HRS_ebb_w10$R10LUNGE == 1) | ((!is.na(HRS_ebb_w10$h_cpd)) & (!is.na(HRS_ebb_w10$R10LUNGE)) & HRS_ebb_w10$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_ebb_w10$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_ebb_w10)

```



### Wave 11

#### Study-specific variable description

| **Name** | `R11LUNGE` |`ybirth`|`yintw (ebb_w11)`|`yintw (ebb_w10)`|
|-|-|-|-|-|
| **Label** | `R11LUNGE:W11 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-EBB-w11`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign ebb_w11, echo=F}

opal.assign.table.tibble(o, 'HRS_ebb_w11','HRS.HRS-EBB-w11',variables=list('R11LUNGE'), missings = T)
HRS_ebb_w11 <- opal.execute(o,'HRS_ebb_w11')
load(paste0(datafolder,"ebb_w11/ybirth.RData"))
HRS_ebb_w11 <- left_join(HRS_ebb_w11,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"ebb_w10/yintw.RData"))
HRS_ebb_w11 <- left_join(HRS_ebb_w11,yintw, by="id")
names(HRS_ebb_w11)[4] <- "yintw_ebb_w10"
rm(yintw)
load(paste0(datafolder,"ebb_w11/yintw.RData"))
HRS_ebb_w11 <- left_join(HRS_ebb_w11,yintw, by="id")
names(HRS_ebb_w11)[5] <- "yintw_ebb_w11"
rm(yintw)

```

```{r local ebb_w11, echo=F}

vbl <- HRS_ebb_w11$R11LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_ebb_w11)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_ebb_w11, aes(x=factor(R11LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ebb_w11$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ebb_w11)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ebb_w11 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ebb_w11$yintw_ebb_w10
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ebb_w11)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ebb_w11, aes(x=factor(yintw_ebb_w10))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_ebb_w11$yintw_ebb_w11
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_ebb_w11)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_ebb_w11, aes(x=factor(yintw_ebb_w11))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R7LUNGE == 0 and R8LUNGE == 0 and R9LUNGE == 0 and R10LUNGE == 0 and R11LUNGE == 0 into 0`
* `R7LUNGE == 1 or R8LUNGE == 1 or R9LUNGE == 1 or R10LUNGE == 1 or R11LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w11 and 0 in w10, h_cpd_age = (year of interview w11-year of interview w10)/2+(year of interview w10 -ybirth)`
* `if h_cpd == 1 in w11 and other wave, h_cpd_age as previously`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo ebb_w11}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_ebb_w11 <- left_join(HRS_ebb_w11, HRS_ds_ebb, by = "id")

# Categorical variable harmonization
HRS_ds_ebb_w11 <- tibble(id=HRS_ebb_w11$id)
HRS_ds_ebb_w11$h_cpd <- rep(999,length(HRS_ebb_w11$id))
HRS_ds_ebb_w11$h_cpd[which(((!is.na(HRS_ebb_w11$R11LUNGE)) & HRS_ebb_w11$R11LUNGE == 0) & (HRS_ebb_w11$h_cpd != 1))] <- 0
HRS_ds_ebb_w11$h_cpd[which(((!is.na(HRS_ebb_w11$R11LUNGE)) & HRS_ebb_w11$R11LUNGE == 1) | ((!is.na(HRS_ebb_w11$h_cpd)) & (!is.na(HRS_ebb_w11$R11LUNGE)) & HRS_ebb_w11$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_ebb_w11$h_cpd_age <- rep(999,length(HRS_ebb_w11$id))
HRS_ds_ebb_w11$h_cpd_age[which(HRS_ds_ebb_w11$h_cpd == 0)] <- 996
HRS_ds_ebb_w11$h_cpd_age[which(HRS_ds_ebb_w11$h_cpd == 1 & HRS_ebb_w11$h_cpd==0 & !HRS_ebb_w11$ybirth %in% miss_values_vector & !(HRS_ebb_w11$yintw_ebb_w11 %in% miss_values_vector | HRS_ebb_w11$yintw_ebb_w10 %in% miss_values_vector))] <- floor((HRS_ebb_w11$yintw_ebb_w11[which(HRS_ds_ebb_w11$h_cpd == 1 & HRS_ebb_w11$h_cpd==0 & !HRS_ebb_w11$ybirth %in% miss_values_vector & !(HRS_ebb_w11$yintw_ebb_w11 %in% miss_values_vector | HRS_ebb_w11$yintw_ebb_w10 %in% miss_values_vector))]+HRS_ebb_w11$yintw_ebb_w10[which(HRS_ds_ebb_w11$h_cpd == 1 & HRS_ebb_w11$h_cpd==0 & !HRS_ebb_w11$ybirth %in% miss_values_vector & !(HRS_ebb_w11$yintw_ebb_w11 %in% miss_values_vector | HRS_ebb_w11$yintw_ebb_w10 %in% miss_values_vector))])/2-HRS_ebb_w11$ybirth[which(HRS_ds_ebb_w11$h_cpd == 1 & HRS_ebb_w11$h_cpd==0 & !HRS_ebb_w11$ybirth %in% miss_values_vector & !(HRS_ebb_w11$yintw_ebb_w11 %in% miss_values_vector | HRS_ebb_w11$yintw_ebb_w10 %in% miss_values_vector))])
HRS_ds_ebb_w11$h_cpd_age[which(HRS_ds_ebb_w11$h_cpd == 1 & !HRS_ebb_w11$h_cpd_age %in% miss_values_vector)] <- HRS_ebb_w11$h_cpd_age[which(HRS_ds_ebb_w11$h_cpd == 1 & !HRS_ebb_w11$h_cpd_age %in% miss_values_vector)]

# We update the status of the individuals in the global table
rm(HRS_ds_ebb)

```


#### Statistics of the new harmonized variable

```{r descript ebb_w11, echo=F}

vbl <- HRS_ds_ebb_w11$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_ebb_w11, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_ebb_w11$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_ebb_w11 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation ebb_w11, echo=F, results='asis'}

AfterH <- table(HRS_ds_ebb_w11$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_ebb_w11$R11LUNGE)) & HRS_ebb_w11$R11LUNGE == 0) & (HRS_ebb_w11$h_cpd != 1)),
  sum(((!is.na(HRS_ebb_w11$R11LUNGE)) & HRS_ebb_w11$R11LUNGE == 1) | ((!is.na(HRS_ebb_w11$h_cpd)) & (!is.na(HRS_ebb_w11$R11LUNGE)) & HRS_ebb_w11$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_ebb_w11$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_ebb_w11)

```



## MBB


### Wave 10

#### Study-specific variable description

| **Name** | `R10LUNGE` |
|-|-|
| **Label** | `R10LUNGE:W10 R ever had lung disease`|
| **Table name**  | `HRS-MBB-w10`|
| **Categories** | `0 = no`<br/>`1 = yes` |
| **Missings** | `NA` |
| **Description** |  |

```{r assign mbb_w10, echo=F}

opal.assign.table.tibble(o, 'HRS_mbb_w10','HRS.HRS-MBB-w10',variables=list('R10LUNGE'), missings = T)
HRS_mbb_w10 <- opal.execute(o,'HRS_mbb_w10')

```

```{r local mbb_w10, echo=F}

vbl <- HRS_mbb_w10$R10LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_mbb_w10)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_mbb_w10, aes(x=factor(R10LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `keep up 1 into 1`
* `keep up 0 into 0`
* `NA into 999`

Age of diagnosis cannot be harmonized.

**R script:**

```{r harmo mbb_w10}

# Categorical variable harmonization
HRS_ds_mbb_w10 <- tibble(id=HRS_mbb_w10$id)
HRS_ds_mbb_w10$h_cpd <- car::recode(HRS_mbb_w10$R10LUNGE, "NA=999")

# We build a global table in order to have updated the status of all the individuals through the different waves
HRS_ds_mbb <- HRS_ds_mbb_w10
HRS_ds_mbb$h_cpd_age <- rep(999,length(HRS_ds_mbb$id))

```


#### Statistics of the new harmonized variable

```{r descript mbb_w10, echo=F}

vbl <- HRS_ds_mbb_w10$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_mbb_w10, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

```


#### Validation

```{r crosstabulation mbb_w10, echo=F}

AfterH <- table(HRS_ds_mbb_w10$h_cpd, useNA = "ifany")
BeforeH <- table(HRS_mbb_w10$R10LUNGE, useNA = "ifany")
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)
rm(HRS_mbb_w10)

```



### Wave 11

#### Study-specific variable description

| **Name** | `R11LUNGE` |`ybirth`|`yintw (mbb_w10)`|`yintw (mbb_w11)`|
|-|-|-|-|-|
| **Label** | `R11LUNGE:W11 R ever had lung disease`|`year of birth`|`year of interview`|`year of interview`|
| **Table name**  | `HRS-MBB-w11`|`ybirth`|`yintw`|`yintw`|
| **Categories** | `0 = no`<br/>`1 = yes` |`continuous`|`continuous`|`continuous`|
| **Missings** | `NA`|  |  |  |
| **Description** |  |  |  |  |

```{r assign mbb_w11, echo=F}

opal.assign.table.tibble(o, 'HRS_mbb_w11','HRS.HRS-MBB-w11',variables=list('R11LUNGE'), missings = T)
HRS_mbb_w11 <- opal.execute(o,'HRS_mbb_w11')
load(paste0(datafolder,"mbb_w11/ybirth.RData"))
HRS_mbb_w11 <- left_join(HRS_mbb_w11,ybirth, by="id")
rm(ybirth)
load(paste0(datafolder,"mbb_w10/yintw.RData"))
HRS_mbb_w11 <- left_join(HRS_mbb_w11,yintw, by="id")
names(HRS_mbb_w11)[4] <- "yintw_mbb_w10"
rm(yintw)
load(paste0(datafolder,"mbb_w11/yintw.RData"))
HRS_mbb_w11 <- left_join(HRS_mbb_w11,yintw, by="id")
names(HRS_mbb_w11)[5] <- "yintw_mbb_w11"
rm(yintw)

```

```{r local mbb_w11, echo=F}

vbl <- HRS_mbb_w11$R11LUNGE
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = names(HRS_mbb_w11)[2])
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")

ggplot(HRS_mbb_w11, aes(x=factor(R11LUNGE))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_mbb_w11$ybirth
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = names(HRS_mbb_w11)[3])
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_mbb_w11 %>% filter(!vbl %in% miss_values_vector), aes(ybirth)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_mbb_w11$yintw_mbb_w10
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_mbb_w11)[4])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_mbb_w11, aes(x=factor(yintw_mbb_w10))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- HRS_mbb_w11$yintw_mbb_w11
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = names(HRS_mbb_w11)[5])
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")

ggplot(HRS_mbb_w11, aes(x=factor(yintw_mbb_w11))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


#### Harmonisation algorithm

To compute `h_cpd` from the study-specific variable it has to be recoded as follows:

* `R10LUNGE == 0 and R11LUNGE == 0 into 0`
* `R10LUNGE == 1 or R11LUNGE == 1 into 1`
* `otherwise into 999`

To compute `h_cpd_age` from the study-specific variable it has to be recoded as follows:

* `if h_cpd == 1 in w11 and 0 in w10, h_cpd_age = (year of interview w11-year of interview w10)/2+(year of interview w10 -ybirth)`
* `if h_cpd == 0, h_cpd_age = 996`
* `h_cpd == missing into 999`

**R script:**

```{r harmo mbb_w11}

# We use the harmonized variable of previous waves instead of the study-specific variables
HRS_mbb_w11 <- left_join(HRS_mbb_w11, HRS_ds_mbb, by = "id")

# Categorical variable harmonization
HRS_ds_mbb_w11 <- tibble(id=HRS_mbb_w11$id)
HRS_ds_mbb_w11$h_cpd <- rep(999,length(HRS_mbb_w11$id))
HRS_ds_mbb_w11$h_cpd[which(((!is.na(HRS_mbb_w11$R11LUNGE)) & HRS_mbb_w11$R11LUNGE == 0) & (HRS_mbb_w11$h_cpd != 1))] <- 0
HRS_ds_mbb_w11$h_cpd[which(((!is.na(HRS_mbb_w11$R11LUNGE)) & HRS_mbb_w11$R11LUNGE == 1) | ((!is.na(HRS_mbb_w11$h_cpd)) & (!is.na(HRS_mbb_w11$R11LUNGE)) & HRS_mbb_w11$h_cpd == 1))] <- 1

# Continuous variable harmonization
HRS_ds_mbb_w11$h_cpd_age <- rep(999,length(HRS_mbb_w11$id))
HRS_ds_mbb_w11$h_cpd_age[which(HRS_ds_mbb_w11$h_cpd == 0)] <- 996
HRS_ds_mbb_w11$h_cpd_age[which(HRS_ds_mbb_w11$h_cpd == 1 & HRS_mbb_w11$h_cpd==0 & !HRS_mbb_w11$ybirth %in% miss_values_vector & !(HRS_mbb_w11$yintw_mbb_w11 %in% miss_values_vector | HRS_mbb_w11$yintw_mbb_w10 %in% miss_values_vector))] <- floor((HRS_mbb_w11$yintw_mbb_w11[which(HRS_ds_mbb_w11$h_cpd == 1 & HRS_mbb_w11$h_cpd==0 & !HRS_mbb_w11$ybirth %in% miss_values_vector & !(HRS_mbb_w11$yintw_mbb_w11 %in% miss_values_vector | HRS_mbb_w11$yintw_mbb_w10 %in% miss_values_vector))]+HRS_mbb_w11$yintw_mbb_w10[which(HRS_ds_mbb_w11$h_cpd == 1 & HRS_mbb_w11$h_cpd==0 & !HRS_mbb_w11$ybirth %in% miss_values_vector & !(HRS_mbb_w11$yintw_mbb_w11 %in% miss_values_vector | HRS_mbb_w11$yintw_mbb_w10 %in% miss_values_vector))])/2-HRS_mbb_w11$ybirth[which(HRS_ds_mbb_w11$h_cpd == 1 & HRS_mbb_w11$h_cpd==0 & !HRS_mbb_w11$ybirth %in% miss_values_vector & !(HRS_mbb_w11$yintw_mbb_w11 %in% miss_values_vector | HRS_mbb_w11$yintw_mbb_w10 %in% miss_values_vector))])

# We update the status of the individuals in the global table
rm(HRS_ds_mbb)
```


#### Statistics of the new harmonized variable

```{r descript mbb_w11, echo=F}

vbl <- HRS_ds_mbb_w11$h_cpd
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(HRS_ds_mbb_w11, aes(x=factor(h_cpd))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vbl <- HRS_ds_mbb_w11$h_cpd_age
kable(Continuous_summary(var = vbl, missing_values = miss_values_vector)[3], caption = ds_label_age)
kable(Continuous_summary(vbl, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = miss_values_vector)$summary, caption = "Summary")
ggplot(HRS_ds_mbb_w11 %>% filter(!vbl %in% miss_values_vector), aes(h_cpd_age)) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label_age) + ylab("Frequency")

```


#### Validation

```{r crosstabulation mbb_w11, echo=F, results='asis'}

AfterH <- table(HRS_ds_mbb_w11$h_cpd, useNA = "ifany")
X <- c(
  sum(((!is.na(HRS_mbb_w11$R11LUNGE)) & HRS_mbb_w11$R11LUNGE == 0) & (HRS_mbb_w11$h_cpd != 1)),
  sum(((!is.na(HRS_mbb_w11$R11LUNGE)) & HRS_mbb_w11$R11LUNGE == 1) | ((!is.na(HRS_mbb_w11$h_cpd)) & (!is.na(HRS_mbb_w11$R11LUNGE)) & HRS_mbb_w11$h_cpd == 1))
)
BeforeH <- c(X[1:2],length(HRS_mbb_w11$id)-sum(X))
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("0->0","1->1","NA->999")
kable(C)

rm(HRS_mbb_w11)

```












## Summary of descriptive statistics of the harmonised variable `h_cpd` accross populations and waves

Two tables are generated: 

1. Percentages of categories in each harmonised variable.

2. Frequencies and percentages of individuals with different trajectories. To avoid too large table, Only trajectories with percentages larger than 0.3 are shown.

<!--AUXILIAR FUNCTIONS-->

```{r helpfunctions, echo=FALSE}

source("../../helpfunctions.r")


```



```{r populations-waves, echo=F}


# All study waves and populations with abbreviated and descriptive names


hrs.hrs.cw <- list(hrs_w1 = c("hrs_w1","HRS w1"), hrs_w2 = c("hrs_w2","HRS w2"), hrs_w3 = c("hrs_w3","HRS w3"), hrs_w4 = c("hrs_w4","HRS w4"), hrs_w5 = c("hrs_w5","HRS w5"), hrs_w6 = c("hrs_w6","HRS w6"), hrs_w7 = c("hrs_w7","HRS w7"), hrs_w8 = c("hrs_w8","HRS w8"), hrs_w9 = c("hrs_w9","HRS w9"), hrs_w10 = c("hrs_w10","HRS w10"), hrs_w11 = c("hrs_w11","HRS w11"))

hrs.ahead.cw <- list(ahead_w2 = c("ahead_w2","AHEAD w2"), ahead_w3 = c("ahead_w3","AHEAD w3"), ahead_w4 = c("ahead_w4","AHEAD w4"), ahead_w5 = c("ahead_w5","AHEAD w5"), ahead_w6 = c("ahead_w6","AHEAD w6"), ahead_w7 = c("ahead_w7","AHEAD w7"), ahead_w8 = c("ahead_w8","AHEAD w8"), ahead_w9 = c("ahead_w9","AHEAD w9"), ahead_w10 = c("ahead_w10","AHEAD w10"), ahead_w11 = c("ahead_w11","AHEAD w11"))

hrs.coda.cw <- list(coda_w4 = c("coda_w4","CODA w4"), coda_w5 = c("coda_w5","CODA w5"), coda_w6 = c("coda_w6","CODA w6"), coda_w7 = c("coda_w7","CODA w7"), coda_w8 = c("coda_w8","CODA w8"), coda_w9 = c("coda_w9","CODA w9"), coda_w10 = c("coda_w10","CODA w10"), coda_w11 = c("coda_w11","CODA w11"))

hrs.wb.cw <- list(wb_w4 = c("wb_w4","WB w4"), wb_w5 = c("wb_w5","WB w5"), wb_w6 = c("wb_w6","WB w6"), wb_w7 = c("wb_w7","WB w7"), wb_w8 = c("wb_w8","WB w8"), wb_w9 = c("wb_w9","WB w9"), wb_w10 = c("wb_w10","WB w10"), wb_w11 = c("wb_w11","WB w11"))

hrs.ebb.cw <- list(ebb_w7 = c("ebb_w7","EBB w7"), ebb_w8 = c("ebb_w8","EBB w8"), ebb_w9 = c("ebb_w9","EBB w9"), ebb_w10 = c("ebb_w10","EBB w10"), ebb_w11 = c("ebb_w11","EBB w11"))

hrs.mbb.cw <- list(mbb_w10 = c("mbb_w10","MBB w10"), mbb_w11 = c("mbb_w11","MBB w11"))




```




<!--Labelling and saving-->

```{r, echo=FALSE}

# HRS
# Consider only waves with some variable harmonised

l.hds <- lapply(hrs.hrs.cw, function(wname) if(exists(paste0("HRS_ds_",wname[1]))){wname = list(get(paste0("HRS_ds_",wname[1])),wname[2])})
nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}

m.hds <- list()

lmlist <- list(lapply(l.hds,function(x)x[[1]]),m.hds)

if(length(l.hds)>0){
  # Labelling categorical variable of tibbles
  lmlist <- labelling(lmlist[[1]],lmlist[[2]],hd_vbl,ds_label)
  # Labelling continuous variable of tibbles
  lmlist <- labelling_c(lmlist[[1]],lmlist[[2]],hd_age_vbl,ds_label_age)
  # Saving tibbles
  savingRD(lmlist[[1]],vbl_name=hd_vbl)
}

hrslist <- lmlist # HRS list


# AHEAD
# Consider only waves with some variable harmonised

l.hds <- lapply(hrs.ahead.cw, function(wname) if(exists(paste0("HRS_ds_",wname[1]))){wname = list(get(paste0("HRS_ds_",wname[1])),wname[2])})
nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}

m.hds <- list()

lmlist <- list(lapply(l.hds,function(x)x[[1]]),m.hds)


if(length(l.hds)>0){
  # Labelling categorical variable of tibbles
  lmlist <- labelling(lmlist[[1]],lmlist[[2]],hd_vbl,ds_label)
  # Labelling continuous variable of tibbles
  lmlist <- labelling_c(lmlist[[1]],lmlist[[2]],hd_age_vbl,ds_label_age)
  # Saving tibbles
  savingRD(lmlist[[1]],vbl_name=hd_vbl)
}

aheadlist <- lmlist # AHEAD list



# CODA
# Consider only waves with some variable harmonised

l.hds <- lapply(hrs.coda.cw, function(wname) if(exists(paste0("HRS_ds_",wname[1]))){wname = list(get(paste0("HRS_ds_",wname[1])),wname[2])})
nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}

m.hds <- list()

lmlist <- list(lapply(l.hds,function(x)x[[1]]),m.hds)


if(length(l.hds)>0){
  # Labelling categorical variable of tibbles
  lmlist <- labelling(lmlist[[1]],lmlist[[2]],hd_vbl,ds_label)
  # Labelling continuous variable of tibbles
  lmlist <- labelling_c(lmlist[[1]],lmlist[[2]],hd_age_vbl,ds_label_age)
  # Saving tibbles
  savingRD(lmlist[[1]],vbl_name=hd_vbl)
}

codalist <- lmlist # CODA list


# WB
# Consider only waves with some variable harmonised

l.hds <- lapply(hrs.wb.cw, function(wname) if(exists(paste0("HRS_ds_",wname[1]))){wname = list(get(paste0("HRS_ds_",wname[1])),wname[2])})
nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}

m.hds <- list()

lmlist <- list(lapply(l.hds,function(x)x[[1]]),m.hds)


if(length(l.hds)>0){
  # Labelling categorical variable of tibbles
  lmlist <- labelling(lmlist[[1]],lmlist[[2]],hd_vbl,ds_label)
  # Labelling continuous variable of tibbles
  lmlist <- labelling_c(lmlist[[1]],lmlist[[2]],hd_age_vbl,ds_label_age)
  # Saving tibbles
  savingRD(lmlist[[1]],vbl_name=hd_vbl)
}

wblist <- lmlist # WB list



# EBB
# Consider only waves with some variable harmonised

l.hds <- lapply(hrs.ebb.cw, function(wname) if(exists(paste0("HRS_ds_",wname[1]))){wname = list(get(paste0("HRS_ds_",wname[1])),wname[2])})
nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}

m.hds <- list()

lmlist <- list(lapply(l.hds,function(x)x[[1]]),m.hds)


if(length(l.hds)>0){
  # Labelling categorical variable of tibbles
  lmlist <- labelling(lmlist[[1]],lmlist[[2]],hd_vbl,ds_label)
  # Labelling continuous variable of tibbles
  lmlist <- labelling_c(lmlist[[1]],lmlist[[2]],hd_age_vbl,ds_label_age)
  # Saving tibbles
  savingRD(lmlist[[1]],vbl_name=hd_vbl)
}

ebblist <- lmlist # EBB list



# MBB
# Consider only waves with some variable harmonised

l.hds <- lapply(hrs.mbb.cw, function(wname) if(exists(paste0("HRS_ds_",wname[1]))){wname = list(get(paste0("HRS_ds_",wname[1])),wname[2])})
nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}

m.hds <- list()

lmlist <- list(lapply(l.hds,function(x)x[[1]]),m.hds)


if(length(l.hds)>0){
  # Labelling categorical variable of tibbles
  lmlist <- labelling(lmlist[[1]],lmlist[[2]],hd_vbl,ds_label)
  # Labelling continuous variable of tibbles
  lmlist <- labelling_c(lmlist[[1]],lmlist[[2]],hd_age_vbl,ds_label_age)
  # Saving tibbles
  savingRD(lmlist[[1]],vbl_name=hd_vbl)
}

mbblist <- lmlist # MBB list

```


<!--Descriptives-->


```{r summ, echo=FALSE}

# HRS
# Consider only harmonised waves
l.hds <- lapply(hrs.hrs.cw, function(wname) if(hd_vbl %in% names(get0(paste0("HRS_ds_",wname[1])))){wname})

nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}



if(length(l.hds)>0){
  lmlist[[1]] <- hrslist[[1]][sapply(l.hds,function(x)x[[1]])]
  lmlist[[2]] <- hrslist[[2]][sapply(l.hds,function(x)x[[1]])]
  
  # Printing table of categories
  print(knitr::kable(summaries(lmlist[[1]],lmlist[[2]],lapply(l.hds,function(x)x[[2]]),hd_vbl),caption=ds_label))
  # Printing table of trajectories
  f.dbb <- trajectories(lmlist[[2]],vbl_name=hd_vbl)
  print(knitr::kable(f.dbb[f.dbb[,3]>=0.3,]))

}



# AHEAD
# Consider only harmonised waves
l.hds <- lapply(hrs.ahead.cw, function(wname) if(hd_vbl %in% names(get0(paste0("HRS_ds_",wname[1])))){wname})
nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}


if(length(l.hds)>0){
  lmlist[[1]] <- aheadlist[[1]][sapply(l.hds,function(x)x[[1]])]
  lmlist[[2]] <- aheadlist[[2]][sapply(l.hds,function(x)x[[1]])]
  
  # Printing table of categories
  print(knitr::kable(summaries(lmlist[[1]],lmlist[[2]],lapply(l.hds,function(x)x[[2]]),hd_vbl),caption=ds_label))
  # Printing table of trajectories
  f.dbb <- trajectories(lmlist[[2]],vbl_name=hd_vbl)
  print(knitr::kable(f.dbb[f.dbb[,3]>=0.3,]))
}


# CODA
# Consider only harmonised waves
l.hds <- lapply(hrs.coda.cw, function(wname) if(hd_vbl %in% names(get0(paste0("HRS_ds_",wname[1])))){wname})
nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}


if(length(l.hds)>0){
  lmlist[[1]] <- codalist[[1]][sapply(l.hds,function(x)x[[1]])]
  lmlist[[2]] <- codalist[[2]][sapply(l.hds,function(x)x[[1]])]
  
  # Printing table of categories
  print(knitr::kable(summaries(lmlist[[1]],lmlist[[2]],lapply(l.hds,function(x)x[[2]]),hd_vbl),caption=ds_label))
  # Printing table of trajectories
  f.dbb <- trajectories(lmlist[[2]],vbl_name=hd_vbl)
  print(knitr::kable(f.dbb[f.dbb[,3]>=0.3,]))
}




# WB
# Consider only harmonised waves
l.hds <- lapply(hrs.wb.cw, function(wname) if(hd_vbl %in% names(get0(paste0("HRS_ds_",wname[1])))){wname})
nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}


if(length(l.hds)>0){
  lmlist[[1]] <- wblist[[1]][sapply(l.hds,function(x)x[[1]])]
  lmlist[[2]] <- wblist[[2]][sapply(l.hds,function(x)x[[1]])]
  
  # Printing table of categories
  print(knitr::kable(summaries(lmlist[[1]],lmlist[[2]],lapply(l.hds,function(x)x[[2]]),hd_vbl),caption=ds_label))
  # Printing table of trajectories
  f.dbb <- trajectories(lmlist[[2]],vbl_name=hd_vbl)
  print(knitr::kable(f.dbb[f.dbb[,3]>=0.3,]))
}



# EBB
# Consider only harmonised waves
l.hds <- lapply(hrs.ebb.cw, function(wname) if(hd_vbl %in% names(get0(paste0("HRS_ds_",wname[1])))){wname})
nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}


if(length(l.hds)>0){
  lmlist[[1]] <- ebblist[[1]][sapply(l.hds,function(x)x[[1]])]
  lmlist[[2]] <- ebblist[[2]][sapply(l.hds,function(x)x[[1]])]
  
  # Printing table of categories
  print(knitr::kable(summaries(lmlist[[1]],lmlist[[2]],lapply(l.hds,function(x)x[[2]]),hd_vbl),caption=ds_label))
  # Printing table of trajectories
  f.dbb <- trajectories(lmlist[[2]],vbl_name=hd_vbl)
  print(knitr::kable(f.dbb))
}



# MBB
# Consider only harmonised waves
l.hds <- lapply(hrs.mbb.cw, function(wname) if(hd_vbl %in% names(get0(paste0("HRS_ds_",wname[1])))){wname})
nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}


if(length(l.hds)>0){
  lmlist[[1]] <- mbblist[[1]][sapply(l.hds,function(x)x[[1]])]
  lmlist[[2]] <- mbblist[[2]][sapply(l.hds,function(x)x[[1]])]
  
  # Printing table of categories
  print(knitr::kable(summaries(lmlist[[1]],lmlist[[2]],lapply(l.hds,function(x)x[[2]]),hd_vbl),caption=ds_label))
  # Printing table of trajectories
  f.dbb <- trajectories(lmlist[[2]],vbl_name=hd_vbl)
  print(knitr::kable(f.dbb))
}

```








## Summary of descriptive statistics of the harmonised variable `h_cpd_age` accross populations and waves





```{r summ_c, echo=FALSE}

# HRS
# Consider only harmonised waves
l.hds <- lapply(hrs.hrs.cw, function(wname) if(hd_age_vbl %in% names(get0(paste0("HRS_ds_",wname[1])))){wname})

nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}



if(length(l.hds)>0){
  lmlist[[1]] <- hrslist[[1]][sapply(l.hds,function(x)x[[1]])]
  lmlist[[2]] <- hrslist[[2]][sapply(l.hds,function(x)x[[1]])]
  
  # Printing table of categories
  print(knitr::kable(summaries_c(lmlist[[1]],lmlist[[2]],lapply(l.hds,function(x)x[[2]]),hd_age_vbl),caption=ds_label_age))
}




# AHEAD
# Consider only harmonised waves
l.hds <- lapply(hrs.ahead.cw, function(wname) if(hd_age_vbl %in% names(get0(paste0("HRS_ds_",wname[1])))){wname})

nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}



if(length(l.hds)>0){
  lmlist[[1]] <- aheadlist[[1]][sapply(l.hds,function(x)x[[1]])]
  lmlist[[2]] <- aheadlist[[2]][sapply(l.hds,function(x)x[[1]])]
  
  # Printing table of categories
  print(knitr::kable(summaries_c(lmlist[[1]],lmlist[[2]],lapply(l.hds,function(x)x[[2]]),hd_age_vbl),caption=ds_label_age))
}



# CODA
# Consider only harmonised waves
l.hds <- lapply(hrs.coda.cw, function(wname) if(hd_age_vbl %in% names(get0(paste0("HRS_ds_",wname[1])))){wname})

nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}



if(length(l.hds)>0){
  lmlist[[1]] <- codalist[[1]][sapply(l.hds,function(x)x[[1]])]
  lmlist[[2]] <- codalist[[2]][sapply(l.hds,function(x)x[[1]])]
  
  # Printing table of categories
  print(knitr::kable(summaries_c(lmlist[[1]],lmlist[[2]],lapply(l.hds,function(x)x[[2]]),hd_age_vbl),caption=ds_label_age))
}




# WB
# Consider only harmonised waves
l.hds <- lapply(hrs.wb.cw, function(wname) if(hd_age_vbl %in% names(get0(paste0("HRS_ds_",wname[1])))){wname})

nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}



if(length(l.hds)>0){
  lmlist[[1]] <- wblist[[1]][sapply(l.hds,function(x)x[[1]])]
  lmlist[[2]] <- wblist[[2]][sapply(l.hds,function(x)x[[1]])]
  
  # Printing table of categories
  print(knitr::kable(summaries_c(lmlist[[1]],lmlist[[2]],lapply(l.hds,function(x)x[[2]]),hd_age_vbl),caption=ds_label_age))
}





# EBB
# Consider only harmonised waves
l.hds <- lapply(hrs.ebb.cw, function(wname) if(hd_age_vbl %in% names(get0(paste0("HRS_ds_",wname[1])))){wname})

nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}



if(length(l.hds)>0){
  lmlist[[1]] <- ebblist[[1]][sapply(l.hds,function(x)x[[1]])]
  lmlist[[2]] <- ebblist[[2]][sapply(l.hds,function(x)x[[1]])]
  
  # Printing table of categories
  print(knitr::kable(summaries_c(lmlist[[1]],lmlist[[2]],lapply(l.hds,function(x)x[[2]]),hd_age_vbl),caption=ds_label_age))
}


# MBB
# Consider only harmonised waves
l.hds <- lapply(hrs.mbb.cw, function(wname) if(hd_age_vbl %in% names(get0(paste0("HRS_ds_",wname[1])))){wname})

nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}



if(length(l.hds)>0){
  lmlist[[1]] <- mbblist[[1]][sapply(l.hds,function(x)x[[1]])]
  lmlist[[2]] <- mbblist[[2]][sapply(l.hds,function(x)x[[1]])]
  
  # Printing table of categories
  print(knitr::kable(summaries_c(lmlist[[1]],lmlist[[2]],lapply(l.hds,function(x)x[[2]]),hd_age_vbl),caption=ds_label_age))
}


```








# Quality estimation

We assume that if an individual answers it has some lung disease in one wave, it has for all the next waves.







<!-- ########################################################## -->
<!--- # Close OPAL R Session -->
```{r closeRsession, echo=FALSE}
opal.logout(o)
```





