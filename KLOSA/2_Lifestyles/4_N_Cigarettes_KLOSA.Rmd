---
title: "Number of cigarettes"
output:
  html_document:
    highlight: tango
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

<!-- ########################################################## --> 
<!-- # Installation, loading packages -->
```{r setup, include=FALSE}
source("../../setup_iago.r")
```
<!-- ########################################################## --> 
<!-- # Loading DS description -->
```{r main, child='../../_DS_Rmd/n_cigarettesDS.Rmd'}
```
```{r global, echo=F}
source('../../_DS_Rmd/n_cigarettesDS.R')
```



# Data process

## Korea

### Wave 1 

#### Study-specific variable description

| **Name** | `w01C105` |
|-|-|
| **Label** | `A present day, smoking amount (unit: piece of split wood/a day)` |
| **Table name** | `w01_main_e` |
| **Categories:**| `continuous` |
| **Missings:**| `-8 = Refuse to answer` <br/>  `NA` |
| **Description** |  |


```{r assign w1, echo=F}
opal.assign.table.tibble(o, 'KLOSA_w1','KLOSA.w01_main_e', variables=list('w01C105'), missings = TRUE)
KLOSA_w1 <- opal.execute(o,'KLOSA_w1')
```

```{r local w1, echo=F}
vbl <- KLOSA_w1$w01C105
kable(Continuous_summary(vbl, missing_values = NA)[3], caption = "Number of cigarettes") 
pander(Continuous_summary(vbl, missing_values = NA)$summary, caption = "Summary")
ggplot(KLOSA_w1, aes(w01C105)) + geom_histogram(stat="count", fill="steelblue") + xlab("Number of cigarettes") + ylab("Frequency") + xlim(0,62)
```

#### Harmonisation algorithm

To compute `n_cigarettes` from the study-specific variable it has to be recoded as follows:

* `w01C105*7`
* `-8 into 997`
* `NA into 999`

**R script:**

```{r harmo w1}
KLOSA_ds_w1 <- tibble(id=KLOSA_w1$id)
KLOSA_ds_w1$n_cigarettes <- car::recode(KLOSA_w1$w01C105*7, "-8*7 = 997;NA = 999 ")
```

#### Statistical description of the new harmonised variable
```{r descript w1, echo=F}
vbl <- KLOSA_ds_w1$n_cigarettes
kable(Continuous_summary(var = vbl, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = ds_label)
kable(Continuous_summary(vbl, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))$summary, caption = "Summary")
ggplot(KLOSA_ds_w1, aes(n_cigarettes)) + geom_histogram(stat="count", fill="steelblue") + xlab(ds_label) + ylab("Frequency") + xlim(0,440) 
```

#### Validation
```{r crosstabulation w1, echo=F}
```




### Wave 2

#### Study-specific variable description

| **Name** | `w02C119` |
|-|-|
| **Label** | `Amount of smoking in persent (unit: a cigarette/ a day)` |
| **Table name** | `w02_main_e_spss` |
| **Categories:**| `continuous` |
| **Missings:**| `-8 = Refuse to answer` <br/>  `NA` |
| **Description** |  |


```{r assign w2, echo=F}
opal.assign.table.tibble(o, 'KLOSA_w2','KLOSA.w02_main_e_spss', variables=list('w02C119'), missings = TRUE)
KLOSA_w2 <- opal.execute(o,'KLOSA_w2')
```

```{r local w2, echo=F}
vbl <- KLOSA_w2$w02C119
kable(Continuous_summary(vbl, missing_values = NA)[3], caption = "Number of cigarettes") 
pander(Continuous_summary(vbl, missing_values = NA)$summary, caption = "Summary")
ggplot(KLOSA_w2, aes(w02C119)) + geom_histogram(stat="count", fill="steelblue") + xlab("Number of cigarettes") + ylab("Frequency") + xlim(0,62)
```

#### Harmonisation algorithm

The harmonized variable is the same than the study-specific variable, but the missing values have to be recoded as follows:

* `w02C119*7`
* `-8 into 997`
* `NA into 999`

**R script:**

```{r harmo w2}
KLOSA_ds_w2 <- tibble(id=KLOSA_w2$id)
KLOSA_ds_w2$n_cigarettes <- car::recode(KLOSA_w2$w02C119*7, "-8*7 = 997;NA = 999 ")
```

#### Statistical description of the new harmonised variable
```{r descript w2, echo=F}
vbl <- KLOSA_ds_w2$n_cigarettes
kable(Continuous_summary(var = vbl, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = ds_label)
kable(Continuous_summary(vbl, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))$summary, caption = "Summary")
ggplot(KLOSA_ds_w2, aes(n_cigarettes)) + geom_histogram(stat="count", fill="steelblue") + xlab(ds_label) + ylab("Frequency") + xlim(0,440) 
```

#### Validation
```{r crosstabulation w2, echo=F}
```




### Wave 3

#### Study-specific variable description

| **Name** | `w03C119` |
|-|-|
| **Label** | `The average of smoking amount (unit : piece of split wood/a day)` |
| **Table name** | `w03_main_e_spss_albert` |
| **Categories:**| `continuous` |
| **Missings:**| `NA` |
| **Description** |  |


```{r assign w3, echo=F}
opal.assign.table.tibble(o, 'KLOSA_w3','KLOSA.w03_main_e_spss_albert', variables=list('w03C119'), missings = TRUE)
KLOSA_w3 <- opal.execute(o,'KLOSA_w3')
# The id's in the third wave add a '.0' at the end of the id's at the previous waves. We correct this. Note that gregexpr("\\.0",ids) == nchar(ids)-1
KLOSA_w3$id <- substr(KLOSA_w3$id,1,nchar(KLOSA_w3$id)-2)

```

```{r local w3, echo=F}
vbl <- KLOSA_w3$w03C119
kable(Continuous_summary(vbl, missing_values = NA)[3], caption = "Number of cigarettes") 
pander(Continuous_summary(vbl, missing_values = NA)$summary, caption = "Summary")
ggplot(KLOSA_w3, aes(w03C119)) + geom_histogram(stat="count", fill="steelblue") + xlab("Number of cigarettes") + ylab("Frequency") + xlim(0,52)
```

#### Harmonisation algorithm

The harmonized variable is the same than the study-specific variable, but the missing values have to be recoded as follows:

* `w03C119*7`
* `NA into 999`

**R script:**

```{r harmo w3}
KLOSA_ds_w3 <- tibble(id=KLOSA_w3$id)
KLOSA_ds_w3$n_cigarettes <- car::recode(KLOSA_w3$w03C119*7, "NA = 999 ")
```

#### Statistical description of the new harmonised variable
```{r descript w3, echo=F}
vbl <- KLOSA_ds_w3$n_cigarettes
kable(Continuous_summary(var = vbl, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = ds_label)
kable(Continuous_summary(vbl, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))$summary, caption = "Summary")
ggplot(KLOSA_ds_w3, aes(n_cigarettes)) + geom_histogram(stat="count", fill="steelblue") + xlab(ds_label) + ylab("Frequency") + xlim(0,370) 
```

#### Validation
```{r crosstabulation w3, echo=F}
```




### Wave 4

#### Study-specific variable description

| **Name** | `w04C119` |
|-|-|
| **Label** | `The average of smoking amount (unit : piece of split wood/a day)` |
| **Table name** | `w04_main_e_spss` |
| **Categories:**| `continuous` |
| **Missings:**| `NA` |
| **Description** |  |


```{r assign w4, echo=F}
opal.assign.table.tibble(o, 'KLOSA_w4','KLOSA.w04_main_e_spss', variables=list('w04C119'), missings = TRUE)
KLOSA_w4 <- opal.execute(o,'KLOSA_w4')
```

```{r local w4, echo=F}
vbl <- KLOSA_w4$w04C119
kable(Continuous_summary(vbl, missing_values = NA)[3], caption = "Number of cigarettes") 
pander(Continuous_summary(vbl, missing_values = NA)$summary, caption = "Summary")
ggplot(KLOSA_w4, aes(w04C119)) + geom_histogram(stat="count", fill="steelblue") + xlab("Number of cigarettes") + ylab("Frequency") + xlim(0,62)
```

#### Harmonisation algorithm

The harmonized variable is the same than the study-specific variable, but the missing values have to be recoded as follows:

* `w04C119*7`
* `NA into 999`

**R script:**

```{r harmo w4}
KLOSA_ds_w4 <- tibble(id=KLOSA_w4$id)
KLOSA_ds_w4$n_cigarettes <- car::recode(KLOSA_w4$w04C119*7, "NA = 999 ")
```

#### Statistical description of the new harmonised variable
```{r descript w4, echo=F}
vbl <- KLOSA_ds_w4$n_cigarettes
kable(Continuous_summary(var = vbl, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = ds_label)
kable(Continuous_summary(vbl, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))$summary, caption = "Summary")
ggplot(KLOSA_ds_w4, aes(n_cigarettes)) + geom_histogram(stat="count", fill="steelblue") + xlab(ds_label) + ylab("Frequency") + xlim(0,440) 
```

#### Validation
```{r crosstabulation w4, echo=F}
```





# Quality estimation
[Comments on the quality of the new harmonised variable.]

<!-- ########################################################## --> 
<!-- # Save -->
```{r save, include=FALSE, echo=F}

l.hds <- list(w1 = KLOSA_ds_w1, w2 = KLOSA_ds_w2, w3 = KLOSA_ds_w3, w4 = KLOSA_ds_w4)


for(index in seq_along(l.hds)){
  label(l.hds[[index]][[2]]) <- ds_label
  n_cigarettes <- l.hds[[index]]
  save(n_cigarettes, file = paste0(datafolder,names(l.hds)[index],"/n_cigarettes.RData"))
}

```
<!-- ########################################################## --> 


<!-- ########################################################## -->
<!--- # Close OPAL R Session -->
```{r closeRsession, echo=FALSE}
opal.logout(o)
```
