---
title: "Age"
output:
  html_document:
    highlight: tango
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

<!-- ########################################################## --> 
<!-- # Installation, loading packages -->
```{r setup, include=FALSE}
source("../../setup.r")
```
<!-- ########################################################## --> 
<!-- # Loading DS description -->
```{r main, child='../../_DS_Rmd/ageDS.Rmd'}
```
```{r global, echo=F}
source('../../_DS_Rmd/ageDS.R')
```


# Data process

## ALSA


### Wave 1 

#### Study-specific variable description

| **Name** | `AGE` |
|----------|------------|
| **Label** | `Age` |
| **Table name** | `ALSA-Wave1` |
| **Missings** | `999 = Missing` |
| **Description** |  |


```{r assign1, echo=F}
opal.assign.table.tibble(o, 'ALSA_w1_age','ALSA.ALSA-Wave1',
                         variables=list('AGE'), missings = TRUE)
ALSA_w1_age <- opal.execute(o,'ALSA_w1_age')
```

```{r local1, echo=F}
vari <- ALSA_w1_age$AGE
kable(Continuous_summary(vari, missing_values = NA)[3], caption = attributes(vari)$`spss::shortName`)
pander(Continuous_summary(vari, missing_values = NA)$summary, caption = "Summary")

ggplot(ALSA_w1_age, aes(AGE)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable, but the missing values have to be recoded as follows:

* `NA into 999`

**R script:**

```{r harmo1}
ALSA_ds_w1 <- tibble(id=ALSA_w1_age$id)
ALSA_ds_w1$age <- car::recode(ALSA_w1_age$AGE, "NA=999")
ALSA_ds_w1$age <- labelled(ALSA_ds_w1$age, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996,  "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript1, echo=F}
vari <- ALSA_ds_w1$age
kable(Continuous_summary(var = vari, missing_values = miss_values_vector)[3])
kable(Continuous_summary(vari, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vari, missing_values = miss_values_vector)$summary, caption = "Summary")

ggplot(ALSA_ds_w1, aes(age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency") 
```

#### Validation
```{r crosstabulation1, echo=F}
```







### Wave 2 

#### Study-specific variable description

| **Name** | `AGE` |
|----------|------------|
| **Label** | `Age` |
| **Table name** | `ALSA-Wave1` |
| **Missings** | `999 = Missing` |
| **Description** |  |


```{r assign2, echo=F}
opal.assign.table.tibble(o, 'ALSA_w1_age','ALSA.ALSA-Wave1',
                         variables=list('AGE'), missings = TRUE)
opal.assign.table.tibble(o, 'ALSA_w2_id','ALSA.ALSA-Wave2',
                         variables=list('DATE'), missings = TRUE)
```

```{r local2, echo=F}
ALSA_w1_age <- opal.execute(o,'ALSA_w1_age')
ALSA_w2_id <- opal.execute(o,'ALSA_w2_id')


Add_indiv <- function(old, new){
  
  new_2 <- matrix(rep(NA, dim(new)[1]*dim(new)[2] ), nrow = dim(new)[1])
  oldm <- as.matrix(old)
  
  for(i in 1:length(new$id)){
    if(sum(new$id[i]==old$id)>=1){
      new_2[i,] <- oldm[which(new$id[i]==old$id),]
    } else {
      new_2[i,] <- c(new$id[i], NA)
    }
  }
  
  new_22 <- data.frame(id=new_2[,1], AGE=as.numeric(new_2[,2]))
  new_22
}

ALSA_w2_age <- Add_indiv(old = ALSA_w1_age, new = ALSA_w2_id)

vari <- ALSA_w2_age$AGE
kable(Continuous_summary(vari, missing_values = NA)[3], caption = attributes(vari)$`spss::shortName`)
pander(Continuous_summary(vari, missing_values = NA)$summary, caption = "Summary")

ggplot(ALSA_w2_age, aes(AGE)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable plus 1 years, but the missing values have to be recoded as follows:

* `NA into 999`

**R script:**

```{r harmo2}
ALSA_ds_w2 <- tibble(id=ALSA_w2_age$id)
ALSA_ds_w2$age <- car::recode(ALSA_w2_age$AGE+1, "NA=999")
ALSA_ds_w2$age <- labelled(ALSA_ds_w2$age, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996,  "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript2, echo=F}
vari <- ALSA_ds_w2$age
kable(Continuous_summary(var = vari, missing_values = miss_values_vector)[3])
kable(Continuous_summary(vari, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vari, missing_values = miss_values_vector)$summary, caption = "Summary")

ggplot(ALSA_ds_w2, aes(age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency") 
```

#### Validation
```{r crosstabulation2, echo=F}
```









### Wave 3 

#### Study-specific variable description

| **Name** | `AGE` |
|----------|------------|
| **Label** | `Age` |
| **Table name** | `ALSA-Wave1` |
| **Missings** | `999 = Missing` |
| **Description** |  |


```{r assign3, echo=F}
opal.assign.table.tibble(o, 'ALSA_w1_age','ALSA.ALSA-Wave1',
                         variables=list('AGE'), missings = TRUE)
opal.assign.table.tibble(o, 'ALSA_w3_id','ALSA.ALSA-Wave3',
                         variables=list('DOMICW3'), missings = TRUE)

```

```{r local3, echo=F}
ALSA_w1_age <- opal.execute(o,'ALSA_w1_age')
ALSA_w3_id <- opal.execute(o,'ALSA_w3_id')


Add_indiv <- function(old, new){
  
  new_2 <- matrix(rep(NA, dim(new)[1]*dim(new)[2] ), nrow = dim(new)[1])
  oldm <- as.matrix(old)
  
  for(i in 1:length(new$id)){
    if(sum(new$id[i]==old$id)>=1){
      new_2[i,] <- oldm[which(new$id[i]==old$id),]
    } else {
      new_2[i,] <- c(new$id[i], NA)
    }
  }
  
  new_22 <- data.frame(id=new_2[,1], AGE=as.numeric(new_2[,2]))
  new_22
}

ALSA_w3_age <- Add_indiv(old = ALSA_w1_age, new = ALSA_w3_id)

vari <- ALSA_w3_age$AGE
kable(Continuous_summary(vari, missing_values = NA)[3], caption = attributes(vari)$`spss::shortName`)
pander(Continuous_summary(vari, missing_values = NA)$summary, caption = "Summary")

ggplot(ALSA_w1_age, aes(AGE)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable plus 2 years, but the missing values have to be recoded as follows:

* `NA into 999`

**R script:**

```{r harmo3}
ALSA_ds_w3 <- tibble(id=ALSA_w3_age$id)
ALSA_ds_w3$age <- car::recode(ALSA_w3_age$AGE+2, "NA=999")
ALSA_ds_w3$age <- labelled(ALSA_ds_w3$age, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996,  "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript3, echo=F}
vari <- ALSA_ds_w3$age
kable(Continuous_summary(var = vari, missing_values = miss_values_vector)[3])
kable(Continuous_summary(vari, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vari, missing_values = miss_values_vector)$summary, caption = "Summary")

ggplot(ALSA_ds_w3, aes(age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency") 
```

#### Validation
```{r crosstabulation3, echo=F}
```







### Wave 4 

#### Study-specific variable description

| **Name** | `AGE` |
|----------|------------|
| **Label** | `Age` |
| **Table name** | `ALSA-Wave1` |
| **Missings** | `999 = Missing` |
| **Description** |  |


```{r assign4, echo=F}
opal.assign.table.tibble(o, 'ALSA_w1_age','ALSA.ALSA-Wave1',
                         variables=list('AGE'), missings = TRUE)
opal.assign.table.tibble(o, 'ALSA_w4_id','ALSA.ALSA-Wave4',
                         variables=list('W4QUNO'), missings = TRUE)

```

```{r local4, echo=F}
ALSA_w1_age <- opal.execute(o,'ALSA_w1_age')
ALSA_w4_id <- opal.execute(o,'ALSA_w4_id')


Add_indiv <- function(old, new){
  
  new_2 <- matrix(rep(NA, dim(new)[1]*dim(new)[2] ), nrow = dim(new)[1])
  oldm <- as.matrix(old)
  
  for(i in 1:length(new$id)){
    if(sum(new$id[i]==old$id)>=1){
      new_2[i,] <- oldm[which(new$id[i]==old$id),]
    } else {
      new_2[i,] <- c(new$id[i], NA)
    }
  }
  
  new_22 <- data.frame(id=new_2[,1], AGE=as.numeric(new_2[,2]))
  new_22
}

ALSA_w4_age <- Add_indiv(old = ALSA_w1_age, new = ALSA_w4_id)

vari <- ALSA_w4_age$AGE
kable(Continuous_summary(vari, missing_values = NA)[3], caption = attributes(vari)$`spss::shortName`)
pander(Continuous_summary(vari, missing_values = NA)$summary, caption = "Summary")

ggplot(ALSA_w4_age, aes(AGE)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable plus 3 years, but the missing values have to be recoded as follows:

* `NA into 999`

**R script:**

```{r harmo4}
ALSA_ds_w4 <- tibble(id=ALSA_w4_age$id)
ALSA_ds_w4$age <- car::recode(ALSA_w4_age$AGE+3, "NA=999")
ALSA_ds_w4$age <- labelled(ALSA_ds_w4$age, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996,  "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript4, echo=F}
vari <- ALSA_ds_w4$age
kable(Continuous_summary(var = vari, missing_values = miss_values_vector)[3])
kable(Continuous_summary(vari, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vari, missing_values = miss_values_vector)$summary, caption = "Summary")

ggplot(ALSA_ds_w4, aes(age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency") 
```

#### Validation
```{r crosstabulation4, echo=F}
```








### Wave 5 

#### Study-specific variable description

| **Name** | `AGE` |
|----------|------------|
| **Label** | `Age` |
| **Table name** | `ALSA-Wave1` |
| **Missings** | `999 = Missing` |
| **Description** |  |


```{r assign5, echo=F}
opal.assign.table.tibble(o, 'ALSA_w1_age','ALSA.ALSA-Wave1',
                         variables=list('AGE'), missings = TRUE)
opal.assign.table.tibble(o, 'ALSA_w5_id','ALSA.ALSA-Wave5',
                         variables=list('INTTYPW5'), missings = TRUE)

```

```{r local5, echo=F}
ALSA_w1_age <- opal.execute(o,'ALSA_w1_age')
ALSA_w5_id <- opal.execute(o,'ALSA_w5_id')


Add_indiv <- function(old, new){
  
  new_2 <- matrix(rep(NA, dim(new)[1]*dim(new)[2] ), nrow = dim(new)[1])
  oldm <- as.matrix(old)
  
  for(i in 1:length(new$id)){
    if(sum(new$id[i]==old$id)>=1){
      new_2[i,] <- oldm[which(new$id[i]==old$id),]
    } else {
      new_2[i,] <- c(new$id[i], NA)
    }
  }
  
  new_22 <- data.frame(id=new_2[,1], AGE=as.numeric(new_2[,2]))
  new_22
}

ALSA_w5_age <- Add_indiv(old = ALSA_w1_age, new = ALSA_w5_id)

vari <- ALSA_w5_age$AGE
kable(Continuous_summary(vari, missing_values = NA)[3], caption = attributes(vari)$`spss::shortName`)
pander(Continuous_summary(vari, missing_values = NA)$summary, caption = "Summary")

ggplot(ALSA_w5_age, aes(AGE)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable plus 6 years, but the missing values have to be recoded as follows:

* `NA into 999`

**R script:**

```{r harmo5}
ALSA_ds_w5 <- tibble(id=ALSA_w5_age$id)
ALSA_ds_w5$age <- car::recode(ALSA_w5_age$AGE+6, "NA=999")
ALSA_ds_w5$age <- labelled(ALSA_ds_w5$age, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996,  "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript5, echo=F}
vari <- ALSA_ds_w5$age
kable(Continuous_summary(var = vari, missing_values = miss_values_vector)[3])
kable(Continuous_summary(vari, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vari, missing_values = miss_values_vector)$summary, caption = "Summary")

ggplot(ALSA_ds_w5, aes(age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency") 
```

#### Validation
```{r crosstabulation5, echo=F}
```








### Wave 6 

#### Study-specific variable description

| **Name** | `AGEW6` |
|----------|------------|
| **Label** | `Age at Wave6 interview` |
| **Table name** | `ALSA-Wave6` |
| **Description** |  |


```{r assign6, echo=F}
opal.assign.table.tibble(o, 'ALSA_w6_age','ALSA.ALSA-Wave6', variables=list('AGEW6'), missings = TRUE)
ALSA_w6_age <- opal.execute(o,'ALSA_w6_age')

opal.assign.table.tibble(o, 'ALSA_w1_ybirth','ALSA.ALSA-Wave1',variables=list('BIRTHDAT'), missings = TRUE)
ALSA_w1_ybirth <- opal.execute(o,'ALSA_w1_ybirth')

Date_of_birth <- function(date){
  date <- as.numeric(date)
  n <- length(date)
  D <- matrix(NA, nrow = n, ncol = 3)
  for(i in 1:n){
    if(log10(date[i])+1>=8){
      D[i,] <- as.numeric(t(sapply(date[i], 
                                               function(x) substring(x, first=c(1, 3, 5), 
                                                                     last=c(2, 4, 8)))))
    }
    else{
      D[i,] <- as.numeric(t(sapply(date[i], 
                                               function(x) substring(x, first=c(1, 2, 4), 
                                                                     last=c(1, 3, 7)))))
    }
  }
  colnames(D) <- c("Day", "Month", "Year")
  D
}

ALSA_w1_ybirth <- cbind(ALSA_w1_ybirth, Date_of_birth(ALSA_w1_ybirth$BIRTHDAT))


```

```{r local6, echo=F}
vari <- ALSA_w6_age$AGEW6
kable(Continuous_summary(vari, missing_values = NA)[3], caption = attributes(vari)$`spss::shortName`)
pander(Continuous_summary(vari, missing_values = NA)$summary, caption = "Summary")

ggplot(ALSA_w6_age, aes(AGEW6)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable, but the missing values have to be recoded as follows:

* `NA into 999`

**R script:**

```{r harmo6}
ALSA_ds_w6 <- tibble(id=ALSA_w6_age$id)
ALSA_ds_w6$age <- car::recode(ALSA_w6_age$AGEW6, "NA=999")
ALSA_ds_w6$age <- labelled(ALSA_ds_w6$age, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996,  "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript6, echo=F}
vari <- ALSA_ds_w6$age
kable(Continuous_summary(var = vari, missing_values = miss_values_vector)[3])
kable(Continuous_summary(vari, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vari, missing_values = miss_values_vector)$summary, caption = "Summary")

ggplot(ALSA_ds_w6, aes(age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency") 
```

#### Validation
```{r crosstabulation6, echo=T}

ALSA_val <- left_join(ALSA_ds_w6,ALSA_ds_w1,by="id", suffix=c(".w6",".w1"))
ALSA_val$diff <- ALSA_val$age.w6-ALSA_val$age.w1

kable(frq(ALSA_val$diff)[[1]][1:4,c(1,3,4)], align = 'c', caption = "The difference of age between this wave and wave 1 should be around 8 years.")

cat("The individual whose answered age is not compatible with given in wave 1 is",ALSA_val$id[which(ALSA_val$diff == 13)],". ")

ALSA_val <-left_join(ALSA_val,ALSA_w1_ybirth,by="id")

cat("The age answered in wave 1 corresponds with its year of birth since 1992 (w1-year) - ",ALSA_val$Year[which(ALSA_val$diff == 13)]," (year of birth) = ",ALSA_val$age.w1[which(ALSA_val$diff == 13)], " (age in wave 1). Therefore we correct its age as follows: [age in wave 6] = [age in wave 1] + 8.")

ALSA_ds_w6$age[which(ALSA_ds_w6$id == ALSA_val$id[which(ALSA_val$diff == 13)])] <- ALSA_ds_w1$age[which(ALSA_ds_w1$id == ALSA_val$id[which(ALSA_val$diff == 13)])] + 8

```







### Wave 7 

#### Study-specific variable description

| **Name** | `AGE` |`living_status`|
|----------|-----|-------|
| **Label** | `Age` |`Living status`|
| **Table name** | `ALSA-Wave1` |`living_status`|
| **Categories** |`continuous`|`0 = Alive`<br/>`1 = Dead`<br/>`2 = Dropout/unknown`|
| **Missings** | `999 = Missing` |  |
| **Description** |  |  |


    
```{r assign7, echo=F}
opal.assign.table.tibble(o, 'ALSA_w1_age','ALSA.ALSA-Wave1', variables=list('AGE'), missings = TRUE)
ALSA_w1_age <- opal.execute(o,'ALSA_w1_age')
opal.assign.table.tibble(o, 'ALSA_w7_id','ALSA.ALSA-Wave7', variables=list('datew7'), missings = TRUE)
ALSA_w7_id <- opal.execute(o,'ALSA_w7_id')
load(paste0(datafolder,"w7/living_status.RData"))


Add_indiv <- function(old, new){
  
  new_2 <- matrix(rep(NA, dim(new)[1]*dim(new)[2] ), nrow = dim(new)[1])
  oldm <- as.matrix(old)
  
  for(i in 1:length(new$id)){
    if(sum(new$id[i]==old$id)>=1){
      new_2[i,] <- oldm[which(new$id[i]==old$id),]
    } else {
      new_2[i,] <- c(new$id[i], NA)
    }
  }
  
  new_22 <- data.frame(id=new_2[,1], AGE=as.numeric(new_2[,2]))
  new_22
}

ALSA_w7_age <- Add_indiv(old = ALSA_w1_age, new = ALSA_w7_id)


ALSA_w7_age <- left_join(ALSA_w7_age,living_status,by="id")
rm(living_status)


```

```{r local7, echo=F}


vari <- ALSA_w7_age$AGE
kable(Continuous_summary(vari, missing_values = NA)[3], caption = attributes(vari)$`spss::shortName`)
pander(Continuous_summary(vari, missing_values = NA)$summary, caption = "Summary")

ggplot(ALSA_w7_age, aes(AGE)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency")


vbl <- ALSA_w7_age$living_status
kable(Categorical_summary(vari, missing_values = NA)[3], caption = "living_status")
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(ALSA_w7_age, aes(x=factor(living_status))) + geom_histogram(stat="count", fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable plus 11 years, but the missing values have to be recoded as follows:

* `NA into 999`
* `living_status==Dead or Dropout into 996`

**R script:**

```{r harmo7}
ALSA_ds_w7 <- tibble(id=ALSA_w7_age$id)
ALSA_ds_w7$age <- car::recode(ALSA_w7_age$AGE+11, "NA=999")
ALSA_ds_w7$age[which(ALSA_w7_age$living_status %in% c(1,2))] <- 996
ALSA_ds_w7$age <- labelled(ALSA_ds_w7$age, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996,  "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript7, echo=F}
vari <- ALSA_ds_w7$age
kable(Continuous_summary(var = vari, missing_values = miss_values_vector)[3])
kable(Continuous_summary(vari, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vari, missing_values = miss_values_vector)$summary, caption = "Summary")

ggplot(ALSA_ds_w7, aes(age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency") 
```

#### Validation
```{r crosstabulation7, echo=F}
```








### Wave 8 

#### Study-specific variable description

| **Name** | `AGE` |
|----------|------------|
| **Label** | `Age` |
| **Table name** | `ALSA-Wave1` |
| **Missings** | `999 = Missing` |
| **Description** |  |

    
```{r assign8, echo=F}
opal.assign.table.tibble(o, 'ALSA_w1_age','ALSA.ALSA-Wave1',
                         variables=list('AGE'), missings = TRUE)
opal.assign.table.tibble(o, 'ALSA_w8_id','ALSA.ALSA-Wave8',
                         variables=list('Date'), missings = TRUE)
```

```{r local8, echo=F}
ALSA_w1_age <- opal.execute(o,'ALSA_w1_age')
ALSA_w8_id <- opal.execute(o,'ALSA_w8_id')


Add_indiv <- function(old, new){
  
  new_2 <- matrix(rep(NA, dim(new)[1]*dim(new)[2] ), nrow = dim(new)[1])
  oldm <- as.matrix(old)
  
  for(i in 1:length(new$id)){
    if(sum(new$id[i]==old$id)>=1){
      new_2[i,] <- oldm[which(new$id[i]==old$id),]
    } else {
      new_2[i,] <- c(new$id[i], NA)
    }
  }
  
  new_22 <- data.frame(id=new_2[,1], AGE=as.numeric(new_2[,2]))
  new_22
}

ALSA_w8_age <- Add_indiv(old = ALSA_w1_age, new = ALSA_w8_id)

vari <- ALSA_w8_age$AGE
kable(Continuous_summary(vari, missing_values = NA)[3], caption = attributes(vari)$`spss::shortName`)
pander(Continuous_summary(vari, missing_values = NA)$summary, caption = "Summary")

ggplot(ALSA_w8_age, aes(AGE)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable plus 13 years, but the missing values have to be recoded as follows:

* `NA into 999`

**R script:**

```{r harmo8}
ALSA_ds_w8 <- tibble(id=ALSA_w8_age$id)
ALSA_ds_w8$age <- car::recode(ALSA_w8_age$AGE+13, "NA=999")
ALSA_ds_w8$age <- labelled(ALSA_ds_w8$age, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996,  "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript8, echo=F}
vari <- ALSA_ds_w8$age
kable(Continuous_summary(var = vari, missing_values = miss_values_vector)[3])
kable(Continuous_summary(vari, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vari, missing_values = miss_values_vector)$summary, caption = "Summary")

ggplot(ALSA_ds_w8, aes(age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency") 
```

#### Validation
```{r crosstabulation8, echo=F}
```








### Wave 9 

#### Study-specific variable description

| **Name** | `AGE` |`living_status`|
|----------|-----|-------|
| **Label** | `Age` |`Living status`|
| **Table name** | `ALSA-Wave1` |`living_status`|
| **Categories** |`continuous`|`0 = Alive`<br/>`1 = Dead`<br/>`2 = Dropout/unknown`|
| **Missings** | `999 = Missing` |  |
| **Description** |  |  |


```{r assign9, echo=F}
opal.assign.table.tibble(o, 'ALSA_w1_age','ALSA.ALSA-Wave1', variables=list('AGE'), missings = TRUE)
ALSA_w1_age <- opal.execute(o,'ALSA_w1_age')
opal.assign.table.tibble(o, 'ALSA_w9_id','ALSA.ALSA-Wave9', variables=list('sex'), missings = TRUE)
ALSA_w9_id <- opal.execute(o,'ALSA_w9_id')
load(paste0(datafolder,"w9/living_status.RData"))

Add_indiv <- function(old, new){
  
  new_2 <- matrix(rep(NA, dim(new)[1]*dim(new)[2] ), nrow = dim(new)[1])
  oldm <- as.matrix(old)
  
  for(i in 1:length(new$id)){
    if(sum(new$id[i]==old$id)>=1){
      new_2[i,] <- oldm[which(new$id[i]==old$id),]
    } else {
      new_2[i,] <- c(new$id[i], NA)
    }
  }
  
  new_22 <- data.frame(id=new_2[,1], AGE=as.numeric(new_2[,2]))
  new_22
}

ALSA_w9_age <- Add_indiv(old = ALSA_w1_age, new = ALSA_w9_id)


ALSA_w9_age <- left_join(ALSA_w9_age,living_status,by="id")
rm(living_status)

```

```{r local9, echo=F}


vari <- ALSA_w9_age$AGE
kable(Continuous_summary(vari, missing_values = NA)[3], caption = attributes(vari)$`spss::shortName`)
pander(Continuous_summary(vari, missing_values = NA)$summary, caption = "Summary")

ggplot(ALSA_w9_age, aes(AGE)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency")


vbl <- ALSA_w9_age$living_status
kable(Categorical_summary(vari, missing_values = NA)[3], caption = "living_status")
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(ALSA_w9_age, aes(x=factor(living_status))) + geom_histogram(stat="count", fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable plus 15 years, but the missing values have to be recoded as follows:

* `NA into 999`
* `living_status==Dead or Dropout into 996`

**R script:**

```{r harmo9}
ALSA_ds_w9 <- tibble(id=ALSA_w9_age$id)
ALSA_ds_w9$age <- car::recode(ALSA_w9_age$AGE+15, "NA=999")
ALSA_ds_w9$age[which(ALSA_w9_age$living_status %in% c(1,2))] <- 996
ALSA_ds_w9$age <- labelled(ALSA_ds_w9$age, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996,  "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript9, echo=F}
vari <- ALSA_ds_w9$age
kable(Continuous_summary(var = vari, missing_values = miss_values_vector)[3])
kable(Continuous_summary(vari, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vari, missing_values = miss_values_vector)$summary, caption = "Summary")

ggplot(ALSA_ds_w9, aes(age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency") + xlim(76,116) 
```

#### Validation
```{r crosstabulation9, echo=F}
```








### Wave 10 

#### Study-specific variable description

| **Name** | `AGE` |
|----------|------------|
| **Label** | `Age` |
| **Table name** | `ALSA-Wave1` |
| **Missings** | `999 = Missing` |
| **Description** |  |


    
```{r assign10, echo=F}
opal.assign.table.tibble(o, 'ALSA_w1_age','ALSA.ALSA-Wave1',
                         variables=list('AGE'), missings = TRUE)
opal.assign.table.tibble(o, 'ALSA_w10_id','ALSA.ALSA-Wave10',
                         variables=list('Date'), missings = TRUE)
```

```{r local10, echo=F}
ALSA_w1_age <- opal.execute(o,'ALSA_w1_age')
ALSA_w10_id <- opal.execute(o,'ALSA_w10_id')


Add_indiv <- function(old, new){
  
  new_2 <- matrix(rep(NA, dim(new)[1]*dim(new)[2] ), nrow = dim(new)[1])
  oldm <- as.matrix(old)
  
  for(i in 1:length(new$id)){
    if(sum(new$id[i]==old$id)>=1){
      new_2[i,] <- oldm[which(new$id[i]==old$id),]
    } else {
      new_2[i,] <- c(new$id[i], NA)
    }
  }
  
  new_22 <- data.frame(id=new_2[,1], AGE=as.numeric(new_2[,2]))
  new_22
}

ALSA_w10_age <- Add_indiv(old = ALSA_w1_age, new = ALSA_w10_id)

vari <- ALSA_w10_age$AGE
kable(Continuous_summary(vari, missing_values = NA)[3], caption = attributes(vari)$`spss::shortName`)
pander(Continuous_summary(vari, missing_values = NA)$summary, caption = "Summary")

ggplot(ALSA_w10_age, aes(AGE)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable plus 16 years, but the missing values have to be recoded as follows:

* `NA into 999`

**R script:**

```{r harmo10}
ALSA_ds_w10 <- tibble(id=ALSA_w10_age$id)
ALSA_ds_w10$age <- car::recode(ALSA_w10_age$AGE+16, "NA=999")
ALSA_ds_w10$age <- labelled(ALSA_ds_w10$age, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996,  "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript10, echo=F}
vari <- ALSA_ds_w10$age
kable(Continuous_summary(var = vari, missing_values = miss_values_vector)[3])
kable(Continuous_summary(vari, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vari, missing_values = miss_values_vector)$summary, caption = "Summary")

ggplot(ALSA_ds_w10, aes(age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency") + xlim(75,105)
```

#### Validation
```{r crosstabulation10, echo=F}
```









### Wave 11 

#### Study-specific variable description

| **Name** | `AGEW11` |
|----------|------------|
| **Label** | `age w11` |
| **Table name** | `ALSA-Wave11` |
| **Description** |  |


```{r assign11, echo=F}
opal.assign.table.tibble(o, 'ALSA_w11_age','ALSA.ALSA-Wave11',
                         variables=list('AGEW11'), missings = TRUE)
ALSA_w11_age <- opal.execute(o,'ALSA_w11_age')
```

```{r local11, echo=F}
vari <- ALSA_w11_age$AGEW11
kable(Continuous_summary(vari, missing_values = NA)[3], caption = attributes(vari)$`spss::shortName`)
pander(Continuous_summary(vari, missing_values = NA)$summary, caption = "Summary")

ggplot(ALSA_w11_age, aes(AGEW11)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable, but the missing values have to be recoded as follows:

* `NA into 999`

**R script:**

```{r harmo11}
ALSA_ds_w11 <- tibble(id=ALSA_w11_age$id)
ALSA_ds_w11$age <- car::recode(ALSA_w11_age$AGEW11, "NA=999")
ALSA_ds_w11$age <- labelled(ALSA_ds_w11$age, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996,  "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript11, echo=F}
vari <- ALSA_ds_w11$age
kable(Continuous_summary(var = vari, missing_values = miss_values_vector)[3])
kable(Continuous_summary(vari, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vari, missing_values = miss_values_vector)$summary, caption = "Summary")

ggplot(ALSA_ds_w11, aes(age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency") 
```

#### Validation
```{r crosstabulation11, echo=F}


ALSA_val <- left_join(ALSA_ds_w11,ALSA_ds_w1,by="id", suffix=c(".w11",".w1"))
ALSA_val$diff <- ALSA_val$age.w11-ALSA_val$age.w1

kable(frq(ALSA_val$diff)[[1]][1:3,c(1,3,4)], align = 'c', caption = "The difference of age between this wave and wave 1 should be around 18 years.")


```








### Wave 12 

#### Study-specific variable description

| **Name** | `ageW12` |
|----------|------------|
| **Label** | `age w12` |
| **Table name** | `ALSA-Wave12` |
| **Description** |  |

    
```{r assign12, echo=F}
opal.assign.table.tibble(o, 'ALSA_w12_age','ALSA.ALSA-Wave12',
                         variables=list('ageW12'), missings = TRUE)
ALSA_w12_age <- opal.execute(o,'ALSA_w12_age')
```

```{r local12, echo=F}
vari <- ALSA_w12_age$ageW12
kable(Continuous_summary(vari, missing_values = NA)[3], caption = attributes(vari)$`spss::shortName`)
pander(Continuous_summary(vari, missing_values = NA)$summary, caption = "Summary")

ggplot(ALSA_w12_age, aes(ageW12)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable, but the missing values have to be recoded as follows:

* `NA into 999`

**R script:**

```{r harmo12}
ALSA_ds_w12 <- tibble(id=ALSA_w12_age$id)
ALSA_ds_w12$age <- car::recode(ALSA_w12_age$ageW12, "NA=999")
ALSA_ds_w12$age <- labelled(ALSA_ds_w12$age, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996,  "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript12, echo=F}
vari <- ALSA_ds_w12$age
kable(Continuous_summary(var = vari, missing_values = miss_values_vector)[3])
kable(Continuous_summary(vari, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vari, missing_values = miss_values_vector)$summary, caption = "Summary")

ggplot(ALSA_ds_w12, aes(age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency") 
```

#### Validation
```{r crosstabulation12, echo=F}



ALSA_val <- left_join(ALSA_ds_w12,ALSA_ds_w1,by="id", suffix=c(".w12",".w1"))
ALSA_val$diff <- ALSA_val$age.w12-ALSA_val$age.w1

kable(frq(ALSA_val$diff)[[1]][1:2,c(1,3,4)], align = 'c', caption = "The difference of age between this wave and wave 1 should be around 21 years.")

```








### Wave 13 

#### Study-specific variable description

| **Name** | `AGE` |
|----------|------------|
| **Label** | `Age` |
| **Table name** | `ALSA-Wave1` |
| **Missings** | `999 = Missing` |
| **Description** |  |

    
```{r assign13, echo=F}
opal.assign.table.tibble(o, 'ALSA_w1_age','ALSA.ALSA-Wave1',
                         variables=list('AGE'), missings = TRUE)
opal.assign.table.tibble(o, 'ALSA_w13_id','ALSA.ALSA-Wave13',
                         variables=list('proxy'), missings = TRUE)

```

```{r local13, echo=F}
ALSA_w1_age <- opal.execute(o,'ALSA_w1_age')
ALSA_w13_id <- opal.execute(o,'ALSA_w13_id')


Add_indiv <- function(old, new){
  
  new_2 <- matrix(rep(NA, dim(new)[1]*dim(new)[2] ), nrow = dim(new)[1])
  oldm <- as.matrix(old)
  
  for(i in 1:length(new$id)){
    if(sum(new$id[i]==old$id)>=1){
      new_2[i,] <- oldm[which(new$id[i]==old$id),]
    } else {
      new_2[i,] <- c(new$id[i], NA)
    }
  }
  
  new_22 <- data.frame(id=new_2[,1], AGE=as.numeric(new_2[,2]))
  new_22
}

ALSA_w13_age <- Add_indiv(old = ALSA_w1_age, new = ALSA_w13_id)

vari <- ALSA_w13_age$AGE
kable(Continuous_summary(vari, missing_values = NA)[3], caption = attributes(vari)$`spss::shortName`)
pander(Continuous_summary(vari, missing_values = NA)$summary, caption = "Summary")

ggplot(ALSA_w13_age, aes(AGE)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable plus 22 years, but the missing values have to be recoded as follows:

* `NA into 999`

**R script:**

```{r harmo13}
ALSA_ds_w13 <- tibble(id=ALSA_w13_age$id)
ALSA_ds_w13$age <- car::recode(ALSA_w13_age$AGE+22, "NA=999")
ALSA_ds_w13$age <- labelled(ALSA_ds_w13$age, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996,  "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript13, echo=F}
vari <- ALSA_ds_w13$age
kable(Continuous_summary(var = vari, missing_values = miss_values_vector)[3])
kable(Continuous_summary(vari, missing_values = miss_values_vector)[2], caption = "Values")
pander(Continuous_summary(vari, missing_values = miss_values_vector)$summary, caption = "Summary")

ggplot(ALSA_ds_w13, aes(age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency") + xlim(80,100)
```

#### Validation
```{r crosstabulation13, echo=F}
```






## Summary of descriptive statistics of the harmonised variable accross populations and waves

```{r helpfunctions, echo=F}

labelling <- function(l.hds,m.hds){
  
  # Labelling of the tibbles with continuous data and creating new tibbles with all missings recodified as NA

  for(name in names(l.hds)) {
    # In the aux_object we copy the old tibble to recodify all missing values as NA.
    aux_object <- l.hds[[name]]
    # Labelling of variables
    label(l.hds[[name]][[2]]) <- label(aux_object[[2]]) <- ds_label
    # Labelling of categories (for continues variables, only missing values)
    l.hds[[name]][[2]] <- labelled(l.hds[[name]][[2]], labels = cont_label)
    aux_object[[2]] <- car::recode(aux_object[[2]], "miss_values_vector=NA")
    # Saving the recodified tibble in list m.hds
    m.hds[[name]] <- aux_object
    rm(aux_object)
  }
  return(list(l.hds,m.hds))

}

# Creation of summary tables for continuous data

summaries <- function(l.hds,m.hds,lnames){

  # Creation of column with summary table categories
  t.summ <- summary(m.hds[[1]][2])[1:6]
  # Adding of missing/no-missing values categories
  t.hds <- c(substr(t.summ,1,regexpr(":", t.summ, fixed=T)-1),labels(Continuous_summary(l.hds[[1]][[2]],missing_values = miss_values_vector)$values_table)[[2]])
  # For each wave/population in l.hds, add the correponding values
  for (i in seq_along(l.hds)){
    # First, summary values
    t.summ <- summary(m.hds[[i]][2])[1:6]
    # Next, missing/no-missing values
    t.hds <- cbind(t.hds,c(as.numeric(substr(t.summ,regexpr(":", t.summ, fixed=T)+1,nchar(t.summ))),as.numeric(Continuous_summary(l.hds[[i]][[2]],missing_values = miss_values_vector)$values_table[1,])))
  }
  # Add sample size for each wave/population
  t.hds <- rbind(t.hds,c("sample size", sapply(l.hds,function(wave) length(wave[[1]]))))
  # Add wave/population names
  dimnames(t.hds)[[2]] <- c(dimnames(summary(m.hds[[1]][2]))[[2]],lnames)
  return(t.hds)
  
}

# Save data tables

savingRD <- function(l.hds,vbl_name){
  
  for(index in seq_along(l.hds)){
    assign(vbl_name,l.hds[[index]])
    save(vbl_name,list = vbl_name, file = paste0(datafolder,names(l.hds)[index],"/",vbl_name,".RData"))
  }

}

```




```{r summ, echo=F}

# All study waves and populations with abbreviated and descriptive names


alsa.cw <- list(w1 = c("w1","W1"), w2 = c("w2","W2"), w3 = c("w3","W3"), w4 = c("w4","W4"), w5 = c("w5","W5"), w6 = c("w6","W6"), w7 = c("w7","W7"), w8 = c("w8","W8"), w9 = c("w9","W9"), w10 = c("w10","W10"), w11 = c("w11","W11"), w12 = c("w12","W12"), w13 = c("w13","W13"))

# Consider only harmonised waves
l.hds <- lapply(alsa.cw, function(wname) if(exists(paste0("ALSA_ds_",wname[1]))){wname = list(get(paste0("ALSA_ds_",wname[1])),wname[2])})
nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}

m.hds <- list()

lmlist <- list(lapply(l.hds,function(x)x[[1]]),m.hds)

if(length(l.hds)>0){
  # Labelling tibbles
  lmlist <- labelling(lmlist[[1]],lmlist[[2]])
  # Printing summaries
  print(knitr::kable(summaries(lmlist[[1]],lmlist[[2]],lapply(l.hds,function(x)x[[2]])),caption=ds_label))
  # Saving tibbles
  savingRD(lmlist[[1]],vbl_name=hd_vbl)
}



```







# Quality estimation
In all waves except 1, 6, 11 ad 12, age is imputed by adding the years in between waves. Recall the central year of each wave:

| **Wave** | **Year** |
|-|-|
|1|1992|
|2|1993|
|3|1994|
|4|1995|
|5|1998|
|6|2000|
|7|2003|
|8|2005|
|9|2007|
|10|2008|
|11|2010|
|12|2013|
|13|2014|




```{r closeRsession, echo=FALSE}
opal.logout(o)
```
