---
title: "Year of interview"
output:
  html_document:
    highlight: tango
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---
  
<!-- ########################################################## --> 

<!-- # Installation, loading packages -->
<!-- **R script:** -->

```{r setup, include=FALSE}
source("M:/WPs/WP1/Maelstrom/data_process/athlos-project.github.io/setup_albert.r")
```
<!-- ########################################################## --> 



# Description of DataSchema variable `yintw`

The description of harmonised variable is the following:
  
* Name: `yintw`
* Label: `year of interview`
* Type of variable: `countinous`
* Missings: 
    + `991 = CAPI/interviewer error`
    + `992 = Impute`
    + `993 = Disable to measure`
    + `994 = Not applicable`
    + `995 = Does not answer`
    + `996 = Not attempt/not done`
    + `997 = Refuse`
    + `998 = Do not know`
    + `999 = Missing`



### ALSA - Wave 1 

#### Study-specific variables

The study-specific variable elected to be harmonised is:

* Name: `datew1`
* Label: `Date of Wave1 interview`
    
```{r assign1}
opal.assign.table.tibble(o, 'ALSA_w1_yinter','ALSA.dates_of_interview_w1',
                         variables=list('datew1'), missings = TRUE)
```

```{r local1}
ALSA_w1_yinter <- opal.execute(o,'ALSA_w1_yinter')
ALSA_w1_yinter$yinter <- as.numeric(format(ALSA_w1_yinter$datew1, '%y'))
Categorical_summary(var = ALSA_w1_yinter$yinter, missing_values = NA)
ggplot(ALSA_w1_yinter, aes(x=factor(yinter))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same of the study-specific variable but the missing values have to be recoded as follows:

* `NA into 999`


R code of the ALGORITHM:

```{r harmo1}
ALSA_ds_w1 <- tibble(id=ALSA_w1_yinter$id)
ALSA_ds_w1$yintw <- ALSA_w1_yinter$yinter
ALSA_ds_w1$yintw <- labelled(ALSA_ds_w1$yintw, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=996, "Does not answer"=995,  "Not applicable"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript1}
Categorical_summary(var = ALSA_ds_w1$yintw, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(ALSA_ds_w1, aes(x=factor(yintw))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Validation
```{r crosstabulation1}
BeforeH <- table(ALSA_w1_yinter$yinter, useNA = "ifany")
AfterH <- table(ALSA_ds_w1$yintw)
C <- rbind(BeforeH,AfterH)
colnames(C) <- names(AfterH)
C
```






### ALSA - Wave 2 

#### Study-specific variables

The study-specific variable elected to be harmonised is:

* Name: `datew2`
* Label: ``

    
```{r assign2}
opal.assign.table.tibble(o, 'ALSA_w2_dinter','ALSA.dates_of_interview_w2',
                         variables=list('datew2'), missings = TRUE)
ALSA_w2_dinter <- opal.execute(o,'ALSA_w2_dinter')

ids <- which(!(ALSA_w2_dinter$id %in% ALSA_w1_yinter$id))
ALSA_w2_dinter <- ALSA_w2_dinter[-ids,]
```

```{r local2}
ALSA_w2_dinter$yinter <- format(ALSA_w2_dinter$datew2, '%y')
Categorical_summary(var = ALSA_w2_dinter$yinter, missing_values = NA)
ggplot(ALSA_w2_dinter, aes(x=factor(yinter))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same of the study-specific variable but the missing values will be recoded as 94 since is the most frecuent value. 

R code of the ALGORITHM:

```{r harmo2}
ALSA_ds_w2 <- tibble(id=ALSA_w2_dinter$id)
ALSA_ds_w2$yintw <- car::recode(ALSA_w2_dinter$yinter, "NA=94")
ALSA_ds_w2$yintw <- labelled(ALSA_ds_w2$yintw, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=996, "Does not answer"=995,  "Not applicable"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript2}
Categorical_summary(var = ALSA_ds_w2$yintw, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(ALSA_ds_w2, aes(x=factor(yintw))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Validation
```{r crosstabulation2}
BeforeH <- table(ALSA_w2_dinter$yinter, useNA = "ifany")
BeforeH <- c(BeforeH[1], sum(BeforeH[c(2,3)]))
AfterH <- table(ALSA_ds_w2$yintw)
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("93", "(NA,94)->94" )
C
```








### ALSA - Wave 3 

#### Study-specific variables

The study-specific variable elected to be harmonised is:

* Name: `datew3`
* Label: `Date of Wave3 interview`



```{r assign3}
opal.assign.table.tibble(o, 'ALSA_w3_yinter','ALSA.dates_of_interview_w3',
                         variables=list('datew3'), missings = TRUE)
opal.assign.table.tibble(o, 'ALSA_w3_id','ALSA.ALSA-Wave3',
                         variables=list('SEXW3'), missings = TRUE)
```

```{r local3}
ALSA_w3_yinter <- opal.execute(o,'ALSA_w3_yinter')
ALSA_w3_yinter$yinter <- format(ALSA_w3_yinter$datew3, '%Y')
ALSA_w3_id <- opal.execute(o,'ALSA_w3_id')

Add_indiv <- function(old, new){
  
  new_2 <- matrix(NA, nrow = dim(new)[1], ncol=dim(old)[2])
  oldm <- as.matrix(old)
  
  for(i in 1:length(new$id)){
    if(sum(new$id[i]==old$id)>=1){
      new_2[i,] <- oldm[which(new$id[i]==old$id),]
    } else {
      new_2[i,] <- c(new$id[i], NA, NA)
    }
  }
  
  new_22 <- data.frame(id=new_2[,1], datew3=new_2[,2], yinter=as.numeric(new_2[,3]))
  new_22
}

ALSA_w3_yinter2 <- Add_indiv(old = ALSA_w3_yinter, new = ALSA_w3_id)


Categorical_summary(var = ALSA_w3_yinter2$yinter, missing_values = NA)
ggplot(ALSA_w3_yinter2, aes(x=factor(yinter))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same of the study-specific variable but the missing values have to be recoded as follows:

* `NA into 999`

R code of the ALGORITHM:

```{r harmo3}
ALSA_ds_w3 <- tibble(id=ALSA_w3_yinter2$id)
ALSA_ds_w3$yintw <- ALSA_w3_yinter2$yinter
ALSA_ds_w3$yintw <- labelled(ALSA_ds_w3$yintw, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=996, "Does not answer"=995,  "Not applicable"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript3}
Categorical_summary(var = ALSA_ds_w3$yintw, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(ALSA_ds_w3, aes(x=factor(yintw))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Validation
```{r crosstabulation3}
BeforeH <- table(ALSA_w3_yinter2$yinter, useNA = "ifany")
AfterH <- table(ALSA_ds_w3$yintw)
C <- rbind(BeforeH,AfterH)
colnames(C) <- names(AfterH)
C
```








### ALSA - Wave 4 

#### Study-specific variables

The study-specific variable elected to be harmonised is:

* Name: `DATEW4`
* Label: `DATE OF INTERVIEW`
    
```{r assign4}
opal.assign.table.tibble(o, 'ALSA_w4_yinter','ALSA.ALSA-Wave4',
                         variables=list('DATEW4'), missings = TRUE)
```

```{r local4}
ALSA_w4_yinter <- opal.execute(o,'ALSA_w4_yinter')
Date_of_birth <- function(date){
  n <- length(date)
  D <- matrix(NA, nrow = n, ncol = 3)
  for(i in 1:n){
      D[i,] <- as.numeric(t(sapply(date[i], 
                                               function(x) substring(x, first=c(1, 4, 7), 
                                                                     last=c(2, 5, 8)))))
    }
  colnames(D) <- c("Day", "Month", "Year")
  D
}

ALSA_w4_yinter <- cbind(ALSA_w4_yinter, Date_of_birth(ALSA_w4_yinter$DATEW4))

Categorical_summary(var = ALSA_w4_yinter$Year, missing_values = NA)
ggplot(ALSA_w4_yinter, aes(x=factor(Year))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

There are the values 5 and 56 that are going to consider as a write mistakes and they are going to be recoded as 95 and 96 	respectively.

#### Harmonisation algorithm
The harmonized variable is the same of the study-specific variable but the missing values have to be recoded as follows:

* `NA into 999`

R code of the ALGORITHM:

```{r harmo4}
ALSA_ds_w4 <- tibble(id=ALSA_w4_yinter$id)
ALSA_ds_w4$yintw <- car::recode(ALSA_w4_yinter$Year, "5=95; 56=96")
ALSA_ds_w4$yintw <- labelled(ALSA_ds_w4$yintw, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=996, "Does not answer"=995,  "Not applicable"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript4}
Categorical_summary(var = ALSA_ds_w4$yintw, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(ALSA_ds_w4, aes(x=factor(yintw))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Validation
```{r crosstabulation4}
BeforeH <- table(ALSA_w4_yinter$Year, useNA = "ifany")
BeforeH <- c(sum(BeforeH[c(1,3)]), sum(BeforeH[c(2,4)]))
AfterH <- table(ALSA_ds_w4$yintw)
C <- rbind(BeforeH,AfterH)
colnames(C) <- names(AfterH)
C
```









### ALSA - Wave 5 

#### Study-specific variables

The study-specific variable elected to be harmonised is:

* Name: `DATE`
* Label: `DATE INTERVIEW COMPLETED`
    
```{r assign5}
opal.assign.table.tibble(o, 'ALSA_w5_yinter','ALSA.ALSA-Wave5',
                         variables=list('DATE'), missings = TRUE)
```

```{r local5}
ALSA_w5_yinter <- opal.execute(o,'ALSA_w5_yinter')
Date_of_birth <- function(date){
  n <- length(date)
  D <- matrix(NA, nrow = n, ncol = 3)
  for(i in 1:n){
      D[i,] <- as.numeric(t(sapply(date[i], 
                                               function(x) substring(x, first=c(1, 4, 7), 
                                                                     last=c(2, 5, 10)))))
    }
  colnames(D) <- c("Month", "Day", "Year")
  D
}

ALSA_w5_yinter <- cbind(ALSA_w5_yinter, Date_of_birth(ALSA_w5_yinter$DATE))

Categorical_summary(var = ALSA_w5_yinter$Year, missing_values = NA)
ggplot(ALSA_w5_yinter, aes(Year)) + geom_histogram(stat="count", fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same of the study-specific variable but the missing values have to be recoded as follows:

* `NA into 999`

R code of the ALGORITHM:

```{r harmo5}
ALSA_ds_w5 <- tibble(id=ALSA_w5_yinter$id)
ALSA_ds_w5$yintw <- ALSA_w5_yinter$Year
ALSA_ds_w5$yintw <- labelled(ALSA_ds_w5$yintw, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=996, "Does not answer"=995,  "Not applicable"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript5}
Categorical_summary(var = ALSA_ds_w5$yintw, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(ALSA_ds_w5, aes(x=factor(yintw))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Validation
```{r crosstabulation5}
BeforeH <- table(ALSA_w5_yinter$Year, useNA = "ifany")
AfterH <- table(ALSA_ds_w5$yintw)
C <- rbind(BeforeH,AfterH)
colnames(C) <- names(AfterH)
C
```









### ALSA - Wave 6 

#### Study-specific variables

The study-specific variable elected to be harmonised is:

* Name: `DATEW6`
* Label: `Wave6 interview date`

    
```{r assign6}
opal.assign.table.tibble(o, 'ALSA_w6_yinter','ALSA.ALSA-Wave6',
                         variables=list('DATEW6'), missings = TRUE)
```

```{r local6}
ALSA_w6_yinter <- opal.execute(o,'ALSA_w6_yinter')
ALSA_w6_yinter$yinter <- format(ALSA_w6_yinter$DATEW6, '%Y')
Categorical_summary(var = ALSA_w6_yinter$yinter, missing_values = NA)
ggplot(ALSA_w6_yinter, aes(x=factor(yinter))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same of the study-specific variable but the missing values have to be recoded as follows:

* `NA into 999`


R code of the ALGORITHM:

```{r harmo6}
ALSA_ds_w6 <- tibble(id=ALSA_w6_yinter$id)
ALSA_ds_w6$yintw <- as.numeric(ALSA_w6_yinter$yinter)
ALSA_ds_w6$yintw <- labelled(ALSA_ds_w6$yintw, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=996, "Does not answer"=995,  "Not applicable"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript6}
Categorical_summary(var = ALSA_ds_w6$yintw, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(ALSA_ds_w6, aes(x=factor(yintw))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Validation
```{r crosstabulation6}
BeforeH <- table(ALSA_w6_yinter$yinter, useNA = "ifany")
AfterH <- table(ALSA_ds_w6$yintw)
C <- rbind(BeforeH,AfterH)
colnames(C) <- names(AfterH)
C
```







### ALSA - Wave 7 

#### Study-specific variables

The study-specific variable elected to be harmonised is:

* Name: `datew7`
* Label: `date of interview-W7`
    
```{r assign7}
opal.assign.table.tibble(o, 'ALSA_w7_yinter','ALSA.dates_of_interview_w7',
                         variables=list('datew7'), missings = TRUE)
opal.assign.table.tibble(o, 'ALSA_w7_id','ALSA.ALSA-Wave7',
                         variables=list('sex'), missings = TRUE)
```


```{r local7}
ALSA_w7_yinter <- opal.execute(o,'ALSA_w7_yinter')
ALSA_w7_id <- opal.execute(o,'ALSA_w7_id')
ALSA_w7_yinter$yinter <- format(ALSA_w7_yinter$datew7, '%Y')


Add_indiv <- function(old, new){
  
  new_2 <- matrix(NA, nrow = dim(new)[1], ncol=dim(old)[2])
  oldm <- as.matrix(old)
  
  for(i in 1:length(new$id)){
    if(sum(new$id[i]==old$id)>=1){
      new_2[i,] <- oldm[which(new$id[i]==old$id),]
    } else {
      new_2[i,] <- c(new$id[i], rep(NA,2))
    }
  }
  
  new_22 <- data.frame(id=new_2[,1], BIRTHDAT=new_2[,2], yinter=as.numeric(new_2[,3]))
  new_22
}


ALSA_w7_ybirth2 <- Add_indiv(old = ALSA_w7_yinter, new = ALSA_w7_id)
Categorical_summary(var = ALSA_w1_yinter$yinter, missing_values = NA)
ggplot(ALSA_w1_yinter, aes(x=factor(yinter))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same of the study-specific variable but the missing values have to be recoded as 2003 since is the most frequent value.


R code of the ALGORITHM:

```{r harmo7}
ALSA_ds_w7 <- tibble(id=ALSA_w7_ybirth2$id)
ALSA_ds_w7$yintw <- car::recode(ALSA_w7_ybirth2$yinter, "NA=2003")
ALSA_ds_w7$yintw <- labelled(ALSA_ds_w7$yintw, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=996, "Does not answer"=995,  "Not applicable"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript7}
Categorical_summary(var = ALSA_ds_w7$yintw, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(ALSA_ds_w7, aes(x=factor(yintw))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Validation
```{r crosstabulation7}
BeforeH <- table(ALSA_w7_ybirth2$yinter, useNA = "ifany")
BeforeH <- c(sum(BeforeH[c(1,3)]), BeforeH[2])
AfterH <- table(ALSA_ds_w7$yintw)
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("(NA,2003)->2003", "2004")
C
```








### ALSA - Wave 8 

#### Study-specific variables

The study-specific variable elected to be harmonised is:

* Name: `Date`
* Label: `Date`
    
```{r assign8}
opal.assign.table.tibble(o, 'ALSA_w8_yinter','ALSA.ALSA-Wave8',
                         variables=list('Date'), missings = TRUE)
```

```{r local8}
ALSA_w8_yinter <- opal.execute(o,'ALSA_w8_yinter')

#This function return a table with the date of birth separated by columns:
Date_of_birth <- function(date){
  date <- as.numeric(date)
  n <- length(date)
  D <- matrix(NA, nrow = n, ncol = 3)
  for(i in 1:n){
    if(log10(date[i])+1>=8){
      D[i,] <- as.numeric(t(sapply(date[i], 
                                               function(x) substring(x, first=c(1, 5, 7), 
                                                                     last=c(4, 6, 8)))))
    }
    else{
      D[i,] <- as.numeric(t(sapply(date[i], 
                                               function(x) substring(x, first=c(1, 5, 7), 
                                                                     last=c(4, 6, 8)))))
    }
  }
  colnames(D) <- c("Year", "Month", "Day")
  D
}

ALSA_w8_yinter2 <- cbind(ALSA_w8_yinter, Date_of_birth(ALSA_w8_yinter$Date))
Categorical_summary(var = ALSA_w8_yinter2$Year, missing_values = NA)
ggplot(ALSA_w8_yinter2, aes(x=factor(Year))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same of the study-specific variable but the missing values have to be recoded as follows:

* `NA into 999`

R code of the ALGORITHM:

```{r harmo8}
ALSA_ds_w8 <- tibble(id=ALSA_w8_yinter2$id)
ALSA_ds_w8$yintw <- ALSA_w8_yinter2$Year
ALSA_ds_w8$yintw <- labelled(ALSA_ds_w8$yintw, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=996, "Does not answer"=995,  "Not applicable"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript8}
Categorical_summary(var = ALSA_ds_w8$yintw, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(ALSA_ds_w8, aes(x=factor(yintw))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Validation
```{r crosstabulation8}
BeforeH <- table(ALSA_w8_yinter2$Year, useNA = "ifany")
AfterH <- table(ALSA_ds_w8$yintw)
C <- rbind(BeforeH,AfterH)
colnames(C) <- names(AfterH)
C
```








### ALSA - Wave 9 

#### Study-specific variables

The study-specific variable elected to be harmonised is:

* Name: `DATEW9`
* Label: `Date of interview Wave 9`

    
```{r assign9}
opal.assign.table.tibble(o, 'ALSA_w9_dinter','ALSA.ALSA-Wave9',
                         variables=list('DATEW9'), missings = TRUE)
```

```{r local9}
ALSA_w9_dinter <- opal.execute(o,'ALSA_w9_dinter')

#This function return a table with the date of birth separated by columns:
Date_of_birth <- function(date){
  date <- as.numeric(date)
  n <- length(date)
  D <- matrix(NA, nrow = n, ncol = 3)
  for(i in 1:n){
    if(is.na(date[i])){
      D[i,] <- rep(NA,3)
    }
    else{
      D[i,] <- as.numeric(t(sapply(date[i], 
                                               function(x) substring(x, first=c(1, 5, 7), 
                                                                     last=c(4, 6, 8)))))
    } 
  }
 colnames(D) <- c("Year", "Month", "Day")    
 D
}

ALSA_w9_yinter <- cbind(ALSA_w9_dinter, Date_of_birth(ALSA_w9_dinter$DATEW9))

Categorical_summary(var = ALSA_w9_yinter$Year, missing_values = NA)
ggplot(ALSA_w9_yinter, aes(x=factor(Year))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same of the study-specific variable but the missing values are going to be computed as 2008 since is the most frequent value.


R code of the ALGORITHM:

```{r harmo9}
ALSA_ds_w9 <- tibble(id=ALSA_w9_yinter$id)
ALSA_ds_w9$yintw <- car::recode(ALSA_w9_yinter$Year, "NA=2008")
ALSA_ds_w9$yintw <- labelled(ALSA_ds_w9$yintw, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=996, "Does not answer"=995,  "Not applicable"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript9}
Categorical_summary(var = ALSA_ds_w9$yintw, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(ALSA_ds_w9, aes(x=factor(yintw))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Validation
```{r crosstabulation9}
BeforeH <- table(ALSA_w9_yinter$Year, useNA = "ifany")
BeforeH <- c(BeforeH[1], sum(BeforeH[2:3]))
AfterH <- table(ALSA_ds_w9$yintw)
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("2007", "(NA,2008)->2008")
C
```







### ALSA - Wave 10 

#### Study-specific variables

The study-specific variable elected to be harmonised is:

* Name: `Date`
* Label: `Date`

    
```{r assign10}
opal.assign.table.tibble(o, 'ALSA_w10_dinter','ALSA.ALSA-Wave10',
                         variables=list('Date'), missings = TRUE)
```

```{r local10}
ALSA_w10_dinter <- opal.execute(o,'ALSA_w10_dinter')
ALSA_w10_dinter$yinter <- format(ALSA_w10_dinter$Date, '%Y')
Categorical_summary(var = ALSA_w10_dinter$yinter, missing_values = NA)
ggplot(ALSA_w10_dinter, aes(x=factor(yinter))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same of the study-specific variable but the missing values have to be recoded as follows:

* `NA into 999`

R code of the ALGORITHM:

```{r harmo10}
ALSA_ds_w10 <- tibble(id=ALSA_w10_dinter$id)
ALSA_ds_w10$yintw <- as.numeric(ALSA_w10_dinter$yinter)
ALSA_ds_w10$yintw <- labelled(ALSA_ds_w10$yintw, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=996, "Does not answer"=995,  "Not applicable"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript10}
Categorical_summary(var = ALSA_ds_w10$yintw, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(ALSA_ds_w10, aes(x=factor(yintw))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Validation
```{r crosstabulation10}
BeforeH <- table(ALSA_w10_dinter$yinter, useNA = "ifany")
AfterH <- table(ALSA_ds_w10$yintw)
C <- rbind(BeforeH,AfterH)
colnames(C) <- names(AfterH)
C
```









### ALSA - Wave 11 

#### Study-specific variables

The study-specific variable elected to be harmonised is:

* Name: `DATEW11`
* Label: `Date of interview Wave 11`

    
```{r assign11}
opal.assign.table.tibble(o, 'ALSA_w11_dinter','ALSA.ALSA-Wave11',
                         variables=list('DATEW11'), missings = TRUE)
```

```{r local11}
ALSA_w11_dinter <- opal.execute(o,'ALSA_w11_dinter')
ALSA_w11_dinter$yinter <- format(ALSA_w11_dinter$DATEW11, '%Y')
Categorical_summary(var = ALSA_w11_dinter$yinter, missing_values = NA)
ggplot(ALSA_w11_dinter, aes(x=factor(yinter))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same of the study-specific variable but the missing values have to be recoded as follows:

* `NA into 999`


R code of the ALGORITHM:

```{r harmo11}
ALSA_ds_w11 <- tibble(id=ALSA_w11_dinter$id)
ALSA_ds_w11$yintw <- as.numeric(ALSA_w11_dinter$yinter)
ALSA_ds_w11$yintw <- labelled(ALSA_ds_w11$yintw, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=996, "Does not answer"=995,  "Not applicable"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript11}
Categorical_summary(var = ALSA_ds_w11$yintw, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(ALSA_ds_w11, aes(x=factor(yintw))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Validation
```{r crosstabulation11}
BeforeH <- table(ALSA_w11_dinter$yinter, useNA = "ifany")
AfterH <- table(ALSA_ds_w11$yintw)
C <- rbind(BeforeH,AfterH)
colnames(C) <- names(AfterH)
C
```









### ALSA - Wave 12 

#### Study-specific variables

The study-specific variable elected to be harmonised is:

* Name: `DATEW12`
* Label: `Date of interview Wave 12`

    
```{r assign12}
opal.assign.table.tibble(o, 'ALSA_w12_dinter','ALSA.ALSA-Wave12',
                         variables=list('DATEW12'), missings = TRUE)
```

```{r local12}
ALSA_w12_dinter <- opal.execute(o,'ALSA_w12_dinter')
ALSA_w12_dinter$yinter <- format(ALSA_w12_dinter$DATEW12, '%Y')
Categorical_summary(var = ALSA_w12_dinter$yinter, missing_values = NA)
ggplot(ALSA_w12_dinter, aes(x=factor(yinter))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same of the study-specific variable but the missing values have to be recoded as follows:

* `NA into 999`

R code of the ALGORITHM:

```{r harmo12}
ALSA_ds_w12 <- tibble(id=ALSA_w12_dinter$id)
ALSA_ds_w12$yintw <- as.numeric(ALSA_w12_dinter$yinter)
ALSA_ds_w12$yintw <- labelled(ALSA_ds_w12$yintw, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=996, "Does not answer"=995,  "Not applicable"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript12}
Categorical_summary(var = ALSA_ds_w12$yintw, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(ALSA_ds_w12, aes(x=factor(yintw))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Validation
```{r crosstabulation12}
BeforeH <- table(ALSA_w12_dinter$yinter, useNA = "ifany")
AfterH <- table(ALSA_ds_w12$yintw)
C <- rbind(BeforeH,AfterH)
colnames(C) <- names(AfterH)
C
```





### ALSA - Wave 13 

#### Study-specific variables

The study-specific variable elected to be harmonised is:

* Name: `DATEW13`
* Label: `Date of interview Wave 13`

    
```{r assign13}
opal.assign.table.tibble(o, 'ALSA_w13_dinter','ALSA.ALSA-Wave13',
                         variables=list('DATEW13'), missings = TRUE)
```

```{r local13}
ALSA_w13_dinter <- opal.execute(o,'ALSA_w13_dinter')
ALSA_w13_dinter$yinter <- format(ALSA_w13_dinter$DATEW13, '%Y')
Categorical_summary(var = ALSA_w13_dinter$yinter, missing_values = NA)
ggplot(ALSA_w13_dinter, aes(x=factor(yinter))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same of the study-specific variable but the missing values have to be recoded as follows:

* `NA into 999`

R code of the ALGORITHM:

```{r harmo13}
ALSA_ds_w13 <- tibble(id=ALSA_w13_dinter$id)
ALSA_ds_w13$yintw <- as.numeric(ALSA_w13_dinter$yinter)
ALSA_ds_w13$yintw <- labelled(ALSA_ds_w13$yintw, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=996, "Does not answer"=995,  "Not applicable"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript13}
Categorical_summary(var = ALSA_ds_w13$yintw, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(ALSA_ds_w13, aes(x=factor(yintw))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Validation
```{r crosstabulation13}
BeforeH <- table(ALSA_w13_dinter$yinter, useNA = "ifany")
AfterH <- table(ALSA_ds_w13$yintw)
C <- rbind(BeforeH,AfterH)
colnames(C) <- names(AfterH)
C
```


#### Quality estimation
The date was the same as the study specific variable taking into account the wave time lapse information. The missing values have been recoded as the most common year between the no missing values. 



```{r save, echo=FALSE}
yintw <- ALSA_ds_w1
save(yintw, file = "../RData/w1/yintw.RData")
rm(yintw)

yintw <- ALSA_ds_w2
save(yintw, file = "../RData/w2/yintw.RData")
rm(yintw)

yintw <- ALSA_ds_w3
save(yintw, file = "../RData/w3/yintw.RData")
rm(yintw)

yintw <- ALSA_ds_w4
save(yintw, file = "../RData/w4/yintw.RData")
rm(yintw)

yintw <- ALSA_ds_w5
save(yintw, file = "../RData/w5/yintw.RData")
rm(yintw)

yintw <- ALSA_ds_w6
save(yintw, file = "../RData/w6/yintw.RData")
rm(yintw)

yintw <- ALSA_ds_w7
save(yintw, file = "../RData/w7/yintw.RData")
rm(yintw)

yintw <- ALSA_ds_w8
save(yintw, file = "../RData/w8/yintw.RData")
rm(yintw)

yintw <- ALSA_ds_w9
save(yintw, file = "../RData/w9/yintw.RData")
rm(yintw)

yintw <- ALSA_ds_w10
save(yintw, file = "../RData/w10/yintw.RData")
rm(yintw)

yintw <- ALSA_ds_w11
save(yintw, file = "../RData/w11/yintw.RData")
rm(yintw)

yintw <- ALSA_ds_w12
save(yintw, file = "../RData/w12/yintw.RData")
rm(yintw)

yintw <- ALSA_ds_w13
save(yintw, file = "../RData/w13/yintw.RData")
rm(yintw)
```


```{r closeRsession, echo=FALSE} 
opal.logout(o)
```
