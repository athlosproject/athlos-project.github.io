---
title: "Respondent"
output:
  html_document:
    highlight: tango
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

<!-- ########################################################## --> 
<!-- # Installation, loading packages -->
```{r setup, include=FALSE}
source("../../setup.r")
library(multidplyr)
cluster <- get_default_cluster()
library(printr)
```
<!-- ########################################################## --> 

<!-- ########################################################## --> 
<!-- # Loading DS description -->
```{r main, child='../../_DS_Rmd/respondentDS.Rmd'}
```

```{r global, echo=F}
source('../../_DS_Rmd/respondentDS.R')
id_missings <- c("Cf-397794-01", "DE-271503-01", "Ih-306138-02", "Ih-737574-01", "Ih-907477-01", "NL-027316-01", "NL-037198-01", "NL-073637-01", "NL-155292-01", "NL-372323-01", "NL-922959-01", "NL-924571-01", "GR-190740-02", "Bn-330112-02", "DK-639322-02", "ES-932056-02", "PL-691802-02", "SE-764326-05", "AT-215568-02", "AT-864946-01", "AT-886095-01", "CZ-023045-01", "CZ-033227-01", "CZ-191583-01", "CZ-356553-01", "CZ-373473-04", "CZ-384175-01", "CZ-526053-01", "CZ-638063-01", "CZ-694720-01", "CZ-695635-01", "F1-191516-01", "F1-728117-01", "HU-042621-01", "PT-022802-01", "PT-073544-01", "PT-443942-01", "PT-713628-01", "PT-843462-01", "DK-197676-02", "Eg-036951-05", "Eg-197395-02", "Eg-758727-02", "Eg-904129-02", "Ih-826469-03", "LU-989099-01", "NL-132447-01", "NL-756812-02", "NL-785371-02", "NL-948960-02", "SE-368759-02", "SE-607164-02", "SE-684973-02", "SI-139484-02")

```


# Data process

## SHARE

### Wave 1

#### Study-specific variable description

| **Name** |`hhid1`|`mstat`|`relrpers`|`hhsize`|`yrbirth`|
|-|-|-|-|-|-|
| **Label** |`household identifier wave 1`|`living with spouse/partner`|`relation to coverscreen respondent`|`household size`|`year of birth`|
| **Table name** |`sharew1_rel2-6-0_cv_r_whitout_nointw1`|`sharew1_rel2-6-0_cv_r_whitout_nointw1`|`sharew1_rel2-6-0_cv_r_whitout_nointw1`|`sharew1_rel2-6-0_cv_r_whitout_nointw1`|`sharew1_rel2-6-0_cv_r_whitout_nointw1`|
| **Categories** |`text`|`1 = living with a spouse`<br/>`2 = living with a partner`<br/>`3 = living as a single`<br/>`97 = other`|`1 = spouse`<br/>`2 = partner`<br/>`3 = child`<br/>`4 = child-in-law`<br/>`5 = parent`<br/>`6 = parent-in-law`<br/>`7 = sibling`<br/>`8 = grand-child`<br/>`9 = other relative (specify)`<br/>`10 = other non-relative (specify)`|`continuous`|`continuous`|
| **Missings** |  |`-2 = refusal`<br/>`-1 = don't know`|`NA`|  |`-2 = refusal`<br/>`-1 = don't know`|
| **Description** |  |  |  |  |  |

```{r assign w1, echo=F}

opal.assign.table.tibble(o, 'SHARE_w1','SHARE.sharew1_rel2-6-0_cv_r_whitout_nointw1',variables=list('hhid1','mstat','relrpers','hhsize','yrbirth'), missings = T)
SHARE_w1 <- opal.execute(o,'SHARE_w1')


```

```{r local w1, echo =F}

vbl <- SHARE_w1$yrbirth
vbl_miss <- c(-1,-2)
kable(Continuous_summary(var = vbl, missing_values = vbl_miss)[3], caption = attributes(vbl)$`spss::shortName`)
kable(Continuous_summary(vbl, missing_values = vbl_miss)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = vbl_miss)$summary, caption = "Summary")
ggplot(SHARE_w1, aes(yrbirth)) + geom_bar(stat="count", width=0.4, fill="steelblue",data = . %>% filter(!vbl %in% vbl_miss)) + xlab(label(vbl)) + ylab("Frequency")

vbl <- SHARE_w1$hhsize
vbl_miss <- c(-1,-2)
kable(Continuous_summary(var = vbl, missing_values = vbl_miss)[3], caption = attributes(vbl)$`spss::shortName`)
pander(Continuous_summary(vbl, missing_values = vbl_miss)$summary, caption = "Summary")
ggplot(SHARE_w1, aes(hhsize)) + geom_bar(stat="count", width=0.4, fill="steelblue",data = . %>% filter(!vbl %in% vbl_miss)) + xlab(label(vbl)) + ylab("Frequency")+scale_x_continuous(breaks=c(1:10))

vbl <- SHARE_w1$mstat
vbl_miss <- c(-1,-2)
kable(Categorical_summary(vbl, missing_values = vbl_miss)[3], caption = attributes(vbl)$`spss::shortName`) 
kable(Categorical_summary(vbl, missing_values = vbl_miss)[2], caption = "Values")
kable(Categorical_summary(vbl, missing_values = vbl_miss)[1], caption = "Category")
ggplot(SHARE_w1, aes(x=factor(mstat))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- SHARE_w1$relrpers
vbl_miss <- c(-1,-2)
kable(Categorical_summary(vbl, missing_values = vbl_miss)[3], caption = attributes(vbl)$`spss::shortName`) 
kable(Categorical_summary(vbl, missing_values = vbl_miss)[1], caption = "Category")
ggplot(SHARE_w1, aes(x=factor(relrpers))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```

**R script:**

```{r preharm w1}


SHARE_w1$yrbirth <- car::recode(SHARE_w1$yrbirth,"c(-1,-2)=NA")

yrbirth_missing <- (SHARE_w1 %>% filter(is.na(yrbirth)))$id
SHARE_miss <- SHARE_w1 %>% select(id,yrbirth) %>% filter(id %in% id_missings)


# Wave 1 missing yrbirth data is non-missing in posterior waves tables for some id's (look at validation of yrbirth at the end). Here is imputed.

SHARE_w1$yrbirth[which(SHARE_w1$id=="Ih-306138-02")] <- 1934
SHARE_w1$yrbirth[which(SHARE_w1$id=="NL-037198-01")] <- 1919


# Some household characteristics
SHARE_hhaux <- SHARE_w1 %>% 
                    group_by(hhid1) %>% 
                    summarise(n=n(),ndhhs=n_distinct(hhsize),hhsize=first(hhsize),my=min(yrbirth),may=max(yrbirth),sna=sum(is.na(relrpers)))

# Individuals in households with some respondent born before 1954
SHARE_sb54 <- SHARE_w1 %>% filter(hhid1 %in% SHARE_hhaux$hhid1[which(SHARE_hhaux$my<=1954)])
# Individuals in households with some respondent born before 1954 and some respondent born after 1954
SHARE_sbsa54 <- SHARE_sb54 %>% filter(hhid1 %in% SHARE_hhaux$hhid1[which(SHARE_hhaux$may>1954)])
SHARE_sbsa54$yrbind <- car::recode(SHARE_sbsa54$yrbirth,"lo:1954=1;1955:hi=0")
SHARE_sbsa54 <- left_join(SHARE_sbsa54,SHARE_hhaux[,c("hhid1","n","sna")], by="hhid1")
# These individuals reordered by household and year of birth and grouped by household
SHARE_hh <- SHARE_sbsa54 %>% arrange(hhid1,yrbirth) %>% group_by(hhid1) %>% mutate(idp = row_number()) %>% 
            gather(kn,vn,c("id","yrbirth","mstat","relrpers","yrbind")) %>%
            unite(coln,kn,idp) %>%
            spread(coln,vn) %>%
            select(c("hhid1","n","hhsize","sna",ends_with("_1"),ends_with("_2"),ends_with("_3")))

# create relrpers variable from relrpers_1 and relrpers_2 for 2-respondent households (see below descriptives and commentary on number of missings)
SHARE_hh$relrpers <- NA
SHARE_hh$relrpers[which(SHARE_hh$n==2)] <- SHARE_hh$relrpers_2[which(SHARE_hh$n==2)]
SHARE_hh$relrpers[which(SHARE_hh$n==2 & is.na(SHARE_hh$relrpers_2))] <- SHARE_hh$relrpers_1[which(SHARE_hh$n==2 & is.na(SHARE_hh$relrpers_2))]
```

```{r local2 w1, echo=F}

kable(frq(SHARE_hhaux$n), caption = 'Frequency of respondents by household')
kable(frq(SHARE_hhaux$ndhhs), caption = 'For each household all individuals answer the same household size')
kable(frq(SHARE_hhaux$hhsize), caption = 'Frequency of answered household sizes')
kable(frq(SHARE_hhaux$n<=SHARE_hhaux$hhsize), caption = 'The respondents by household are always less or equal than the household sizes')

# All hh born > 1954
kable(SHARE_w1[which(SHARE_w1$hhid1 %in% SHARE_hhaux$hhid1[which(SHARE_hhaux$my>1954)]),], caption = 'Individuals in households all whose members are born later than 1954')
kable(frq(SHARE_w1$mstat[which(SHARE_w1$hhid1 %in% SHARE_hhaux$hhid1[which(SHARE_hhaux$my>1954)])]),caption = 'Frequency of their variable mstat')
kable(frq(is.na(SHARE_w1$relrpers[which(SHARE_w1$hhid1 %in% SHARE_hhaux$hhid1[which(SHARE_hhaux$my>1954)])])),caption = 'Missing values of their variable relrpers')

# HH with some born <=1954 and some > 1954
kable(frq(SHARE_hhaux$n[which(SHARE_hhaux$hhid1 %in% SHARE_sbsa54$hhid1)]),caption = 'Frequency of respondents in households with some born before and some born after 1954.')

## HH with some missing yrbirth
kable(SHARE_w1 %>% filter(hhid1 %in% (SHARE_w1 %>% filter(is.na(yrbirth)))$hhid1),caption = 'Individuals in households with some yrbirth data missing')

# HH with n==2
kable(frq(SHARE_hh$sna[which(SHARE_hh$n==2)]), caption = 'Frequency of missings in variable relrpers by household in 2-respondent households with one born before and one after 1954')
cat('This means that for each household with 2 respondents except one (shown below), one of them has fulfilled the relrpers variable meanwhile the other did not.')
kable(SHARE_hh %>% filter(n==2 & sna==0) %>% select(-ends_with("_3")),caption = '2-respondent household with no relrpers missing')

kable(frq((SHARE_hh %>% filter(n==2))$hhsize),caption = 'Frequency of household size for 2-respondent households.')


vbl <- as.numeric(SHARE_hh$yrbirth_1[which(SHARE_hh$n==2)])
vbl_miss <- c(-1,-2)
kable(Continuous_summary(var = vbl, missing_values = vbl_miss)[3], caption = "Year of birth of individuals born before 1954 in those 2-respondent households with another individual born after 1954")
pander(Continuous_summary(vbl, missing_values = vbl_miss)$summary, caption = "Summary")
ggplot(SHARE_hh, aes(as.numeric(yrbirth_1))) + geom_bar(stat="count", width=0.4, fill="steelblue",data = . %>% filter(!yrbirth_1 %in% vbl_miss & n==2)) + xlab(label(vbl)) + ylab("Frequency")

vbl <- as.numeric(SHARE_hh$yrbirth_2[which(SHARE_hh$n==2)])
vbl_miss <- c(-1,-2)
kable(Continuous_summary(var = vbl, missing_values = vbl_miss)[3], caption = "Year of birth of individuals born axter 1954 in those 2-respondent households with another individual born before 1954")
pander(Continuous_summary(vbl, missing_values = vbl_miss)$summary, caption = "Summary")
ggplot(SHARE_hh, aes(as.numeric(yrbirth_2))) + geom_bar(stat="count", width=0.4, fill="steelblue",data = . %>% filter(!yrbirth_2 %in% vbl_miss & n==2)) + xlab(label(vbl)) + ylab("Frequency")

# hhsize<=3
kable(frq(SHARE_hh$mstat_1[which(SHARE_hh$n==2 & SHARE_hh$hhsize<=3)]),caption = 'Frequency of mstat for individuals born before 1954 in 2-respondent household with answered size less or equal than 3')

kable(frq(SHARE_hh$mstat_2[which(SHARE_hh$n==2 & SHARE_hh$hhsize<=3)]),caption = 'Frequency of mstat for individuals born after 1954 in 2-respondent household with answered size less or equal than 3')

kable(SHARE_hh %>% filter(n==2 & hhsize<=3 & mstat_1==3) %>% select(-ends_with("_3")),caption = 'The two households with some mstat==3')

# hhsize>3
kable(frq(SHARE_hh$mstat_1[which(SHARE_hh$n==2 & SHARE_hh$hhsize>3)]),caption = 'Frequency of mstat for individuals born before 1954 in 2-respondent household with answered size greater than 3')

kable(frq(SHARE_hh$mstat_2[which(SHARE_hh$n==2 & SHARE_hh$hhsize>3)]),caption = 'Frequency of mstat for individuals born after 1954 in 2-respondent household with answered size greater than 3')

kable(SHARE_hh %>% filter(n==2 & hhsize>3 & mstat_1==3) %>% select(-ends_with("_3")),caption = 'The two households with some mstat==3')

kable(frq(SHARE_hh$relrpers_1[which(SHARE_hh$n==2 & SHARE_hh$hhsize>3 & !is.na(SHARE_hh$relrpers_1))]),caption = 'Frequency of relrpers for individuals born before 1954 in 2-respondent households with answered size greater than 3')

kable(frq(SHARE_hh$relrpers_2[which(SHARE_hh$n==2 & SHARE_hh$hhsize>3 & !is.na(SHARE_hh$relrpers_2))]),caption = 'Frequency of relrpers for individuals born after 1954 in 2-respondent households with answered size greater than 3')

kable(frq(SHARE_hh$relrpers[which(SHARE_hh$n==2 & SHARE_hh$hhsize>3)]),caption = 'Joined frequency of relrpers for 2-respondent households with answered size greater than 3')




# HH with n==3
kable(SHARE_hh[which(SHARE_hh$n==3),],caption = 'Individuals in 3-respondent households with some born before and some after 1954')
cat('In fact, for each of the households of the previous table, there are two individuals born before 1954 and one born after that year. Moreover, all the older claim living as a single (mstat==3).')

```


#### Harmonisation algorithm
To compute the harmonised variable from the study-specific variables it has to be obtained by means of the next algorithm:

* ` id : yrbirth <= 1954 or missing into 0 participant`
* `id : yrbirth > 1954`
  + `all id with = hhid1 accomplish yrbirth > 1954`
    * `recode mstat == 1,2 into 1 spouse/partner` (since almost all these `hhid1` are for a unique `id` and `relrpers` is mostly missing)
  + `there is id with = hhid1 : yrbirth <=1954`
    * `2 id with = hhid1 & hhsize <= 3`
      + `recode mstat == 1,2 for both id's with = hhid1 into 1 spouse/partner`
      + `recode mstat == 3 for some id with = hhid1 into 2 other`
    * `2 id with = hhid1 & hhsize > 3`
      + `recode mstat == 1,2 for both id's & relrpers == 1,2 for some id with = hhid1 into 1 spouse/partner`
      + `recode mstat == 3 | relrpers > 2 for some id with = hhid1 into 2 other`
    * `3 id with = hhid1 into 2 other` (we codify sure relationship with older id, for which `mstat==3`)

**R script:**

```{r harmo w1}

SHARE_ds_w1 <- tibble(id=SHARE_w1$id)
SHARE_ds_w1$respondent <- NA
# id : yrbirth <= 1954 or missing into 0 participant
SHARE_ds_w1$respondent[which(SHARE_w1$yrbirth<=1954 | is.na(SHARE_w1$yrbirth))] <- 0
# all id with = hhid1 accomplish yrbirth > 1954
SHARE_ds_w1$respondent[which(SHARE_w1$hhid1 %in% SHARE_hhaux$hhid1[which(SHARE_hhaux$my>1954)])] <- car::recode(SHARE_w1$mstat[which(SHARE_w1$hhid1 %in% SHARE_hhaux$hhid1[which(SHARE_hhaux$my>1954)])],"c(1,2) = 1")
# there is id with = hhid1 : yrbirth <=1954
# 2 id with = hhid1 & hhsize <= 3
SHARE_ds_w1$respondent[which(SHARE_w1$yrbirth>1954 & SHARE_w1$hhid1 %in% SHARE_hh$hhid1[which(SHARE_hh$n==2 & SHARE_hh$hhsize<=3 & SHARE_hh$mstat_1 %in% c(1,2) & SHARE_hh$mstat_2 %in% c(1,2))])] <- 1
SHARE_ds_w1$respondent[which(SHARE_w1$yrbirth>1954 & SHARE_w1$hhid1 %in% SHARE_hh$hhid1[which(SHARE_hh$n==2 & SHARE_hh$hhsize<=3 & (SHARE_hh$mstat_1 == 3 | SHARE_hh$mstat_2 == 3))])] <- 2
# 2 id with = hhid1 & hhsize > 3
SHARE_ds_w1$respondent[which(SHARE_w1$yrbirth>1954 & SHARE_w1$hhid1 %in% SHARE_hh$hhid1[which(SHARE_hh$n==2 & SHARE_hh$hhsize>3 & SHARE_hh$mstat_1 %in% c(1,2) & SHARE_hh$mstat_2 %in% c(1,2) & SHARE_hh$relrpers %in% c(1,2))])] <- 1
SHARE_ds_w1$respondent[which(SHARE_w1$yrbirth>1954 & SHARE_w1$hhid1 %in% SHARE_hh$hhid1[which(SHARE_hh$n==2 & SHARE_hh$hhsize>3 & (SHARE_hh$mstat_1 == 3 | SHARE_hh$mstat_2 == 3 | SHARE_hh$relrpers > 2))])] <- 2
# 3 id with = hhid1 into 2 other
SHARE_ds_w1$respondent[which(SHARE_w1$yrbirth>1954 & SHARE_w1$hhid1 %in% SHARE_hh$hhid1[which(SHARE_hh$n==3)])] <- 2

```


#### Statistical description of the new harmonised variable
```{r descript w1, echo=FALSE}
vbl <- SHARE_ds_w1$respondent
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label) 
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(SHARE_ds_w1, aes(x=factor(vbl))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```


#### Validation
```{r crosstabulation w1, echo=FALSE}


rm(SHARE_hh,SHARE_hhaux,SHARE_sb54,SHARE_sbsa54)
```






### Wave 2

#### Study-specific variable description

| **Name** |`hhid2`|`mstat`|`mstat2`|`yrbirth`|
|-|-|-|-|-|
| **Label** |`household identifier wave 2`|`living with spouse/partner`|`living with spouse/partner (avalable for israel w2 only)`|`year of birth`|
| **Table name** |`sharew2_rel2-6-0_cv_r_without_noint`|`sharew2_rel2-6-0_cv_r_without_noint`|`sharew2_rel2-6-0_cv_r_without_noint`|`sharew2_rel2-6-0_cv_r_without_noint`|
| **Categories** |`text`|`1 = living with a spouse`<br/>`2 = living with a partner`<br/>`3 = living as a single`<br/>`97 = other`|`1 = living w. spouse/partner`<br/>`3 = living single`|`continuous`|
| **Missings** |  |`NA`|`NA`|`-2 = refusal`<br/>`-1 = don't know`|
| **Description** |  |  |  |  |

```{r assign w2, echo=F}

opal.assign.table.tibble(o, 'SHARE_w2','SHARE.sharew2_rel2-6-0_cv_r_without_noint',variables=list('hhid2','mstat','mstat2','yrbirth'), missings = T)
SHARE_w2 <- opal.execute(o,'SHARE_w2')


```



```{r local w2, echo =F}

vbl <- SHARE_w2$yrbirth
vbl_miss <- c(-1,-2)
kable(Continuous_summary(var = vbl, missing_values = vbl_miss)[3], caption = attributes(vbl)$`spss::shortName`)
kable(Continuous_summary(vbl, missing_values = vbl_miss)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = vbl_miss)$summary, caption = "Summary")
ggplot(SHARE_w2, aes(yrbirth)) + geom_bar(stat="count", width=0.4, fill="steelblue",data = . %>% filter(!vbl %in% vbl_miss)) + xlab(label(vbl)) + ylab("Frequency")

vbl <- SHARE_w2$mstat
vbl_miss <- c(-1,-2)
kable(Categorical_summary(vbl, missing_values = vbl_miss)[3], caption = attributes(vbl)$`spss::shortName`) 
kable(Categorical_summary(vbl, missing_values = vbl_miss)[1], caption = "Category")
ggplot(SHARE_w2, aes(x=factor(mstat))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

vbl <- SHARE_w2$mstat2
vbl_miss <- c(-1,-2)
kable(Categorical_summary(vbl, missing_values = vbl_miss)[3], caption = attributes(vbl)$`spss::shortName`) 
kable(Categorical_summary(vbl, missing_values = vbl_miss)[1], caption = "Category")
ggplot(SHARE_w2, aes(x=factor(mstat2))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")


kable(table(is.na(SHARE_w2$mstat),is.na(SHARE_w2$mstat2)),caption = 'Variables mstat and mstat2 are mutually exclusive')
```


**R script:**

```{r preharm w2}

SHARE_w2$yrbirth <- car::recode(SHARE_w2$yrbirth,"c(-1,-2)=NA")

#Some missing yrbirth data is available from previous waves
SHARE_w2 <- left_join(SHARE_w2,SHARE_w1 %>% select(id,yrbirth) %>% filter(!yrbirth %in% c(-1,-2)),by = "id", suffix = c("","_w1"))
SHARE_w2$yrbirth[which(is.na(SHARE_w2$yrbirth))] <- SHARE_w2$yrbirth_w1[which(is.na(SHARE_w2$yrbirth))]
SHARE_w2 <- SHARE_w2 %>% select(-yrbirth_w1)



yrbirth_missing <- union(yrbirth_missing,(SHARE_w2 %>% filter(is.na(yrbirth)))$id)
SHARE_miss <- full_join(SHARE_miss,SHARE_w2 %>% select(id,yrbirth) %>% filter(id %in% id_missings),by="id",suffix = c("_w1","_w2"))

# Some household characteristics

cluster_assign_value(cluster,'SHARE_ds_w1',SHARE_ds_w1)
SHARE_hhaux <- SHARE_w2 %>%
                    multidplyr::partition(hhid2) %>%
                    summarise(n=n(),my=min(yrbirth),may=max(yrbirth),inw1=sum(id %in% SHARE_ds_w1$id)) %>%
                    dplyr::collect() %>% arrange(hhid2)



SHARE_hhaux$ninw1 <- SHARE_hhaux$n - SHARE_hhaux$inw1
SHARE_w2$yrbind <- car::recode(SHARE_w2$yrbirth,"lo:1956=1;1957:hi=0")
SHARE_w2 <- left_join(SHARE_w2,SHARE_hhaux[,c("hhid2","n","inw1","ninw1","my","may")], by="hhid2")
SHARE_w2 <- left_join(SHARE_w2,SHARE_ds_w1,by="id")
SHARE_w2$idinw1 <- NA
SHARE_w2$idinw1[which(SHARE_w2$id %in% SHARE_ds_w1$id)] <- 1
SHARE_w2$idinw1[which(!SHARE_w2$id %in% SHARE_ds_w1$id)] <- 0

# Individuals in households with all individuals from wave 1
SHARE_allold <- SHARE_w2 %>% filter(hhid2 %in% SHARE_hhaux$hhid2[which(SHARE_hhaux$n==SHARE_hhaux$inw1)])
# Individuals in households with more than one individuals and all new
SHARE_allnew <- SHARE_w2 %>% filter(hhid2 %in% SHARE_hhaux$hhid2[which(SHARE_hhaux$inw1==0)] & n>1) %>% select(-my,-may)

# These individuals reordered by household and year of birth and grouped by household
SHARE_hhan <- SHARE_allnew %>% arrange(hhid2,yrbirth) %>% group_by(hhid2) %>% mutate(idp = row_number()) %>% 
            gather(kn,vn,c("id","yrbirth","mstat","mstat2","yrbind")) %>%
            unite(coln,kn,idp) %>%
            spread(coln,vn) %>%
            select(c("hhid2","n",ends_with("_1"),ends_with("_2"),ends_with("_3"),ends_with("_4"))) %>%
            mutate_at(vars(contains("yrbi"),contains("mstat")),as.numeric)



# Individuals in households with some individuals from wave 1 and some new
SHARE_somenew <- SHARE_w2 %>% filter(hhid2 %in% SHARE_hhaux$hhid2[which(SHARE_hhaux$inw1!=0 & SHARE_hhaux$inw1!=SHARE_hhaux$n)]) %>% select(-my,-may)

# These individuals reordered by household and year of birth and grouped by household
SHARE_hhsn <- SHARE_somenew %>% arrange(hhid2,desc(idinw1),yrbirth) %>% group_by(hhid2) %>% mutate(idp = row_number()) %>% 
            gather(kn,vn,c("id","idinw1","yrbirth","mstat","mstat2","yrbind","respondent")) %>%
            unite(coln,kn,idp) %>%
            spread(coln,vn) %>%
            select(c("hhid2","n","inw1","ninw1",ends_with("_1"),ends_with("_2"),ends_with("_3"),ends_with("_4"))) %>%
            mutate_at(vars(contains("idinw1"),contains("yrbi"),contains("mstat"),contains("respondent")),as.numeric)



```



```{r local2 w2, echo=FALSE}
kable(frq(SHARE_hhaux$n), caption = 'Frequency of respondents by household')


# Some new
kable(frq((SHARE_hhaux %>% filter(hhid2 %in% SHARE_somenew$hhid2))$n),caption = 'Frequency of households by number of respondents in those with some individual already in wave 1 and some new')

kable(frq((SHARE_w2 %>% filter(inw1>0 & ninw1>0))$n),caption = 'Frequency of respondents by household in those with some individual already in wave 1 and some new (i.e., the individuals in the households above)')

kable(frq((SHARE_w2 %>% filter(hhid2 %in% SHARE_somenew$hhid2 & ninw1==1))$n), caption = 'Of those above, which are in households with a unique individual new')
kable(frq((SHARE_w2 %>% filter(hhid2 %in% SHARE_somenew$hhid2 & ninw1>1))$n), caption = 'Of those above, which are in households with more than a new individual')


kable(SHARE_w2 %>% arrange(hhid2,desc(idinw1),yrbirth) %>% filter(hhid2 %in% SHARE_somenew$hhid2 & ninw1>1) %>% select(c("hhid2","id","n","inw1","ninw1","idinw1","mstat","mstat2","yrbind","yrbirth","respondent")),caption = 'These individuals')

kable(frq((SHARE_hhsn)$idinw1_1),caption = 'Individuals in households with respondents in wave 1 are organised so that first column are respondents in wave 1')
cat("By the way such that SHARE_somenew and SHARE_hhsn have been built, in n-respondent households with respondents in wave 1 are organised so that nth column are not respondents in wave 1")
kable(frq(SHARE_somenew$inw1[which(SHARE_somenew$n==3)]),caption = 'Individuals in 3-respondent households with 1 and 2 respondents in wave 1 respectively')
# kable(frq((SHARE_hhsn %>% filter(n==3))$idinw1_2),caption = 'The same data across households. 3-respondent households with 1 and 2 respondents in wave 1 respectively')



# All new
kable(frq((SHARE_hhaux %>% filter(hhid2 %in% SHARE_allnew$hhid2))$n),caption = 'Frequency of respondents by household in those with more than one individual and none already in wave 1')

kable(frq((SHARE_hhan)$yrbind_1),caption = 'Individuals in households without respondents in wave 1 are organised so that the ones in first column were born before 1956')

kable(frq(SHARE_hhan$yrbirth_1<=SHARE_hhan$yrbirth_2), caption = 'Individuals in households without respondents in wave 1 are organised so that the ones in first column were born before those in second column.')

kable(SHARE_w2[which(SHARE_w2$hhid2 %in% (SHARE_hhaux %>% filter(hhid2 %in% SHARE_allnew$hhid2 & n==4))$hhid2),],caption = 'The household of previous ones with four individuals')


## HH with some missing yrbirth
kable(SHARE_w2 %>% filter(hhid2 %in% (SHARE_w2 %>% filter(is.na(yrbirth)))$hhid2),caption = 'Individuals in households with some yrbirth data missing')



```






#### Harmonisation algorithm
To compute the harmonised variable from the study-specific variables it has to be obtained by means of the next algorithm:

* `id in wave 1 into respondent-wave-1`
* `1-respondent born before 1956 households not in wave 1 into 0 participant`
* `1-respondent born after 1956 households not in wave 1`
  + `recode mstat == 1,2 into 1 spouse/partner`
  + `recode mstat ==3 into 2 other`
* `id not in wave 1 in n-respondent households with other ids in wave 1 (n==2,3,4 & ninw1 == 1)`
  + `recode mstat == 1,2 into 1 spouse/partner`
  + `recode mstat ==3 into 2 other`
  + `recode mstat ==NA into 999`
* `id not in wave 1 in n-respondent households with some other ids not in wave 1 and one in wave 1 (n==3,4 & inw1 == 1)`
  + `recode mstat == 1,2 for id and id in wave 1 into 1 spouse/partner`
  + `recode mstat == 3 for id and mstat ==1,2 for id in wave 1 into 2 other`
  + `recode mstat == 3 for id in wave 1 into 2 other`
* `some exceptions and inw1 == 2 are treated separately (cf. table above with these individuals)`
* `id in household with all id not in wave 1`
  + `one id born before and one after 1956 or missing`
    * `before 1956 into 0`
    * `after 1956 or missing recode mstat == 1,2 into 1, mstat == 3 into 2`
  + `otherwise:`
    * `younger id born before 1956 into 0`
    * `older ids born before 1956 into recode mstat == 1,2 into 1, mstat == 3 into 2`


**R script:**


```{r harmo w2}

SHARE_ds_w2 <- tibble(id=SHARE_w2$id)
SHARE_ds_w2$respondent <- NA
# id in wave 1 into respondent-wave-1
SHARE_ds_w2$respondent[which(SHARE_w2$idinw1==1)] <- SHARE_w2$respondent[which(SHARE_w2$idinw1==1)]
# 1-respondent born before 1956 households not in wave 1 into 0 participant
SHARE_ds_w2$respondent[which(SHARE_w2$idinw1==0 & SHARE_w2$n==1 & SHARE_w2$yrbind==1)] <- 0
# 1-respondent born after 1956 households not in wave 1
SHARE_ds_w2$respondent[which(SHARE_w2$idinw1==0 & SHARE_w2$n==1 & SHARE_w2$yrbind==0 & !is.na(SHARE_w2$mstat))] <- car::recode(SHARE_w2$mstat[which(SHARE_w2$idinw1==0 & SHARE_w2$n==1 & SHARE_w2$yrbind==0 & !is.na(SHARE_w2$mstat))],"c(1,2)=1; 3=2")
SHARE_ds_w2$respondent[which(SHARE_w2$idinw1==0 & SHARE_w2$n==1 & SHARE_w2$yrbind==0 & !is.na(SHARE_w2$mstat2))] <- car::recode(SHARE_w2$mstat2[which(SHARE_w2$idinw1==0 & SHARE_w2$n==1 & SHARE_w2$yrbind==0 & !is.na(SHARE_w2$mstat2))],"c(1,2)=1; 3=2")
# id not in wave 1 in n-respondent households with id in wave 1 (n>1 & inw1 == n-1)
SHARE_ds_w2$respondent[which(SHARE_w2$idinw1==0 & SHARE_w2$n>1 & SHARE_w2$ninw1==1 & !is.na(SHARE_w2$mstat))] <- car::recode(SHARE_w2$mstat[which(SHARE_w2$idinw1==0 & SHARE_w2$n>1 & SHARE_w2$ninw1==1 & !is.na(SHARE_w2$mstat))],"c(1,2)=1; 3=2;NA=999")
SHARE_ds_w2$respondent[which(SHARE_w2$idinw1==0 & SHARE_w2$n>1 & SHARE_w2$ninw1==1 & !is.na(SHARE_w2$mstat2))] <- car::recode(SHARE_w2$mstat2[which(SHARE_w2$idinw1==0 & SHARE_w2$n>1 & SHARE_w2$ninw1==1 & !is.na(SHARE_w2$mstat2))],"c(1,2)=1; 3=2;NA=999")
SHARE_ds_w2$respondent[which(SHARE_w2$id=="ES-882383-04")] <- 2
# id not in wave 1 in n-respondent households with some other not ids in wave 1 and one in wave 1 (n==3,4 & inw1 == 1)
SHARE_hhsn$respondent_2[which(SHARE_hhsn$n==3 & SHARE_hhsn$inw1==1 & SHARE_hhsn$mstat_1 %in% c(1,2) & SHARE_hhsn$mstat_2 %in% c(1,2))] <- 1
SHARE_hhsn$respondent_2[which(SHARE_hhsn$n==3 & SHARE_hhsn$inw1==1 & SHARE_hhsn$mstat_1 %in% c(1,2) & SHARE_hhsn$mstat_2 == 3)] <- 2
SHARE_hhsn$respondent_2[which(SHARE_hhsn$n==3 & SHARE_hhsn$inw1==1 & SHARE_hhsn$mstat_1 == 3)] <- 2
SHARE_hhsn$respondent_2[which(SHARE_hhsn$n==3 & SHARE_hhsn$inw1==1 & SHARE_hhsn$mstat2_1 %in% c(1,2) & SHARE_hhsn$mstat2_2 %in% c(1,2))] <- 1
SHARE_hhsn$respondent_2[which(SHARE_hhsn$n==3 & SHARE_hhsn$inw1==1 & SHARE_hhsn$mstat2_1 %in% c(1,2) & SHARE_hhsn$mstat2_2 == 3)] <- 2
SHARE_hhsn$respondent_2[which(SHARE_hhsn$n==3 & SHARE_hhsn$inw1==1 & SHARE_hhsn$mstat2_1 == 3)] <- 2
SHARE_hhsn$respondent_3[which(SHARE_hhsn$n==3 & SHARE_hhsn$inw1==1 & SHARE_hhsn$mstat_1 %in% c(1,2) & SHARE_hhsn$mstat_3 %in% c(1,2))] <- 1
SHARE_hhsn$respondent_3[which(SHARE_hhsn$n==3 & SHARE_hhsn$inw1==1 & SHARE_hhsn$mstat_1 %in% c(1,2) & SHARE_hhsn$mstat_3 == 3)] <- 2
SHARE_hhsn$respondent_3[which(SHARE_hhsn$n==3 & SHARE_hhsn$inw1==1 & SHARE_hhsn$mstat_1 == 3)] <- 2
SHARE_hhsn$respondent_3[which(SHARE_hhsn$n==3 & SHARE_hhsn$inw1==1 & SHARE_hhsn$mstat2_1 %in% c(1,2) & SHARE_hhsn$mstat2_3 %in% c(1,2))] <- 1
SHARE_hhsn$respondent_3[which(SHARE_hhsn$n==3 & SHARE_hhsn$inw1==1 & SHARE_hhsn$mstat2_1 %in% c(1,2) & SHARE_hhsn$mstat2_3 == 3)] <- 2
SHARE_hhsn$respondent_3[which(SHARE_hhsn$n==3 & SHARE_hhsn$inw1==1 & SHARE_hhsn$mstat2_1 == 3)] <- 2
SHARE_hhsn$respondent_3[which(SHARE_hhsn$id_3=="ES-536018-02")] <- 2
SHARE_hhsn$respondent_2[which(SHARE_hhsn$id_2=="ES-206829-02")] <- 1
SHARE_hhsn$respondent_3[which(SHARE_hhsn$id_3=="ES-206829-04")] <- 2
SHARE_hhsn$respondent_4[which(SHARE_hhsn$id_4=="ES-206829-03")] <- 2

SHARE_hhsn$respondent_3[which(SHARE_hhsn$hhid2=="ES-604668-A")] <- 2
SHARE_hhsn$respondent_4[which(SHARE_hhsn$hhid2=="ES-604668-A")] <- 2
SHARE_hhsn$respondent_3[which(SHARE_hhsn$hhid2=="ES-825413-A")] <- 1
SHARE_hhsn$respondent_4[which(SHARE_hhsn$hhid2=="ES-825413-A")] <- 1
SHARE_hhsn$respondent_3[which(SHARE_hhsn$hhid2=="ES-940921-A")] <- 2
SHARE_hhsn$respondent_4[which(SHARE_hhsn$hhid2=="ES-940921-A")] <- 2


SHARE_ds_w2 <- left_join(SHARE_ds_w2,SHARE_hhsn[which(SHARE_hhsn$ninw1>1 & SHARE_hhsn$idinw1_2==0),c("id_2","respondent_2")],by = c("id"="id_2"))
SHARE_ds_w2 <- left_join(SHARE_ds_w2,SHARE_hhsn[which(SHARE_hhsn$ninw1>1 & SHARE_hhsn$idinw1_3==0),c("id_3","respondent_3")],by = c("id"="id_3"))
SHARE_ds_w2 <- left_join(SHARE_ds_w2,SHARE_hhsn[which(SHARE_hhsn$ninw1>1 & SHARE_hhsn$idinw1_4==0),c("id_4","respondent_4")],by = c("id"="id_4"))
SHARE_ds_w2$respondent[which(SHARE_ds_w2$id %in% SHARE_hhsn$id_2 & SHARE_w2$ninw1>1 & SHARE_w2$idinw1==0)] <- SHARE_ds_w2$respondent_2[which(SHARE_ds_w2$id %in% SHARE_hhsn$id_2 & SHARE_w2$ninw1>1 & SHARE_w2$idinw1==0)]
SHARE_ds_w2$respondent[which(SHARE_ds_w2$id %in% SHARE_hhsn$id_3 & SHARE_w2$ninw1>1 & SHARE_w2$idinw1==0)] <- SHARE_ds_w2$respondent_3[which(SHARE_ds_w2$id %in% SHARE_hhsn$id_3 & SHARE_w2$ninw1>1 & SHARE_w2$idinw1==0)]
SHARE_ds_w2$respondent[which(SHARE_ds_w2$id %in% SHARE_hhsn$id_4 & SHARE_w2$ninw1>1 & SHARE_w2$idinw1==0)] <- SHARE_ds_w2$respondent_4[which(SHARE_ds_w2$id %in% SHARE_hhsn$id_4 & SHARE_w2$ninw1>1 & SHARE_w2$idinw1==0)]

SHARE_ds_w2 <- SHARE_ds_w2[,c("id","respondent")]

# id in household with all id not in wave 1
# one id born before and one after 1956 or missing yrbirth
SHARE_ds_w2$respondent[which(SHARE_ds_w2$id %in% (SHARE_w2 %>% filter(inw1==0 & (may>1956 | is.na(may)) & n==2 & yrbind==1))$id)] <- 0
SHARE_ds_w2$respondent[which(SHARE_w2$inw1==0 & SHARE_w2$yrbind==0 & SHARE_w2$n==2 & !is.na(SHARE_w2$mstat))] <- car::recode(SHARE_w2$mstat[which(SHARE_w2$inw1==0 & SHARE_w2$yrbind==0 & SHARE_w2$n==2 & !is.na(SHARE_w2$mstat))],"c(1,2)=1; 3=2; NA=999")
SHARE_ds_w2$respondent[which(SHARE_w2$inw1==0 & SHARE_w2$yrbind==0 & SHARE_w2$n==2 & !is.na(SHARE_w2$mstat2))] <- car::recode(SHARE_w2$mstat2[which(SHARE_w2$inw1==0 & SHARE_w2$yrbind==0 & SHARE_w2$n==2 & !is.na(SHARE_w2$mstat2))],"c(1,2)=1; 3=2; NA=999")
SHARE_ds_w2$respondent[which(SHARE_w2$n==2 & SHARE_w2$inw1==0 & is.na(SHARE_w2$yrbirth))] <- car::recode(SHARE_w2$mstat[which(SHARE_w2$n==2 & SHARE_w2$inw1==0 & is.na(SHARE_w2$yrbirth))],"c(1,2)=1; 3=2; NA=999")

# otherwise
# younger id born before 1956 into 0
SHARE_ds_w2$respondent[which(SHARE_ds_w2$id %in% (SHARE_hhan %>% filter(n==2 & yrbind_1==1 & yrbind_2==1))$id_2)] <- 0

# older ids born before 1956 into recode mstat == 1,2 into 1, mstat == 3 into 2
SHARE_hhan$respondent_1[which(SHARE_hhan$n==2 & SHARE_hhan$yrbind_1==1 & SHARE_hhan$yrbind_2==1 & !is.na(SHARE_hhan$mstat_1))] <- car::recode(SHARE_hhan$mstat_1[which(SHARE_hhan$n==2 & SHARE_hhan$yrbind_1==1 & SHARE_hhan$yrbind_2==1 & !is.na(SHARE_hhan$mstat_1))],"c(1,2)=1; 3=2")
SHARE_hhan$respondent_1[which(SHARE_hhan$n==2 & SHARE_hhan$yrbind_1==1 & SHARE_hhan$yrbind_2==1 & !is.na(SHARE_hhan$mstat2_1))] <- car::recode(SHARE_hhan$mstat2_1[which(SHARE_hhan$n==2 & SHARE_hhan$yrbind_1==1 & SHARE_hhan$yrbind_2==1 & !is.na(SHARE_hhan$mstat2_1))],"c(1,2)=1; 3=2")



SHARE_ds_w2 <- left_join(SHARE_ds_w2,SHARE_hhan[which(SHARE_hhan$n==2 & SHARE_hhan$yrbind_1==1 & SHARE_hhan$yrbind_2==1),c("id_1","respondent_1")],by = c("id"="id_1"))



SHARE_ds_w2$respondent[which(SHARE_ds_w2$id %in% SHARE_hhan$id_1[which(SHARE_hhan$n==2 & SHARE_hhan$yrbind_1==1 & SHARE_hhan$yrbind_2==1)])] <- SHARE_ds_w2$respondent_1[which(SHARE_ds_w2$id %in% SHARE_hhan$id_1[which(SHARE_hhan$n==2 & SHARE_hhan$yrbind_1==1 & SHARE_hhan$yrbind_2==1)])]

SHARE_ds_w2 <- SHARE_ds_w2[,c("id","respondent")]
SHARE_ds_w2$respondent[which(SHARE_ds_w2$id=="Ir-650190-04")] <- 2
SHARE_ds_w2$respondent[which(SHARE_ds_w2$id=="Ir-650190-03")] <- 2
SHARE_ds_w2$respondent[which(SHARE_ds_w2$id=="Ir-650190-01")] <- 0
SHARE_ds_w2$respondent[which(SHARE_ds_w2$id=="Ir-650190-02")] <- 1

SHARE_ds_w2$respondent <- car::recode(SHARE_ds_w2$respondent,"NA=999")

```




#### Statistical description of the new harmonised variable
```{r descript w2, echo=FALSE}
vbl <- SHARE_ds_w2$respondent
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label) 
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(SHARE_ds_w2, aes(x=factor(vbl))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```


#### Validation
```{r crosstabulation w2, echo=FALSE}

kable(SHARE_w2 %>% filter(hhid2 %in% SHARE_hhsn$hhid2[which(SHARE_hhsn$hhid2 %in% (SHARE_w2 %>% filter(idinw1==0 & n==2 & inw1==1 & is.na(mstat) & is.na(mstat2)))$hhid2)]),caption = 'Household with a new individual without mstat data (one missing of respondent)')

kable(SHARE_w2 %>% filter(hhid2 %in% SHARE_hhan$hhid2[which(SHARE_hhan$hhid2 %in% (SHARE_w2 %>% filter(n==2 & inw1==0 & is.na(mstat) & is.na(mstat2)))$hhid2)]),caption = 'Household with two new individuals including one without mstat data (the other missing of respondent)')

rm(SHARE_allnew,SHARE_allold,SHARE_hhan,SHARE_hhaux,SHARE_hhsn,SHARE_somenew)

```




### Wave 3


| **Name** |`hhid3`|`mstat`|`yrbirth`|
|-|-|-|-|
| **Label** |`household identifier wave 3`|`living with spouse/partner`|`year of birth`|
| **Table name** |`sharew3_rel1_cv_r_without_noint`|`sharew3_rel1_cv_r_without_noint`|`sharew3_rel1_cv_r_without_noint`|
| **Categories** |`text`|`1 = living with a spouse`<br/>`2 = living with a partner`<br/>`3 = living as a single`<br/>`97 = other`|`continuous`|
| **Missings** |  |`NA`|`NA`|
| **Description** |  |  |  |

```{r assign w3, echo=F}

opal.assign.table.tibble(o, 'SHARE_w3','SHARE.sharew3_rel1_cv_r_without_noint',variables=list('hhid3','mstat','yrbirth'), missings = T)
SHARE_w3 <- opal.execute(o,'SHARE_w3')


```




```{r local w3, echo =F}

vbl <- SHARE_w3$yrbirth
vbl_miss <- c(-1,-2)
kable(Continuous_summary(var = vbl, missing_values = vbl_miss)[3], caption = attributes(vbl)$`spss::shortName`)
pander(Continuous_summary(vbl, missing_values = vbl_miss)$summary, caption = "Summary")
ggplot(SHARE_w3, aes(yrbirth)) + geom_bar(stat="count", width=0.4, fill="steelblue",data = . %>% filter(!vbl %in% vbl_miss)) + xlab(label(vbl)) + ylab("Frequency")

vbl <- SHARE_w3$mstat
vbl_miss <- c(-1,-2)
kable(Categorical_summary(vbl, missing_values = vbl_miss)[3], caption = attributes(vbl)$`spss::shortName`) 
kable(Categorical_summary(vbl, missing_values = vbl_miss)[1], caption = "Category")
ggplot(SHARE_w3, aes(x=factor(mstat))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```

**R script:**

```{r preharm w3}

SHARE_w3$yrbirth <- car::recode(SHARE_w3$yrbirth,"c(-1,-2)=NA")

#Some missing yrbirth data is available from previous waves
SHARE_w3 <- left_join(SHARE_w3,SHARE_w1 %>% select(id,yrbirth) %>% filter(!yrbirth %in% c(-1,-2)),by = "id", suffix = c("","_w1"))
SHARE_w3$yrbirth[which(is.na(SHARE_w3$yrbirth))] <- SHARE_w3$yrbirth_w1[which(is.na(SHARE_w3$yrbirth))]
SHARE_w3 <- left_join(SHARE_w3,SHARE_w2 %>% select(id,yrbirth) %>% filter(!yrbirth %in% c(-1,-2)),by = "id", suffix = c("","_w2"))
SHARE_w3$yrbirth[which(is.na(SHARE_w3$yrbirth))] <- SHARE_w3$yrbirth_w2[which(is.na(SHARE_w3$yrbirth))]
SHARE_w3 <- SHARE_w3 %>% select(-yrbirth_w1,-yrbirth_w2)


yrbirth_missing <- union(yrbirth_missing,(SHARE_w3 %>% filter(is.na(yrbirth)))$id)
SHARE_miss <- full_join(SHARE_miss,SHARE_w3 %>% select(id,yrbirth) %>% filter(id %in% id_missings),by="id")

# Wave 3 missing yrbirth data is non-missing in posterior waves tables for some id's (look at validation of yrbirth at the end). Here is imputed.

SHARE_w3$yrbirth[SHARE_w3$id=="SE-764326-05"] <- 1951


cluster_assign_value(cluster,'SHARE_ds_w2',SHARE_ds_w2)
SHARE_hhaux <- SHARE_w3 %>%
                    multidplyr::partition(hhid3) %>%
                    summarise(n=n(),inpw=sum(id %in% SHARE_ds_w1$id | id %in% SHARE_ds_w2$id)) %>%
                    dplyr::collect() %>% arrange(hhid3)


SHARE_hhaux$ninpw <- SHARE_hhaux$n - SHARE_hhaux$inpw
SHARE_w3 <- left_join(SHARE_w3,SHARE_hhaux[,c("hhid3","n","inpw","ninpw")], by="hhid3")
SHARE_w3 <- left_join(SHARE_w3,SHARE_ds_w1,by="id")
SHARE_w3 <- left_join(SHARE_w3,SHARE_ds_w2,by="id",suffix = c("_w1","_w2"))
SHARE_w3$idinpw <- NA
SHARE_w3$idinpw[which(SHARE_w3$id %in% union(SHARE_ds_w1$id,SHARE_ds_w2$id))] <- 1
SHARE_w3$idinpw[which(!SHARE_w3$id %in% union(SHARE_ds_w1$id,SHARE_ds_w2$id))] <- 0
SHARE_w3$respondent <- SHARE_w3$respondent_w1
SHARE_w3$respondent[which(is.na(SHARE_w3$respondent_w1))] <- SHARE_w3$respondent_w2[which(is.na(SHARE_w3$respondent_w1))]


# n==1 & inpw==0
SHARE_n1i0 <- full_join(SHARE_w1 %>% select(id,hhid1,yrbirth,mstat) %>% filter(hhid1 %in% (SHARE_w3 %>% filter(n==1 & idinpw==0))$hhid3),SHARE_w2 %>% select(id,hhid2,yrbirth,mstat) %>% filter(hhid2 %in% (SHARE_w3 %>% filter(n==1 & idinpw==0))$hhid3),by =c("id","hhid1"="hhid2"), suffix = c("_w1","_w2"))
SHARE_n1i0 <- left_join((SHARE_w3 %>% filter(n==1 & idinpw==0) %>% select(-inpw,-ninpw,-respondent_w1,-respondent_w2,-respondent)),SHARE_n1i0,by =c("hhid3"="hhid1"),suffix=c("_w3",""))


# n==2 & inpw==0
SHARE_n2i0 <- full_join(SHARE_w1 %>% select(id,hhid1,yrbirth,mstat) %>% filter(hhid1 %in% (SHARE_w3 %>% filter(n==2 & inpw==0))$hhid3),SHARE_w2 %>% select(id,hhid2,yrbirth,mstat,mstat2) %>% filter(hhid2 %in% (SHARE_w3 %>% filter(n==2 & inpw==0))$hhid3),by =c("id","hhid1"="hhid2"), suffix = c("_w1","_w2"))
SHARE_n2i0 <- left_join((SHARE_w3 %>% filter(n==2 & inpw==0) %>% select(-ninpw,-respondent_w1,-respondent_w2,-respondent,-idinpw)),SHARE_n2i0,by =c("hhid3"="hhid1"),suffix=c("_w3",""))

# n==2 & inpw==1
SHARE_n2i1 <- full_join(SHARE_w1 %>% select(id,hhid1,yrbirth,mstat) %>% filter(hhid1 %in% (SHARE_w3 %>% filter(n==2 & inpw==1))$hhid3),SHARE_w2 %>% select(id,hhid2,yrbirth,mstat,mstat2) %>% filter(hhid2 %in% (SHARE_w3 %>% filter(n==2 & inpw==1))$hhid3),by =c("id","hhid1"="hhid2"), suffix = c("_w1","_w2"))
SHARE_n2i1 <- left_join((SHARE_w3 %>% filter(n==2 & inpw==1) %>% select(-ninpw,-respondent_w1,-respondent_w2)),SHARE_n2i1,by =c("hhid3"="hhid1"),suffix=c("_w3",""))

# n==3 & inpw==1
SHARE_n3i1 <- full_join(SHARE_w1 %>% select(id,hhid1,yrbirth,mstat) %>% filter(hhid1 %in% (SHARE_w3 %>% filter(n==3 & inpw==1))$hhid3),SHARE_w2 %>% select(id,hhid2,yrbirth,mstat,mstat2) %>% filter(hhid2 %in% (SHARE_w3 %>% filter(n==3 & inpw==1))$hhid3),by =c("id","hhid1"="hhid2"), suffix = c("_w1","_w2"))
SHARE_n3i1 <- left_join((SHARE_w3 %>% filter(n==3 & inpw==1) %>% select(-ninpw,-respondent_w1,-respondent_w2)),SHARE_n3i1,by =c("hhid3"="hhid1"),suffix=c("_w3",""))





```






```{r local2 w3,echo=FALSE}


kable(frq(SHARE_hhaux$n), caption = 'Frequency of respondents by household')

kable(addmargins(table(SHARE_hhaux$n,SHARE_hhaux$inpw,dnn = c("n","inpw"))),caption = "Households classified by number of id's in them (rows)  and their number of id's in previous waves (columns). Therefore the difference ('ninpw' = how many are not in previous waves) is given by the lower diagonals.")

kable(frq(SHARE_ds_w2$id[which(SHARE_ds_w2$respondent %in% miss_values_vector)] %in% SHARE_w3$id), caption = 'The missing values of the previous wave are not in this wave')


# n==1 & idinpw==0
vbl <- (SHARE_w3 %>% filter(n==1 & idinpw==0))$mstat
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = 'Frequency of mstat for individuals in 1-respondent households not in previous waves') 
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")
ggplot(SHARE_w3, aes(x=factor(mstat))) + geom_bar(stat="count", width=0.4, fill="steelblue", data = . %>% filter(n==1 & idinpw==0)) + xlab(label(vbl)) + ylab("Frequency")

kable(SHARE_n1i0 %>% filter(id %in% (SHARE_n1i0 %>% filter(!is.na(id)))$id),caption = 'These individuals and their cohouseholds in some of the previous waves (for those with some cohousehold), repeated when there are more than one of the last ones')

kable(SHARE_n1i0 %>% filter(!id %in% (SHARE_n1i0 %>% filter(!is.na(id)))$id) %>% select(-id,-ends_with("_w1"),-ends_with("_w2")),caption = 'The individuals without cohouseholds data in the previous waves')


# n==2 & inpw==0
kable(SHARE_n2i0,caption = '2-respondent households without individuals in previous waves and their preceding cohouseholds')



# n==2 & inpw==1
kable(frq(SHARE_w3$respondent[which(SHARE_w3$n==2 & SHARE_w3$inpw==1 & SHARE_w3$idinpw==1)]),caption = 'Frequency of respondent for cohouseholds respondents in previous waves of new ones in 2-respondent households')

kable(SHARE_n2i1 %>% filter(hhid3 %in% (SHARE_w3 %>% filter(n==2 & inpw==1 & idinpw==1 & respondent==1))$hhid3), caption = '2-respondent household for which the respondent from previous waves is spouse/partner')

vbl <- (SHARE_w3 %>% filter(n==2 & inpw==1 & idinpw==0))$mstat
kable(Categorical_summary(vbl, missing_values = NA)[2], caption = 'Frequency of mstat for individuals in 1-respondent households not in previous waves') 
kable(Categorical_summary(vbl, missing_values = NA)[1], caption = "Category")
ggplot(SHARE_w3, aes(x=factor(mstat))) + geom_bar(stat="count", width=0.4, fill="steelblue", data = . %>% filter(n==2 & inpw==1 & idinpw==0)) + xlab(label(vbl)) + ylab("Frequency")

# n==3 & inpw==1
kable(SHARE_n3i1,caption = '3-respondent households with a unique individual in previous waves')

# n==3 & inpw==2
kable(SHARE_w3 %>% filter(n==3 & inpw==2),caption = '3-respondent households with a unique individual not in previous waves')

# n==4
kable(SHARE_w3 %>% filter(n==4 & inpw!=4),caption = '4-respondent households with some individual not in previous waves')

```






#### Harmonisation algorithm
To compute the harmonised variable from the study-specific variables it has to be obtained by means of the next algorithm:

* `id in previous waves into respondent`
* `id's not in previous waves`
  + `1-respondent households: recode mstat==1,2 into 1 and mstat==3 into 2`
  + `some exceptions are treated separately (cf. table above with these individuals)`
  + `2-respondent households with no one in previous waves (n==2 & inpw==0)`
    * `if there are no preceding cohouseholds, recode mstat==1,2 into 1 and mstat==3 into 2`
    * `if there are preceding cohouseholds, recode into 2 other`
  + `2-respondent households with one respondent from previous waves (n==2 & inpw==1)`
    * `recode mstat==1,2 into 1 and mstat==3 into 2`
  + `3-respondent households with a unique respondent from previous waves (n==3 & inpw==1) into 2 other`
  + `3-respondent households with a unique respondent not from previous waves (n==3 & inpw==2): recode mstat==1,2 into 1 and mstat==3 into 2`
  + `4-respondent households into 2 other`





**R script:**

```{r harmo w3}


SHARE_ds_w3 <- tibble(id=SHARE_w3$id)
SHARE_ds_w3$respondent <- NA
# id in previous waves into respondent
SHARE_ds_w3$respondent[which(SHARE_w3$idinpw==1)] <- SHARE_w3$respondent[which(SHARE_w3$idinpw==1)]

# 1-respondent households not in previous waves
SHARE_ds_w3$respondent[which(SHARE_w3$n==1 & SHARE_w3$idinpw==0)] <- car::recode(SHARE_w3$mstat[which(SHARE_w3$n==1 & SHARE_w3$idinpw==0)],"c(1,2) = 1; 3 = 2")
# some exceptions are treated separately:
SHARE_ds_w3$respondent[which(SHARE_w3$id %in% c("ES-294221-02","ES-308425-03","ES-615082-02","AT-308544-02","ES-206221-03","ES-702749-02","GR-586334-08","CZ-338422-05"))] <- 2

# 2-respondent households with no one in previous waves (n==2 & inpw==0)
SHARE_ds_w3$respondent[which(SHARE_w3$n==2 & SHARE_w3$inpw==0)] <- car::recode(SHARE_w3$mstat[which(SHARE_w3$n==2 & SHARE_w3$inpw==0)], "c(1,2) = 1; 3 = 2")
SHARE_ds_w3$respondent[which(SHARE_w3$id %in% (SHARE_n2i0 %>% filter(!is.na(id)))$id_w3)] <- 2

# 2-respondent households with one respondent from previous waves (n==2 & inpw==1)
SHARE_ds_w3$respondent[which(SHARE_w3$n==2 & SHARE_w3$inpw==1 & SHARE_w3$idinpw==0)] <- car::recode(SHARE_w3$mstat[which(SHARE_w3$n==2 & SHARE_w3$inpw==1 & SHARE_w3$idinpw==0)], "c(1,2) = 1; 3 = 2")
SHARE_ds_w3$respondent[which(SHARE_w3$id==(SHARE_n2i1 %>% filter(idinpw==0 & hhid3 %in% (SHARE_w3 %>% filter(n==2 & inpw==1 & idinpw==1 & respondent==1))$hhid3))$id_w3)] <- 0

# 3-respondent households with a unique respondent from previous waves (n==2 & inpw==1) into 2 other
SHARE_ds_w3$respondent[which(SHARE_w3$idinpw==0 & SHARE_w3$n==3 & SHARE_w3$inpw==1)] <- 2

# 3-respondent households with a unique respondent not from previous waves (n==3 & inpw==2): recode mstat==1,2 into 1 and mstat==3 into 2
SHARE_ds_w3$respondent[which(SHARE_w3$n==3 & SHARE_w3$inpw==2 & SHARE_w3$idinpw==0)] <- car::recode(SHARE_w3$mstat[which(SHARE_w3$n==3 & SHARE_w3$inpw==2 & SHARE_w3$idinpw==0)], "c(1,2) = 1; 3 = 2")
SHARE_ds_w3$respondent[which(SHARE_w3$id=="FR-667859-11")] <- 2

# n==4
SHARE_ds_w3$respondent[which(SHARE_w3$idinpw==0 & SHARE_w3$n==4 & SHARE_w3$inpw!=4)] <- 2


SHARE_ds_w3$respondent <- car::recode(SHARE_ds_w3$respondent, "NA=999")
```




#### Statistical description of the new harmonised variable
```{r descript w3, echo=FALSE}
vbl <- SHARE_ds_w3$respondent
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label) 
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(SHARE_ds_w3, aes(x=factor(vbl))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```


#### Validation
```{r crosstabulation w3, echo=FALSE}

kable(SHARE_w3[which(SHARE_w3$n==1 & SHARE_w3$idinpw==0 & is.na(SHARE_w3$mstat)),], caption = '1-respondent households with missing mstat data')

kable(SHARE_n2i1 %>% filter(hhid3 %in% (SHARE_w3 %>% filter(n==2 & inpw==1 & idinpw==0 & is.na(mstat)))$hhid3), caption = '2-respondent household for which the new respondent has missing mstat data')


rm(SHARE_hhaux,SHARE_n1i0,SHARE_n2i0,SHARE_n2i1,SHARE_n3i1)
```



### Wave 4



| **Name** |`hhid4`|`partnerinhh`|`yrbirth`|`relrpers`|
|-|-|-|-|-|
| **Label** |`household identifier wave 4`|`partner in household`|`year of birth`|`relation to coverscreen respondent`|
| **Table name** |`sharew4_rel1-1-1_cv_r_without_noint`|`sharew4_rel1-1-1_cv_r_without_noint`|`sharew4_rel1-1-1_cv_r_without_noint`|`sharew4_rel1-1-1_cv_r_without_noint`|
| **Categories** |`text`|`1 = yes`<br/>`3 = no`|`continuous`|`1 = spouse/partner`<br/>`3 = child`<br/>`4 = child-in-law`<br/>`5 = parent`<br/>`6 = parent-in-law`<br/>`7 = sibling`<br/>`8 = grand-child`<br/>`9 = other relative (specify)`<br/>`10 = other non-relative (specify)`<br/>`11 = ex-spouse/ex-partner`<br/>`12 = deceased spouse`<br/>`13 = proxy`|
| **Missings** |  |  |`-2 = refusal`<br/>`-1 = don't know`<br/>`NA`|`NA`|
| **Description** |  |  |  |  |



```{r assign w4, echo=F}


opal.assign.table.tibble(o, 'SHARE_w4','SHARE.sharew4_rel1-1-1_cv_r_without_noint',variables=list('hhid4','yrbirth','partnerinhh','relrpers'), missings = T)
SHARE_w4 <- opal.execute(o,'SHARE_w4')


```


```{r local w4, echo=FALSE}


vbl <- SHARE_w4$yrbirth
vbl_miss <- c(-1,-2)
kable(Continuous_summary(var = vbl, missing_values = vbl_miss)[3], caption = attributes(vbl)$`spss::shortName`)
kable(Continuous_summary(vbl, missing_values = vbl_miss)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = vbl_miss)$summary, caption = "Summary")
ggplot(SHARE_w4, aes(yrbirth)) + geom_bar(stat="count", width=0.4, fill="steelblue",data = . %>% filter(!vbl %in% vbl_miss)) + xlab(label(vbl)) + ylab("Frequency")

vbl <- SHARE_w4$partnerinhh
kable(Categorical_summary(vbl, missing_values = vbl_miss)[3], caption = attributes(vbl)$`spss::shortName`) 
kable(Categorical_summary(vbl, missing_values = vbl_miss)[1], caption = "Category")
ggplot(SHARE_w4, aes(x=factor(partnerinhh))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")


vbl <- SHARE_w4$relrpers
kable(Categorical_summary(vbl, missing_values = vbl_miss)[3], caption = attributes(vbl)$`spss::shortName`) 
kable(Categorical_summary(vbl, missing_values = vbl_miss)[1], caption = "Category")
ggplot(SHARE_w4, aes(x=factor(relrpers))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```




```{r preharm w4}

SHARE_w4$yrbirth <- car::recode(SHARE_w4$yrbirth,"c(-1,-2)=NA")

#Some missing yrbirth data is available from previous waves
SHARE_w4 <- left_join(SHARE_w4,SHARE_w1 %>% select(id,yrbirth) %>% filter(!yrbirth %in% c(-1,-2)),by = "id", suffix = c("","_w1"))
SHARE_w4$yrbirth[which(is.na(SHARE_w4$yrbirth))] <- SHARE_w4$yrbirth_w1[which(is.na(SHARE_w4$yrbirth))]
SHARE_w4 <- left_join(SHARE_w4,SHARE_w2 %>% select(id,yrbirth) %>% filter(!yrbirth %in% c(-1,-2)),by = "id", suffix = c("","_w2"))
SHARE_w4$yrbirth[which(is.na(SHARE_w4$yrbirth))] <- SHARE_w4$yrbirth_w2[which(is.na(SHARE_w4$yrbirth))]
SHARE_w4 <- left_join(SHARE_w4,SHARE_w3 %>% select(id,yrbirth) %>% filter(!yrbirth %in% c(-1,-2)),by = "id", suffix = c("","_w3"))
SHARE_w4$yrbirth[which(is.na(SHARE_w4$yrbirth))] <- SHARE_w4$yrbirth_w3[which(is.na(SHARE_w4$yrbirth))]
SHARE_w4 <- SHARE_w4 %>% select(-yrbirth_w1,-yrbirth_w2,-yrbirth_w3)



yrbirth_missing <- union(yrbirth_missing,(SHARE_w4 %>% filter(is.na(yrbirth)))$id)
SHARE_miss <- full_join(SHARE_miss,SHARE_w4 %>% select(id,yrbirth) %>% filter(id %in% id_missings),by="id",suffix = c("_w3","_w4"))

# Wave 4 missing yrbirth data is non-missing in posterior waves tables for some id's (look at validation of yrbirth at the end). Here is imputed.

SHARE_w4$yrbirth[which(SHARE_w4$id=="AT-864946-01")] <- 1945
SHARE_w4$yrbirth[which(SHARE_w4$id=="AT-886095-01")] <- 1926
SHARE_w4$yrbirth[which(SHARE_w4$id=="CZ-373473-04")] <- 1950
SHARE_w4$yrbirth[which(SHARE_w4$id=="CZ-694720-01")] <- 1954
SHARE_w4$yrbirth[which(SHARE_w4$id=="F1-191516-01")] <- 1950
SHARE_w4$yrbirth[which(SHARE_w4$id=="F1-728117-01")] <- 1946

cluster_assign_value(cluster,'SHARE_ds_w3',SHARE_ds_w3)
SHARE_hhaux <- SHARE_w4 %>%
                    multidplyr::partition(hhid4) %>%
                    summarise(n=n(),my=min(yrbirth),may=max(yrbirth),inpw=sum(id %in% SHARE_ds_w1$id | id %in% SHARE_ds_w2$id | id %in% SHARE_ds_w3$id)) %>%
                    dplyr::collect() %>% arrange(hhid4)



SHARE_hhaux$ninpw <- SHARE_hhaux$n - SHARE_hhaux$inpw
SHARE_w4$yrbind <- car::recode(SHARE_w4$yrbirth,"lo:1960=1;1961:hi=0")
SHARE_w4 <- left_join(SHARE_w4,SHARE_hhaux[,c("hhid4","n","inpw","ninpw","my","may")], by="hhid4")
SHARE_w4 <- left_join(SHARE_w4,SHARE_ds_w1,by="id")
SHARE_w4 <- left_join(SHARE_w4,SHARE_ds_w2,by="id",suffix = c("_w1","_w2"))
SHARE_w4 <- left_join(SHARE_w4,SHARE_ds_w3,by="id")
SHARE_w4$idinpw <- NA
SHARE_w4$idinpw[which(SHARE_w4$id %in% union(union(SHARE_ds_w1$id,SHARE_ds_w2$id),SHARE_ds_w3$id))] <- 1
SHARE_w4$idinpw[which(!SHARE_w4$id %in% union(union(SHARE_ds_w1$id,SHARE_ds_w2$id),SHARE_ds_w3$id))] <- 0
SHARE_w4$respondent[which(!is.na(SHARE_w4$respondent_w1))] <- SHARE_w4$respondent_w1[which(!is.na(SHARE_w4$respondent_w1))]
SHARE_w4$respondent[which(!is.na(SHARE_w4$respondent_w2))] <- SHARE_w4$respondent_w2[which(!is.na(SHARE_w4$respondent_w2))]
SHARE_w4 <- SHARE_w4 %>% select(-respondent_w1,-respondent_w2)


# n>1 & ninpw==1
# Individuals with paradoxical data between relrpers and partnerinhh grouped by households
SHARE_hhrnm <- SHARE_w4 %>% filter(hhid4 %in% (SHARE_w4 %>% filter(n>1 & ninpw==1 & idinpw==0 & relrpers!=1 & partnerinhh==1))$hhid4) %>%
              arrange(hhid4,idinpw,yrbirth) %>% group_by(hhid4) %>% mutate(idp = row_number()) %>% 
              gather(kn,vn,c("id","yrbirth","partnerinhh","relrpers","yrbind","respondent","idinpw")) %>%
              unite(coln,kn,idp) %>%
              spread(coln,vn) %>%
              select(c("hhid4","n","inpw","ninpw","my","may",ends_with("_1"),ends_with("_2"))) %>%
              mutate_at(vars(contains("yrbirth"),contains("partnerinhh"),contains("relrpers"),contains("yrbind"),contains("respondent"),contains("idinpw")),as.numeric)



# Individuals in 2-respondent households with respondent == 0 for the ones in previous waves.
SHARE_hhrz <- SHARE_w4 %>% filter(hhid4 %in% (SHARE_w4 %>% filter(n==2 & ninpw==1 & idinpw==1 & respondent==0))$hhid4) %>%
              arrange(hhid4,idinpw,yrbirth) %>% group_by(hhid4) %>% mutate(idp = row_number()) %>% 
              gather(kn,vn,c("id","yrbirth","partnerinhh","relrpers","yrbind","respondent","idinpw")) %>%
              unite(coln,kn,idp) %>%
              spread(coln,vn) %>%
              select(c("hhid4","n","inpw",ends_with("_1"),ends_with("_2"))) %>%
              mutate_at(vars(contains("yrbirth"),contains("partnerinhh"),contains("relrpers"),contains("yrbind"),contains("respondent"),contains("idinpw")),as.numeric) %>%
              select(-yrbind_1,-yrbind_2)


# Individuals in 2-respondent households with respondent != 0 for the ones in previous waves.
SHARE_hhrnz <- SHARE_w4 %>% filter(hhid4 %in% (SHARE_w4 %>% filter(n==2 & ninpw==1 & idinpw==1 & respondent!=0))$hhid4) %>%
              arrange(hhid4,idinpw,yrbirth) %>% group_by(hhid4) %>% mutate(idp = row_number()) %>% 
              gather(kn,vn,c("id","yrbirth","partnerinhh","relrpers","yrbind","respondent","idinpw")) %>%
              unite(coln,kn,idp) %>%
              spread(coln,vn) %>%
              select(c("hhid4","n","inpw","ninpw","my","may",ends_with("_1"),ends_with("_2"))) %>%
              mutate_at(vars(contains("yrbirth"),contains("partnerinhh"),contains("relrpers"),contains("yrbind"),contains("respondent"),contains("idinpw")),as.numeric) %>%
              select(-ninpw,-my,-may,-yrbind_1,-yrbind_2)
SHARE_hhrnz$hh <- substr(SHARE_hhrnz$hhid4,1,9)
SHARE_w1 <- left_join(SHARE_w1,SHARE_ds_w1,by="id")
SHARE_w2 <- left_join(SHARE_w2[,-match("respondent",names(SHARE_w2))],SHARE_ds_w2,by="id")

SHARE_hhrnz0 <- full_join(SHARE_w1 %>% select(id,hhid1,yrbirth,mstat,respondent) %>% filter(substr(hhid1,1,9) %in% substr(SHARE_hhrnz$hhid4,1,9)),SHARE_w2 %>% select(id,hhid2,yrbirth,mstat,mstat2,respondent) %>% filter(substr(hhid2,1,9) %in% substr(SHARE_hhrnz$hhid4,1,9)),by =c("id","hhid1"="hhid2"), suffix = c("_w1","_w2"))
SHARE_hhrnz0$hh <- substr(SHARE_hhrnz0$hhid1,1,9)
SHARE_hhrnzf <- left_join(SHARE_hhrnz,SHARE_hhrnz0,by =c("hh"),suffix=c("_w4",""))



# n==2 & inpw==0
SHARE_n2i0 <- SHARE_w4 %>% filter(inpw==0 & n==2) %>% select(-my,-may)

# These individuals reordered by household and year of birth and grouped by household
SHARE_hhan <- SHARE_n2i0 %>% arrange(hhid4,yrbirth)%>% select(-respondent,-relrpers) %>% group_by(hhid4) %>% mutate(idp = row_number()) %>% 
            gather(kn,vn,c("id","yrbirth","partnerinhh","yrbind")) %>%
            unite(coln,kn,idp) %>%
            spread(coln,vn) %>%
            select(c("hhid4","n",ends_with("_1"),ends_with("_2"))) %>%
            mutate_at(vars(contains("yrbi"),contains("partnerinhh")),as.numeric)


```


```{r local2 w4,echo=FALSE}

kable(frq(SHARE_hhaux$n), caption = 'Frequency of respondents by household')

kable(addmargins(table(SHARE_hhaux$n,SHARE_hhaux$inpw,dnn = c("n","inpw"))),caption = "Households classified by number of id's in them (rows)  and their number of id's in previous waves (columns). Therefore the difference ('ninpw' = how many are not in previous waves) is given by the lower diagonals.")

# n==1 & idinpw==0
kable(table((SHARE_w4 %>% filter(n==1 & idinpw==0 & yrbind==0))$relrpers,(SHARE_w4 %>% filter(n==1 & idinpw==0 & yrbind==0))$partnerinhh,useNA = "ifany"),caption = 'Crossing table of relrpers with partnerinhh for 1-respondent households not in previous waves born after 1960')

kable(SHARE_w4 %>% filter(n==1 & idinpw==0 & yrbind==0 & relrpers %in% c(3,9) & partnerinhh==1),caption = 'The individuals with paradoxical data')

# n>1 & ninpw==1 & idinpw==0
kable(table((SHARE_w4 %>% filter(n>1 & ninpw==1 & idinpw==0))$relrpers,(SHARE_w4 %>% filter(n>1 & ninpw==1 & idinpw==0))$partnerinhh,useNA = "ifany"),caption = 'Crossing table of relrpers with partnerinhh for individuals not in previous waves unique in n-respondent households for n>1')
kable(SHARE_hhrnm %>% select(-ninpw,-my,-may,-respondent_1,-yrbind_1,-yrbind_2),caption = 'Households of the individuals with paradoxical data')

### n==2 & ninpw==1
kable(frq((SHARE_w4 %>% filter(n==2 & ninpw==1))$respondent), caption = 'Frequency of respondent variable in 2-respondent households with only one not in previous waves')

kable(frq((SHARE_w4 %>% filter(hhid4 %in% (SHARE_w4 %>% filter(n==2 & ninpw==1 & idinpw==1 & respondent!=0))$hhid4))$partnerinhh),caption = 'Frequency of partnerinhh for individuals in 2-respondent households with respondent != 0 for the ones in previous waves')
kable(SHARE_hhrnzf %>% select(-hh,-idinpw_1,-idinpw_2,-mstat2,-partnerinhh_1,-partnerinhh_2),caption = 'Individuals in 2-respondent households with respondent != 0 for the ones both in present and past waves')

### n==3 & ninpw==1
kable(SHARE_w4 %>% filter(n==3 & inpw==2) %>% select(-my,-may), caption = '3-respondent households with only one not in previous waves')

# n==4 & inpw<=2

kable(SHARE_w4 %>% filter(n==4 & inpw<=2) %>% select(-my,-may), caption = '4-respondent households with at most two in previous waves')


# n==2 & inpw==0
kable(frq((SHARE_hhan)$yrbind_1),caption = 'Individuals in households without respondents in previous waves are organised so that the ones in first column were born before 1960')

kable(frq(SHARE_hhan$yrbirth_1<=SHARE_hhan$yrbirth_2), caption = 'Individuals in households without respondents in previous waves are organised so that the ones in first column were born before those in second column.')

# n==3 & inpw==0
kable(SHARE_w4 %>% filter(n==3 & inpw==0) %>% select(-my,-may,-ninpw,-yrbind,-respondent,-idinpw),caption = '3-respondent households without respondents in previous waves')



## HH with some missing yrbirth
kable(SHARE_w4 %>% filter(hhid4 %in% (SHARE_w4 %>% filter(is.na(yrbirth)))$hhid4),caption = 'Individuals in households with some yrbirth data missing')

```




#### Harmonisation algorithm
To compute the harmonised variable from the study-specific variables it has to be obtained by means of the next algorithm:

* `id in previous waves into respondent`
* `1-respondent born before 1960 or with missing yrbirth data households not in previous waves into 0 participant`
* `1-respondent born after 1960 households not in previous waves`
  + `recode relrpers==1 into 1, relrpers!=1 into 2`
  + `if relrpers is missing`
    * `recode partnerinhh == 1 into 1 spouse/partner`
    * `recode partnerinhh ==3 into 2 other`
* `id not in previous waves in 2-respondent households with other id in previous waves (n==2 & ninpw == 1)`
  + `if old id respondent == 0 recode partnerinhh==1 for both respondents into 1, otherwise into 2`
  + `if old id respondent == 1, respondent into 2`
  + `if old id respondent == 2, a particular cade for the two cases`
* `id not in previous waves in 3-respondent households with other id in previous waves (n==3 & ninpw == 1)`
  + `recode partnerinhh == 1 into 1 spouse/partner`
  + `recode partnerinhh ==3 into 2 other`
* `id in 2-respondent households with all id not in previous waves (n==2 & inpw==0)`
  + `one id born before and one after 1960 or missing`
    * `before 1960 into 0`
    * `after 1960 or missing yrbirth data recode partnerinhh == 1 into 1, partnerinhh == 3 into 2`
  + `otherwise:`
    * `younger id born before 1960 into 0`
    * `older ids born before 1960 into recode partnerinhh == 1 into 1, partnerinhh == 3 into 2`
* `id in 3-respondent households with all id not in previous waves (n==3 & inpw==0) or in 4-respondent households with two id's at most in previous waves (n==4 & inpw<=2)`
  + `treated as particular cases`




**R script:**

```{r harmo w4}


SHARE_ds_w4 <- tibble(id=SHARE_w4$id)
SHARE_ds_w4$respondent <- NA
# id in previous waves into respondent
SHARE_ds_w4$respondent[which(SHARE_w4$idinpw==1)] <- SHARE_w4$respondent[which(SHARE_w4$idinpw==1)]

# 1-respondent born before 1960 or with missing yrbirth data households not in previous waves into 0 participant
SHARE_ds_w4$respondent[which(SHARE_w4$idinpw==0 & SHARE_w4$n==1 & (SHARE_w4$yrbind==1 | is.na(SHARE_w4$yrbind)))] <- 0
# 1-respondent born after 1960 households not in previous waves
SHARE_ds_w4$respondent[which(SHARE_w4$idinpw==0 & SHARE_w4$n==1 & SHARE_w4$yrbind==0)] <- car::recode(SHARE_w4$relrpers[which(SHARE_w4$idinpw==0 & SHARE_w4$n==1 & SHARE_w4$yrbind==0)],"1 = 1; c(3,9,10) = 2")
SHARE_ds_w4$respondent[which(SHARE_w4$idinpw==0 & SHARE_w4$n==1 & SHARE_w4$yrbind==0 & is.na(SHARE_w4$relrpers))] <- car::recode(SHARE_w4$partnerinhh[which(SHARE_w4$idinpw==0 & SHARE_w4$n==1 & SHARE_w4$yrbind==0 & is.na(SHARE_w4$relrpers))],"1 = 1; 3 = 2")

# id not in previous waves in 2-respondent households with other id in previous waves (n==2 & ninpw == 1)
### if old id respondent == 0 recode partnerinhh==1 for both respondents into 1, otherwise into 2
SHARE_hhrz$respondent_1[which(SHARE_hhrz$partnerinhh_1==1 & SHARE_hhrz$partnerinhh_2==1)] <- 1
SHARE_hhrz$respondent_1[which(SHARE_hhrz$partnerinhh_1==3 | SHARE_hhrz$partnerinhh_2==3)] <- 2
SHARE_hhrz$respondent_1[which(SHARE_hhrz$id_1=="SE-077285-02")] <- 2

SHARE_ds_w4 <- left_join(SHARE_ds_w4,SHARE_hhrz[,c("id_1","respondent_1")], by = c("id"="id_1"))
SHARE_ds_w4$respondent[which(SHARE_ds_w4$id %in% SHARE_hhrz$id_1)] <- SHARE_ds_w4$respondent_1[which(SHARE_ds_w4$id %in% SHARE_hhrz$id_1)]

SHARE_ds_w4 <- SHARE_ds_w4[,c("id","respondent")]

### if old id respondent != 0
SHARE_hhrnz$respondent_1[which(SHARE_hhrnz$respondent_2==1)] <- 2
SHARE_hhrnz$respondent_1[which(SHARE_hhrnz$id_1=="AT-308544-03")] <- 1
SHARE_hhrnz$respondent_1[which(SHARE_hhrnz$id_1=="ES-294221-03")] <- 2

SHARE_ds_w4 <- left_join(SHARE_ds_w4,SHARE_hhrnz[,c("id_1","respondent_1")], by = c("id"="id_1"))
SHARE_ds_w4$respondent[which(SHARE_ds_w4$id %in% SHARE_hhrnz$id_1)] <- SHARE_ds_w4$respondent_1[which(SHARE_ds_w4$id %in% SHARE_hhrnz$id_1)]

SHARE_ds_w4 <- SHARE_ds_w4[,c("id","respondent")]

# id not in previous waves in 3-respondent households with other id in previous waves (n==3 & ninpw == 1)
SHARE_ds_w4$respondent[which(SHARE_w4$n==3 & SHARE_w4$inpw==2 & SHARE_w4$idinpw==0)] <- car::recode(SHARE_w4$partnerinhh[which(SHARE_w4$n==3 & SHARE_w4$inpw==2 & SHARE_w4$idinpw==0)],"1 = 1; 3 = 2")



# n==4 & inpw<=2
SHARE_ds_w4$respondent[which(SHARE_ds_w4$id=="ES-271380-02")] <- 1
SHARE_ds_w4$respondent[which(SHARE_ds_w4$id=="ES-271380-03")] <- 2
SHARE_ds_w4$respondent[which(SHARE_ds_w4$id=="ES-271380-04")] <- 2
SHARE_ds_w4$respondent[which(SHARE_ds_w4$id=="ES-898677-03")] <- 2
SHARE_ds_w4$respondent[which(SHARE_ds_w4$id=="ES-898677-04")] <- 2


# id in household with all id not in previous waves (inpw==0)
### n==2
##### one id born before and one after 1960 or missing
SHARE_ds_w4$respondent[which(SHARE_ds_w4$id %in% (SHARE_w4 %>% filter(inpw==0 & (may>1960 | is.na(may)) & n==2 & yrbind==1))$id)] <- 0
SHARE_ds_w4$respondent[which(SHARE_w4$inpw==0 & (SHARE_w4$yrbind==0 | is.na(SHARE_w4$yrbind)) & SHARE_w4$n==2)] <- car::recode(SHARE_w4$partnerinhh[which(SHARE_w4$inpw==0 & (SHARE_w4$yrbind==0 | is.na(SHARE_w4$yrbind)) & SHARE_w4$n==2)],"1=1; 3=2")

##### otherwise
####### younger id born before 1960 into 0
SHARE_ds_w4$respondent[which(SHARE_ds_w4$id %in% (SHARE_hhan %>% filter(n==2 & yrbind_1==1 & yrbind_2==1))$id_2)] <- 0

####### older ids born before 1960 into recode partnerinhh == 1 into 1, partnerinhh == 3 into 2
SHARE_hhan$respondent_1[which(SHARE_hhan$n==2 & SHARE_hhan$yrbind_1==1 & SHARE_hhan$yrbind_2==1)] <- car::recode(SHARE_hhan$partnerinhh_1[which(SHARE_hhan$n==2 & SHARE_hhan$yrbind_1==1 & SHARE_hhan$yrbind_2==1)],"1=1; 3=2")
SHARE_ds_w4 <- left_join(SHARE_ds_w4,SHARE_hhan[which(SHARE_hhan$n==2 & SHARE_hhan$yrbind_1==1 & SHARE_hhan$yrbind_2==1),c("id_1","respondent_1")],by = c("id"="id_1"))
SHARE_ds_w4$respondent[which(SHARE_ds_w4$id %in% SHARE_hhan$id_1[which(SHARE_hhan$n==2 & SHARE_hhan$yrbind_1==1 & SHARE_hhan$yrbind_2==1)])] <- SHARE_ds_w4$respondent_1[which(SHARE_ds_w4$id %in% SHARE_hhan$id_1[which(SHARE_hhan$n==2 & SHARE_hhan$yrbind_1==1 & SHARE_hhan$yrbind_2==1)])]
SHARE_ds_w4 <- SHARE_ds_w4[,c("id","respondent")]


### n==3
SHARE_ds_w4$respondent[which(SHARE_ds_w4$id=="CZ-299742-01")] <- 0
SHARE_ds_w4$respondent[which(SHARE_ds_w4$id=="CZ-299742-03")] <- 1
SHARE_ds_w4$respondent[which(SHARE_ds_w4$id=="CZ-299742-04")] <- 2
SHARE_ds_w4$respondent[which(SHARE_ds_w4$id=="ES-008093-01")] <- 0
SHARE_ds_w4$respondent[which(SHARE_ds_w4$id=="ES-008093-02")] <- 2
SHARE_ds_w4$respondent[which(SHARE_ds_w4$id=="ES-008093-03")] <- 1
SHARE_ds_w4$respondent[which(SHARE_ds_w4$id=="ES-809567-03")] <- 2
SHARE_ds_w4$respondent[which(SHARE_ds_w4$id=="ES-809567-04")] <- 0
SHARE_ds_w4$respondent[which(SHARE_ds_w4$id=="ES-809567-05")] <- 1



```





#### Statistical description of the new harmonised variable
```{r descript w4, echo=FALSE}
vbl <- SHARE_ds_w4$respondent
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label) 
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(SHARE_ds_w4, aes(x=factor(vbl))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```



#### Validation
```{r crosstabulation w4, echo=FALSE}

rm(SHARE_hhan,SHARE_hhaux,SHARE_hhrnm,SHARE_hhrnz,SHARE_hhrnz0,SHARE_hhrnzf,SHARE_hhrz,SHARE_n2i0)
```




### Wave 5



| **Name** |`hhid5`|`partnerinhh`|`yrbirth`|`relrpers`|
|-|-|-|-|-|
| **Label** |`household identifier wave 5`|`partner in household`|`year of birth`|`relation to coverscreen respondent`|
| **Table name** |`sharew5_rel1-0-0_cv_r_without_noint`|`sharew5_rel1-0-0_cv_r_without_noint`|`sharew5_rel1-0-0_cv_r_without_noint`|`sharew5_rel1-0-0_cv_r_without_noint`|
| **Categories** |`text`|`1 = yes`<br/>`3 = no`|`continuous`|`1 = spouse/partner`<br/>`3 = child`<br/>`4 = child-in-law`<br/>`5 = parent`<br/>`6 = parent-in-law`<br/>`7 = sibling`<br/>`8 = grand-child`<br/>`9 = other relative (specify)`<br/>`10 = other non-relative (specify)`<br/>`11 = ex-spouse/ex-partner`<br/>`12 = deceased spouse`<br/>`13 = proxy`|
| **Missings** |  |`NA`|`-2 = refusal`<br/>`-1 = don't know`<br/>`NA`|`NA`|
| **Description** |  |  |  |  |


```{r assign w5, echo=F}

opal.assign.table.tibble(o, 'SHARE_w5','SHARE.sharew5_rel1-0-0_cv_r_without_noint',variables=list('hhid5','yrbirth','partnerinhh','relrpers'), missings = T)
SHARE_w5 <- opal.execute(o,'SHARE_w5')


```



```{r local w5, echo=FALSE}


vbl <- SHARE_w5$yrbirth
vbl_miss <- c(-1,-2)
kable(Continuous_summary(var = vbl, missing_values = vbl_miss)[3], caption = attributes(vbl)$`spss::shortName`)
kable(Continuous_summary(vbl, missing_values = vbl_miss)[2], caption = "Values")
pander(Continuous_summary(vbl, missing_values = vbl_miss)$summary, caption = "Summary")
ggplot(SHARE_w5, aes(yrbirth)) + geom_bar(stat="count", width=0.4, fill="steelblue",data = . %>% filter(!vbl %in% vbl_miss)) + xlab(label(vbl)) + ylab("Frequency")

vbl <- SHARE_w5$partnerinhh
kable(Categorical_summary(vbl, missing_values = vbl_miss)[3], caption = attributes(vbl)$`spss::shortName`) 
kable(Categorical_summary(vbl, missing_values = vbl_miss)[1], caption = "Category")
ggplot(SHARE_w5, aes(x=factor(partnerinhh))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")


vbl <- SHARE_w5$relrpers
kable(Categorical_summary(vbl, missing_values = vbl_miss)[3], caption = attributes(vbl)$`spss::shortName`) 
kable(Categorical_summary(vbl, missing_values = vbl_miss)[1], caption = "Category")
ggplot(SHARE_w5, aes(x=factor(relrpers))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(label(vbl)) + ylab("Frequency")

```


```{r preharm w5}

SHARE_w5$yrbirth <- car::recode(SHARE_w5$yrbirth,"c(-1,-2)=NA")

#Some missing yrbirth data is available from previous waves
SHARE_w5 <- left_join(SHARE_w5,SHARE_w1 %>% select(id,yrbirth) %>% filter(!yrbirth %in% c(-1,-2)),by = "id", suffix = c("","_w1"))
SHARE_w5$yrbirth[which(is.na(SHARE_w5$yrbirth))] <- SHARE_w5$yrbirth_w1[which(is.na(SHARE_w5$yrbirth))]
SHARE_w5 <- left_join(SHARE_w5,SHARE_w2 %>% select(id,yrbirth) %>% filter(!yrbirth %in% c(-1,-2)),by = "id", suffix = c("","_w2"))
SHARE_w5$yrbirth[which(is.na(SHARE_w5$yrbirth))] <- SHARE_w5$yrbirth_w2[which(is.na(SHARE_w5$yrbirth))]
SHARE_w5 <- left_join(SHARE_w5,SHARE_w3 %>% select(id,yrbirth) %>% filter(!yrbirth %in% c(-1,-2)),by = "id", suffix = c("","_w3"))
SHARE_w5$yrbirth[which(is.na(SHARE_w5$yrbirth))] <- SHARE_w5$yrbirth_w3[which(is.na(SHARE_w5$yrbirth))]
SHARE_w5 <- left_join(SHARE_w5,SHARE_w4 %>% select(id,yrbirth) %>% filter(!yrbirth %in% c(-1,-2)),by = "id", suffix = c("","_w4"))
SHARE_w5$yrbirth[which(is.na(SHARE_w5$yrbirth))] <- SHARE_w5$yrbirth_w4[which(is.na(SHARE_w5$yrbirth))]
SHARE_w5 <- SHARE_w5 %>% select(-yrbirth_w1,-yrbirth_w2,-yrbirth_w3,-yrbirth_w4)



yrbirth_missing <- union(yrbirth_missing,(SHARE_w5 %>% filter(is.na(yrbirth)))$id)
SHARE_miss <- full_join(SHARE_miss,SHARE_w5 %>% select(id,yrbirth) %>% filter(id %in% id_missings),by="id")


cluster_assign_value(cluster,'SHARE_ds_w4',SHARE_ds_w4)
SHARE_hhaux <- SHARE_w5 %>%
                    multidplyr::partition(hhid5) %>%
                    summarise(n=n(),my=min(yrbirth),may=max(yrbirth),inpw=sum(id %in% SHARE_ds_w1$id | id %in% SHARE_ds_w2$id | id %in% SHARE_ds_w3$id | id %in% SHARE_ds_w4$id)) %>%
                    dplyr::collect() %>% arrange(hhid5)



SHARE_hhaux$ninpw <- SHARE_hhaux$n - SHARE_hhaux$inpw
SHARE_w5$yrbind <- car::recode(SHARE_w5$yrbirth,"lo:1962=1;1963:hi=0")
SHARE_w5 <- left_join(SHARE_w5,SHARE_hhaux[,c("hhid5","n","inpw","ninpw","my","may")], by="hhid5")
SHARE_w5 <- left_join(SHARE_w5,SHARE_ds_w1,by="id")
SHARE_w5 <- left_join(SHARE_w5,SHARE_ds_w2,by="id",suffix = c("_w1","_w2"))
SHARE_w5 <- left_join(SHARE_w5,SHARE_ds_w3,by="id")
SHARE_w5 <- left_join(SHARE_w5,SHARE_ds_w4,by="id",suffix = c("_w3","_w4"))
SHARE_w5$idinpw <- NA
SHARE_w5$idinpw[which(SHARE_w5$id %in% union(union(union(SHARE_ds_w1$id,SHARE_ds_w2$id),SHARE_ds_w3$id),SHARE_ds_w4$id))] <- 1
SHARE_w5$idinpw[which(!SHARE_w5$id %in% union(union(union(SHARE_ds_w1$id,SHARE_ds_w2$id),SHARE_ds_w3$id),SHARE_ds_w4$id))] <- 0
SHARE_w5$respondent <- SHARE_w5$respondent_w4
SHARE_w5$respondent[which(!is.na(SHARE_w5$respondent_w1))] <- SHARE_w5$respondent_w1[which(!is.na(SHARE_w5$respondent_w1))]
SHARE_w5$respondent[which(!is.na(SHARE_w5$respondent_w2))] <- SHARE_w5$respondent_w2[which(!is.na(SHARE_w5$respondent_w2))]
SHARE_w5$respondent[which(!is.na(SHARE_w5$respondent_w3))] <- SHARE_w5$respondent_w3[which(!is.na(SHARE_w5$respondent_w3))]
SHARE_w5 <- SHARE_w5 %>% select(-respondent_w1,-respondent_w2,-respondent_w3,-respondent_w4)


SHARE_hh <- SHARE_w5 %>% filter(n!=inpw) %>%
            arrange(hhid5,idinpw,yrbirth) %>% group_by(hhid5) %>% mutate(idp = row_number()) %>% 
              gather(kn,vn,c("id","yrbirth","partnerinhh","relrpers","yrbind","respondent","idinpw")) %>%
              unite(coln,kn,idp) %>%
              spread(coln,vn) %>%
              select(c("hhid5","n","inpw","ninpw","my","may",ends_with("_1"),ends_with("_2"),ends_with("_3"))) %>%
              mutate_at(vars(contains("yrbirth"),contains("partnerinhh"),contains("relrpers"),contains("yrbind"),contains("respondent"),contains("idinpw")),as.numeric)

SHARE_hh$hh <- substr(SHARE_hh$hhid5,1,9)
SHARE_w1$hh <- substr(SHARE_w1$hhid1,1,9)
SHARE_w2$hh <- substr(SHARE_w2$hhid2,1,9)
SHARE_w3$hh <- substr(SHARE_w3$hhid3,1,9)
SHARE_w4$hh <- substr(SHARE_w4$hhid4,1,9)

SHARE_w3 <- left_join(SHARE_w3[,-match("respondent",names(SHARE_w3))],SHARE_ds_w3,by="id")
SHARE_w4 <- left_join(SHARE_w4[,-match("respondent",names(SHARE_w4))],SHARE_ds_w4,by="id")



SHARE_hh20 <- full_join(SHARE_w1 %>% select(id,hhid1,yrbirth,mstat,relrpers,respondent,hh) %>% filter(hh %in% (SHARE_hh %>% filter(n==2 & ninpw==1 & respondent_2!=0))$hh), SHARE_w2 %>% select(id,hhid2,yrbirth,mstat,mstat2,respondent,hh) %>% filter(hh %in% (SHARE_hh %>% filter(n==2 & ninpw==1 & respondent_2!=0))$hh), by =c("id","hh"), suffix = c("_w1","_w2"))

SHARE_hh21 <- full_join(SHARE_w3 %>% select(id,hhid3,yrbirth,mstat,respondent,hh) %>% filter(hh %in% (SHARE_hh %>% filter(n==2 & ninpw==1 & respondent_2!=0))$hh), SHARE_w4 %>% select(id,hhid4,yrbirth,partnerinhh,relrpers,respondent,hh) %>% filter(hh %in% (SHARE_hh %>% filter(n==2 & ninpw==1 & respondent_2!=0))$hh), by =c("id","hh"), suffix = c("_w3","_w4"))
SHARE_hh2f <- full_join(SHARE_hh20,SHARE_hh21, by = c("id","hh"),suffix = c("_w1","_w4"))
SHARE_hh2f <- left_join(SHARE_hh %>% filter(n==2 & ninpw==1 & respondent_2!=0),SHARE_hh2f,by =c("hh"),suffix=c("_w5",""))


```



```{r local2 w5,echo=FALSE}

kable(frq(SHARE_hhaux$n), caption = 'Frequency of respondents by household')

kable(addmargins(table(SHARE_hhaux$n,SHARE_hhaux$inpw,dnn = c("n","inpw"))),caption = "Households classified by number of id's in them (rows)  and their number of id's in previous waves (columns). Therefore the difference ('ninpw' = how many are not in previous waves) is given by the lower diagonals.")

# n==1 & idinpw==0
kable(frq((SHARE_w5 %>% filter(n==1 & inpw==0))$yrbind),caption = 'Distribution of being born before/after 1962 for individuals in 1-respondent households')
kable(table((SHARE_w5 %>% filter(n==1 & idinpw==0 & (yrbind==0 | is.na(yrbind))))$relrpers,(SHARE_w5 %>% filter(n==1 & idinpw==0 & (yrbind==0 | is.na(yrbind))))$partnerinhh,useNA = "ifany"),caption = 'Crossing table of relrpers with partnerinhh for 1-respondent households not in previous waves born after 1962')


# n==2 & inpw==1

kable(table((SHARE_w5 %>% filter(n>1 & ninpw==1 & idinpw==0))$relrpers,(SHARE_w5 %>% filter(n>1 & ninpw==1 & idinpw==0))$partnerinhh,useNA = "ifany"),caption = 'Crossing table of relrpers with partnerinhh for individuals not in previous waves unique in n-respondent households for n>1')

kable(SHARE_hh %>% filter(n>1 & ninpw==1 & partnerinhh_1==1 & relrpers_1!=1) %>% select(-ends_with("_3"),-ninpw,-my,-may,-respondent_1,-yrbind_1,-yrbind_2,-hh),caption = 'Households of the individuals with paradoxical data')

kable(frq((SHARE_w5 %>% filter(n==2 & ninpw==1))$respondent), caption = 'Frequency of respondent variable in 2-respondent households with only one not in previous waves')

kable(SHARE_hh2f %>% select(-ninpw,-my,-may,-respondent_1,-starts_with("yrbind"),-ends_with("_3"),-hh,-relrpers_w1,-mstat2),caption = '2-respondent household for which the respondent from previous waves is spouse/partner or other, together with the ex-cohouseholds')

# n==3 & ninpw==1
kable(frq((SHARE_w5 %>% filter(n==3 & ninpw==1))$respondent), caption = 'Frequency of respondent variable in 3-respondent households with only one not in previous waves')


# n==2 & inpw==0
kable(frq((SHARE_hh %>% filter(n==2 & inpw==0))$yrbind_1),caption = 'Individuals in households without respondents in previous waves are organised so that the ones in first column were born before 1960')

kable(frq((SHARE_hh %>% filter(n==2 & inpw==0))$yrbirth_1<=(SHARE_hh %>% filter(n==2 & inpw==0))$yrbirth_2), caption = 'Individuals in households without respondents in previous waves are organised so that the ones in first column were born before those in second column.')


## HH with some missing yrbirth
kable(SHARE_w5 %>% group_by(hhid5) %>% filter(any(is.na(yrbirth))),caption = 'Individuals in households with some yrbirth data missing')

```



#### Harmonisation algorithm

To compute the harmonised variable from the study-specific variables it has to be obtained by means of the next algorithm:

* `id in previous waves into respondent`
* `1-respondent born before 1962 households not in previous waves into 0 participant`
* `1-respondent born after 1962 households not in previous waves`
  + `recode partnerinhh == 1 into 1 spouse/partner`
  + `recode partnerinhh ==3 into 2 other`
* `id not in previous waves in 2-respondent households with other id in previous waves (n==2 & ninpw == 1)`
  + `if old id respondent == 0 recode partnerinhh==1 for both respondents into 1, otherwise into 2`
  + `if old id respondent == 1, respondent into 2`
* `id not in previous waves in 3-respondent households with other id in previous waves (n==3 & ninpw == 1)`
  + `recode partnerinhh == 1 for it and another into 1 spouse/partner`
  + `otherwise into 2 other`
  

* `id in 2-respondent households with all id not in previous waves (n==2 & inpw==0)`
  + `one id born before and one after 1962 or missing`
    * `before 1962 into 0`
    * `after 1962 or missing yrbirth data recode partnerinhh == 1 into 1, partnerinhh == 3 into 2`
  + `otherwise:`
    * `younger id born before 1962 into 0`
    * `older ids born before 1962 into recode partnerinhh == 1 into 1, partnerinhh == 3 into 2`


**R script:**

```{r harmo w5}


SHARE_ds_w5 <- tibble(id=SHARE_w5$id)
SHARE_ds_w5$respondent <- NA
# id in previous waves into respondent
SHARE_ds_w5$respondent[which(SHARE_w5$idinpw==1)] <- SHARE_w5$respondent[which(SHARE_w5$idinpw==1)]


# 1-respondent born before 1962 or with missing yrbirth data households not in previous waves into 0 participant
SHARE_ds_w5$respondent[which(SHARE_w5$idinpw==0 & SHARE_w5$n==1 & (SHARE_w5$yrbind==1 | is.na(SHARE_w5$yrbind)))] <- 0
# 1-respondent born after 1962 households not in previous waves
SHARE_ds_w5$respondent[which(SHARE_w5$idinpw==0 & SHARE_w5$n==1 & SHARE_w5$yrbind==0)] <- car::recode(SHARE_w5$partnerinhh[which(SHARE_w5$idinpw==0 & SHARE_w5$n==1 & SHARE_w5$yrbind==0)],"1=1; 3=2")

# id not in previous waves in 2-respondent households with other id in previous waves (n==2 & ninpw == 1)
### if old id respondent == 0 recode partnerinhh==1 for both respondents into 1, otherwise into 2

#SHARE_hh %>% filter(n==2 & ninpw==1 & respondent_2==0)

SHARE_hh$respondent_1[which(SHARE_hh$n==2 & SHARE_hh$ninpw==1 & SHARE_hh$respondent_2==0 & SHARE_hh$partnerinhh_1==1 & SHARE_hh$partnerinhh_2==1)] <- 1
SHARE_hh$respondent_1[which(SHARE_hh$n==2 & SHARE_hh$ninpw==1 & SHARE_hh$respondent_2==0 & (SHARE_hh$partnerinhh_1==3 | SHARE_hh$partnerinhh_2==3))] <- 2

### if old id respondent != 0
SHARE_hh$respondent_1[which(SHARE_hh$n==2 & SHARE_hh$ninpw==1 & SHARE_hh$respondent_2!=0)] <- 2
SHARE_hh$respondent_1[which(SHARE_hh$id_1=="Ih-059753-02")] <- 0

SHARE_ds_w5 <- left_join(SHARE_ds_w5,SHARE_hh[which(SHARE_hh$n==2 & SHARE_hh$ninpw==1),c("id_1","respondent_1")], by = c("id"="id_1"))
SHARE_ds_w5$respondent[which(SHARE_ds_w5$id %in% SHARE_hh$id_1[which(SHARE_hh$n==2 & SHARE_hh$ninpw==1)])] <- SHARE_ds_w5$respondent_1[which(SHARE_ds_w5$id %in% SHARE_hh$id_1[which(SHARE_hh$n==2 & SHARE_hh$ninpw==1)])]

SHARE_ds_w5 <- SHARE_ds_w5[,c("id","respondent")]


# id not in previous waves in 3-respondent households with other id in previous waves (n==3 & ninpw == 1)
SHARE_ds_w5$respondent[which(SHARE_ds_w5$id %in% (SHARE_w5 %>% filter(idinpw==0 & (id %in% (SHARE_w5 %>% group_by(hhid5) %>% filter(n==3 & ninpw==1 & sum((partnerinhh==1 & idinpw==0) & (sum(partnerinhh==1 & idinpw==1)==1))))$id)))$id)] <- 1
SHARE_ds_w5$respondent[which(SHARE_ds_w5$id %in% (SHARE_w5 %>% filter(idinpw==0 & (id %in% (SHARE_w5 %>% group_by(hhid5) %>% filter(n==3 & ninpw==1 & !sum((partnerinhh==1 & idinpw==0) & (sum(partnerinhh==1 & idinpw==1)==1))))$id)))$id)] <- 2



# id in household with all id not in previous waves (inpw==0)
### n==2
##### one id born before and one after 1962 or missing
SHARE_ds_w5$respondent[which(SHARE_ds_w5$id %in% (SHARE_w5 %>% filter(inpw==0 & (may>1962 | is.na(may)) & n==2 & yrbind==1))$id)] <- 0
SHARE_ds_w5$respondent[which(SHARE_w5$inpw==0 & (SHARE_w5$yrbind==0 | is.na(SHARE_w5$yrbind)) & SHARE_w5$n==2)] <- car::recode(SHARE_w5$partnerinhh[which(SHARE_w5$inpw==0 & (SHARE_w5$yrbind==0 | is.na(SHARE_w5$yrbind)) & SHARE_w5$n==2)],"1=1; 3=2")

##### otherwise
####### younger id born before 1962 into 0
SHARE_ds_w5$respondent[which(SHARE_ds_w5$id %in% (SHARE_hh %>% filter(n==2 & inpw==0 & yrbind_1==1 & yrbind_2==1))$id_2)] <- 0

####### older ids born before 1962 into recode partnerinhh == 1 into 1, partnerinhh == 3 into 2
SHARE_hh$respondent_1[which(SHARE_hh$n==2 & SHARE_hh$inpw==0 & SHARE_hh$yrbind_1==1 & SHARE_hh$yrbind_2==1)] <- car::recode(SHARE_hh$partnerinhh_1[which(SHARE_hh$n==2 & SHARE_hh$yrbind_1==1 & SHARE_hh$yrbind_2==1)],"1=1; 3=2")
SHARE_ds_w5 <- left_join(SHARE_ds_w5,SHARE_hh[which(SHARE_hh$n==2 & SHARE_hh$inpw==0 & SHARE_hh$yrbind_1==1 & SHARE_hh$yrbind_2==1),c("id_1","respondent_1")],by = c("id"="id_1"))
SHARE_ds_w5$respondent[which(SHARE_ds_w5$id %in% SHARE_hh$id_1[which(SHARE_hh$n==2 & SHARE_hh$inpw==0 & SHARE_hh$yrbind_1==1 & SHARE_hh$yrbind_2==1)])] <- SHARE_ds_w5$respondent_1[which(SHARE_ds_w5$id %in% SHARE_hh$id_1[which(SHARE_hh$n==2 & SHARE_hh$inpw==0 & SHARE_hh$yrbind_1==1 & SHARE_hh$yrbind_2==1)])]
SHARE_ds_w5 <- SHARE_ds_w5[,c("id","respondent")]



```




#### Statistical description of the new harmonised variable
```{r descript w5, echo=FALSE}
vbl <- SHARE_ds_w5$respondent
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label) 
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Category")
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[2], caption = "Type of missing")
ggplot(SHARE_ds_w5, aes(x=factor(vbl))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```





#### Validation
```{r crosstabulation w5, echo=FALSE}


rm(SHARE_hhaux,SHARE_hh,SHARE_hh20,SHARE_hh21,SHARE_hh2f)
```



### Validation of `yrbirth` across waves

```{r, echo=FALSE}

yrbirth_missing <- unique(yrbirth_missing)
cat("Validation of id's with previous missing yrbirth: ",identical(yrbirth_missing,id_missings))
kable(SHARE_miss %>% mutate(TNA=rowSums(is.na(.))) %>% filter(TNA!=5) %>% select(-TNA),caption = "Id's with yrbirth data but previous missing values")

```


## Summary of descriptive statistics of the harmonised variable accross populations and waves

Two tables are generated: 

1. Percentages of categories in each harmonised variable.

2. Frequencies and percentages of individuals with different trajectories.


```{r helpfunctions, echo=F}


labelling <- function(l.hds,m.hds){
  
  # Labelling of the tibbles with categorical data and creating new tibbles with all missings recodified as NA

  for(name in names(l.hds)) {
    # In the aux_object we copy the old tibble to recodify all missing values as NA.
    aux_object <- l.hds[[name]]
    # Labelling of variables
    label(l.hds[[name]][[2]]) <- label(aux_object[[2]]) <- ds_label
    # Labelling of categories (for continues variables, only missing values)
    l.hds[[name]][[2]] <- labelled(l.hds[[name]][[2]], labels = cat_label)
    aux_object[[2]] <- car::recode(aux_object[[2]], "miss_values_vector=NA")
    # Labelling of categories (for categorical variables, only non-missing values)
    aux_object[[2]] <- labelled(aux_object[[2]], labels = cat_label[1:3])
  # Saving the recodified tibble in list m.hds
    m.hds[[name]] <- aux_object
    rm(aux_object)
  }
  return(list(l.hds,m.hds))

}

# Creation of summary tables for categorical data

summaries <- function(l.hds,m.hds,lnames){

  # Creation of columns with categories and labels
  t.hds <- frq(l.hds[[1]][2])[[1]][,c(1,2)] 
  # For each wave/population in l.hds, add the correponding values
  for (i in seq_along(l.hds)){
    t.hds[2+i] <- frq(l.hds[[i]][2])[[1]][,4] 
  }
  # Add sample size for each wave/population
  t.hds[14,] <- c("n", "sample size", sapply(l.hds,function(wave) length(wave[[1]]))
  )
  # Add wave/population names
  names(t.hds)<-c("val", "label",lnames)
  return(t.hds)
  
}

# Creation of trajectories table for each population

trajectories <- function(m.hds,vbl_name){
  
  # First wave data
  dbb <- m.hds[[1]][,c("id",vbl_name)]
  # Merge with next waves data
  for(ind in 2:length(m.hds)){
    dbb <- merge(dbb, m.hds[[ind]][,c("id",vbl_name)], by = "id", suffixes = c("", paste0(".",names(m.hds)[ind])), all = T)
  }
  names(dbb) <- c("id", names(m.hds))
  
  # Glue individual data through all waves into trajectories
  v.dbb <- dbb[,2]
  for(ind in 2:length(m.hds)){
    v.dbb <- paste(v.dbb,dbb[,ind+1],sep="")
  }
  # Trajectories and frequencies
  f.dbb <- frq(v.dbb)[[1]][,c(1,2,4)]
  return(f.dbb)
  
}

# Save data tables

savingRD <- function(l.hds,vbl_name){
  
  for(index in seq_along(l.hds)){
    assign(vbl_name,l.hds[[index]])
    save(vbl_name,list = vbl_name, file = paste0(datafolder,names(l.hds)[index],"/",vbl_name,".RData"))
  }

}

```




```{r summ, echo=F}

# All study waves and populations with abbreviated and descriptive names



share.cw <- list(w1 = c("w1","W1"), w2 = c("w2","W2"), w3 = c("w3","W3"), w4 = c("w4","W4"), w5 = c("w5","W5"))

# Consider only harmonised waves
l.hds <- lapply(share.cw, function(wname) if(exists(paste0("SHARE_ds_",wname[1]))){wname = list(get(paste0("SHARE_ds_",wname[1])),wname[2])})
nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}

m.hds <- list()

lmlist <- list(lapply(l.hds,function(x)x[[1]]),m.hds)

if(length(l.hds)>0){
  # Labelling tibbles
  lmlist <- labelling(lmlist[[1]],lmlist[[2]])
  # Printing table of categories
  print(knitr::kable(summaries(lmlist[[1]],lmlist[[2]],lapply(l.hds,function(x)x[[2]])),caption=ds_label))
  # Printing table of trajectories
  f.dbb <- trajectories(lmlist[[2]],vbl_name=hd_vbl)
  print(knitr::kable(f.dbb))
  # Saving tibbles
  savingRD(lmlist[[1]],vbl_name=hd_vbl)
}



```


# Quality estimation

We have not found any variable in original datasets identifying eligible people, spouses/partners or other types of respondents, so we harmonised this variable taking into account the following eligibility rules detailed in documentation.

> The target population of individuals for wave 1 is defined as "All individuals born in 1954 or earlier, speaking the official language of the country and not living abroad or in an institution such as a prison during the duration of the field work, and their spouses/partners independent of age. The remark above as to people living in institutions for elderly applies here as well.

> (The Survey of Health, Aging, and Retirement in Europe - Methodology)

> The SHARE target population consists of all persons aged 50 years and over at the time of sampling who have their regular domicile in the respective SHARE country. Persons are excluded if they are incarcerated, hospitalised or out of the country during the entire survey period, unable to speak the country's language(s) or have moved to an unknown address. In wave 1 all household members born 1954 or earlier are eligible for an interview. Starting in wave 2, for new countries or refreshment samples, there is only one selected respondent per household who has to be born 1956 or earlier in wave 2, 1960 or earlier in wave 4, 1962 or earlier in wave 5 and 1964 or earlier in wave 6. In addition - in all waves - current partners living in the same household are interviewed regardless of their age.

> SHARE Release Guide 6.1.1

For wave 3:

> The objective of SHARELIFE was to interview all SHARE respondents 50+ who participated in wave 1 or wave 2 as well as their current partners. In case a household splits, younger expartners of wave 1 or wave 2 respondents are not followed (this is ex-partners who were below the age of 50 at the time of data collection in wave 1 or wave 2).

> SHARELIFE Release Guide 6.1.1


<!-- ########################################################## -->
<!--- # Close OPAL R Session -->
```{r closeRsession, echo=FALSE}
opal.logout(o)
```





