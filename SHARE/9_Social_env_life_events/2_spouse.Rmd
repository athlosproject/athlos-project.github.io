---
title: "Has spouse/partner"
output:
  html_document:
    highlight: tango
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

<!-- ########################################################## --> 
<!-- # Installation, loading packages -->
```{r setup, include=FALSE}
source("../../setup_iago.r")
```
<!-- ########################################################## --> 
<!-- # Loading DS description -->
```{r main, child='../../_DS_Rmd/spouseDS.Rmd'}
```


```{r global, echo=F}
source('../../_DS_Rmd/spouseDS.R')
```


<!-- ########################################################## --> 

# Data process

## SHARE
### Wave 1 

#### Study-specific variable description

The study-specific variable elected to be harmonised is:

* Name: `dn014_`
* Label: `marital status`
* Categories: 
    + `1 = married and living together with spouse`
    + `2 = registered partnership`
    + `3 = married, living separated from spouse`
    + `4 = never married`
    + `5 = divorced`
    + `6 = widowed`
* Missings:
    + `-2 = refusal`
    + `-1 = don't know`


* Description: 
```{r assign1, echo=F}
opal.assign.table.tibble(o, 'SHARE_w1_spouse','SHARE.sharew1_rel2-6-0_dn', variables=list('dn014_'), missings = TRUE)
```

```{r local1, echo=F}
SHARE_w1_spouse <- opal.execute(o,'SHARE_w1_spouse')
vari <- SHARE_w1_spouse$dn014_
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w1_spouse$dn014_, missing_values = NA)
ggplot(SHARE_w1_spouse, aes(x=factor(dn014_))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("marital status") + ylab("Frequency")
```

#### Harmonisation algorithm
To compute the harmonize variable from the study-specific variable it has to be recoded as follows:

* `1,2 or 3 into 1`
* `4,5 or 6 into 0`
* `-2 into 997`
* `-1 into 998`
* `NA into 999`

**R script:**

```{r harmo1, echo=TRUE}
SHARE_ds_w1 <- tibble(id=SHARE_w1_spouse$id)
SHARE_ds_w1$spouse <- car::recode(as.vector(SHARE_w1_spouse$dn014_), "1:3='1'; 4:6='0'; -2='997'; -1='998'; NA='999'")
SHARE_ds_w1$spouse <- labelled(SHARE_ds_w1$spouse, labels = c("No"=0, "Yes"=1, "Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996, "Don't answer"=995,  "Not attempt/not done/not yet recorded"=994, "Disable to measure"=993, "Impute"=992, "CAPI/interviewer error"=991))
```

#### Statistical description of the new harmonised variable
```{r descript1, echo=F}
vari <- SHARE_ds_w1$spouse
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3])
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
#Categorical_summary(var = SHARE_ds_w1$spouse, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(SHARE_ds_w1, aes(x=factor(spouse))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Has spouse/partner") + ylab("Frequency")
```

#### Validation
```{r crosstabulation1, echo=F}
AfterH <- table(SHARE_ds_w1$spouse)
BeforeH <- table(SHARE_w1_spouse$dn014_, useNA='ifany')
BeforeH[[3]] <- sum(BeforeH[[3]],BeforeH[[4]],BeforeH[[5]])
BeforeH[[6]] <- sum(BeforeH[[6]],BeforeH[[7]],BeforeH[[8]])
BeforeH <- BeforeH[c(6,3,1,2,9)]
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("4:6->0","1:3->1","-2->997","-1->998","NA->999")

kable(C)
```

 
 



### Wave 2

#### Study-specific variable description

The study-specific variables elected to be harmonised are:

* Name: `dn044_`
* Label: `marital status changed`
* Categories: 
    + `1 = yes, marital status has changed`
    + `5 = no, marital status has not changed`
* Missings:
    + `-2 = refusal`
    + `-1 = don't know`
    

* Name: `dn014_`
* Label: `marital status`
* Categories: 
    + `1 = married and living together with spouse`
    + `2 = registered partnership`
    + `3 = married, living separated from spouse`
    + `4 = never married`
    + `5 = divorced`
    + `6 = widowed`
* Missings:
    + `-2 = refusal`
    + `-1 = don't know`


* Name: `dn040_`
* Label: `partner outside household`
* Categories: 
    + `1 = yes`
    + `5 = no`
* Missings:
    + `-2 = refusal`
    + `-1 = don't know`
    

* Name: `SHARE_ds_w1$spouse` - harmonized variable from Wave1


* Description: 
```{r assign2, echo=F}
opal.assign.table.tibble(o, 'SHARE_w2_spouse','SHARE.sharew2_rel2-6-0_dn',variables=list('dn044_','dn014_','dn040_'), missings = TRUE)
```

```{r local2, echo=F}
SHARE_w2_spouse <- opal.execute(o,'SHARE_w2_spouse')

vari <- SHARE_w2_spouse$dn044_
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w2_spouse$dn044_, missing_values = NA)
ggplot(SHARE_w2_spouse, aes(x=factor(dn044_))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("marital status changed") + ylab("Frequency")

vari <- SHARE_w2_spouse$dn014_
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w2_spouse$dn014_, missing_values = NA)
ggplot(SHARE_w2_spouse, aes(x=factor(dn014_))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("marital status") + ylab("Frequency")

vari <- SHARE_w2_spouse$dn040_
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w2_spouse$dn040_, missing_values = NA)
ggplot(SHARE_w2_spouse, aes(x=factor(dn040_))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("partner outside household") + ylab("Frequency")
```

#### Harmonisation algorithm
To compute the harmonize variable from the study-specific variable it has to be recoded as follows:

* `IF (dn014_ = 1,2 or 3) or (dn040_ = 1) THEN 1`
* `IF (dn014_ = 4,5 or 6) and (dn040_ = 5) THEN 0`
* `NA into 999`



**R script:**

```{r harmo2, echo=TRUE}

#ID - MERGE - FUNCTION:
#old: table with different number of individuals with the information that you need
#new: table with the individuals that you want

same_indiv <- function(old, new){
  
  new_2 <- matrix(NA, nrow = dim(new)[1], ncol=dim(old)[2])
  colnames(new_2) <- colnames(old)
  oldm <- as.matrix(old)
  
  for(i in 1:length(new$id)){
    if(sum(new$id[i]==old$id)>=1){
      new_2[i,] <- oldm[which(new$id[i]==old$id),]
    } else {
      new_2[i,] <- c(new$id[i], rep_len(NA,dim(old)[2]-1))
    }
  }
  new_2 <- data.frame(new_2)
  new_22 <- data.frame(id=new_2$id, dn044_=new$dn044_, dn014_=new$dn014_, dn040_=new$dn040_, spouse=new_2$spouse)
  new_22
}

# old = SHARE_ds_w1 (variable: spouse)
# new = SHARE_w2_spouse (variables: dn044_, dn014_, dn040_)


SHARE_w2_spouse_2 <- same_indiv(SHARE_ds_w1, SHARE_w2_spouse)

SHARE_ds_w2 <- tibble(id=SHARE_w2_spouse_2$id)

SHARE_w2_spouse_2$dn044_ <- car::recode(as.vector(SHARE_w2_spouse_2$dn044_), "NA='-999'")
SHARE_w2_spouse_2$dn014_ <- car::recode(as.vector(SHARE_w2_spouse_2$dn014_), "NA='-999'")
SHARE_w2_spouse_2$dn040_ <- car::recode(as.vector(SHARE_w2_spouse_2$dn040_), "NA='-999'")
SHARE_w2_spouse_2$spouse <- car::recode(as.vector(SHARE_w2_spouse_2$spouse), "NA='-999'")

SHARE_ds_w2$spouse <- c(NA) # I think it is required

for(i in 1:dim(SHARE_w2_spouse_2)[1]){
  
  if(SHARE_w2_spouse_2$dn044_[i] == 5){ 
    #marital status has not changed so we take it from Wave1:
    if(SHARE_w2_spouse_2$spouse[i] == 0){ SHARE_ds_w2$spouse[i] = 0 }
    else if(SHARE_w2_spouse_2$spouse[i] == 1){ SHARE_ds_w2$spouse[i] = 1 }
    }
    
  else if(SHARE_w2_spouse_2$dn044_[i] == 1 | !(SHARE_w2_spouse_2$dn044_[i] %in% c(1,5)) ){ 
    #marital status has changed OR he didn't answer this question which means that this questionnaire is BASELINE
  
    if(SHARE_w2_spouse_2$dn014_[i] %in% c(1,2,3) | SHARE_w2_spouse_2$dn040_[i] == 1) { 
     SHARE_ds_w2$spouse[i] = 1 }
    else if(SHARE_w2_spouse_2$dn014_[i] %in% c(4,5,6) & !(SHARE_w2_spouse_2$dn040_[i] %in% c(1,-1,-2)) ) { 
      SHARE_ds_w2$spouse[i] = 0 }
  } 
    # clear missings:
    else if(SHARE_w2_spouse_2$dn014_[i] == -2 & SHARE_w2_spouse_2$dn040_[i] == -2) { 
      SHARE_ds_w2$spouse[i] = 997 }
    else if(SHARE_w2_spouse_2$dn014_[i] == -1 & SHARE_w2_spouse_2$dn040_[i] == -1) { 
      SHARE_ds_w2$spouse[i] = 998 }
    else if(SHARE_w2_spouse_2$dn014_[i] == -2 & SHARE_w2_spouse_2$dn040_[i] == -1) { 
      SHARE_ds_w2$spouse[i] = 999 }
    else if(SHARE_w2_spouse_2$dn014_[i] == -1 & SHARE_w2_spouse_2$dn040_[i] == -2) { 
      SHARE_ds_w2$spouse[i] = 999 }
    
    #unclear missings:
    else if(SHARE_w2_spouse_2$dn014_[i] == -2 & !(SHARE_w2_spouse_2$dn040_[i] %in% c(1,-1,-2)) ) { 
      SHARE_ds_w2$spouse[i] = 997 }
    else if(SHARE_w2_spouse_2$dn014_[i] == -1 & !(SHARE_w2_spouse_2$dn040_[i] %in% c(1,-1,-2)) ) { 
      SHARE_ds_w2$spouse[i] = 998 }
    else if(SHARE_w2_spouse_2$dn014_[i] %in% c(4,5,6) & SHARE_w2_spouse_2$dn040_[i] == -2) { 
      SHARE_ds_w2$spouse[i] = 997 }
    else if(SHARE_w2_spouse_2$dn014_[i] %in% c(4,5,6) & SHARE_w2_spouse_2$dn040_[i] == -1) { 
      SHARE_ds_w2$spouse[i] = 998 }
}

SHARE_ds_w2$spouse <- car::recode(as.vector(SHARE_ds_w2$spouse), "NA='999'")
SHARE_ds_w2$spouse <- labelled(SHARE_ds_w2$spouse, labels = c("No"=0, "Yes"=1, "Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996, "Don't answer"=995,  "Not attempt/not done/not yet recorded"=994, "Disable to measure"=993, "Impute"=992, "CAPI/interviewer error"=991))
```

#### Statistical description of the new harmonised variable
```{r descript2, echo=F}
vari <- SHARE_ds_w2$spouse
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3])
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
#Categorical_summary(var = SHARE_ds_w2$spouse, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(SHARE_ds_w2, aes(x=factor(spouse))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Has spouse/partner") + ylab("Frequency")
```

#### Validation
```{r crosstabulation2, echo=F}

```

 
 



### Wave 3

#### Study-specific variable description

The study-specific variables elected to be harmonised are:

* Name: `sl_rp009_i` for i in [1,18]
* Label: `still living with partner`
* Categories: 
    + `1 = yes`
    + `5 = no`
* Missings:
    + `-2 = refusal`
    + `-1 = don't know`
    
* Name: `sl_rp019_i` for i in [1,5]
* Label: `still living with non-cohabitating partner`
* Categories: 
    + `1 = yes`
    + `5 = no`
* Missings:
    + `-2 = refusal`
    + `-1 = don't know`

* Description: 
```{r assign3, echo=F}
opal.assign.table.tibble(o, 'SHARE_w3_spouse','SHARE.sharew3_rel1_rp',
                         variables=list('sl_rp009_1','sl_rp009_2','sl_rp009_3','sl_rp009_4',
                                        'sl_rp009_5','sl_rp009_6','sl_rp009_11','sl_rp009_12',
                                        'sl_rp009_13','sl_rp009_14','sl_rp009_15',
                                        'sl_rp009_16','sl_rp009_17','sl_rp009_18',
                                        'sl_rp019_1','sl_rp019_2','sl_rp019_3','sl_rp019_4','sl_rp019_5'),
                                        missings = TRUE)
SHARE_w3_spouse <- opal.execute(o,'SHARE_w3_spouse')

```

```{r local3, echo=F}

vari <- SHARE_w3_spouse$sl_rp009_1
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w3_spouse$sl_rp009_2, missing_values = NA)
ggplot(SHARE_w3_spouse, aes(x=factor(sl_rp009_1))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("still living with partner?") + ylab("Frequency")

vari <- SHARE_w3_spouse$sl_rp009_2
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w3_spouse$sl_rp009_2, missing_values = NA)
ggplot(SHARE_w3_spouse, aes(x=factor(sl_rp009_2))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("still living with partner?") + ylab("Frequency")

vari <- SHARE_w3_spouse$sl_rp009_3
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w3_spouse$sl_rp009_2, missing_values = NA)
ggplot(SHARE_w3_spouse, aes(x=factor(sl_rp009_3))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("still living with partner?") + ylab("Frequency")

vari <- SHARE_w3_spouse$sl_rp009_4
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w3_spouse$sl_rp009_2, missing_values = NA)
ggplot(SHARE_w3_spouse, aes(x=factor(sl_rp009_4))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("still living with partner?") + ylab("Frequency")

vari <- SHARE_w3_spouse$sl_rp009_5
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w3_spouse$sl_rp009_2, missing_values = NA)
ggplot(SHARE_w3_spouse, aes(x=factor(sl_rp009_5))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("still living with partner?") + ylab("Frequency")

vari <- SHARE_w3_spouse$sl_rp009_6
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w3_spouse$sl_rp009_2, missing_values = NA)
ggplot(SHARE_w3_spouse, aes(x=factor(sl_rp009_6))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("still living with partner?") + ylab("Frequency")


vari <- SHARE_w3_spouse$sl_rp009_11
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w3_spouse$sl_rp009_2, missing_values = NA)
ggplot(SHARE_w3_spouse, aes(x=factor(sl_rp009_11))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("still living with partner?") + ylab("Frequency")

vari <- SHARE_w3_spouse$sl_rp009_12
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w3_spouse$sl_rp009_2, missing_values = NA)
ggplot(SHARE_w3_spouse, aes(x=factor(sl_rp009_12))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("still living with partner?") + ylab("Frequency")

vari <- SHARE_w3_spouse$sl_rp009_13
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w3_spouse$sl_rp009_2, missing_values = NA)
ggplot(SHARE_w3_spouse, aes(x=factor(sl_rp009_13))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("still living with partner?") + ylab("Frequency")

vari <- SHARE_w3_spouse$sl_rp009_14
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w3_spouse$sl_rp009_2, missing_values = NA)
ggplot(SHARE_w3_spouse, aes(x=factor(sl_rp009_14))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("still living with partner?") + ylab("Frequency")

vari <- SHARE_w3_spouse$sl_rp009_15
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w3_spouse$sl_rp009_2, missing_values = NA)
ggplot(SHARE_w3_spouse, aes(x=factor(sl_rp009_15))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("still living with partner?") + ylab("Frequency")

vari <- SHARE_w3_spouse$sl_rp009_16
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w3_spouse$sl_rp009_2, missing_values = NA)
ggplot(SHARE_w3_spouse, aes(x=factor(sl_rp009_16))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("still living with partner?") + ylab("Frequency")

vari <- SHARE_w3_spouse$sl_rp009_17
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w3_spouse$sl_rp009_2, missing_values = NA)
ggplot(SHARE_w3_spouse, aes(x=factor(sl_rp009_17))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("still living with partner?") + ylab("Frequency")

vari <- SHARE_w3_spouse$sl_rp009_18
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w3_spouse$sl_rp009_2, missing_values = NA)
ggplot(SHARE_w3_spouse, aes(x=factor(sl_rp009_18))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("still living with partner?") + ylab("Frequency")


vari <- SHARE_w3_spouse$sl_rp019_1
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w3_spouse$sl_rp019_5, missing_values = NA)
ggplot(SHARE_w3_spouse, aes(x=factor(sl_rp019_1))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("still living with non-cohabitating partner?") + ylab("Frequency")

vari <- SHARE_w3_spouse$sl_rp019_2
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w3_spouse$sl_rp019_5, missing_values = NA)
ggplot(SHARE_w3_spouse, aes(x=factor(sl_rp019_2))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("still living with non-cohabitating partner?") + ylab("Frequency")

vari <- SHARE_w3_spouse$sl_rp019_3
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w3_spouse$sl_rp019_5, missing_values = NA)
ggplot(SHARE_w3_spouse, aes(x=factor(sl_rp019_3))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("still living with non-cohabitating partner?") + ylab("Frequency")

vari <- SHARE_w3_spouse$sl_rp019_4
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w3_spouse$sl_rp019_5, missing_values = NA)
ggplot(SHARE_w3_spouse, aes(x=factor(sl_rp019_4))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("still living with non-cohabitating partner?") + ylab("Frequency")

vari <- SHARE_w3_spouse$sl_rp019_5
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w3_spouse$sl_rp019_5, missing_values = NA)
ggplot(SHARE_w3_spouse, aes(x=factor(sl_rp019_5))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("still living with non-cohabitating partner?") + ylab("Frequency")



```

#### Harmonisation algorithm
To recode the harmonize variable from the study-specific variable it has to be recoded as follows:  

* `if every variable is 5 or missing, then 0`
* `if any variable equals 1, then 1`
* `NA into 999`

**R script:**

```{r harmo3, echo=TRUE}
SHARE_ds_w3 <- tibble(id=SHARE_w3_spouse$id)

SHARE_w3_spouse$sl_rp009_1 <- car::recode(as.vector(SHARE_w3_spouse$sl_rp009_1), "NA='-999'")
SHARE_w3_spouse$sl_rp009_2 <- car::recode(as.vector(SHARE_w3_spouse$sl_rp009_2), "NA='-999'")
SHARE_w3_spouse$sl_rp009_3 <- car::recode(as.vector(SHARE_w3_spouse$sl_rp009_3), "NA='-999'")
SHARE_w3_spouse$sl_rp009_4 <- car::recode(as.vector(SHARE_w3_spouse$sl_rp009_4), "NA='-999'")
SHARE_w3_spouse$sl_rp009_5 <- car::recode(as.vector(SHARE_w3_spouse$sl_rp009_5), "NA='-999'")
SHARE_w3_spouse$sl_rp009_6 <- car::recode(as.vector(SHARE_w3_spouse$sl_rp009_6), "NA='-999'")
SHARE_w3_spouse$sl_rp009_11 <- car::recode(as.vector(SHARE_w3_spouse$sl_rp009_11), "NA='-999'")
SHARE_w3_spouse$sl_rp009_12 <- car::recode(as.vector(SHARE_w3_spouse$sl_rp009_12), "NA='-999'")
SHARE_w3_spouse$sl_rp009_13 <- car::recode(as.vector(SHARE_w3_spouse$sl_rp009_13), "NA='-999'")
SHARE_w3_spouse$sl_rp009_14 <- car::recode(as.vector(SHARE_w3_spouse$sl_rp009_14), "NA='-999'")
SHARE_w3_spouse$sl_rp009_15 <- car::recode(as.vector(SHARE_w3_spouse$sl_rp009_15), "NA='-999'")
SHARE_w3_spouse$sl_rp009_16 <- car::recode(as.vector(SHARE_w3_spouse$sl_rp009_16), "NA='-999'")
SHARE_w3_spouse$sl_rp009_17 <- car::recode(as.vector(SHARE_w3_spouse$sl_rp009_17), "NA='-999'")
SHARE_w3_spouse$sl_rp009_18 <- car::recode(as.vector(SHARE_w3_spouse$sl_rp009_18), "NA='-999'")
SHARE_w3_spouse$sl_rp019_1 <- car::recode(as.vector(SHARE_w3_spouse$sl_rp019_1), "NA='-999'")
SHARE_w3_spouse$sl_rp019_2 <- car::recode(as.vector(SHARE_w3_spouse$sl_rp019_2), "NA='-999'")
SHARE_w3_spouse$sl_rp019_3 <- car::recode(as.vector(SHARE_w3_spouse$sl_rp019_3), "NA='-999'")
SHARE_w3_spouse$sl_rp019_4 <- car::recode(as.vector(SHARE_w3_spouse$sl_rp019_4), "NA='-999'")
SHARE_w3_spouse$sl_rp019_5 <- car::recode(as.vector(SHARE_w3_spouse$sl_rp019_5), "NA='-999'")


SHARE_ds_w3$spouse <- c(NA) 

for(i in 1:dim(SHARE_w3_spouse)[1]){
  if(SHARE_w3_spouse$sl_rp009_1[i] == 1 | 
     SHARE_w3_spouse$sl_rp009_2[i] == 1 | 
     SHARE_w3_spouse$sl_rp009_3[i] == 1 |
     SHARE_w3_spouse$sl_rp009_4[i] == 1 | 
     SHARE_w3_spouse$sl_rp009_5[i] == 1 | 
     SHARE_w3_spouse$sl_rp009_6[i] == 1 |
     SHARE_w3_spouse$sl_rp009_11[i] == 1 |
     SHARE_w3_spouse$sl_rp009_12[i] == 1 | 
     SHARE_w3_spouse$sl_rp009_13[i] == 1 |
     SHARE_w3_spouse$sl_rp009_14[i] == 1 |
     SHARE_w3_spouse$sl_rp009_15[i] == 1 | 
     SHARE_w3_spouse$sl_rp009_16[i] == 1 | 
     SHARE_w3_spouse$sl_rp009_17[i] == 1 |
     SHARE_w3_spouse$sl_rp009_18[i] == 1 | 
     SHARE_w3_spouse$sl_rp019_1[i] == 1 |
     SHARE_w3_spouse$sl_rp019_2[i] == 1 | 
     SHARE_w3_spouse$sl_rp019_3[i] == 1 |
     SHARE_w3_spouse$sl_rp019_4[i] == 1 | 
     SHARE_w3_spouse$sl_rp019_5[i] == 1) { 
      SHARE_ds_w3$spouse[i] = 1 }
  else if(
     SHARE_w3_spouse$sl_rp009_1[i] %in% c(5,-999) & 
     SHARE_w3_spouse$sl_rp009_2[i] %in% c(5,-999) & 
     SHARE_w3_spouse$sl_rp009_3[i] %in% c(5,-999) &
     SHARE_w3_spouse$sl_rp009_4[i] %in% c(5,-999) & 
     SHARE_w3_spouse$sl_rp009_5[i] %in% c(5,-999) & 
     SHARE_w3_spouse$sl_rp009_6[i] %in% c(5,-999) &
     SHARE_w3_spouse$sl_rp009_11[i] %in% c(5,-999) &
     SHARE_w3_spouse$sl_rp009_12[i] %in% c(5,-999) & 
     SHARE_w3_spouse$sl_rp009_13[i] %in% c(5,-999) &
     SHARE_w3_spouse$sl_rp009_14[i] %in% c(5,-999) &
     SHARE_w3_spouse$sl_rp009_15[i] %in% c(5,-999) & 
     SHARE_w3_spouse$sl_rp009_16[i] %in% c(5,-999) & 
     SHARE_w3_spouse$sl_rp009_17[i] %in% c(5,-999) &
     SHARE_w3_spouse$sl_rp009_18[i] %in% c(5,-999) & 
     SHARE_w3_spouse$sl_rp019_1[i] %in% c(5,-999) &
     SHARE_w3_spouse$sl_rp019_2[i] %in% c(5,-999) & 
     SHARE_w3_spouse$sl_rp019_3[i] %in% c(5,-999) &
     SHARE_w3_spouse$sl_rp019_4[i] %in% c(5,-999) & 
     SHARE_w3_spouse$sl_rp019_5[i] %in% c(5,-999)) { 
      SHARE_ds_w3$spouse[i] = 0 }
  

}

SHARE_ds_w3$spouse <- car::recode(as.vector(SHARE_ds_w3$spouse), "NA='999'")
SHARE_ds_w3$spouse <- labelled(SHARE_ds_w3$spouse, labels = c("No"=0, "Yes"=1, "Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996, "Don't answer"=995,  "Not attempt/not done/not yet recorded"=994, "Disable to measure"=993, "Impute"=992, "CAPI/interviewer error"=991))
```

#### Statistical description of the new harmonised variable
```{r descript3, echo=F}
vari <- SHARE_ds_w3$spouse
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3])
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
#Categorical_summary(var = SHARE_ds_w3$spouse, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(SHARE_ds_w3, aes(x=factor(spouse))) + geom_bar(stat="count", width=0.4, fill="steelblue")+ xlab("Has spouse/partner") + ylab("Frequency")
```

##### Validation
```{r crosstabulation3, echo=F}

```

 
 




### Wave 4

#### Study-specific variable description

The study-specific variable elected to be harmonised is:

* Name: `dn044_`
* Label: `marital status changed`
* Categories: 
    + `1 = yes, marital status has changed`
    + `5 = no, marital status has not changed`
* Missings:
    + `-2 = refusal`
    + `-1 = don't know`

* Name: `dn014_`
* Label: `marital status`
* Categories: 
    + `1 = married and living together with spouse`
    + `2 = registered partnership`
    + `3 = married, living separated from spouse`
    + `4 = never married`
    + `5 = divorced`
    + `6 = widowed`
* Missings:
    + `-2 = refusal`
    + `-1 = don't know`

* Name: `dn040_`
* Label: `partner outside household`
* Categories: 
    + `1 = yes`
    + `5 = no`
* Missings:
    + `-9 = not applicable (e.g.filtered)`
    + `-5 = not asnwered`
    + `-2 = refusal`
    + `-1 = don't know`
    
* Name: `spouse` from the previous wave

* Description: 
```{r assign4, echo=F}
opal.assign.table.tibble(o, 'SHARE_w4_spouse','SHARE.sharew4_rel1-1-1_dn',variables=list('dn014_','dn044_','dn040_'), missings = TRUE)
```

```{r local4, echo=F}
SHARE_w4_spouse <- opal.execute(o,'SHARE_w4_spouse')

vari <- SHARE_w4_spouse$dn044_
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w4_spouse$dn044_, missing_values = NA)
ggplot(SHARE_w4_spouse, aes(x=factor(dn044_))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("marital status changed") + ylab("Frequency")

vari <- SHARE_w4_spouse$dn014_
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w4_spouse$dn014_, missing_values = NA)
ggplot(SHARE_w4_spouse, aes(x=factor(dn014_))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("marital status") + ylab("Frequency")


vari <- SHARE_w4_spouse$dn040_
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w4_spouse$dn040_, missing_values = NA)
ggplot(SHARE_w4_spouse, aes(x=factor(dn040_))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("partner outside household") + ylab("Frequency")
```

#### Harmonisation algorithm
To recode the harmonize variable from the study-specific variable it has to be recoded as follows:  


* `NA into 999`

**R script:**

```{r harmo4, echo=TRUE}

# ID - MERGE - FUNCTION:
# old: table with different number of individuals with the information that you need
# new: table with the individuals that you want

same_indiv <- function(old, new){
  
  new_2 <- matrix(NA, nrow = dim(new)[1], ncol=dim(old)[2])
  colnames(new_2) <- colnames(old)
  oldm <- as.matrix(old)
  
  for(i in 1:length(new$id)){
    if(sum(new$id[i]==old$id)>=1){
      new_2[i,] <- oldm[which(new$id[i]==old$id),]
    } else {
      new_2[i,] <- c(new$id[i], rep_len(NA,dim(old)[2]-1))
    }
  }
  new_2 <- data.frame(new_2)
  new_22 <- data.frame(id=new_2$id, dn044_=new$dn044_, dn014_=new$dn014_, dn040_=new$dn040_, spouse=new_2$spouse)
  new_22
}

# old = SHARE_ds_w3 (variable: spouse)
# new = SHARE_w4_spouse (variables: dn044_, dn014_, dn040_)


#SHARE_w4_spouse_2 <- same_indiv(SHARE_ds_w3, SHARE_w4_spouse)
SHARE_w4_spouse_2 <- same_indiv(SHARE_ds_w2, SHARE_w4_spouse)
SHARE_ds_w4 <- tibble(id=SHARE_w4_spouse_2$id)

SHARE_w4_spouse_2$dn044_ <- car::recode(as.vector(SHARE_w4_spouse_2$dn044_), "NA='-999'")
SHARE_w4_spouse_2$dn014_ <- car::recode(as.vector(SHARE_w4_spouse_2$dn014_), "NA='-999'")
SHARE_w4_spouse_2$dn040_ <- car::recode(as.vector(SHARE_w4_spouse_2$dn040_), "NA='-999'")
SHARE_w4_spouse_2$spouse <- car::recode(as.vector(SHARE_w4_spouse_2$spouse), "NA='-999'")


SHARE_ds_w4$spouse <- c(NA) # I think it is required

for(i in 1:dim(SHARE_w4_spouse_2)[1]){
  
  if(SHARE_w4_spouse_2$dn044_[i] == 5){ 
    #marital status has not changed so we take it from Wave1:
    if(SHARE_w4_spouse_2$spouse[i] == 0){ SHARE_ds_w4$spouse[i] = 0 }
    else if(SHARE_w4_spouse_2$spouse[i] == 1){ SHARE_ds_w4$spouse[i] = 1 }
    }
    
  else if(SHARE_w4_spouse_2$dn044_[i] == 1 | !(SHARE_w4_spouse_2$dn044_[i] %in% c(1,5)) ){ 
    #marital status has changed OR he didn't answer this question which means that this questionnaire is BASELINE
  
    if(SHARE_w4_spouse_2$dn014_[i] %in% c(1,2,3) | SHARE_w4_spouse_2$dn040_[i] == 1) { 
     SHARE_ds_w4$spouse[i] = 1 }
    else if(SHARE_w4_spouse_2$dn014_[i] %in% c(4,5,6) & !(SHARE_w4_spouse_2$dn040_[i] %in% c(1,-1,-2)) ) { 
      SHARE_ds_w4$spouse[i] = 0 }
  }
    # clear missings:
    else if(SHARE_w4_spouse_2$dn014_[i] == -2 & SHARE_w4_spouse_2$dn040_[i] == -2) { 
      SHARE_ds_w4$spouse[i] = 997 }
    else if(SHARE_w4_spouse_2$dn014_[i] == -1 & SHARE_w4_spouse_2$dn040_[i] == -1) { 
      SHARE_ds_w4$spouse[i] = 998 }
    else if(SHARE_w4_spouse_2$dn014_[i] == -2 & SHARE_w4_spouse_2$dn040_[i] == -1) { 
      SHARE_ds_w4$spouse[i] = 999 }
    else if(SHARE_w4_spouse_2$dn014_[i] == -1 & SHARE_w4_spouse_2$dn040_[i] == -2) { 
      SHARE_ds_w4$spouse[i] = 999 }
    
    #unclear missings:
    else if(SHARE_w4_spouse_2$dn014_[i] == -2 & !(SHARE_w4_spouse_2$dn040_[i] %in% c(1,-1,-2)) ) { 
      SHARE_ds_w4$spouse[i] = 997 }
    else if(SHARE_w4_spouse_2$dn014_[i] == -1 & !(SHARE_w4_spouse_2$dn040_[i] %in% c(1,-1,-2)) ) { 
      SHARE_ds_w4$spouse[i] = 998 }
    else if(SHARE_w4_spouse_2$dn014_[i] %in% c(4,5,6) & SHARE_w4_spouse_2$dn040_[i] == -2) { 
      SHARE_ds_w4$spouse[i] = 997 }
    else if(SHARE_w4_spouse_2$dn014_[i] %in% c(4,5,6) & SHARE_w4_spouse_2$dn040_[i] == -1) { 
      SHARE_ds_w4$spouse[i] = 998 }
}

SHARE_ds_w4$spouse <- car::recode(as.vector(SHARE_ds_w4$spouse), "NA='999'")
SHARE_ds_w4$spouse <- labelled(SHARE_ds_w4$spouse, labels = c("No"=0, "Yes"=1, "Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996, "Don't answer"=995,  "Not attempt/not done/not yet recorded"=994, "Disable to measure"=993, "Impute"=992, "CAPI/interviewer error"=991))
```

#### Statistical description of the new harmonised variable
```{r descript4, echo=F}
vari <- SHARE_ds_w4$spouse
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3])
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
#Categorical_summary(var = SHARE_ds_w4$spouse, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(SHARE_ds_w4, aes(x=factor(spouse))) + geom_bar(stat="count", width=0.4, fill="steelblue")+ xlab("Has spouse/partner") + ylab("Frequency")
```

##### Validation
```{r crosstabulation4, echo=F}

```

 
 



### Wave 5

#### Study-specific variable description

The study-specific variable elected to be harmonised is:

* Name: `dn044_`
* Label: `marital status changed`
* Categories: 
    + `1 = yes, marital status has changed`
    + `5 = no, marital status has not changed`
* Missings:
    + `-2 = refusal`
    + `-1 = don't know`

* Name: `dn014_`
* Label: `marital status`
* Categories: 
    + `1 = married and living together with spouse`
    + `2 = registered partnership`
    + `3 = married, living separated from spouse`
    + `4 = never married`
    + `5 = divorced`
    + `6 = widowed`
* Missings:
    + `-2 = refusal`
    + `-1 = don't know`

* Name: `dn040_`
* Label: `partner outside household`
* Categories: 
    + `1 = yes`
    + `5 = no`
* Missings:
    + `-9 = not applicable (e.g.filtered)`
    + `-5 = not asnwered`
    + `-2 = refusal`
    + `-1 = don't know`
    
* Name: `spouse` from the previous wave

* Description: 
```{r assign5, echo=F}
opal.assign.table.tibble(o, 'SHARE_w5_spouse','SHARE.sharew5_rel1-0-0_dn',variables=list('dn014_','dn040_','dn044_'), missings = TRUE)
```

```{r local5, echo=F}
SHARE_w5_spouse <- opal.execute(o,'SHARE_w5_spouse')

vari <- SHARE_w5_spouse$dn014_
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w5_spouse$dn014_, missing_values = NA)
ggplot(SHARE_w5_spouse, aes(x=factor(dn014_))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Marital status") + ylab("Frequency")

vari <- SHARE_w5_spouse$dn040_
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w5_spouse$dn040_, missing_values = NA)
ggplot(SHARE_w5_spouse, aes(x=factor(dn040_))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Partner outside household") + ylab("Frequency")

vari <- SHARE_w5_spouse$dn044_
kable(Categorical_summary(vari, missing_values = NA)[2], caption = attributes(vari)$`spss::shortName`)
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
#Categorical_summary(var = SHARE_w5_spouse$dn044_, missing_values = NA)
ggplot(SHARE_w5_spouse, aes(x=factor(dn044_))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Marital status changed?") + ylab("Frequency")
```

#### Harmonisation algorithm
To recode the harmonize variable from the study-specific variable it has to be recoded as follows:  


* `NA into 999`

**R script:**

```{r harmo5, echo=TRUE}

# ID - MERGE - FUNCTION:
#old: table with different number of individuals with the information that you need
#new: table with the individuals that you want

same_indiv <- function(old, new){
  
  new_2 <- matrix(NA, nrow = dim(new)[1], ncol=dim(old)[2])
  colnames(new_2) <- colnames(old)
  oldm <- as.matrix(old)
  
  for(i in 1:length(new$id)){
    if(sum(new$id[i]==old$id)>=1){
      new_2[i,] <- oldm[which(new$id[i]==old$id),]
    } else {
      new_2[i,] <- c(new$id[i], rep_len(NA,dim(old)[2]-1))
    }
  }
  new_2 <- data.frame(new_2)
  new_22 <- data.frame(id=new_2$id, dn044_=new$dn044_, dn014_=new$dn014_, dn040_=new$dn040_, spouse=new_2$spouse)
  new_22
}

# old = SHARE_ds_w4 (variable: spouse)
# new = SHARE_w5_spouse (variables: dn044_, dn014_, dn040_)


SHARE_w5_spouse_2 <- same_indiv(SHARE_ds_w4, SHARE_w5_spouse)

SHARE_ds_w5 <- tibble(id=SHARE_w5_spouse_2$id)

SHARE_w5_spouse_2$dn044_ <- car::recode(as.vector(SHARE_w5_spouse_2$dn044_), "NA='-999'")
SHARE_w5_spouse_2$dn014_ <- car::recode(as.vector(SHARE_w5_spouse_2$dn014_), "NA='-999'")
SHARE_w5_spouse_2$dn040_ <- car::recode(as.vector(SHARE_w5_spouse_2$dn040_), "NA='-999'")
SHARE_w5_spouse_2$spouse <- car::recode(as.vector(SHARE_w5_spouse_2$spouse), "NA='-999'")


SHARE_ds_w5$spouse <- c(NA) # I think it is required

for(i in 1:dim(SHARE_w5_spouse_2)[1]){
  
  if(SHARE_w5_spouse_2$dn044_[i] == 5){ 
    #marital status has not changed so we take it from Wave1:
    if(SHARE_w5_spouse_2$spouse[i] == 0){ SHARE_ds_w5$spouse[i] = 0 }
    else if(SHARE_w5_spouse_2$spouse[i] == 1){ SHARE_ds_w5$spouse[i] = 1 }
    }
    
  else if(SHARE_w5_spouse_2$dn044_[i] == 1 | !(SHARE_w5_spouse_2$dn044_[i] %in% c(1,5)) ){ 
    #marital status has changed OR he didn't answer this question which means that this questionnaire is BASELINE
  
    if(SHARE_w5_spouse_2$dn014_[i] %in% c(1,2,3) | SHARE_w5_spouse_2$dn040_[i] == 1) { 
     SHARE_ds_w5$spouse[i] = 1 }
    else if(SHARE_w5_spouse_2$dn014_[i] %in% c(4,5,6) & !(SHARE_w5_spouse_2$dn040_[i] %in% c(1,-1,-2)) ) { 
      SHARE_ds_w5$spouse[i] = 0 }
  }
    # clear missings:
    else if(SHARE_w5_spouse_2$dn014_[i] == -2 & SHARE_w5_spouse_2$dn040_[i] == -2) { 
      SHARE_ds_w5$spouse[i] = 997 }
    else if(SHARE_w5_spouse_2$dn014_[i] == -1 & SHARE_w5_spouse_2$dn040_[i] == -1) { 
      SHARE_ds_w5$spouse[i] = 998 }
    else if(SHARE_w5_spouse_2$dn014_[i] == -2 & SHARE_w5_spouse_2$dn040_[i] == -1) { 
      SHARE_ds_w5$spouse[i] = 999 }
    else if(SHARE_w5_spouse_2$dn014_[i] == -1 & SHARE_w5_spouse_2$dn040_[i] == -2) { 
      SHARE_ds_w5$spouse[i] = 999 }
    
    #unclear missings:
    else if(SHARE_w5_spouse_2$dn014_[i] == -2 & !(SHARE_w5_spouse_2$dn040_[i] %in% c(1,-1,-2)) ) { 
      SHARE_ds_w5$spouse[i] = 997 }
    else if(SHARE_w5_spouse_2$dn014_[i] == -1 & !(SHARE_w5_spouse_2$dn040_[i] %in% c(1,-1,-2)) ) { 
      SHARE_ds_w5$spouse[i] = 998 }
    else if(SHARE_w5_spouse_2$dn014_[i] %in% c(4,5,6) & SHARE_w5_spouse_2$dn040_[i] == -2) { 
      SHARE_ds_w5$spouse[i] = 997 }
    else if(SHARE_w5_spouse_2$dn014_[i] %in% c(4,5,6) & SHARE_w5_spouse_2$dn040_[i] == -1) { 
      SHARE_ds_w5$spouse[i] = 998 }
}

SHARE_ds_w5$spouse <- car::recode(as.vector(SHARE_ds_w5$spouse), "NA='999'")
SHARE_ds_w5$spouse <- labelled(SHARE_ds_w5$spouse, labels = c("No"=0, "Yes"=1, "Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996, "Don't answer"=995,  "Not attempt/not done/not yet recorded"=994, "Disable to measure"=993, "Impute"=992, "CAPI/interviewer error"=991))
```

#### Statistical description of the new harmonised variable
```{r descript5, echo=F}
vari <- SHARE_ds_w5$spouse
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3])
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
#Categorical_summary(var = SHARE_ds_w5$spouse, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(SHARE_ds_w5, aes(x=factor(spouse))) + geom_bar(stat="count", width=0.4, fill="steelblue")+ xlab("Has spouse/partner") + ylab("Frequency")
```

##### Validation
```{r crosstabulation5, echo=F}

```








```{r final, echo=F}

l.hds <- list(w1 = SHARE_ds_w1, w2 = SHARE_ds_w2, w3 = SHARE_ds_w3, w4 = SHARE_ds_w4, w5 = SHARE_ds_w5)

for(name in names(l.hds)) {
  aux_object <- l.hds[[name]]
  label(l.hds[[name]][[2]]) <- label(aux_object[[2]]) <- ds_label # Text value assigned at the DS description, at the top
  l.hds[[name]][[2]] <- labelled(l.hds[[name]][[2]], labels = cat_label)
  aux_object[[2]] <- car::recode(aux_object[[2]], "miss_values_vector=NA")
  aux_object[[2]] <- labelled(aux_object[[2]], labels = cat_label[1:2])
  m_name <- paste0("SHARE_m_ds_",name)
  assign(m_name, aux_object)
  rm(aux_object)
}

```

## Summary of descriptive statistics of the harmonised variable accross populations and waves

Two tables are generated: 

1. Percentages of categories in each harmonised variable.

2. Frequencies and percentages of individuals with different trajectories.


```{r summ}

t.hds <- frq(l.hds[[1]][2])[[1]][,c(1,2)] 
for (i in seq_along(l.hds)){
  t.hds[2+i] <- frq(l.hds[[i]][2])[[1]][,4] 
}
t.hds[13,] <- c("n", "sample size", sapply(l.hds,function(wave) length(wave[[1]]))
             )
names(t.hds)<-c("val", "label",names(l.hds))
kable(t.hds)

dbb <- get(paste0("SHARE_m_ds_",names(l.hds)[1]))[,c("id","spouse")]
for(ind in 2:length(l.hds)){
  dbb <- merge(dbb, get(paste0("SHARE_m_ds_",names(l.hds)[ind]))[,c("id","spouse")], by = "id", suffixes = c("", paste0(".",names(l.hds)[ind])), all = T)
}
names(dbb) <- c("id", names(l.hds))

v.dbb <- dbb[,2]
for(ind in 2:length(l.hds)){
  v.dbb <- paste(v.dbb,dbb[,ind+1],sep="")
}
f.dbb <- frq(v.dbb)[[1]][,c(1,2,4)]
kable(f.dbb)

```





 
```{r save, echo=FALSE}
spouse <- SHARE_ds_w1
save(spouse, file = "../RData/w1/spouse.RData")
rm(spouse)

spouse <- SHARE_ds_w2
save(spouse, file = "../RData/w2/spouse.RData")
rm(spouse)

spouse <- SHARE_ds_w3
save(spouse, file = "../RData/w3/spouse.RData")
rm(spouse)

spouse <- SHARE_ds_w4
save(spouse, file = "../RData/w4/spouse.RData")
rm(spouse)

spouse <- SHARE_ds_w5
save(spouse, file = "../RData/w5/spouse.RData")
rm(spouse)

```

# Quality estimation

In wave 3, each variable `sl_rp009_i` and `sl_rp019_i` seems to refer to a different name-partner, so we read missing values as for those non applicable partners (those who never have been partners).

```{r closeRsession, echo=FALSE} 
opal.logout(o)
```

