---
title: "Current depressive status"
output: 
  html_document:
    theme: united
    highlight: tango
    toc: true
    toc_depth: 6
    toc_float:
      collapsed: true
      smooth_scroll: true
    number_sections: true
---

<!-- ########################################################## --> 

<!-- # Installation, loading packages -->
<!-- **R script:** -->



```{r setup, include=FALSE, echo=FALSE}
source("M:/WPs/WP1/Maelstrom/data_process/athlos-project.github.io/setup_albert.r")
```

<!-- ########################################################## --> 

# Description of DataSchema variable

The description of harmonised variable is the following:

* Short name: `depression`
* Variable label: `Current depressive status of the participant`
* Variable description: `Current depressive status of the participant`
* Domain: `Psycological measures`
* Value type: `categorical`
* Category coding:

**Code** | **Category Label**
-------- | ------------------
0        | no depression
1        | depression

* Category missings: 

**Code** | **Category Label**
----| ------------------
991 | CAPI/interviewer error
992 | Impute
993 | Disable to measure
994 | Not attempt/not done
995 | Does not answer
996 | Not applicable
997 | Refuse
998 | Do not know
999 | Missing


```{r lab, echo=FALSE}
ds_label <- "Current depressive status"
ds_label_all <- "Current depressive status of the participant"
```


<!-- ########################################################## --> 

# Data process

## England 

### Wave 1 

#### Study-specific variable description
 

| **Name** | `psceda`| `pscedb` | `pscedc` | `pscedd` | `pscede` | `pscedf` | `pscedg` | `pscedh` |
|-|-|-|-|-|-|-|-|-|
| **Label** | `Much of the time during the past week, have you felt depressed?`| `Much of the time during the past week, have you felt that everything you did was an effort?` | `Much of the time during the past week, has your sleep been restless?` | `Much of the time during the past week, were you happy?` | `Much of the time during the past week, have you felt lonely?` | `Much of the time during the past week, have you enjoyed life?` | `Much of the time during the past week, have you felt sad?` | `Much of the time during the past week, could you not get going?` | 
| **Table name** | `wave_1_core_data_v3` | `wave_1_core_data_v3` | `wave_1_core_data_v3` | `wave_1_core_data_v3` | `wave_1_core_data_v3` | `wave_1_core_data_v3` | `wave_1_core_data_v3` | `wave_1_core_data_v3` | 
| **Categories** |`1 = yes`| `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` |
| | `2 = no` | `2 = no`| `2 = no` | `2 = no` | `2 = no` | `2 = no` | `2 = no` | `2 = no` |
| **Missing** |`-9 = Refusal`| `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | 
| | `-8 = Don't Know` | `-8 = Don't Know`| `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` |
| | `-1 = Not applicable` | `-1 = Not applicable`| `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` |
| **Description** | | | | | | | | |


```{r assign1, echo=FALSE}
opal.assign.table.tibble(o, 'ELSA_dep','ELSA.wave_1_core_data_v3',
                         variables=list('psceda', 'pscedb', 'pscedc', 'pscedd', 'pscede', 'pscedf', 'pscedg', 'pscedh'), missings = TRUE)
ELSA_dep <- opal.execute(o,'ELSA_dep')
```

```{r local1, echo=FALSE}
vari <- ELSA_dep$psceda
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedb
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedc
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedd
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscede
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedf
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedg
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedh
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Harmonisation algorithm
To compute the harmonized variable from the study-specific variable it has to be recoded as follows:

First of all: 

* The reversed items pscedd, pscedf: 
    + `recode 1 into 0`
    + `recode 2 into 1`
    
* The direct items psceda, pscedb, pscedc, pscede, pscedg, pscedh: 
    + `keep 1 into 1`
    + `recode 2 into 0`


Secondly in order to get the final score the items have to be summed. If one items is missing, scores on the completed items are summed; the total is divided by the number of items answered and multiplied by 8. If more than 1 items are missing the individual get a missing value in the final score. 

After get the final score, it has to be recoded as follows: 

* `0-3 into 0`
* `>4 into 1`
* `NA into`
    + `997 if the individual has more items = -9 than -8, -1 and NA`
    + `998 if the individual has more items = -8 than -9, -1 and NA`
    + `996 if the individual has more items = -1 than -9, -8 and NA`
    + `999 if the individual has more items = NA than -8, -9 and -1`

**R script:**

```{r harmo1, echo=TRUE}
#reversed items
ELSA_dep$pd <- car::recode(ELSA_dep$pscedd, "1=0; 2=1; -8=NA; -9=NA; -1=NA")
ELSA_dep$pf <- car::recode(ELSA_dep$pscedf, "1=0; 2=1; -8=NA; -9=NA; -1=NA")

#direct items  
ELSA_dep$pa <- car::recode(ELSA_dep$psceda, "2=0; -8=NA; -9=NA; -1=NA")
ELSA_dep$pb <- car::recode(ELSA_dep$pscedb, "2=0; -8=NA; -9=NA; -1=NA")
ELSA_dep$pc <- car::recode(ELSA_dep$pscedc, "2=0; -8=NA; -9=NA; -1=NA")
ELSA_dep$pe <- car::recode(ELSA_dep$pscede, "2=0; -8=NA; -9=NA; -1=NA")
ELSA_dep$pg <- car::recode(ELSA_dep$pscedg, "2=0; -8=NA; -9=NA; -1=NA")
ELSA_dep$ph <- car::recode(ELSA_dep$pscedh, "2=0; -8=NA; -9=NA; -1=NA")


ELSA_dep$nmiss <- apply(ELSA_dep[,10:17], MARGIN = 1, FUN = function(x) sum(is.na(x)))


ELSA_dep$final_score <- apply(ELSA_dep[,10:17], MARGIN = 1, FUN = function(x) sum(x, na.rm = TRUE))


ELSA_dep$final_score[which(ELSA_dep$nmiss==1)] <- (ELSA_dep$final_score[which(ELSA_dep$nmiss==1)]/7)*8

ELSA_dep$n8 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x==(-8), na.rm = TRUE))
ELSA_dep$n9 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x==(-9), na.rm = TRUE))
ELSA_dep$n1 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x==(-1), na.rm = TRUE))
ELSA_dep$nNA <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(is.na(x)))

ELSA_dep$max_891_NA <- apply(ELSA_dep[,20:22], MARGIN = 1, FUN = function(x) which.max(x))
ELSA_dep$max_891_NA <- car::recode(ELSA_dep$max_891_NA, "1=998;2=997;3=996;4=999")

ELSA_dep$final_score[which(ELSA_dep$nmiss>1)] <- ELSA_dep$max_891_NA[which(ELSA_dep$nmiss>1)]

ELSA_ds_w1 <- tibble(id=ELSA_dep$id)
ELSA_ds_w1$depression <- car::recode(ELSA_dep$final_score, "0:3.99999999=0; 4:900=1")
ELSA_ds_w1$depression <- labelled(ELSA_ds_w1[[2]], labels = c("no depression"=0, "depression"=1,  "Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996, "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistical description of the new harmonised variable
```{r descript1, echo=FALSE}
vari <- ELSA_ds_w1$depression
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
ggplot(ELSA_ds_w1, aes(x=factor(ELSA_ds_w1[[2]]))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Validation
```{r crosstabulation1, echo=FALSE}
BeforeH <- c(sum(na.omit(ELSA_dep$final_score)<4), sum(na.omit(ELSA_dep$final_score)>=4 & na.omit(ELSA_dep$final_score)<900), sum(na.omit(ELSA_dep$final_score)==996), sum(na.omit(ELSA_dep$final_score)==997), sum(na.omit(ELSA_dep$final_score)==998))
AfterH <- table(ELSA_ds_w1[[2]], useNA = "ifany")
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("<4->0",">=4->1", "-1->996", "-9->997", "-8->998") 
kable(C)
```

```{r importOPAL1, echo=FALSE}
label(ELSA_ds_w1$depression) <- ds_label_all
depression <- ELSA_ds_w1
save(depression, file = "../RData/w1/depression.RData")
rm(depression)
```




### Wave 2

#### Study-specific variable description

| **Name** | `PScedA`| `PScedB` | `PScedC` | `PScedD` | `PScedE` | `PScedF` | `PScedG` | `PScedH` |
|-|-|-|-|-|-|-|-|-|
| **Label** | `Whether respondent has felt depressed much of the time during the past week`| `Whether respondent felt everything they did during the past week was an effort` | `Whether respondent felt their sleep was restless during the past week` | `Whether respondent was happy much of the time during the past week` | `Whether respondent felt lonely much of the time during the past week` | `Whether respondent enjoyed life much of the time during the past week` | `Whether respondent felt sad much of the time during the past week` | `Whether respondent could not get going much of the time during the past week` | 
| **Table name** | `wave_2_core_data_v4` | `wave_2_core_data_v4` | `wave_2_core_data_v4` | `wave_2_core_data_v4` | `wave_2_core_data_v4` | `wave_2_core_data_v4` | `wave_2_core_data_v4` | `wave_2_core_data_v4` | 
| **Categories** |`1 = yes`| `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` |
| | `2 = no` | `2 = no`| `2 = no` | `2 = no` | `2 = no` | `2 = no` | `2 = no` | `2 = no` |
| **Missing** |`-9 = Refusal`| `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | 
| | `-8 = Don't Know` | `-8 = Don't Know`| `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` |
| | `-1 = Not applicable` | `-1 = Not applicable`| `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` |
| **Description** | | | | | | | | |

```{r assign2, echo=FALSE}
opal.assign.table.tibble(o, 'ELSA_dep','ELSA.wave_2_core_data_v4',
                         variables=list('PScedA', 'PScedB', 'PScedC', 'PScedD', 'PScedE', 'PScedF', 'PScedG', 'PScedH'), missings = TRUE)
ELSA_dep <- opal.execute(o,'ELSA_dep')
```

```{r local2, echo=FALSE}
vari <- ELSA_dep$PScedA
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedB
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedC
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedD
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedE
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedF
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedG
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedH
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Harmonisation algorithm
To compute the harmonized variable from the study-specific variable it has to be recoded as follows:

First of all: 

* The reversed items pscedd, pscedf: 
    + `recode 1 into 0`
    + `recode 2 into 1`
    
* The direct items psceda, pscedb, pscedc, pscede, pscedg, pscedh: 
    + `keep 1 into 1`
    + `recode 2 into 0`


Secondly in order to get the final score the items have to be summed. If one items is missing, scores on the completed items are summed; the total is divided by the number of items answered and multiplied by 8. If more than 1 items are missing the individual get a missing value in the final score. 

After get the final score, it has to be recoded as follows: 

* `0-3 into 0`
* `>4 into 1`
* `NA into`
    + `997 if the individual has more items = -9 than -8, -1 and NA`
    + `998 if the individual has more items = -8 than -9, -1 and NA`
    + `996 if the individual has more items = -1 than -9, -8 and NA`
    + `999 if the individual has more items = NA than -8, -9 and -1`

**R script:**

```{r harmo2, echo=TRUE}
#reversed items
ELSA_dep$pd <- car::recode(ELSA_dep$PScedD, "1=0; 2=1; -8=NA; -9=NA; -1=NA")
ELSA_dep$pf <- car::recode(ELSA_dep$PScedF, "1=0; 2=1; -8=NA; -9=NA; -1=NA")

#direct items  
ELSA_dep$pa <- car::recode(ELSA_dep$PScedA, "2=0; -8=NA; -9=NA; -1=NA")
ELSA_dep$pb <- car::recode(ELSA_dep$PScedB, "2=0; -8=NA; -9=NA; -1=NA")
ELSA_dep$pc <- car::recode(ELSA_dep$PScedC, "2=0; -8=NA; -9=NA; -1=NA")
ELSA_dep$pe <- car::recode(ELSA_dep$PScedE, "2=0; -8=NA; -9=NA; -1=NA")
ELSA_dep$pg <- car::recode(ELSA_dep$PScedG, "2=0; -8=NA; -9=NA; -1=NA")
ELSA_dep$ph <- car::recode(ELSA_dep$PScedH, "2=0; -8=NA; -9=NA; -1=NA")


ELSA_dep$nmiss <- apply(ELSA_dep[,10:17], MARGIN = 1, FUN = function(x) sum(is.na(x)))


ELSA_dep$final_score <- apply(ELSA_dep[,10:17], MARGIN = 1, FUN = function(x) sum(x, na.rm = TRUE))


ELSA_dep$final_score[which(ELSA_dep$nmiss==1)] <- (ELSA_dep$final_score[which(ELSA_dep$nmiss==1)]/7)*8

ELSA_dep$n8 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x==(-8), na.rm = TRUE))
ELSA_dep$n9 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x==(-9), na.rm = TRUE))
ELSA_dep$n1 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x==(-1), na.rm = TRUE))
ELSA_dep$nNA <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(is.na(x)))

ELSA_dep$max_891_NA <- apply(ELSA_dep[,20:22], MARGIN = 1, FUN = function(x) which.max(x))
ELSA_dep$max_891_NA <- car::recode(ELSA_dep$max_891_NA, "1=998;2=997;3=996;4=999")

ELSA_dep$final_score[which(ELSA_dep$nmiss>1)] <- ELSA_dep$max_891_NA[which(ELSA_dep$nmiss>1)]

ELSA_ds_w2 <- tibble(id=ELSA_dep$id)
ELSA_ds_w2$depression <- car::recode(ELSA_dep$final_score, "0:3.99999999=0; 4:900=1")
ELSA_ds_w2$depression <- labelled(ELSA_ds_w2[[2]], labels = c("no depression"=0, "depression"=1,  "Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996, "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistical description of the new harmonised variable
```{r descript2, echo=FALSE}
vari <- ELSA_ds_w2$depression
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
ggplot(ELSA_ds_w2, aes(x=factor(ELSA_ds_w2[[2]]))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Validation
```{r crosstabulation2, echo=FALSE}
BeforeH <- c(sum(na.omit(ELSA_dep$final_score)<4), sum(na.omit(ELSA_dep$final_score)>=4 & na.omit(ELSA_dep$final_score)<900), sum(na.omit(ELSA_dep$final_score)==996), sum(na.omit(ELSA_dep$final_score)==997), sum(na.omit(ELSA_dep$final_score)==998))
AfterH <- table(ELSA_ds_w2[[2]], useNA = "ifany")
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("<4->0",">=4->1", "-1->996", "-9->997", "-8->998") 
kable(C)
```


```{r importOPAL2, echo=FALSE}
label(ELSA_ds_w2$depression) <- ds_label_all
depression <- ELSA_ds_w2
save(depression, file = "../RData/w2/depression.RData")
rm(depression)
```



### Wave 3

#### Study-specific variable description

| **Name** | `psceda`| `pscedb` | `pscedc` | `pscedd` | `pscede` | `pscedf` | `pscedg` | `pscedh` |
|-|-|-|-|-|-|-|-|-|
| **Label** | `Whether respondent has felt depressed much of the time during the past week`| `Whether respondent felt everything they did during the past week was an effort` | `Whether respondent felt their sleep was restless during the past week` | `Whether respondent was happy much of the time during the past week` | `Whether respondent felt lonely much of the time during the past week` | `Whether respondent enjoyed life much of the time during the past week` | `Whether respondent felt sad much of the time during the past week` | `Whether respondent could not get going much of the time during the past week` | 
| **Table name** | `wave_3_elsa_data_v4` | `wave_3_elsa_data_v4` | `wave_3_elsa_data_v4` | `wave_3_elsa_data_v4` | `wave_3_elsa_data_v4` | `wave_3_elsa_data_v4` | `wave_3_elsa_data_v4` | `wave_3_elsa_data_v4` | 
| **Categories** |`1 = yes`| `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` |
| | `2 = no` | `2 = no`| `2 = no` | `2 = no` | `2 = no` | `2 = no` | `2 = no` | `2 = no` |
| **Missing** |`-9 = Refusal`| `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | 
| | `-8 = Don't Know` | `-8 = Don't Know`| `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` |
| | `-1 = Not applicable` | `-1 = Not applicable`| `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` |
| | `-2 = Schedule not applicable` | `-2 = Schedule not applicable`| `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` |
| **Description** | | | | | | | | |

```{r assign3, echo=FALSE}
opal.assign.table.tibble(o, 'ELSA_dep','ELSA.wave_3_elsa_data_v4',
                         variables=list('psceda', 'pscedb', 'pscedc', 'pscedd', 'pscede', 'pscedf', 'pscedg', 'pscedh'), missings = TRUE)
ELSA_dep <- opal.execute(o,'ELSA_dep')
```

```{r local3, echo=FALSE}
vari <- ELSA_dep$psceda
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedb
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedc
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedd
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscede
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedf
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedg
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedh
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Harmonisation algorithm
To compute the harmonized variable from the study-specific variable it has to be recoded as follows:

First of all: 

* The reversed items pscedd, pscedf: 
    + `recode 1 into 0`
    + `recode 2 into 1`
    
* The direct items psceda, pscedb, pscedc, pscede, pscedg, pscedh: 
    + `keep 1 into 1`
    + `recode 2 into 0`


Secondly in order to get the final score the items have to be summed. If one items is missing, scores on the completed items are summed; the total is divided by the number of items answered and multiplied by 8. If more than 1 items are missing the individual get a missing value in the final score. 

After get the final score, it has to be recoded as follows: 

* `0-3 into 0`
* `>4 into 1`
* `NA into`
    + `997 if the individual has more items = -9 than -8, -1, -2 and NA`
    + `998 if the individual has more items = -8 than -9, -1, -2 and NA`
    + `996 if the individual has more items = -1 and -2 than -9, -8 and NA`
    + `999 if the individual has more items = NA than -8, -9, -2 and -1`

**R script:**

```{r harmo3, echo=TRUE}
#reversed items
ELSA_dep$pd <- car::recode(ELSA_dep$pscedd, "1=0; 2=1; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pf <- car::recode(ELSA_dep$pscedf, "1=0; 2=1; -8=NA; -9=NA; -1=NA; -2=NA")

#direct items  
ELSA_dep$pa <- car::recode(ELSA_dep$psceda, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pb <- car::recode(ELSA_dep$pscedb, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pc <- car::recode(ELSA_dep$pscedc, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pe <- car::recode(ELSA_dep$pscede, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pg <- car::recode(ELSA_dep$pscedg, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$ph <- car::recode(ELSA_dep$pscedh, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")


ELSA_dep$nmiss <- apply(ELSA_dep[,10:17], MARGIN = 1, FUN = function(x) sum(is.na(x)))


ELSA_dep$final_score <- apply(ELSA_dep[,10:17], MARGIN = 1, FUN = function(x) sum(x, na.rm = TRUE))


ELSA_dep$final_score[which(ELSA_dep$nmiss==1)] <- (ELSA_dep$final_score[which(ELSA_dep$nmiss==1)]/7)*8

ELSA_dep$n8 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x==(-8), na.rm = TRUE))
ELSA_dep$n9 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x==(-9), na.rm = TRUE))
ELSA_dep$n12 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x%in%c(-1, -2), na.rm = TRUE))
ELSA_dep$nNA <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(is.na(x)))

ELSA_dep$max_891_NA <- apply(ELSA_dep[,20:22], MARGIN = 1, FUN = function(x) which.max(x))
ELSA_dep$max_891_NA <- car::recode(ELSA_dep$max_891_NA, "1=998;2=997;3=996;4=999")

ELSA_dep$final_score[which(ELSA_dep$nmiss>1)] <- ELSA_dep$max_891_NA[which(ELSA_dep$nmiss>1)]

ELSA_ds_w3 <- tibble(id=ELSA_dep$id)
ELSA_ds_w3$depression <- car::recode(ELSA_dep$final_score, "0:3.99999999=0; 4:900=1")
ELSA_ds_w3$depression <- labelled(ELSA_ds_w3[[2]], labels = c("no depression"=0, "depression"=1,  "Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996, "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistical description of the new harmonised variable
```{r descript3, echo=FALSE}
vari <- ELSA_ds_w3$depression
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
ggplot(ELSA_ds_w3, aes(x=factor(ELSA_ds_w3[[2]]))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

##### Validation
```{r crosstabulation3, echo=FALSE}
BeforeH <- c(sum(na.omit(ELSA_dep$final_score)<4), sum(na.omit(ELSA_dep$final_score)>=4 & na.omit(ELSA_dep$final_score)<900), sum(na.omit(ELSA_dep$final_score)==996), sum(na.omit(ELSA_dep$final_score)==997), sum(na.omit(ELSA_dep$final_score)==998))
AfterH <- table(ELSA_ds_w3[[2]], useNA = "ifany")
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("<4->0",">=4->1", "(-1,-2)->996", "-9->997", "-8->998") 
kable(C)
```

```{r importOPAL3, echo=FALSE}
label(ELSA_ds_w3$depression) <- ds_label_all
depression <- ELSA_ds_w3
save(depression, file = "../RData/w3/depression.RData")
rm(depression)
```


### Wave 4

#### Study-specific variable description

| **Name** | `psceda`| `pscedb` | `pscedc` | `pscedd` | `pscede` | `pscedf` | `pscedg` | `pscedh` |
|-|-|-|-|-|-|-|-|-|
| **Label** | `Whether respondent has felt depressed much of the time during the past week`| `Whether respondent felt everything they did during the past week was an effort` | `Whether respondent felt their sleep was restless during the past week` | `Whether respondent was happy much of the time during the past week` | `Whether respondent felt lonely much of the time during the past week` | `Whether respondent enjoyed life much of the time during the past week` | `Whether respondent felt sad much of the time during the past week` | `Whether respondent could not get going much of the time during the past week` | 
| **Table name** | `wave_4_elsa_data_v3` | `wave_4_elsa_data_v3` | `wave_4_elsa_data_v3` | `wave_4_elsa_data_v3` | `wave_4_elsa_data_v3` | `wave_4_elsa_data_v3` | `wave_4_elsa_data_v3` | `wave_4_elsa_data_v3` | 
| **Categories** |`1 = yes`| `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` |
| | `2 = no` | `2 = no`| `2 = no` | `2 = no` | `2 = no` | `2 = no` | `2 = no` | `2 = no` |
| **Missing** |`-9 = Refusal`| `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | 
| | `-8 = Don't Know` | `-8 = Don't Know`| `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` |
| | `-1 = Not applicable` | `-1 = Not applicable`| `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` |
| | `-2 = Schedule not applicable` | `-2 = Schedule not applicable`| `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` |
| **Description** | | | | | | | | |

```{r assign4, echo=FALSE}
opal.assign.table.tibble(o, 'ELSA_dep','ELSA.wave_4_elsa_data_v3',
                         variables=list('psceda', 'pscedb', 'pscedc', 'pscedd', 'pscede', 'pscedf', 'pscedg', 'pscedh'), missings = TRUE)
ELSA_dep <- opal.execute(o,'ELSA_dep')
```

```{r local4, echo=FALSE}
vari <- ELSA_dep$psceda
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedb
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedc
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedd
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscede
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedf
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedg
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedh
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Harmonisation algorithm
To compute the harmonized variable from the study-specific variable it has to be recoded as follows:

First of all: 

* The reversed items pscedd, pscedf: 
    + `recode 1 into 0`
    + `recode 2 into 1`
    
* The direct items psceda, pscedb, pscedc, pscede, pscedg, pscedh: 
    + `keep 1 into 1`
    + `recode 2 into 0`


Secondly in order to get the final score the items have to be summed. If one items is missing, scores on the completed items are summed; the total is divided by the number of items answered and multiplied by 8. If more than 1 items are missing the individual get a missing value in the final score. 

After get the final score, it has to be recoded as follows: 

* `0-3 into 0`
* `>4 into 1`
* `NA into`
    + `997 if the individual has more items = -9 than -8, -1, -2 and NA`
    + `998 if the individual has more items = -8 than -9, -1, -2 and NA`
    + `996 if the individual has more items = -1 and -2 than -9, -8 and NA`
    + `999 if the individual has more items = NA than -8, -9, -2 and -1`

**R script:**

```{r harmo4, echo=TRUE}
#reversed items
ELSA_dep$pd <- car::recode(ELSA_dep$pscedd, "1=0; 2=1; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pf <- car::recode(ELSA_dep$pscedf, "1=0; 2=1; -8=NA; -9=NA; -1=NA; -2=NA")

#direct items  
ELSA_dep$pa <- car::recode(ELSA_dep$psceda, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pb <- car::recode(ELSA_dep$pscedb, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pc <- car::recode(ELSA_dep$pscedc, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pe <- car::recode(ELSA_dep$pscede, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pg <- car::recode(ELSA_dep$pscedg, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$ph <- car::recode(ELSA_dep$pscedh, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")


ELSA_dep$nmiss <- apply(ELSA_dep[,10:17], MARGIN = 1, FUN = function(x) sum(is.na(x)))


ELSA_dep$final_score <- apply(ELSA_dep[,10:17], MARGIN = 1, FUN = function(x) sum(x, na.rm = TRUE))


ELSA_dep$final_score[which(ELSA_dep$nmiss==1)] <- (ELSA_dep$final_score[which(ELSA_dep$nmiss==1)]/7)*8

ELSA_dep$n8 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x==(-8), na.rm = TRUE))
ELSA_dep$n9 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x==(-9), na.rm = TRUE))
ELSA_dep$n12 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x%in%c(-1, -2), na.rm = TRUE))
ELSA_dep$nNA <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(is.na(x)))

ELSA_dep$max_891_NA <- apply(ELSA_dep[,20:22], MARGIN = 1, FUN = function(x) which.max(x))
ELSA_dep$max_891_NA <- car::recode(ELSA_dep$max_891_NA, "1=998;2=997;3=996;4=999")

ELSA_dep$final_score[which(ELSA_dep$nmiss>1)] <- ELSA_dep$max_891_NA[which(ELSA_dep$nmiss>1)]

ELSA_ds_w4 <- tibble(id=ELSA_dep$id)
ELSA_ds_w4$depression <- car::recode(ELSA_dep$final_score, "0:3.99999999=0; 4:900=1")
ELSA_ds_w4$depression <- labelled(ELSA_ds_w4[[2]], labels = c("no depression"=0, "depression"=1,  "Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996, "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistical description of the new harmonised variable
```{r descript4, echo=FALSE}
vari <- ELSA_ds_w4$depression
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
ggplot(ELSA_ds_w4, aes(x=factor(ELSA_ds_w4[[2]]))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Validation
```{r crosstabulation4, echo=FALSE}
BeforeH <- c(sum(na.omit(ELSA_dep$final_score)<4), sum(na.omit(ELSA_dep$final_score)>=4 & na.omit(ELSA_dep$final_score)<900), sum(na.omit(ELSA_dep$final_score)==996), sum(na.omit(ELSA_dep$final_score)==997), sum(na.omit(ELSA_dep$final_score)==998))
AfterH <- table(ELSA_ds_w4[[2]], useNA = "ifany")
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("<4->0",">=4->1", "(-1,-2)->996", "-9->997", "-8->998") 
kable(C)
```

```{r importOPAL4, echo=FALSE}
label(ELSA_ds_w4$depression) <- ds_label_all
depression <- ELSA_ds_w4
save(depression, file = "../RData/w4/depression.RData")
rm(depression)
```



### Wave 5

#### Study-specific variable description

| **Name** | `psceda`| `pscedb` | `pscedc` | `pscedd` | `pscede` | `pscedf` | `pscedg` | `pscedh` |
|-|-|-|-|-|-|-|-|-|
| **Label** | `Whether respondent has felt depressed much of the time during the past week`| `Whether respondent felt everything they did during the past week was an effort` | `Whether respondent felt their sleep was restless during the past week` | `Whether respondent was happy much of the time during the past week` | `Whether respondent felt lonely much of the time during the past week` | `Whether respondent enjoyed life much of the time during the past week` | `Whether respondent felt sad much of the time during the past week` | `Whether respondent could not get going much of the time during the past week` | 
| **Table name** | `wave_5_elsa_data_v4` | `wave_5_elsa_data_v4` | `wave_5_elsa_data_v4` | `wave_5_elsa_data_v4` | `wave_5_elsa_data_v4` | `wave_5_elsa_data_v4` | `wave_5_elsa_data_v4` | `wave_5_elsa_data_v4` | 
| **Categories** |`1 = yes`| `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` |
| | `2 = no` | `2 = no`| `2 = no` | `2 = no` | `2 = no` | `2 = no` | `2 = no` | `2 = no` |
| **Missing** |`-9 = Refusal`| `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | 
| | `-8 = Don't Know` | `-8 = Don't Know`| `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` |
| | `-1 = Not applicable` | `-1 = Not applicable`| `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` |
| | `-2 = Schedule not applicable` | `-2 = Schedule not applicable`| `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` |
| **Description** | | | | | | | | |

```{r assign5, echo=FALSE}
opal.assign.table.tibble(o, 'ELSA_dep','ELSA.wave_5_elsa_data_v4',
                         variables=list('psceda', 'pscedb', 'pscedc', 'pscedd', 'pscede', 'pscedf', 'pscedg', 'pscedh'), missings = TRUE)
ELSA_dep <- opal.execute(o,'ELSA_dep')
```

```{r local5, echo=FALSE}
vari <- ELSA_dep$psceda
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedb
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedc
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedd
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscede
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedf
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedg
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$pscedh
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Harmonisation algorithm
To compute the harmonized variable from the study-specific variable it has to be recoded as follows:

First of all: 

* The reversed items pscedd, pscedf: 
    + `recode 1 into 0`
    + `recode 2 into 1`
    
* The direct items psceda, pscedb, pscedc, pscede, pscedg, pscedh: 
    + `keep 1 into 1`
    + `recode 2 into 0`


Secondly in order to get the final score the items have to be summed. If one items is missing, scores on the completed items are summed; the total is divided by the number of items answered and multiplied by 8. If more than 1 items are missing the individual get a missing value in the final score. 

After get the final score, it has to be recoded as follows: 

* `0-3 into 0`
* `>4 into 1`
* `NA into`
    + `997 if the individual has more items = -9 than -8, -1, -2 and NA`
    + `998 if the individual has more items = -8 than -9, -1, -2 and NA`
    + `996 if the individual has more items = -1 and -2 than -9, -8 and NA`
    + `999 if the individual has more items = NA than -8, -9, -2 and -1`

**R script:**

```{r harmo5, echo=TRUE}
#reversed items
ELSA_dep$pd <- car::recode(ELSA_dep$pscedd, "1=0; 2=1; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pf <- car::recode(ELSA_dep$pscedf, "1=0; 2=1; -8=NA; -9=NA; -1=NA; -2=NA")

#direct items  
ELSA_dep$pa <- car::recode(ELSA_dep$psceda, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pb <- car::recode(ELSA_dep$pscedb, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pc <- car::recode(ELSA_dep$pscedc, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pe <- car::recode(ELSA_dep$pscede, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pg <- car::recode(ELSA_dep$pscedg, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$ph <- car::recode(ELSA_dep$pscedh, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")


ELSA_dep$nmiss <- apply(ELSA_dep[,10:17], MARGIN = 1, FUN = function(x) sum(is.na(x)))


ELSA_dep$final_score <- apply(ELSA_dep[,10:17], MARGIN = 1, FUN = function(x) sum(x, na.rm = TRUE))


ELSA_dep$final_score[which(ELSA_dep$nmiss==1)] <- (ELSA_dep$final_score[which(ELSA_dep$nmiss==1)]/7)*8

ELSA_dep$n8 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x==(-8), na.rm = TRUE))
ELSA_dep$n9 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x==(-9), na.rm = TRUE))
ELSA_dep$n12 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x%in%c(-1, -2), na.rm = TRUE))
ELSA_dep$nNA <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(is.na(x)))

ELSA_dep$max_891_NA <- apply(ELSA_dep[,20:22], MARGIN = 1, FUN = function(x) which.max(x))
ELSA_dep$max_891_NA <- car::recode(ELSA_dep$max_891_NA, "1=998;2=997;3=996;4=999")

ELSA_dep$final_score[which(ELSA_dep$nmiss>1)] <- ELSA_dep$max_891_NA[which(ELSA_dep$nmiss>1)]

ELSA_ds_w5 <- tibble(id=ELSA_dep$id)
ELSA_ds_w5$depression <- car::recode(ELSA_dep$final_score, "0:3.99999999=0; 4:900=1")
ELSA_ds_w5$depression <- labelled(ELSA_ds_w5[[2]], labels = c("no depression"=0, "depression"=1,  "Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996, "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistical description of the new harmonised variable
```{r descript5, echo=FALSE}
vari <- ELSA_ds_w5$depression
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
ggplot(ELSA_ds_w5, aes(x=factor(ELSA_ds_w5[[2]]))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Validation
```{r crosstabulation5, echo=FALSE}
BeforeH <- c(sum(na.omit(ELSA_dep$final_score)<4), sum(na.omit(ELSA_dep$final_score)>=4 & na.omit(ELSA_dep$final_score)<900), sum(na.omit(ELSA_dep$final_score)==996), sum(na.omit(ELSA_dep$final_score)==997), sum(na.omit(ELSA_dep$final_score)==998))
AfterH <- table(ELSA_ds_w5[[2]], useNA = "ifany")
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("<4->0",">=4->1", "(-1,-2)->996", "-9->997", "-8->998") 
kable(C)
```

```{r importOPAL5, echo=FALSE}
label(ELSA_ds_w5$depression) <- ds_label_all
depression <- ELSA_ds_w5
save(depression, file = "../RData/w5/depression.RData")
rm(depression)
```



### Wave 6

#### Study-specific variable description

| **Name** | `PScedA`| `PScedB` | `PScedC` | `PScedD` | `PScedE` | `PScedF` | `PScedG` | `PScedH` |
|-|-|-|-|-|-|-|-|-|
| **Label** | `Whether respondent has felt depressed much of the time during the past week`| `Whether respondent felt everything they did during the past week was an effort` | `Whether respondent felt their sleep was restless during the past week` | `Whether respondent was happy much of the time during the past week` | `Whether respondent felt lonely much of the time during the past week` | `Whether respondent enjoyed life much of the time during the past week` | `Whether respondent felt sad much of the time during the past week` | `Whether respondent could not get going much of the time during the past week` | 
| **Table name** | `wave_6_elsa_data_v2` | `wave_6_elsa_data_v2` | `wave_6_elsa_data_v2` | `wave_6_elsa_data_v2` | `wave_6_elsa_data_v2` | `wave_6_elsa_data_v2` | `wave_6_elsa_data_v2` | `wave_6_elsa_data_v2` | 
| **Categories** |`1 = yes`| `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` |
| | `2 = no` | `2 = no`| `2 = no` | `2 = no` | `2 = no` | `2 = no` | `2 = no` | `2 = no` |
| **Missing** |`-9 = Refusal`| `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | 
| | `-8 = Don't Know` | `-8 = Don't Know`| `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` |
| | `-1 = Not applicable` | `-1 = Not applicable`| `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` |
| | `-2 = Schedule not applicable` | `-2 = Schedule not applicable`| `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` |
| **Description** | | | | | | | | |

```{r assign6, echo=FALSE}
opal.assign.table.tibble(o, 'ELSA_dep','ELSA.wave_6_elsa_data_v2',
                         variables=list('PScedA', 'PScedB', 'PScedC', 'PScedD', 'PScedE', 'PScedF', 'PScedG', 'PScedH'), missings = TRUE)
ELSA_dep <- opal.execute(o,'ELSA_dep')
```

```{r local6, echo=FALSE}
vari <- ELSA_dep$PScedA
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedB
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedC
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedD
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedE
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedF
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedG
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedH
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

```

#### Harmonisation algorithm
To compute the harmonized variable from the study-specific variable it has to be recoded as follows:

First of all: 

* The reversed items pscedd, pscedf: 
    + `recode 1 into 0`
    + `recode 2 into 1`
    
* The direct items psceda, pscedb, pscedc, pscede, pscedg, pscedh: 
    + `keep 1 into 1`
    + `recode 2 into 0`


Secondly in order to get the final score the items have to be summed. If one items is missing, scores on the completed items are summed; the total is divided by the number of items answered and multiplied by 8. If more than 1 items are missing the individual get a missing value in the final score. 

After get the final score, it has to be recoded as follows: 

* `0-3 into 0`
* `>4 into 1`
* `NA into`
    + `997 if the individual has more items = -9 than -8, -1, -2 and NA`
    + `998 if the individual has more items = -8 than -9, -1, -2 and NA`
    + `996 if the individual has more items = -1 and -2 than -9, -8 and NA`
    + `999 if the individual has more items = NA than -8, -9, -2 and -1`

**R script:**

```{r harmo6, echo=TRUE}
#reversed items
ELSA_dep$pd <- car::recode(ELSA_dep$PScedD, "1=0; 2=1; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pf <- car::recode(ELSA_dep$PScedF, "1=0; 2=1; -8=NA; -9=NA; -1=NA; -2=NA")

#direct items  
ELSA_dep$pa <- car::recode(ELSA_dep$PScedA, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pb <- car::recode(ELSA_dep$PScedB, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pc <- car::recode(ELSA_dep$PScedC, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pe <- car::recode(ELSA_dep$PScedE, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pg <- car::recode(ELSA_dep$PScedG, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$ph <- car::recode(ELSA_dep$PScedH, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")


ELSA_dep$nmiss <- apply(ELSA_dep[,10:17], MARGIN = 1, FUN = function(x) sum(is.na(x)))


ELSA_dep$final_score <- apply(ELSA_dep[,10:17], MARGIN = 1, FUN = function(x) sum(x, na.rm = TRUE))


ELSA_dep$final_score[which(ELSA_dep$nmiss==1)] <- (ELSA_dep$final_score[which(ELSA_dep$nmiss==1)]/7)*8

ELSA_dep$n8 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x==(-8), na.rm = TRUE))
ELSA_dep$n9 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x==(-9), na.rm = TRUE))
ELSA_dep$n12 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x%in%c(-1, -2), na.rm = TRUE))
ELSA_dep$nNA <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(is.na(x)))

ELSA_dep$max_891_NA <- apply(ELSA_dep[,20:22], MARGIN = 1, FUN = function(x) which.max(x))
ELSA_dep$max_891_NA <- car::recode(ELSA_dep$max_891_NA, "1=998;2=997;3=996;4=999")

ELSA_dep$final_score[which(ELSA_dep$nmiss>1)] <- ELSA_dep$max_891_NA[which(ELSA_dep$nmiss>1)]

ELSA_ds_w6 <- tibble(id=ELSA_dep$id)
ELSA_ds_w6$depression <- car::recode(ELSA_dep$final_score, "0:3.99999999=0; 4:900=1")
ELSA_ds_w6$depression <- labelled(ELSA_ds_w6[[2]], labels = c("no depression"=0, "depression"=1,  "Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996, "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistical description of the new harmonised variable
```{r descript6, echo=FALSE}
vari <- ELSA_ds_w6$depression
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
ggplot(ELSA_ds_w6, aes(x=factor(ELSA_ds_w6[[2]]))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Validation
```{r crosstabulation6, echo=FALSE}
BeforeH <- c(sum(na.omit(ELSA_dep$final_score)<4), sum(na.omit(ELSA_dep$final_score)>=4 & na.omit(ELSA_dep$final_score)<900), sum(na.omit(ELSA_dep$final_score)==996), sum(na.omit(ELSA_dep$final_score)==997), sum(na.omit(ELSA_dep$final_score)==998))
AfterH <- table(ELSA_ds_w6[[2]], useNA = "ifany")
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("<4->0",">=4->1", "(-1,-2)->996", "-9->997", "-8->998") 
kable(C)
```

```{r importOPAL6, echo=FALSE}
label(ELSA_ds_w6$depression) <- ds_label_all
depression <- ELSA_ds_w6
save(depression, file = "../RData/w6/depression.RData")
rm(depression)
```

### Wave 7

#### Study-specific variable description

| **Name** | `PScedA`| `PScedB` | `PScedC` | `PScedD` | `PScedE` | `PScedF` | `PScedG` | `PScedH` |
|-|-|-|-|-|-|-|-|-|
| **Label** | `Whether respondent has felt depressed much of the time during the past week`| `Whether respondent felt everything they did during the past week was an effort` | `Whether respondent felt their sleep was restless during the past week` | `Whether respondent was happy much of the time during the past week` | `Whether respondent felt lonely much of the time during the past week` | `Whether respondent enjoyed life much of the time during the past week` | `Whether respondent felt sad much of the time during the past week` | `Whether respondent could not get going much of the time during the past week` | 
| **Table name** | `wave_7_elsa_data` | `wave_7_elsa_data` | `wave_7_elsa_data` | `wave_7_elsa_data` | `wave_7_elsa_data` | `wave_7_elsa_data` | `wave_7_elsa_data` | `wave_7_elsa_data` | 
| **Categories** |`1 = yes`| `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` | `1 = yes` |
| | `2 = no` | `2 = no`| `2 = no` | `2 = no` | `2 = no` | `2 = no` | `2 = no` | `2 = no` |
| **Missing** |`-9 = Refusal`| `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | `-9 = Refusal` | 
| | `-8 = Don't Know` | `-8 = Don't Know`| `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` | `-8 = Don't Know` |
| | `-1 = Not applicable` | `-1 = Not applicable`| `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` | `-1 = Not applicable` |
| | `-2 = Schedule not applicable` | `-2 = Schedule not applicable`| `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` | `-2 = Schedule not applicable` |
| **Description** | | | | | | | | |

```{r assign7, echo=FALSE}
opal.assign.table.tibble(o, 'ELSA_dep','ELSA.wave_7_elsa_data',
                         variables=list('PScedA', 'PScedB', 'PScedC', 'PScedD', 'PScedE', 'PScedF', 'PScedG', 'PScedH'), missings = TRUE)
ELSA_dep <- opal.execute(o,'ELSA_dep')
```

```{r local7, echo=FALSE}
vari <- ELSA_dep$PScedA
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedB
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedC
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedD
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedE
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedF
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedG
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- ELSA_dep$PScedH
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(-9 -8, -1, -2))[2], caption = "Type of missing")
ggplot(ELSA_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Harmonisation algorithm
To compute the harmonized variable from the study-specific variable it has to be recoded as follows:

First of all: 

* The reversed items pscedd, pscedf: 
    + `recode 1 into 0`
    + `recode 2 into 1`
    
* The direct items psceda, pscedb, pscedc, pscede, pscedg, pscedh: 
    + `keep 1 into 1`
    + `recode 2 into 0`


Secondly in order to get the final score the items have to be summed. If one items is missing, scores on the completed items are summed; the total is divided by the number of items answered and multiplied by 8. If more than 1 items are missing the individual get a missing value in the final score. 

After get the final score, it has to be recoded as follows: 

* `0-3 into 0`
* `>4 into 1`
* `NA into`
    + `997 if the individual has more items = -9 than -8, -1, -2 and NA`
    + `998 if the individual has more items = -8 than -9, -1, -2 and NA`
    + `996 if the individual has more items = -1 and -2 than -9, -8 and NA`
    + `999 if the individual has more items = NA than -8, -9, -2 and -1`

**R script:**

```{r harmo7, echo=TRUE}
#reversed items
ELSA_dep$pd <- car::recode(ELSA_dep$PScedD, "1=0; 2=1; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pf <- car::recode(ELSA_dep$PScedF, "1=0; 2=1; -8=NA; -9=NA; -1=NA; -2=NA")

#direct items  
ELSA_dep$pa <- car::recode(ELSA_dep$PScedA, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pb <- car::recode(ELSA_dep$PScedB, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pc <- car::recode(ELSA_dep$PScedC, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pe <- car::recode(ELSA_dep$PScedE, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$pg <- car::recode(ELSA_dep$PScedG, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")
ELSA_dep$ph <- car::recode(ELSA_dep$PScedH, "2=0; -8=NA; -9=NA; -1=NA; -2=NA")

ELSA_dep$nmiss <- apply(ELSA_dep[,10:17], MARGIN = 1, FUN = function(x) sum(is.na(x)))


ELSA_dep$final_score <- apply(ELSA_dep[,10:17], MARGIN = 1, FUN = function(x) sum(x, na.rm = TRUE))


ELSA_dep$final_score[which(ELSA_dep$nmiss==1)] <- (ELSA_dep$final_score[which(ELSA_dep$nmiss==1)]/7)*8

ELSA_dep$n8 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x==(-8), na.rm = TRUE))
ELSA_dep$n9 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x==(-9), na.rm = TRUE))
ELSA_dep$n12 <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(x%in%c(-1, -2), na.rm = TRUE))
ELSA_dep$nNA <- apply(ELSA_dep[,2:9], MARGIN = 1, FUN = function(x) sum(is.na(x)))

ELSA_dep$max_891_NA <- apply(ELSA_dep[,20:22], MARGIN = 1, FUN = function(x) which.max(x))
ELSA_dep$max_891_NA <- car::recode(ELSA_dep$max_891_NA, "1=998;2=997;3=996;4=999")

ELSA_dep$final_score[which(ELSA_dep$nmiss>1)] <- ELSA_dep$max_891_NA[which(ELSA_dep$nmiss>1)]

ELSA_ds_w7 <- tibble(id=ELSA_dep$id)
ELSA_ds_w7$depression <- car::recode(ELSA_dep$final_score, "0:3.99999999=0; 4:900=1")
ELSA_ds_w7$depression <- labelled(ELSA_ds_w7[[2]], labels = c("no depression"=0, "depression"=1,  "Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996, "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistical description of the new harmonised variable
```{r descript7, echo=FALSE}
vari <- ELSA_ds_w7$depression
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
ggplot(ELSA_ds_w7, aes(x=factor(ELSA_ds_w7[[2]]))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Validation
```{r crosstabulation7, echo=FALSE}
BeforeH <- c(sum(na.omit(ELSA_dep$final_score)<4), sum(na.omit(ELSA_dep$final_score)>=4 & na.omit(ELSA_dep$final_score)<900), sum(na.omit(ELSA_dep$final_score)==996), sum(na.omit(ELSA_dep$final_score)==997), sum(na.omit(ELSA_dep$final_score)==998))
AfterH <- table(ELSA_ds_w7[[2]], useNA = "ifany")
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("<4->0",">=4->1", "(-1,-2)->996", "-9->997", "-8->998") 
kable(C)
```

```{r importOPAL7, echo=FALSE}
label(ELSA_ds_w7$depression) <- ds_label_all
depression <- ELSA_ds_w7
save(depression, file = "../RData/w7/depression.RData")
rm(depression)
```

# Quality estimation


ELSA used the eight item version of the Center for Epidemiologic Studies Depression Scale (CES-D) to measure depressive symptoms. To determine depressive symptoms, each self-respondent was asked the following questions with response options of yes or no: 1) Much of the time during the past week, I felt depressed; 2) I felt everything I did was an effort; 3) My sleep was restless; 4) I was happy; 5) I felt lonely; 6) I enjoyed life; 7) I felt sad; 8) I could not get going. For each respondent, the total number of yes responses to questions 1, 2, 3, 5, 7, 8, and the no responses to questions 4 and 6 were summed to arrive at a total depressive symptom score ranging from 0 to 8. We classified those who reported four or more depressive symptoms as having significant depressive symptoms, a cut-off that has been found to produce comparable results to the 16-symptom cut-off for the well-validated 20-item CES-D scale. =4
We get the final variable using the sigle items because we didn't have the final score. 
Regarding the missing values, we follow this criteria: only one missing item was allowed > score the completed items divided by the number of items answered and multiplied by 8.



```{r closeRsession, echo=FALSE} 
opal.logout(o)
```