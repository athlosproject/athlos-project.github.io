---
title: "Year of Death"
output:
  html_document:
    highlight: tango
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

<!-- ########################################################## --> 
<!-- # Installation, loading packages -->
```{r setup, include=FALSE}
source("../../setup.r")
```
<!-- ########################################################## --> 
<!-- # Loading DS description -->
```{r main, child='../../_DS_Rmd/ydeathDS.Rmd'}
```
```{r global, echo=F}
source('../../_DS_Rmd/ydeathDS.R')
```

# Data process




## England



```{r assign_all, echo=F}


opal.assign.table.tibble(o,'ELSA_w1_ybirth','ELSA.wave_1_core_data_v3',
                         variables=list('indobyr'), missings = TRUE)
opal.assign.table.tibble(o, 'ELSA_w2_ybirth','ELSA.wave_2_core_data_v4',
                         variables=list('indobyr'), missings = TRUE)
opal.assign.table.tibble(o, 'ELSA_w3_ybirth','ELSA.wave_3_elsa_data_v4',
                         variables=list('indobyr'), missings = TRUE)
opal.assign.table.tibble(o, 'ELSA_w4_ybirth','ELSA.wave_4_elsa_data_v3',
                         variables=list('indobyr'), missings = TRUE)
opal.assign.table.tibble(o, 'ELSA_w5_ybirth','ELSA.wave_5_elsa_data_v4',
                         variables=list('indobyr'), missings = TRUE)
opal.assign.table.tibble(o, 'ELSA_w6_ybirth','ELSA.wave_6_elsa_data_v2',
                         variables=list('Indobyr'), missings = TRUE)
opal.assign.table.tibble(o, 'ELSA_w7_ybirth','ELSA.wave_7_elsa_data',
                         variables=list('Indobyr'), missings = TRUE)

core1 <- opal.execute(o,'ELSA_w1_ybirth')
core2 <- opal.execute(o,'ELSA_w2_ybirth')
core3 <- opal.execute(o,'ELSA_w3_ybirth')
core4 <- opal.execute(o,'ELSA_w4_ybirth')
core5 <- opal.execute(o,'ELSA_w5_ybirth')
core6 <- opal.execute(o,'ELSA_w6_ybirth')
core7 <- opal.execute(o,'ELSA_w7_ybirth')

opal.assign.table.tibble(o, 'ELSA_w2_ydeath','ELSA.elsa_eol_w2_archive_v1',
                         variables=list('EiDateY'), missings = TRUE)
opal.assign.table.tibble(o, 'ELSA_w3_ydeath','ELSA.elsa_eol_w3_archive_v1',
                         variables=list('EiDateY'), missings = TRUE)
opal.assign.table.tibble(o, 'ELSA_w4_ydeath','ELSA.elsa_eol_w4_archive_v1',
                         variables=list('EiDateY'), missings = TRUE)
opal.assign.table.tibble(o, 'ELSA_w6_ydeath','ELSA.elsa_endoflife_w6archive',
                         variables=list('EiDateY'), missings = TRUE)
eol2 <- opal.execute(o,'ELSA_w2_ydeath')
eol3 <- opal.execute(o,'ELSA_w3_ydeath')
eol4 <- opal.execute(o,'ELSA_w4_ydeath')
eol6 <- opal.execute(o,'ELSA_w6_ydeath')

```

**R script:**

```{r global_harmo}

# Individuals in EoL interviews not interviewed in any wave from 1 are removed. We keep them only in first EoL interview they appear.
# Printed lengths of cases
# 135 - 1 = 134
ids2 <- (eol2 %>% filter(id %in% Reduce(union,list(core1$id,core2$id))))$id
# 375 - 1 = 374
ids3 <- setdiff((eol3 %>% filter(id %in% Reduce(union,list(core1$id,core2$id,core3$id))))$id, eol2$id)
# 242 -1 - 4 = 237
ids4 <- setdiff((eol4 %>% filter(id %in% Reduce(union,list(core1$id,core2$id,core3$id,core4$id))))$id, union(eol2$id,eol3$id))
# 240
ids6 <- setdiff((eol6 %>% filter(id %in% Reduce(union,list(core1$id,core2$id,core3$id,core4$id,core5$id,core6$id))))$id,Reduce(union,list(eol2$id,eol3$id,eol4$id)))
# 134 + 374 + 237 + 240 = 985
ids <- Reduce(union, list(ids2,ids3,ids4,ids6))

eol <- full_join(eol2 %>% filter(id %in% ids2),eol3 %>% filter(id %in% ids3), by = "id", suffix = c(".w2",".w3"))
eol <- full_join(eol, eol4 %>% filter(id %in% ids4), by = "id")
eol <- full_join(eol, eol6 %>% filter(id %in% ids6), by = "id", suffix = c(".w4",".w6"))

# Years of death of id's in wave 3 and EoL interview are harmonised in wave 4
# 374 - 2 = 372
dids3 <- setdiff(ids3,core3$id)
# 237 + 2 = 239
dids4 <- union(ids4,setdiff(ids3,dids3))

# Years of death before wave 3 (2006-2007) of id's in wave 3 EoL interview and neither in wave 3 nor wave 2 interviews are harmonised in wave 2
# 134 + 160 = 294
dids2 <- union(ids2,(eol3 %>% filter(id %in% ids3 & !id %in% union(core2$id,core3$id) & EiDateY<2006))$id)
# 372 - 160 = 212
dids3 <- setdiff(dids3,dids2)


# Years of death before wave 4 (2008-2009) of id's in wave 4 EoL interview and neither in wave 4 nor wave 3 interviews but in wave 2, are harmonised in wave 3
# 212 + 15 = 227
dids3 <- union(dids3,(eol4 %>% filter(id %in% ids4 & id %in% setdiff(core2$id,core3$id) & EiDateY<2008))$id)
# 239 - 15 = 224
dids4 <- setdiff(dids4,dids3)

# Years of death before wave 3 (2006-2007) of id's only in wave 4 EoL and wave 1 interviews, are harmonised in wave 2
# 294 + 1 = 295
dids2 <- union(dids2,(eol4 %>% filter(id %in% ids4 & id %in% setdiff(core1$id,union(core2$id,core3$id)) & EiDateY<2006))$id)
# 224 - 1 = 223
dids4 <- setdiff(dids4,dids2)

# Years of death between wave 3 (2006-2007) and wave 4 (2008-2009) of id's only in wave 4 EoL and wave 1 interviews, are harmonised in wave 3
# 227 + 8 = 235
dids3 <- union(dids3,(eol4 %>% filter(id %in% ids4 & id %in% setdiff(core1$id,union(core2$id,core3$id)) & EiDateY<2008 & EiDateY>=2006))$id)
# 223 - 8 = 215
dids4 <- setdiff(dids4,dids3)


# Years of death before wave 6 (2012-2013) of id's in wave 6 EoL interview and neither in wave 6 nor wave 5 interviews but in wave 4, are harmonised in wave 5. We avoid id's with years of death 2000 and 2007, since they have later year of interview so EiDateY data is considered to be missing.
# 149
dids5 <- (eol6 %>% filter(id %in% setdiff(core4$id,core5$id) & EiDateY<2012 & !EiDateY %in% c(-8,2000,2007)))$id
# 240 - 149 = 91
dids6 <- setdiff(ids6,dids5)

# Years of death before wave 5 (2010-2011) of id's in wave 6 EoL interview, and wave 3 but any later interview, are harmonised in wave 4
# 215 + 3 = 218
dids4 <- union(dids4,(eol6 %>% filter(id %in% setdiff(core3$id,union(core4$id,core5$id)) & EiDateY<2010))$id)
# 91 - 3 = 88
dids6 <- setdiff(dids6,dids4)

# Years of death between wave 5 (2010-2011) and wave 6 (2012-2013) of id's in wave 6 EoL interview, and wave 3 but any later interview, are harmonised in wave 5
# 149 + 1 = 150
dids5 <- union(dids5,(eol6 %>% filter(id %in% setdiff(core3$id,union(core4$id,core5$id)) & EiDateY<2012 & EiDateY>=2010))$id)
# 88 - 1 = 87
dids6 <- setdiff(dids6,dids5)

# Years of death between wave 5 (2010-2011) and wave 6 (2012-2013) of id's in wave 6 EoL interview, and wave 2 but any later interview, are harmonised in wave 5
# 150 + 1 = 151
dids5 <- union(dids5,(eol6 %>% filter(id %in% setdiff(core2$id,Reduce(union,list(core3$id,core4$id,core5$id))) & EiDateY<2012 & EiDateY>=2010))$id)
# 87 - 1 = 86
dids6 <- setdiff(dids6,dids5)

# Years of death between wave 5 (2010-2011) and wave 6 (2012-2013) of id's in wave 6 EoL interview, and wave 1 but any later interview, are harmonised in wave 5
# 151 + 1 = 152
dids5 <- union(dids5,(eol6 %>% filter(id %in% setdiff(core1$id,Reduce(union,list(core2$id,core3$id,core4$id,core5$id))) & EiDateY<2012 & EiDateY>=2010))$id)
# 86 - 1 = 85
dids6 <- setdiff(dids6,dids5)

eol <- eol %>% mutate(EiDateY = coalesce(EiDateY.w2,EiDateY.w3,EiDateY.w4,EiDateY.w6))
```




```{r descript0, echo=F}

kable(frq(ids2 %in% core2$id)[[1]][1,c(1,2,4)], caption = "There are no id's in wave 2 being also in EoL interview")
# kable(frq(eol2$EiDateY)[[1]][-c(1:3,8),c(1,3,4,6)]) # This should appear in local2

kable(frq(ids3 %in% core3$id)[[1]][c(1:2),c(1,2,4,6)], caption = "There are 2 id's in wave 3 which are also in EoL interview")
kable(frq((eol3 %>% filter(id %in% ids3 & id %in% core3$id))$EiDateY)[[1]][c(1:2),c(1,2,4,6)], caption = "Their years of death")
kable(frq((eol3 %>% filter(id %in% ids3 & !id %in% core3$id & !id %in% core2$id))$EiDateY)[[1]][c(1:5),c(1,2,4,6)], caption = "Years of death of individuals neither in wave 3 nor in wave 2, but in wave 3 EoL interview")
kable(frq((eol3 %>% filter(id %in% ids3 & !id %in% core3$id & id %in% core2$id))$EiDateY)[[1]][,c(1,2,4,6)], caption = "Years of death of individuals not in wave 3 but in its EoL interview and in wave 2")

kable(frq(ids4 %in% core4$id)[[1]][1,c(1,2,4)], caption = "There are no id's in wave 4 being also in EoL interview")
kable(frq((eol4 %>% filter(id %in% ids4 & id %in% ids4 & id %in% setdiff(core2$id,core3$id)))$EiDateY)[[1]][c(1:4),c(1,2,4,6)], caption = "Years of death of individuals in wave 4 EoL interview and in wave 2 but any later wave")
kable(frq((eol4 %>% filter(id %in% ids4 & id %in% setdiff(core1$id,union(core2$id,core3$id))))$EiDateY)[[1]][c(1:5),c(1,2,4,6)], caption = "Years of death of individuals in wave 4 EoL interview and in wave 1 but any later wave")
kable(frq((eol4 %>% filter(id %in% ids4 & id %in% core3$id))$EiDateY)[[1]][c(1:4),c(1,2,4,6)], caption = "Years of death of individuals in wave 4 EoL interview and in wave 3")

kable(frq(eol6$id %in% core6$id)[[1]][1,c(1,2,4)], caption = "There are no id's in wave 6 being also in EoL interview")
kable(frq((eol6 %>% filter(id %in% setdiff(core4$id,core5$id)))$EiDateY)[[1]][c(1:8),c(1,2,4,6)], caption = "Years of death of individuals in wave 6 EoL interview and in wave 4 but any later wave")
kable(frq((eol6 %>% filter(id %in% setdiff(core3$id,union(core4$id,core5$id))))$EiDateY)[[1]][c(1:3),c(1,2,4,6)], caption = "Years of death of individuals in wave 6 EoL interview and in wave 3 but any later wave")
kable(frq((eol6 %>% filter(id %in% setdiff(core2$id,Reduce(union,list(core3$id,core4$id,core5$id)))))$EiDateY)[[1]][c(1:2),c(1,2,4,6)], caption = "Years of death of individuals in wave 6 EoL interview and in wave 2 but any later wave")
kable(frq((eol6 %>% filter(id %in% setdiff(core1$id,Reduce(union,list(core2$id,core3$id,core4$id,core5$id)))))$EiDateY)[[1]][c(1),c(1,2,4,6)], caption = "Years of death of individuals in wave 6 EoL interview and in wave 1 but any later wave")

kable(frq((eol[,-1] %>% mutate(nn = rowSums(!is.na(.))))$nn)[[1]][1,c(1,2,4)], caption = "In the built data frame there is a unique non NA value by row")

```


### Wave 1 

Not applicable.

### Wave 2

#### Study-specific variable description


| **Name** |`EiDateY`|
|-|-|
| **Label** |`Year of death`|
| **Table name** |`elsa_eol_w2_archive_v1`|
| **Units** |`years`|
| **Missings** |`-9 = Refused/not answered`<br/>`-8 = Don't know`<br/>`-1 = Not applicable`|
| **Description** |  |



```{r local2, echo=F}


vbl <- (eol %>% filter(id %in% dids2))$EiDateY
vbl_miss <- c(-9, -8, -1)
kable(Categorical_summary(vbl, missing_values = vbl_miss)[3], caption = "EiDateY")
#kable(Categorical_summary(vbl, missing_values = vbl_miss)[2], caption = "Type of missing")
kable(Categorical_summary(vbl, missing_values = vbl_miss)[1], caption = label(vbl))
ggplot(eol, aes(x=factor(EiDateY))) + geom_histogram(stat="count", fill="steelblue", data = . %>% filter(id %in% dids2)) + xlab(label(vbl)) + ylab("Frequency")

```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable, but the missing values have to be recoded as follows:

* `recode -9 "Refused/not answered" into 997`
* `recode -8 "Don't know" into 998`
* `recode -1 "Not applicable" into 996`
* `NA into 999`


**R script:**

```{r harmo2}
ELSA_ds_w2 <- tibble(id=dids2)
ELSA_ds_w2$ydeath <- car::recode((eol %>% filter(id %in% dids2))$EiDateY, "-9=997; -8=998; -1=996; NA=999")

```

#### Statistics of the new harmonised variable
```{r descript2, echo=F}

vbl <- ELSA_ds_w2$ydeath
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Values")
ggplot(ELSA_ds_w2, aes(factor(ydeath))) + geom_histogram(stat="count", fill="steelblue") + xlab(ds_label) + ylab("Frequency") 

```

#### Validation
```{r crosstabulation2, echo=F}

```






### Wave 3

#### Study-specific variable description


| **Name** |`EiDateY`|
|-|-|
| **Label** |`Year of death`|
| **Table name** |`elsa_eol_w3_archive_v1`|
| **Units** |`years`|
| **Missings** |`-9 = Refused/not answered`<br/>`-8 = Don't know`<br/>`-1 = Not applicable`|
| **Description** |  |



```{r local3, echo=F}

vbl <- (eol %>% filter(id %in% dids3))$EiDateY
vbl_miss <- c(-9, -8, -1)
kable(Categorical_summary(vbl, missing_values = vbl_miss)[3], caption = "EiDateY")
kable(Categorical_summary(vbl, missing_values = vbl_miss)[1], caption = label(vbl))
ggplot(eol, aes(x=factor(EiDateY))) + geom_histogram(stat="count", fill="steelblue", data = . %>% filter(id %in% dids3)) + xlab(label(vbl)) + ylab("Frequency")

```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable, but the missing values have to be recoded as follows:

* `recode -9 "Refused/not answered" into 997`
* `recode -8 "Don't know" into 998`
* `recode -1 "Not applicable" into 996`
* `NA into 999`

**R script:**

```{r harmo3}
ELSA_ds_w3 <- tibble(id=dids3)
ELSA_ds_w3$ydeath <- car::recode((eol %>% filter(id %in% dids3))$EiDateY, "-9=997; -8=998; -1=996; NA=999")

```

#### Statistics of the new harmonised variable
```{r descript3, echo=F}

vbl <- ELSA_ds_w3$ydeath
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Values")
ggplot(ELSA_ds_w3, aes(factor(ydeath))) + geom_histogram(stat="count", fill="steelblue") + xlab(ds_label) + ylab("Frequency") 
```

#### Validation
```{r crosstabulation3, echo=F}

```




### Wave 4

#### Study-specific variable description


| **Name** |`EiDateY`|
|-|-|
| **Label** |`Year of death`|
| **Table name** |`elsa_eol_w4_archive_v1`|
| **Units** |`years`|
| **Missings** |`-9 = Refused/not answered`<br/>`-8 = Don't know`<br/>`-1 = Not applicable`|
| **Description** |  |



```{r local4, echo=F}

vbl <- (eol %>% filter(id %in% dids4))$EiDateY
vbl_miss <- c(-9, -8, -1)
kable(Categorical_summary(vbl, missing_values = vbl_miss)[3], caption = "EiDateY")
kable(Categorical_summary(vbl, missing_values = vbl_miss)[1], caption = label(vbl))
ggplot(eol, aes(x=factor(EiDateY))) + geom_histogram(stat="count", fill="steelblue", data = . %>% filter(id %in% dids4)) + xlab(label(vbl)) + ylab("Frequency")

```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable, but the missing values have to be recoded as follows:

* `recode -9 "Refused/not answered" into 997`
* `recode -8 "Don't know" into 998`
* `recode -1 "Not applicable" into 996`
* `NA into 999`

**R script:**

```{r harmo4}
ELSA_ds_w4 <- tibble(id=dids4)
ELSA_ds_w4$ydeath <- car::recode((eol %>% filter(id %in% dids4))$EiDateY, "-9=997; -8=998; -1=996; NA=999")

```

#### Statistics of the new harmonised variable
```{r descript4, echo=F}

vbl <- ELSA_ds_w4$ydeath
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Values")
ggplot(ELSA_ds_w4, aes(factor(ydeath))) + geom_histogram(stat="count", fill="steelblue") + xlab(ds_label) + ylab("Frequency") 

```

#### Validation
```{r crosstabulation4, echo=F}

```







### Wave 5

#### Study-specific variable description





```{r local5, echo=F}

vbl <- (eol %>% filter(id %in% dids5))$EiDateY
vbl_miss <- c(-9, -8, -1)
kable(Categorical_summary(vbl, missing_values = vbl_miss)[3], caption = "EiDateY")
kable(Categorical_summary(vbl, missing_values = vbl_miss)[1], caption = label(vbl))
ggplot(eol, aes(x=factor(EiDateY))) + geom_histogram(stat="count", fill="steelblue", data = . %>% filter(id %in% dids5)) + xlab(label(vbl)) + ylab("Frequency")


```

#### Harmonisation algorithm
The variable is going to computed from the study-specific variable from wave 6, but the missing values have to be recoded as follows:

* `recode -9 "Refused/not answered" into 997`
* `recode -8 "Don't know" into 998`
* `recode -1 "Not applicable" into 996`
* `NA into 999`


**R script:**

```{r harmo5}
ELSA_ds_w5 <- tibble(id=dids5)
ELSA_ds_w5$ydeath <- car::recode((eol %>% filter(id %in% dids5))$EiDateY, "-9=997; -8=998; -1=996; NA=999")
```

#### Statistics of the new harmonised variable
```{r descript5, echo=F}

vbl <- ELSA_ds_w5$ydeath
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Values")
ggplot(ELSA_ds_w5, aes(factor(ydeath))) + geom_histogram(stat="count", fill="steelblue") + xlab(ds_label) + ylab("Frequency") 
```

#### Validation
```{r crosstabulation5, echo=F}
```



### Wave 6

#### Study-specific variable description


| **Name** |`EiDateY`|
|-|-|
| **Label** |`Year of death`|
| **Table name** |`elsa_endoflife_w6archive`|
| **Units** |`years`|
| **Missings** |`-9 = Refused/not answered`<br/>`-8 = Don't know`<br/>`-1 = Not applicable`|
| **Description** |  |


```{r assign6, echo=F}
```

```{r local6, echo=F}

vbl <- (eol %>% filter(id %in% dids6))$EiDateY
vbl_miss <- c(-9, -8, -1)
kable(Categorical_summary(vbl, missing_values = vbl_miss)[3], caption = "EiDateY")
kable(Categorical_summary(vbl, missing_values = vbl_miss)[1], caption = label(vbl))
ggplot(eol, aes(x=factor(EiDateY))) + geom_histogram(stat="count", fill="steelblue", data = . %>% filter(id %in% dids6)) + xlab(label(vbl)) + ylab("Frequency")


```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable, but the missing values have to be recoded as follows:

* `recode -9 "Refused/not answered" into 997`
* `recode -8 "Don't know" into 998`
* `recode -1 "Not applicable" into 996`
* `NA into 999`
* `Id's with years of death 2000 and 2007 have later year of interview, so data is considered to be missing.`

**R script:**

```{r harmo6}
ELSA_ds_w6 <- tibble(id=dids6)
ELSA_ds_w6$ydeath <- car::recode((eol %>% filter(id %in% dids6))$EiDateY, "-9=997; -8=998; -1=996; NA=999; c(2000,2007)=999")
```

#### Statistics of the new harmonised variable
```{r descript6, echo=F}

vbl <- ELSA_ds_w6$ydeath
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[3], caption = ds_label)
kable(Categorical_summary(vbl, missing_values = miss_values_vector)[1], caption = "Values")
ggplot(ELSA_ds_w6, aes(factor(ydeath))) + geom_histogram(stat="count", fill="steelblue") + xlab(ds_label) + ylab("Frequency") 
```

#### Validation
```{r crosstabulation6, echo=F}

```




### Wave 7

Not available data



## Summary of descriptive statistics of the harmonised variable accross populations and waves

```{r helpfunctions, echo=F}

labelling <- function(l.hds,m.hds){
  
  # Labelling of the tibbles with continuous data and creating new tibbles with all missings recodified as NA

  for(name in names(l.hds)) {
    # In the aux_object we copy the old tibble to recodify all missing values as NA.
    aux_object <- l.hds[[name]]
    # Labelling of variables
    label(l.hds[[name]][[2]]) <- label(aux_object[[2]]) <- ds_label
    # Labelling of categories (for continues variables, only missing values)
    l.hds[[name]][[2]] <- labelled(l.hds[[name]][[2]], labels = cont_label)
    aux_object[[2]] <- car::recode(aux_object[[2]], "miss_values_vector=NA")
    # Saving the recodified tibble in list m.hds
    m.hds[[name]] <- aux_object
    rm(aux_object)
  }
  return(list(l.hds,m.hds))

}

# Creation of summary tables for continuous data

summaries <- function(l.hds,m.hds,lnames){

  # Creation of column with summary table categories
  t.summ <- summary(m.hds[[1]][2])[1:6]
  # Adding of missing/no-missing values categories
  t.hds <- c(substr(t.summ,1,regexpr(":", t.summ, fixed=T)-1),labels(Continuous_summary(l.hds[[1]][[2]],missing_values = miss_values_vector)$values_table)[[2]])
  # For each wave/population in l.hds, add the correponding values
  for (i in seq_along(l.hds)){
    # First, summary values
    t.summ <- summary(m.hds[[i]][2])[1:6]
    # Next, missing/no-missing values
    t.hds <- cbind(t.hds,c(as.numeric(substr(t.summ,regexpr(":", t.summ, fixed=T)+1,nchar(t.summ))),as.numeric(Continuous_summary(l.hds[[i]][[2]],missing_values = miss_values_vector)$values_table[1,])))
  }
  # Add sample size for each wave/population
  t.hds <- rbind(t.hds,c("sample size", sapply(l.hds,function(wave) length(wave[[1]]))))
  # Add wave/population names
  dimnames(t.hds)[[2]] <- c(dimnames(summary(m.hds[[1]][2]))[[2]],lnames)
  return(t.hds)
  
}

# Save data tables

savingRD <- function(l.hds,vbl_name){
  
  for(index in seq_along(l.hds)){
    assign(vbl_name,l.hds[[index]])
    save(vbl_name,list = vbl_name, file = paste0(datafolder,names(l.hds)[index],"/",vbl_name,".RData"))
  }

}

```




```{r summ, echo=F}

# All study waves and populations with abbreviated and descriptive names


elsa.cw <- list(w1 = c("w1","W1"), w2 = c("w2","W2"), w3 = c("w3","W3"), w4 = c("w4","W4"), w5 = c("w5","W5"), w6 = c("w6","W6"), w7 = c("w7","W7"))

# Consider only harmonised waves
l.hds <- lapply(elsa.cw, function(wname) if(exists(paste0("ELSA_ds_",wname[1]))){wname = list(get(paste0("ELSA_ds_",wname[1])),wname[2])})
nullw <- which(sapply(l.hds, is.null))

if(length(nullw)!=0){
  l.hds <- l.hds[-nullw]
}

m.hds <- list()

lmlist <- list(lapply(l.hds,function(x)x[[1]]),m.hds)

if(length(l.hds)>0){
  # Labelling tibbles
  lmlist <- labelling(lmlist[[1]],lmlist[[2]])
  # Printing summaries
  print(knitr::kable(summaries(lmlist[[1]],lmlist[[2]],lapply(l.hds,function(x)x[[2]])),caption=ds_label))
  # Saving tibbles
  savingRD(lmlist[[1]],vbl_name=hd_vbl)
}



```


# Quality estimation

No comments



```{r closeRsession, echo=FALSE}
opal.logout(o)
```
