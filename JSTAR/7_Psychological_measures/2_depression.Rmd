---
title: "Current depressive status"
output: 
  html_document:
    theme: united
    highlight: tango
    toc: true
    toc_depth: 6
    toc_float:
      collapsed: true
      smooth_scroll: true
    number_sections: true
---

<!-- ########################################################## --> 

<!-- # Installation, loading packages -->
<!-- **R script:** -->



```{r setup, include=FALSE, echo=FALSE}
source("M:/WPs/WP1/Maelstrom/data_process/athlos-project.github.io/setup_albert.r")
```

<!-- ########################################################## --> 

# Description of DataSchema variable

The description of harmonised variable is the following:

* Short name: `depression`
* Variable label: `Current depressive status of the participant`
* Variable description: `Current depressive status of the participant`
* Domain: `Psycological measures`
* Value type: `categorical`
* Category coding:

**Code** | **Category Label**
-------- | ------------------
0        | no depression
1        | depression

* Category missings: 

**Code** | **Category Label**
----| ------------------
991 | CAPI/interviewer error
992 | Impute
993 | Disable to measure
994 | Not attempt/not done
995 | Does not answer
996 | Not applicable
997 | Refuse
998 | Do not know
999 | Missing


```{r lab, echo=FALSE}
ds_label <- "Current depressive status"
ds_label_all <- "Current depressive status of the participant"
```

<!-- ########################################################## --> 

# Data process

## aksst 

### Wave 1 

#### Study-specific variable description



| **Name** | `tome45`| `tome46` | `tome47` | `tome48` | `tome49` | `tome50` | `tome51` | `tome52` | `tome53` | `tome54` | 
|-|-|-|-|-|-|-|-|-|-|-| 
| **Label** | `Q8:MENTAL CONDITION FOR THE PAST WEEK -1- UNUSUALLY ANXIOUS`| `Q8:MENTAL CONDITION FOR THE PAST WEEK -2- DID YOU LOSE YOUR APPETITE?` | `Q8:MENTAL CONDITION FOR THE PAST WEEK -3- GLOOM DESPITE OF ENCOURAGEMENT` | `Q8:MENTAL CONDITION FOR THE PAST WEEK -4- YOU CAN DO WHAT OTHERS CAN DO` | `Q8:MENTAL CONDITION FOR THE PAST WEEK -5- DIFFICULT TO CONCENTRATE` | `Q8:MENTAL CONDITION FOR THE PAST WEEK -6- DID YOU FEEL DEPRESSED?` | `Q8:MENTAL CONDITION FOR THE PAST WEEK -7- UNUSUALLY BOTHERSOME` | `Q8:MENTAL CONDITION FOR THE PAST WEEK -8- FEEL THE FUTURE LOOKS GOOD` | `Q8:MENTAL CONDITION FOR THE PAST WEEK -9- THINK YOUR LIFE IS A FAILURE` | `Q8:MENTAL CONDITION FOR THE PAST WEEK -10- DID YOU FEEL SCARED?` | 
| **Table name** | `jstar_2007_5cities` | `jstar_2007_5cities` | `jstar_2007_5cities` | `jstar_2007_5cities` | `jstar_2007_5cities` | `jstar_2007_5cities` | `jstar_2007_5cities` | `jstar_2007_5cities` | `jstar_2007_5cities` | `jstar_2007_5cities` | 



| **Name** | `tome55`| `tome56` | `tome57` | `tome58` | `tome59` | `tome60` | `tome61` | `tome62` | `tome63` | `tome64` | 
|-|-|-|-|-|-|-|-|-|-|-| 
| **Label** | `Q8:MENTAL CONDITION FOR THE PAST WEEK -11- WAS YOUR SLEEP RESTLESS?`| `Q8:MENTAL CONDITION FOR THE PAST WEEK -12- DID YOU FEEL HAPPINESS?` | `Q8:MENTAL CONDITION FOR THE PAST WEEK -13- WERE YOU MORE SILENT THAN USUAL?` | `Q8:MENTAL CONDITION FOR THE PAST WEEK -14- DID YOU FEEL LONELY?` | `Q8:MENTAL CONDITION FOR THE PAST WEEK -15- FEEL STANDOFFISH FROM PEOPLE` | `Q8:MENTAL CONDITION FOR THE PAST WEEK -16- DID YOU FEEL DELIGHTFULNESS?` | `Q8:MENTAL CONDITION FOR THE PAST WEEK -17- DID YOU CRY OR FEEL LIKE CRYING?` | `Q8:MENTAL CONDITION FOR THE PAST WEEK -18- DID YOU FEEL SAD?` | `Q8:MENTAL CONDITION FOR THE PAST WEEK -19- FEEL AVERSION FROM PEOPLE` | `Q8:MENTAL CONDITION FOR THE PAST WEEK -20- DID YOU FEEL ENERVATION?` | 
| **Table name** | `jstar_2007_5cities` | `jstar_2007_5cities` | `jstar_2007_5cities` | `jstar_2007_5cities` | `jstar_2007_5cities` | `jstar_2007_5cities` | `jstar_2007_5cities` | `jstar_2007_5cities` | `jstar_2007_5cities` | `jstar_2007_5cities` | 



```{r assign_aksst1, echo=FALSE}
opal.assign.table.tibble(o, 'JSTAR_dep','JSTAR_datasets_restricted.jstar_2007_5cities',
                         variables=list('tome45', 'tome46', 'tome47', 'tome48', 'tome49', 'tome50', 'tome51', 'tome52', 'tome53', 'tome54', 'tome55', 'tome56', 'tome57', 'tome58', 'tome59', 'tome60', 'tome61', 'tome62', 'tome63', 'tome64'), missings = TRUE)
JSTAR_dep <- opal.execute(o,'JSTAR_dep')
```

```{r local_aksst1, echo=FALSE}
vari <- JSTAR_dep$tome45
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome46
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome47
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome48
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome49
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome50
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome51
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome52
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome53
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome54
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome55
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome56
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome57
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome58
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome59
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome60
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome61
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome62
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome63
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome64
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Harmonisation algorithm
To compute the harmonized variable from the study-specific variable it has to be recoded as follows:

First of all: 
* The reversed items tome48, tome52, tome56, tome60: 
  + `recode 1 into 3`
  + `keep 2`
  + `recode 3 into 1`
  + `recode 4 into 0`
* The direct items tome45, tome46, tome47,tome49, tome50, tome51, tome53, tome54, tome55, tome57, tome58, tome59, tome61, tome62, tome63, tome64: 
  + `recode 1 into 0`
  + `recode 2 into 1`
  + `recode 3 into 2`
  + `recode 4 into 3`

Secondly in order to get the final score the items have to be summed. If one to 4 items are missing, scores on the completed items are summed; the total is divided by the number of items answered and multiplied by 20. If more than 4 items are missing the individual get a missing value in the final score. 

After get the final score, it has to be recoded as follows: 

* `0-15 into 0`
* `>16 into 1`
* `NA into 999`


**R script:**

```{r harmo_aksst1, echo=TRUE}
#reversed items
JSTAR_dep$p48 <- car::recode(JSTAR_dep$tome48, "1=3; 3=1; 4=0")
JSTAR_dep$p52 <- car::recode(JSTAR_dep$tome52, "1=3; 3=1; 4=0")
JSTAR_dep$p56 <- car::recode(JSTAR_dep$tome56, "1=3; 3=1; 4=0")
JSTAR_dep$p60 <- car::recode(JSTAR_dep$tome60, "1=3; 3=1; 4=0")

#direct items
JSTAR_dep$p45 <- car::recode(JSTAR_dep$tome45, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p46 <- car::recode(JSTAR_dep$tome46, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p47 <- car::recode(JSTAR_dep$tome47, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p49 <- car::recode(JSTAR_dep$tome49, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p50 <- car::recode(JSTAR_dep$tome50, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p51 <- car::recode(JSTAR_dep$tome51, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p53 <- car::recode(JSTAR_dep$tome53, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p54 <- car::recode(JSTAR_dep$tome54, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p55 <- car::recode(JSTAR_dep$tome55, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p57 <- car::recode(JSTAR_dep$tome57, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p58 <- car::recode(JSTAR_dep$tome58, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p59 <- car::recode(JSTAR_dep$tome59, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p61 <- car::recode(JSTAR_dep$tome61, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p62 <- car::recode(JSTAR_dep$tome62, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p63 <- car::recode(JSTAR_dep$tome63, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p64 <- car::recode(JSTAR_dep$tome64, "1=0; 2=1; 3=2; 4=3")

JSTAR_dep$nmiss <- apply(JSTAR_dep[,22:41], MARGIN = 1, FUN = function(x) sum(is.na(x)))


JSTAR_dep$final_score <- apply(JSTAR_dep[,22:41], MARGIN = 1, FUN = function(x) sum(x, na.rm = TRUE))

JSTAR_dep$final_score[which(JSTAR_dep$nmiss>4)] <- 999

JSTAR_dep$final_score[which(JSTAR_dep$nmiss==3)] <- (JSTAR_dep$final_score[which(JSTAR_dep$nmiss==3)]/17)*20
JSTAR_dep$final_score[which(JSTAR_dep$nmiss==2)] <- (JSTAR_dep$final_score[which(JSTAR_dep$nmiss==2)]/18)*20
JSTAR_dep$final_score[which(JSTAR_dep$nmiss==1)] <- (JSTAR_dep$final_score[which(JSTAR_dep$nmiss==1)]/19)*20



JSTAR_aksst_ds_w1 <- tibble(id=JSTAR_dep$id)
JSTAR_aksst_ds_w1$depression <- car::recode(JSTAR_dep$final_score, "0:15.99999999=0; 16:900=1")
JSTAR_aksst_ds_w1$depression <- labelled(JSTAR_aksst_ds_w1[[2]], labels = c("no depression"=0, "depression"=1,  "Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996, "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistical description of the new harmonised variable
```{r descript_aksst1, echo=FALSE}
vari <- JSTAR_aksst_ds_w1$depression
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
ggplot(JSTAR_aksst_ds_w1, aes(x=factor(JSTAR_aksst_ds_w1[[2]]))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Validation
```{r crosstabulation_aksst1, echo=FALSE}
BeforeH <- c(sum(na.omit(JSTAR_dep$final_score)<16), sum(na.omit(JSTAR_dep$final_score)>=16 & na.omit(JSTAR_dep$final_score)<900), sum(na.omit(JSTAR_dep$final_score)==999))
AfterH <- table(JSTAR_aksst_ds_w1[[2]], useNA = "ifany")
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("<16->0",">=16->1", "NA->999") 
kable(C)
```


```{r importOPAL_aksst1, echo=FALSE}
#opal.assign.data(o, 'JSTAR_aksst_ds_w1', JSTAR_aksst_ds_w1)
#opal.symbol_import(o,'JSTAR_aksst_ds_w1', project='_Athlos_Harm_Dataset')

label(JSTAR_aksst_ds_w1$depression) <- ds_label_all
depression <- JSTAR_aksst_ds_w1
save(depression, file = "../RData/aksst_w1/depression.RData")
rm(depression, JSTAR_dep)

JSTAR_aksst_m_ds_w1 <- JSTAR_aksst_ds_w1
JSTAR_aksst_m_ds_w1$depression <- car::recode(JSTAR_aksst_m_ds_w1$depression, "c(991, 992, 993, 994, 995, 996, 997,998, 999)=NA")
#opal.assign.data(o, 'JSTAR_aksst_m_ds_w1', JSTAR_aksst_m_ds_w1)
#opal.symbol_import(o,'JSTAR_aksst_m_ds_w1', project='_Athlos_Harm_Dataset')
```





### Wave 2 

#### Study-specific variable description

| **Name** | `tome101`| `tome102` | `tome103` | `tome104` | `tome105` | `tome106` | `tome107` | `tome108` | `tome109` | `tome110` | 
|-|-|-|-|-|-|-|-|-|-|-| 
| **Label** | `Q10:MENTAL CONDITION LAST WEEK -1- FELT UNUSUAL IN SOME WAY`| `Q10:MENTAL CONDITION LAST WEEK -2- HAD NO APPETITE` | `Q10:MENTAL CONDITION LAST WEEK -3- COULD NOT BE CONSOLED BY FAMILY OR FRIENDS` | `Q10:MENTAL CONDITION LAST WEEK -4- FELT I COULD DO ANYTHING OTHERS COULD DO` | `Q10:MENTAL CONDITION LAST WEEK -5- COULD NOT CONCENTRATE` | `Q10:MENTAL CONDITION LAST WEEK -6- FELT DEPRESSED` | `Q10:MENTAL CONDITION LAST WEEK -7- FELT BOTHERSOME TO DO SOMETHING EFFORTLESS` | `Q10:MENTAL CONDITION LAST WEEK -8- FELT THE FUTURE WAS BRIGHT` | `Q10:MENTAL CONDITION LAST WEEK -9- FELT MY LIFE HAS BEEN A FAILURE` | `Q10:MENTAL CONDITION LAST WEEK -10- FELT FRIGHTENED` | 
| **Table name** | `jstar_2009_5cities` | `jstar_2009_5cities` | `jstar_2009_5cities` | `jstar_2009_5cities` | `jstar_2009_5cities` | `jstar_2009_5cities` | `jstar_2009_5cities` | `jstar_2009_5cities` | `jstar_2009_5cities` | `jstar_2009_5cities` | 


| **Name** | `tome111`| `tome112` | `tome113` | `tome114` | `tome115` | `tome116` | `tome117` | `tome118` | `tome119` | `tome120` | 
|-|-|-|-|-|-|-|-|-|-|-| 
| **Label** | `Q10:MENTAL CONDITION LAST WEEK -11- COULD NOT SLEEP WELL`| `Q10:MENTAL CONDITION LAST WEEK -12- FELT HAPPY` | `Q10:MENTAL CONDITION LAST WEEK -13- FELT MORE TACITURN THAN USUAL` | `Q10:MENTAL CONDITION LAST WEEK -14- FELT LONELY` | `Q10:MENTAL CONDITION LAST WEEK -15- PEOPLE AROUND ME SEEMED COLD TO ME` | `Q10:MENTAL CONDITION LAST WEEK -16- FELT HAPPY` | `Q10:MENTAL CONDITION LAST WEEK -17- CRIED OR FELT LIKE CRYING` | `Q10:MENTAL CONDITION LAST WEEK -18- FELT SAD` | `Q10:MENTAL CONDITION LAST WEEK -19- FELT THAT PEOPLE AROUND ME DISLIKED ME` | `Q10:MENTAL CONDITION LAST WEEK -20- DIDNâ???TT FEEL LIKE DOING ANYTHING` | 
| **Table name** | `jstar_2009_5cities` | `jstar_2009_5cities` | `jstar_2009_5cities` | `jstar_2009_5cities` | `jstar_2009_5cities` | `jstar_2009_5cities` | `jstar_2009_5cities` | `jstar_2009_5cities` | `jstar_2009_5cities` | `jstar_2009_5cities` | 

```{r assign_aksst2, echo=FALSE}
opal.assign.table.tibble(o, 'JSTAR_dep','JSTAR_datasets_restricted.jstar_2009_5cities',
                         variables=list('tome101', 'tome102', 'tome103', 'tome104', 'tome105', 'tome106', 'tome107', 'tome108', 'tome109', 'tome110', 'tome111', 'tome112', 'tome113', 'tome114', 'tome115', 'tome116', 'tome117', 'tome118', 'tome119', 'tome120'), missings = TRUE)
JSTAR_dep <- opal.execute(o,'JSTAR_dep')
```

```{r local_aksst2, echo=FALSE}
vari <- JSTAR_dep$tome101
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome102
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome103
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome104
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome105
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome106
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome107
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome108
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome109
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome110
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome111
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome112
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome113
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome114
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome115
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome116
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome117
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome118
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome119
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome120
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Harmonisation algorithm
To compute the harmonized variable from the study-specific variable it has to be recoded as follows:

First of all: 
* The reversed items tome104, tome108, tome112, tome116:
  + `recode 1 into 3`
  + `keep 2`
  + `recode 3 into 1`
  + `recode 4 into 0`
* The direct items tome101, tome102, tome103, tome105, tome106, tome107, tome109, tome110, tome111,tome113, tome114, tome115, tome117, tome118, tome119, tome120: 
  + `recode 1 into 0`
  + `recode 2 into 1`
  + `recode 3 into 2`
  + `recode 4 into 3`

Secondly in order to get the final score the items have to be summed. If one to 4 items are missing, scores on the completed items are summed; the total is divided by the number of items answered and multiplied by 20. If more than 4 items are missing the individual get a missing value in the final score. 

After get the final score, it has to be recoded as follows: 

* `0-15 into 0`
* `>16 into 1`
* `NA into 999`

**R script:**

```{r harmo_aksst2, echo=TRUE}
#reversed items
JSTAR_dep$p104 <- car::recode(JSTAR_dep$tome104, "1=3; 3=1; 4=0")
JSTAR_dep$p108 <- car::recode(JSTAR_dep$tome108, "1=3; 3=1; 4=0")
JSTAR_dep$p112 <- car::recode(JSTAR_dep$tome112, "1=3; 3=1; 4=0")
JSTAR_dep$p116 <- car::recode(JSTAR_dep$tome116, "1=3; 3=1; 4=0")

#direct items
JSTAR_dep$p45 <- car::recode(JSTAR_dep$tome101, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p46 <- car::recode(JSTAR_dep$tome102, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p47 <- car::recode(JSTAR_dep$tome103, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p49 <- car::recode(JSTAR_dep$tome105, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p50 <- car::recode(JSTAR_dep$tome106, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p51 <- car::recode(JSTAR_dep$tome107, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p53 <- car::recode(JSTAR_dep$tome109, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p54 <- car::recode(JSTAR_dep$tome110, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p55 <- car::recode(JSTAR_dep$tome111, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p57 <- car::recode(JSTAR_dep$tome113, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p58 <- car::recode(JSTAR_dep$tome114, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p59 <- car::recode(JSTAR_dep$tome115, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p61 <- car::recode(JSTAR_dep$tome117, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p62 <- car::recode(JSTAR_dep$tome118, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p63 <- car::recode(JSTAR_dep$tome119, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p64 <- car::recode(JSTAR_dep$tome120, "1=0; 2=1; 3=2; 4=3")

JSTAR_dep$nmiss <- apply(JSTAR_dep[,22:41], MARGIN = 1, FUN = function(x) sum(is.na(x)))


JSTAR_dep$final_score <- apply(JSTAR_dep[,22:41], MARGIN = 1, FUN = function(x) sum(x, na.rm = TRUE))

JSTAR_dep$final_score[which(JSTAR_dep$nmiss>4)] <- 999

JSTAR_dep$final_score[which(JSTAR_dep$nmiss==3)] <- (JSTAR_dep$final_score[which(JSTAR_dep$nmiss==3)]/17)*20
JSTAR_dep$final_score[which(JSTAR_dep$nmiss==2)] <- (JSTAR_dep$final_score[which(JSTAR_dep$nmiss==2)]/18)*20
JSTAR_dep$final_score[which(JSTAR_dep$nmiss==1)] <- (JSTAR_dep$final_score[which(JSTAR_dep$nmiss==1)]/19)*20


JSTAR_aksst_ds_w2 <- tibble(id=JSTAR_dep$id)
JSTAR_aksst_ds_w2$depression <- car::recode(JSTAR_dep$final_score, "0:15.99999999=0; 16:900=1")
JSTAR_aksst_ds_w2$depression <- labelled(JSTAR_aksst_ds_w2[[2]], labels = c("no depression"=0, "depression"=1,  "Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996, "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistical description of the new harmonised variable
```{r descript_aksst2, echo=FALSE}
vari <- JSTAR_aksst_ds_w2$depression
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
ggplot(JSTAR_aksst_ds_w2, aes(x=factor(JSTAR_aksst_ds_w2[[2]]))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Validation
```{r crosstabulation_aksst2, echo=FALSE}
BeforeH <- c(sum(na.omit(JSTAR_dep$final_score)<16), sum(na.omit(JSTAR_dep$final_score)>=16 & na.omit(JSTAR_dep$final_score)<900), sum(na.omit(JSTAR_dep$final_score)==999))
AfterH <- table(JSTAR_aksst_ds_w2[[2]], useNA = "ifany")
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("<16->0",">=16->1", "NA->999") 
kable(C)
```


```{r importOPAL_aksst2, echo=FALSE}
#opal.assign.data(o, 'JSTAR_aksst_ds_w2', JSTAR_aksst_ds_w2)
#opal.symbol_import(o,'JSTAR_aksst_ds_w2', project='_Athlos_Harm_Dataset')

label(JSTAR_aksst_ds_w2$depression) <- ds_label_all
depression <- JSTAR_aksst_ds_w2
save(depression, file = "../RData/aksst_w2/depression.RData")
rm(depression, JSTAR_dep)

JSTAR_aksst_m_ds_w2 <- JSTAR_aksst_ds_w2
JSTAR_aksst_m_ds_w2$depression <- car::recode(JSTAR_aksst_m_ds_w2$depression, "c(991, 992, 993, 994, 995, 996, 997,998, 999)=NA")
opal.assign.data(o, 'JSTAR_aksst_m_ds_w2', JSTAR_aksst_m_ds_w2)
#opal.symbol_import(o,'JSTAR_aksst_m_ds_w2', project='_Athlos_Harm_Dataset')
```







### Wave 3 

#### Study-specific variable description



| **Name** | `q8_1`| `q8_2` | `q8_3` | `q8_4` | `q8_5` | `q8_6` | `q8_7` | `q8_8` | `q8_9` | `q8_10` | 
|-|-|-|-|-|-|-|-|-|-|-| 
| **Label** | `11Q8:CONDITION LAST WEEK -1- FELT UNUSUAL IN SOME WAY`| `11Q8:CONDITION LAST WEEK -2- HAD NO APPETITE` | `11Q8:CONDITION LAST WEEK -3- COULD NOT BE CONSOLED BY FAMILY OR FRIENDS` | `11Q8:CONDITION LAST WEEK -4- FELT I COULD DO ANYTHING OTHERS COULD DO` | `11Q8:CONDITION LAST WEEK -5- COULD NOT CONCENTRATE` | `11Q8:CONDITION LAST WEEK -6- FELT DEPRESSED` | `11Q8:CONDITION LAST WEEK -7- FELT BOTHERSOME TO DO SOMETHING EFFORTLESS` | `11Q8:CONDITION LAST WEEK -8- FELT THE FUTURE WAS BRIGHT` | `11Q8:CONDITION LAST WEEK -9- FELT MY LIFE HAS BEEN A FAILURE` | `11Q8:CONDITION LAST WEEK -10- FELT FRIGHTENED` | 
| **Table name** | `jstar_2011_5cities` | `jstar_2011_5cities` | `jstar_2011_5cities` | `jstar_2011_5cities` | `jstar_2011_5cities` | `jstar_2011_5cities` | `jstar_2011_5cities` | `jstar_2011_5cities` | `jstar_2011_5cities` | `jstar_2011_5cities` | 


| **Name** | `q8_11`| `q8_12` | `q8_13` | `q8_14` | `q8_15` | `q8_16` | `q8_17` | `q8_18` | `q8_19` | `q8_20` | 
|-|-|-|-|-|-|-|-|-|-|-| 
| **Label** | `11Q8:CONDITION LAST WEEK -11- COULD NOT SLEEP WELL`| `11Q8:CONDITION LAST WEEK -12- FELT HAPPY` | `11Q8:CONDITION LAST WEEK -13- FELT MORE TACITURN THAN USUAL` | `11Q8:CONDITION LAST WEEK -14- FELT LONELY` | `11Q8:CONDITION LAST WEEK -15- PEOPLE AROUND ME SEEMED COLD TO ME` | `11Q8:CONDITION LAST WEEK -16- FELT HAPPY` | `11Q8:CONDITION LAST WEEK -17- CRIED OR FELT LIKE CRYING` | `11Q8:CONDITION LAST WEEK -18- FELT SAD` | `11Q8:CONDITION LAST WEEK -19- FELT THAT PEOPLE AROUND ME DISLIKED ME` | `11Q8:CONDITION LAST WEEK -20- DIDNÕT FEEL LIKE DOING ANYTHING` | 
| **Table name** | `jstar_2011_5cities` | `jstar_2011_5cities` | `jstar_2011_5cities` | `jstar_2011_5cities` | `jstar_2011_5cities` | `jstar_2011_5cities` | `jstar_2011_5cities` | `jstar_2011_5cities` | `jstar_2011_5cities` | `jstar_2011_5cities` | 



```{r assign_aksst3, echo=FALSE}
opal.assign.table.tibble(o, 'JSTAR_dep','JSTAR_datasets_restricted.jstar_2011_5cities',
                         variables=list('q8_1', 'q8_2', 'q8_3', 'q8_4', 'q8_5', 'q8_6', 'q8_7', 'q8_8', 'q8_9', 'q8_10', 'q8_11', 'q8_12', 'q8_13', 'q8_14', 'q8_15', 'q8_16', 'q8_17', 'q8_18', 'q8_19', 'q8_20'), missings = TRUE)
JSTAR_dep <- opal.execute(o,'JSTAR_dep')
```

```{r local_aksst3, echo=FALSE}
vari <- JSTAR_dep$q8_1
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_2
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_3
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_4
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_5
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_6
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_7
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_8
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_9
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_10
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_11
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_12
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_13
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_14
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_15
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_16
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_17
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_18
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_19
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_20
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Harmonisation algorithm
To compute the harmonized variable from the study-specific variable it has to be recoded as follows:

First of all: 
* The reversed items q8_4, q8_8, q8_12,  q8_16: 
  + `recode 1 into 3`
  + `keep 2`
  + `recode 3 into 1`
  + `recode 4 into 0`
* The direct items q8_1, q8_2, q8_3, q8_5, q8_6, q8_7, q8_9, q8_10, q8_11, q8_13, q8_14, q8_15, q8_17, q8_18, q8_19, q8_20: 
  + `recode 1 into 0`
  + `recode 2 into 1`
  + `recode 3 into 2`
  + `recode 4 into 3`

Secondly in order to get the final score the items have to be summed. If one to 4 items are missing, scores on the completed items are summed; the total is divided by the number of items answered and multiplied by 20. If more than 4 items are missing the individual get a missing value in the final score. 

After get the final score, it has to be recoded as follows: 

* `0-15 into 0`
* `>16 into 1`
* `NA into 999`

**R script:**

```{r harmo_aksst3, echo=TRUE}
JSTAR_dep$q8_14 <- as.numeric(JSTAR_dep$q8_14)
JSTAR_dep$q8_15 <- as.numeric(JSTAR_dep$q8_15)

#reversed items
JSTAR_dep$p4 <- car::recode(JSTAR_dep$q8_4, "1=3; 3=1; 4=0")
JSTAR_dep$p8 <- car::recode(JSTAR_dep$q8_8, "1=3; 3=1; 4=0")
JSTAR_dep$p12 <- car::recode(JSTAR_dep$q8_12, "1=3; 3=1; 4=0")
JSTAR_dep$p16 <- car::recode(JSTAR_dep$q8_16, "1=3; 3=1; 4=0")

#direct items
JSTAR_dep$p1 <- car::recode(JSTAR_dep$q8_1, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p2 <- car::recode(JSTAR_dep$q8_2, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p3 <- car::recode(JSTAR_dep$q8_3, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p5 <- car::recode(JSTAR_dep$q8_5, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p6 <- car::recode(JSTAR_dep$q8_6, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p7 <- car::recode(JSTAR_dep$q8_7, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p9 <- car::recode(JSTAR_dep$q8_9, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p10 <- car::recode(JSTAR_dep$q8_10, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p11 <- car::recode(JSTAR_dep$q8_11, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p13 <- car::recode(JSTAR_dep$q8_13, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p14 <- car::recode(JSTAR_dep$q8_14, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p15 <- car::recode(JSTAR_dep$q8_15, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p17 <- car::recode(JSTAR_dep$q8_17, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p18 <- car::recode(JSTAR_dep$q8_18, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p19 <- car::recode(JSTAR_dep$q8_19, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p20 <- car::recode(JSTAR_dep$q8_20, "1=0; 2=1; 3=2; 4=3")

JSTAR_dep$nmiss <- apply(JSTAR_dep[,22:41], MARGIN = 1, FUN = function(x) sum(is.na(x)))


JSTAR_dep$final_score <- apply(JSTAR_dep[,22:41], MARGIN = 1, FUN = function(x) sum(x, na.rm = TRUE))

JSTAR_dep$final_score[which(JSTAR_dep$nmiss>4)] <- 999

JSTAR_dep$final_score[which(JSTAR_dep$nmiss==3)] <- (JSTAR_dep$final_score[which(JSTAR_dep$nmiss==3)]/17)*20
JSTAR_dep$final_score[which(JSTAR_dep$nmiss==2)] <- (JSTAR_dep$final_score[which(JSTAR_dep$nmiss==2)]/18)*20
JSTAR_dep$final_score[which(JSTAR_dep$nmiss==1)] <- (JSTAR_dep$final_score[which(JSTAR_dep$nmiss==1)]/19)*20

JSTAR_aksst_ds_w3 <- tibble(id=JSTAR_dep$id)
JSTAR_aksst_ds_w3$depression <- car::recode(JSTAR_dep$final_score, "0:15.99999999=0; 16:900=1")
JSTAR_aksst_ds_w3$depression <- labelled(JSTAR_aksst_ds_w3[[2]], labels = c("no depression"=0, "depression"=1,  "Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996, "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistical description of the new harmonised variable
```{r descript_aksst3, echo=FALSE}
vari <- JSTAR_aksst_ds_w3$depression
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
ggplot(JSTAR_aksst_ds_w3, aes(x=factor(JSTAR_aksst_ds_w3[[2]]))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```


#### Validation
```{r crosstabulation_aksst3, echo=FALSE}
BeforeH <- c(sum(na.omit(JSTAR_dep$final_score)<16), sum(na.omit(JSTAR_dep$final_score)>=16 & na.omit(JSTAR_dep$final_score)<900), sum(na.omit(JSTAR_dep$final_score)==999))
AfterH <- table(JSTAR_aksst_ds_w3[[2]], useNA = "ifany")
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("<16->0",">=16->1", "NA->999") 
kable(C)
```


```{r importOPAL_aksst3, echo=FALSE}
#opal.assign.data(o, 'JSTAR_aksst_ds_w3', JSTAR_aksst_ds_w3)
#opal.symbol_import(o,'JSTAR_aksst_ds_w3', project='_Athlos_Harm_Dataset')

label(JSTAR_aksst_ds_w3$depression) <- ds_label_all
depression <- JSTAR_aksst_ds_w3
save(depression, file = "../RData/aksst_w3/depression.RData")
rm(depression, JSTAR_dep)

JSTAR_aksst_m_ds_w3 <- JSTAR_aksst_ds_w3
JSTAR_aksst_m_ds_w3$depression <- car::recode(JSTAR_aksst_m_ds_w3$depression, "c(991, 992, 993, 994, 995, 996, 997,998, 999)=NA")
#opal.assign.data(o, 'JSTAR_aksst_m_ds_w3', JSTAR_aksst_m_ds_w3)
#opal.symbol_import(o,'JSTAR_aksst_m_ds_w3', project='_Athlos_Harm_Dataset')
```





## tn 

### Wave 1 

#### Study-specific variable description


| **Name** | `tome45`| `tome46` | `tome47` | `tome48` | `tome49` | `tome50` | `tome51` | `tome52` | `tome53` | `tome54` | 
|-|-|-|-|-|-|-|-|-|-|-| 
| **Label** | `Q8:MENTAL CONDITION LAST WEEK -1- FELT UNUSUAL IN SOME WAY`| `Q8:MENTAL CONDITION LAST WEEK -2- HAD NO APPETITE` | `Q8:MENTAL CONDITION LAST WEEK -3- COULD NOT BE CONSOLED BY FAMILY OR FRIENDS` | `Q8:MENTAL CONDITION LAST WEEK -4- FELT I COULD DO ANYTHING OTHERS COULD DO` | `Q8:MENTAL CONDITION LAST WEEK -5- COULD NOT CONCENTRATE` | `Q8:MENTAL CONDITION LAST WEEK -6- FELT DEPRESSED` | `Q8:MENTAL CONDITION LAST WEEK -7- FELT BOTHERSOME TO DO SOMETHING EFFORTLESS` | `Q8:MENTAL CONDITION LAST WEEK -8- FELT THE FUTURE WAS BRIGHT` | `Q8:MENTAL CONDITION LAST WEEK -9- FELT MY LIFE HAS BEEN A FAILURE` | `Q8:MENTAL CONDITION LAST WEEK -10- FELT FRIGHTENED` | 
| **Table name** | `jstar_2009_2cities` | `jstar_2009_2cities` | `jstar_2009_2cities` | `jstar_2009_2cities` | `jstar_2009_2cities` | `jstar_2009_2cities` | `jstar_2009_2cities` | `jstar_2009_2cities` | `jstar_2009_2cities` | `jstar_2009_2cities` | 


| **Name** | `tome55`| `tome56` | `tome57` | `tome58` | `tome59` | `tome60` | `tome61` | `tome62` | `tome63` | `tome64` | 
|-|-|-|-|-|-|-|-|-|-|-| 
| **Label** | `Q8:MENTAL CONDITION LAST WEEK -11- COULD NOT SLEEP WELL`| `Q8:MENTAL CONDITION LAST WEEK -12- FELT HAPPY` | `Q8:MENTAL CONDITION LAST WEEK -13- FELT MORE TACITURN THAN USUAL` | `Q8:MENTAL CONDITION LAST WEEK -14- FELT LONELY` | `Q8:MENTAL CONDITION LAST WEEK -15- PEOPLE AROUND ME SEEMED COLD TO ME` | `Q8:MENTAL CONDITION LAST WEEK -16- FELT HAPPY` | `Q8:MENTAL CONDITION LAST WEEK -17- CRIED OR FELT LIKE CRYING` | `Q8:MENTAL CONDITION LAST WEEK -18- FELT SAD` | `Q8:MENTAL CONDITION LAST WEEK -19- FELT THAT PEOPLE AROUND ME DISLIKED ME` | `Q8:MENTAL CONDITION LAST WEEK -20- DIDNâ???TT FEEL LIKE DOING ANYTHING` | 
| **Table name** | `jstar_2009_2cities` | `jstar_2009_2cities` | `jstar_2009_2cities` | `jstar_2009_2cities` | `jstar_2009_2cities` | `jstar_2009_2cities` | `jstar_2009_2cities` | `jstar_2009_2cities` | `jstar_2009_2cities` | `jstar_2009_2cities` |

```{r assign_tn1, echo=FALSE}
opal.assign.table.tibble(o, 'JSTAR_dep','JSTAR_datasets_restricted.jstar_2009_2cities',
                         variables=list('tome45', 'tome46', 'tome47', 'tome48', 'tome49', 'tome50', 'tome51', 'tome52', 'tome53', 'tome54', 'tome55', 'tome56', 'tome57', 'tome58', 'tome59', 'tome60', 'tome61', 'tome62', 'tome63', 'tome64'), missings = TRUE)
JSTAR_dep <- opal.execute(o,'JSTAR_dep')
```

```{r local_tn1, echo=FALSE}
vari <- JSTAR_dep$tome45
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome46
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome47
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome48
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome49
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome50
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome51
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome52
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome53
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome54
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome55
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome56
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome57
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome58
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome59
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome60
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome61
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome62
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome63
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$tome64
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Harmonisation algorithm
To compute the harmonized variable from the study-specific variable it has to be recoded as follows:

First of all: 
* The reversed items tome48, tome52, tome56, tome60: 
  + `recode 1 into 3`
  + `keep 2`
  + `recode 3 into 1`
  + `recode 4 into 0`
* The direct items tome45, tome46, tome47,tome49, tome50, tome51, tome53, tome54, tome55, tome57, tome58, tome59, tome61, tome62, tome63, tome64: 
  + `recode 1 into 0`
  + `recode 2 into 1`
  + `recode 3 into 2`
  + `recode 4 into 3`

Secondly in order to get the final score the items have to be summed. If one to 4 items are missing, scores on the completed items are summed; the total is divided by the number of items answered and multiplied by 20. If more than 4 items are missing the individual get a missing value in the final score. 

After get the final score, it has to be recoded as follows: 

* `0-15 into 0`
* `>16 into 1`
* `NA into 999`

**R script:**

```{r harmo_tn1, echo=TRUE}
#reversed items
JSTAR_dep$p48 <- car::recode(JSTAR_dep$tome48, "1=3; 3=1; 4=0")
JSTAR_dep$p52 <- car::recode(JSTAR_dep$tome52, "1=3; 3=1; 4=0")
JSTAR_dep$p56 <- car::recode(JSTAR_dep$tome56, "1=3; 3=1; 4=0")
JSTAR_dep$p60 <- car::recode(JSTAR_dep$tome60, "1=3; 3=1; 4=0")

#direct items
JSTAR_dep$p45 <- car::recode(JSTAR_dep$tome45, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p46 <- car::recode(JSTAR_dep$tome46, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p47 <- car::recode(JSTAR_dep$tome47, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p49 <- car::recode(JSTAR_dep$tome49, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p50 <- car::recode(JSTAR_dep$tome50, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p51 <- car::recode(JSTAR_dep$tome51, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p53 <- car::recode(JSTAR_dep$tome53, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p54 <- car::recode(JSTAR_dep$tome54, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p55 <- car::recode(JSTAR_dep$tome55, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p57 <- car::recode(JSTAR_dep$tome57, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p58 <- car::recode(JSTAR_dep$tome58, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p59 <- car::recode(JSTAR_dep$tome59, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p61 <- car::recode(JSTAR_dep$tome61, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p62 <- car::recode(JSTAR_dep$tome62, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p63 <- car::recode(JSTAR_dep$tome63, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p64 <- car::recode(JSTAR_dep$tome64, "1=0; 2=1; 3=2; 4=3")

JSTAR_dep$nmiss <- apply(JSTAR_dep[,22:41], MARGIN = 1, FUN = function(x) sum(is.na(x)))


JSTAR_dep$final_score <- apply(JSTAR_dep[,22:41], MARGIN = 1, FUN = function(x) sum(x, na.rm = TRUE))

JSTAR_dep$final_score[which(JSTAR_dep$nmiss>4)] <- 999

JSTAR_dep$final_score[which(JSTAR_dep$nmiss==3)] <- (JSTAR_dep$final_score[which(JSTAR_dep$nmiss==3)]/17)*20
JSTAR_dep$final_score[which(JSTAR_dep$nmiss==2)] <- (JSTAR_dep$final_score[which(JSTAR_dep$nmiss==2)]/18)*20
JSTAR_dep$final_score[which(JSTAR_dep$nmiss==1)] <- (JSTAR_dep$final_score[which(JSTAR_dep$nmiss==1)]/19)*20

JSTAR_tn_ds_w1 <- tibble(id=JSTAR_dep$id)
JSTAR_tn_ds_w1$depression <- car::recode(JSTAR_dep$final_score, "0:15.99999999=0; 16:900=1")
JSTAR_tn_ds_w1$depression <- labelled(JSTAR_tn_ds_w1[[2]], labels = c("no depression"=0, "depression"=1,  "Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996, "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistical description of the new harmonised variable
```{r descript_tn1, echo=FALSE}
vari <- JSTAR_tn_ds_w1$depression
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
ggplot(JSTAR_tn_ds_w1, aes(x=factor(JSTAR_tn_ds_w1[[2]]))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Validation
```{r crosstabulation_tn1, echo=FALSE}
BeforeH <- c(sum(na.omit(JSTAR_dep$final_score)<16), sum(na.omit(JSTAR_dep$final_score)>=16 & na.omit(JSTAR_dep$final_score)<900), sum(na.omit(JSTAR_dep$final_score)==999))
AfterH <- table(JSTAR_tn_ds_w1[[2]], useNA = "ifany")
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("<16->0",">=16->1", "NA->999") 
kable(C)
```


```{r importOPAL_tn1, echo=FALSE}
#opal.assign.data(o, 'JSTAR_tn_ds_w1', JSTAR_tn_ds_w1)
#opal.symbol_import(o,'JSTAR_tn_ds_w1', project='_Athlos_Harm_Dataset')

label(JSTAR_tn_ds_w1$depression) <- ds_label_all
depression <- JSTAR_tn_ds_w1
save(depression, file = "../RData/tn_w1/depression.RData")
rm(depression, JSTAR_dep)

JSTAR_tn_m_ds_w1 <- JSTAR_tn_ds_w1
JSTAR_tn_m_ds_w1$depression <- car::recode(JSTAR_tn_m_ds_w1$depression, "c(991, 992, 993, 994, 995, 996, 997,998, 999)=NA")
opal.assign.data(o, 'JSTAR_tn_m_ds_w1', JSTAR_tn_m_ds_w1)
#opal.symbol_import(o,'JSTAR_tn_m_ds_w1', project='_Athlos_Harm_Dataset')
```







### Wave 2 

#### Study-specific variable description

| **Name** | `q8_1`| `q8_2` | `q8_3` | `q8_4` | `q8_5` | `q8_6` | `q8_7` | `q8_8` | `q8_9` | `q8_10` | 
|-|-|-|-|-|-|-|-|-|-|-| 
| **Label** | `11Q8:CONDITION LAST WEEK -1- FELT UNUSUAL IN SOME WAY`| `11Q8:CONDITION LAST WEEK -2- HAD NO APPETITE` | `11Q8:CONDITION LAST WEEK -3- COULD NOT BE CONSOLED BY FAMILY OR FRIENDS` | `11Q8:CONDITION LAST WEEK -4- FELT I COULD DO ANYTHING OTHERS COULD DO` | `11Q8:CONDITION LAST WEEK -5- COULD NOT CONCENTRATE` | `11Q8:CONDITION LAST WEEK -6- FELT DEPRESSED` | `11Q8:CONDITION LAST WEEK -7- FELT BOTHERSOME TO DO SOMETHING EFFORTLESS` | `11Q8:CONDITION LAST WEEK -8- FELT THE FUTURE WAS BRIGHT` | `11Q8:CONDITION LAST WEEK -9- FELT MY LIFE HAS BEEN A FAILURE` | `11Q8:CONDITION LAST WEEK -10- FELT FRIGHTENED` | 
| **Table name** | `jstar_2011_2cities` | `jstar_2011_2cities` | `jstar_2011_2cities` | `jstar_2011_2cities` | `jstar_2011_2cities` | `jstar_2011_2cities` | `jstar_2011_2cities` | `jstar_2011_2cities` | `jstar_2011_2cities` | `jstar_2011_2cities` | 

| **Name** | `q8_11`| `q8_12` | `q8_13` | `q8_14` | `q8_15` | `q8_16` | `q8_17` | `q8_18` | `q8_19` | `q8_20` | 
|-|-|-|-|-|-|-|-|-|-|-| 
| **Label** | `11Q8:CONDITION LAST WEEK -11- COULD NOT SLEEP WELL`| `11Q8:CONDITION LAST WEEK -12- FELT HAPPY` | `11Q8:CONDITION LAST WEEK -13- FELT MORE TACITURN THAN USUAL` | `11Q8:CONDITION LAST WEEK -14- FELT LONELY` | `11Q8:CONDITION LAST WEEK -15- PEOPLE AROUND ME SEEMED COLD TO ME` | `11Q8:CONDITION LAST WEEK -16- FELT HAPPY` | `11Q8:CONDITION LAST WEEK -17- CRIED OR FELT LIKE CRYING` | `11Q8:CONDITION LAST WEEK -18- FELT SAD` | `11Q8:CONDITION LAST WEEK -19- FELT THAT PEOPLE AROUND ME DISLIKED ME` | `11Q8:CONDITION LAST WEEK -20- DIDNÕT FEEL LIKE DOING ANYTHING` | 
| **Table name** | `jstar_2011_2cities` | `jstar_2011_2cities` | `jstar_2011_2cities` | `jstar_2011_2cities` | `jstar_2011_2cities` | `jstar_2011_2cities` | `jstar_2011_2cities` | `jstar_2011_2cities` | `jstar_2011_2cities` | `jstar_2011_2cities` | 

```{r assign_tn2, echo=FALSE}
opal.assign.table.tibble(o, 'JSTAR_dep','JSTAR_datasets_restricted.jstar_2011_2cities',
                         variables=list('q8_1', 'q8_2', 'q8_3', 'q8_4', 'q8_5', 'q8_6', 'q8_7', 'q8_8', 'q8_9', 'q8_10', 'q8_11', 'q8_12', 'q8_13', 'q8_14', 'q8_15', 'q8_16', 'q8_17', 'q8_18', 'q8_19', 'q8_20'), missings = TRUE)
JSTAR_dep <- opal.execute(o,'JSTAR_dep')
```

```{r local_tn2, echo=FALSE}
vari <- JSTAR_dep$q8_1
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_2
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_3
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_4
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_5
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_6
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_7
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_8
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_9
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_10
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_11
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_12
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_13
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_14
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_15
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_16
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_17
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_18
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_19
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_20
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Harmonisation algorithm
To compute the harmonized variable from the study-specific variable it has to be recoded as follows:

First of all: 
* The reversed items q8_4, q8_8, q8_12,  q8_16: 
  + `recode 1 into 3`
  + `keep 2`
  + `recode 3 into 1`
  + `recode 4 into 0`
* The direct items q8_1, q8_2, q8_3, q8_5, q8_6, q8_7, q8_9, q8_10, q8_11, q8_13, q8_14, q8_15, q8_17, q8_18, q8_19, q8_20: 
  + `recode 1 into 0`
  + `recode 2 into 1`
  + `recode 3 into 2`
  + `recode 4 into 3`

Secondly in order to get the final score the items have to be summed. If one to 4 items are missing, scores on the completed items are summed; the total is divided by the number of items answered and multiplied by 20. If more than 4 items are missing the individual get a missing value in the final score. 

After get the final score, it has to be recoded as follows: 

* `0-15 into 0`
* `>16 into 1`
* `NA into 999`

**R script:**

```{r harmo_tn2, echo=TRUE}
JSTAR_dep$q8_14 <- as.numeric(JSTAR_dep$q8_14)
JSTAR_dep$q8_15 <- as.numeric(JSTAR_dep$q8_15)

#reversed items
JSTAR_dep$p4 <- car::recode(JSTAR_dep$q8_4, "1=3; 3=1; 4=0")
JSTAR_dep$p8 <- car::recode(JSTAR_dep$q8_8, "1=3; 3=1; 4=0")
JSTAR_dep$p12 <- car::recode(JSTAR_dep$q8_12, "1=3; 3=1; 4=0")
JSTAR_dep$p16 <- car::recode(JSTAR_dep$q8_16, "1=3; 3=1; 4=0")

#direct items
JSTAR_dep$p1 <- car::recode(JSTAR_dep$q8_1, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p2 <- car::recode(JSTAR_dep$q8_2, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p3 <- car::recode(JSTAR_dep$q8_3, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p5 <- car::recode(JSTAR_dep$q8_5, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p6 <- car::recode(JSTAR_dep$q8_6, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p7 <- car::recode(JSTAR_dep$q8_7, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p9 <- car::recode(JSTAR_dep$q8_9, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p10 <- car::recode(JSTAR_dep$q8_10, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p11 <- car::recode(JSTAR_dep$q8_11, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p13 <- car::recode(JSTAR_dep$q8_13, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p14 <- car::recode(JSTAR_dep$q8_14, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p15 <- car::recode(JSTAR_dep$q8_15, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p17 <- car::recode(JSTAR_dep$q8_17, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p18 <- car::recode(JSTAR_dep$q8_18, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p19 <- car::recode(JSTAR_dep$q8_19, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p20 <- car::recode(JSTAR_dep$q8_20, "1=0; 2=1; 3=2; 4=3")

JSTAR_dep$nmiss <- apply(JSTAR_dep[,22:41], MARGIN = 1, FUN = function(x) sum(is.na(x)))


JSTAR_dep$final_score <- apply(JSTAR_dep[,22:41], MARGIN = 1, FUN = function(x) sum(x, na.rm = TRUE))

JSTAR_dep$final_score[which(JSTAR_dep$nmiss>4)] <- 999

JSTAR_dep$final_score[which(JSTAR_dep$nmiss==3)] <- (JSTAR_dep$final_score[which(JSTAR_dep$nmiss==3)]/17)*20
JSTAR_dep$final_score[which(JSTAR_dep$nmiss==2)] <- (JSTAR_dep$final_score[which(JSTAR_dep$nmiss==2)]/18)*20
JSTAR_dep$final_score[which(JSTAR_dep$nmiss==1)] <- (JSTAR_dep$final_score[which(JSTAR_dep$nmiss==1)]/19)*20


JSTAR_tn_ds_w2 <- tibble(id=JSTAR_dep$id)
JSTAR_tn_ds_w2$depression <- car::recode(JSTAR_dep$final_score, "0:15.99999999=0; 16:900=1")
JSTAR_tn_ds_w2$depression <- labelled(JSTAR_tn_ds_w2[[2]], labels = c("no depression"=0, "depression"=1,  "Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996, "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistical description of the new harmonised variable
```{r descript_tn2, echo=FALSE}
vari <- JSTAR_tn_ds_w2$depression
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
ggplot(JSTAR_tn_ds_w2, aes(x=factor(JSTAR_tn_ds_w2[[2]]))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Validation
```{r crosstabulation_tn2, echo=FALSE}
BeforeH <- c(sum(na.omit(JSTAR_dep$final_score)<16), sum(na.omit(JSTAR_dep$final_score)>=16 & na.omit(JSTAR_dep$final_score)<900), sum(na.omit(JSTAR_dep$final_score)==999))
AfterH <- table(JSTAR_tn_ds_w2[[2]], useNA = "ifany")
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("<16->0",">=16->1", "NA->999") 
kable(C)
```


```{r importOPAL_tn2, echo=FALSE}
#opal.assign.data(o, 'JSTAR_tn_ds_w2', JSTAR_tn_ds_w2)
#opal.symbol_import(o,'JSTAR_tn_ds_w2', project='_Athlos_Harm_Dataset')

label(JSTAR_tn_ds_w2$depression) <- ds_label_all
depression <- JSTAR_tn_ds_w2
save(depression, file = "../RData/tn_w2/depression.RData")
rm(depression, JSTAR_dep)

JSTAR_tn_m_ds_w2 <- JSTAR_tn_ds_w2
JSTAR_tn_m_ds_w2$depression <- car::recode(JSTAR_tn_m_ds_w2$depression, "c(991, 992, 993, 994, 995, 996, 997,998, 999)=NA")
#opal.assign.data(o, 'JSTAR_tn_m_ds_w2', JSTAR_tn_m_ds_w2)
#opal.symbol_import(o,'JSTAR_tn_m_ds_w2', project='_Athlos_Harm_Dataset')
```





## cth 

### Wave 1 

#### Study-specific variable description

 
| **Name** | `q8_1`| `q8_2` | `q8_3` | `q8_4` | `q8_5` | `q8_6` | `q8_7` | `q8_8` | `q8_9` | `q8_10` | 
|-|-|-|-|-|-|-|-|-|-|-| 
| **Label** | `11Q8:CONDITION LAST WEEK -1- FELT UNUSUAL IN SOME WAY`| `11Q8:CONDITION LAST WEEK -2- HAD NO APPETITE` | `11Q8:CONDITION LAST WEEK -3- COULD NOT BE CONSOLED BY FAMILY OR FRIENDS` | `11Q8:CONDITION LAST WEEK -4- FELT I COULD DO ANYTHING OTHERS COULD DO` | `11Q8:CONDITION LAST WEEK -5- COULD NOT CONCENTRATE` | `11Q8:CONDITION LAST WEEK -6- FELT DEPRESSED` | `11Q8:CONDITION LAST WEEK -7- FELT BOTHERSOME TO DO SOMETHING EFFORTLESS` | `11Q8:CONDITION LAST WEEK -8- FELT THE FUTURE WAS BRIGHT` | `11Q8:CONDITION LAST WEEK -9- FELT MY LIFE HAS BEEN A FAILURE` | `11Q8:CONDITION LAST WEEK -10- FELT FRIGHTENED` | 
| **Table name** | `jstar_2011_3cities` | `jstar_2011_3cities` | `jstar_2011_3cities` | `jstar_2011_3cities` | `jstar_2011_3cities` | `jstar_2011_3cities` | `jstar_2011_3cities` | `jstar_2011_3cities` | `jstar_2011_3cities` | `jstar_2011_3cities` | 


| **Name** | `q8_11`| `q8_12` | `q8_13` | `q8_14` | `q8_15` | `q8_16` | `q8_17` | `q8_18` | `q8_19` | `q8_20` | 
|-|-|-|-|-|-|-|-|-|-|-| 
| **Label** | `11Q8:CONDITION LAST WEEK -11- COULD NOT SLEEP WELL`| `11Q8:CONDITION LAST WEEK -12- FELT HAPPY` | `11Q8:CONDITION LAST WEEK -13- FELT MORE TACITURN THAN USUAL` | `11Q8:CONDITION LAST WEEK -14- FELT LONELY` | `11Q8:CONDITION LAST WEEK -15- PEOPLE AROUND ME SEEMED COLD TO ME` | `11Q8:CONDITION LAST WEEK -16- FELT HAPPY` | `11Q8:CONDITION LAST WEEK -17- CRIED OR FELT LIKE CRYING` | `11Q8:CONDITION LAST WEEK -18- FELT SAD` | `11Q8:CONDITION LAST WEEK -19- FELT THAT PEOPLE AROUND ME DISLIKED ME` | `11Q8:CONDITION LAST WEEK -20- DIDNÕT FEEL LIKE DOING ANYTHING` | 
| **Table name** | `jstar_2011_3cities` | `jstar_2011_3cities` | `jstar_2011_3cities` | `jstar_2011_3cities` | `jstar_2011_3cities` | `jstar_2011_3cities` | `jstar_2011_3cities` | `jstar_2011_3cities` | `jstar_2011_3cities` | `jstar_2011_3cities` | 


```{r assign_cth1, echo=FALSE}
opal.assign.table.tibble(o, 'JSTAR_dep','JSTAR_datasets_restricted.jstar_2011_3cities',
                         variables=list('q8_1', 'q8_2', 'q8_3', 'q8_4', 'q8_5', 'q8_6', 'q8_7', 'q8_8', 'q8_9', 'q8_10', 'q8_11', 'q8_12', 'q8_13', 'q8_14', 'q8_15', 'q8_16', 'q8_17', 'q8_18', 'q8_19', 'q8_20'), missings = TRUE)
JSTAR_dep <- opal.execute(o,'JSTAR_dep')
```

```{r local_cth1, echo=FALSE}
vari <- JSTAR_dep$q8_1
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_2
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_3
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_4
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_5
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_6
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_7
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_8
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_9
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_10
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_11
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_12
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_13
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_14
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_15
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_16
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_17
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_18
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_19
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")

vari <- JSTAR_dep$q8_20
kable(Categorical_summary(vari, missing_values = NA)[2], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = NA)[1], caption = "Category")
ggplot(JSTAR_dep, aes(x=factor(vari))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Harmonisation algorithm
To compute the harmonized variable from the study-specific variable it has to be recoded as follows:

First of all: 
* The reversed items q8_4, q8_8, q8_12,  q8_16: 
  + `recode 1 into 3`
  + `keep 2`
  + `recode 3 into 1`
  + `recode 4 into 0`
* The direct items q8_1, q8_2, q8_3, q8_5, q8_6, q8_7, q8_9, q8_10, q8_11, q8_13, q8_14, q8_15, q8_17, q8_18, q8_19, q8_20: 
  + `recode 1 into 0`
  + `recode 2 into 1`
  + `recode 3 into 2`
  + `recode 4 into 3`

Secondly in order to get the final score the items have to be summed. If one to 4 items are missing, scores on the completed items are summed; the total is divided by the number of items answered and multiplied by 20. If more than 4 items are missing the individual get a missing value in the final score. 

After get the final score, it has to be recoded as follows: 

* `0-15 into 0`
* `>16 into 1`
* `NA into 999`

**R script:**

```{r harmo_cth1, echo=TRUE}
JSTAR_dep$q8_1 <- as.numeric(JSTAR_dep$q8_1)
JSTAR_dep$q8_14 <- as.numeric(JSTAR_dep$q8_14)
JSTAR_dep$q8_15 <- as.numeric(JSTAR_dep$q8_15)

#reversed items
JSTAR_dep$p4 <- car::recode(JSTAR_dep$q8_4, "1=3; 3=1; 4=0")
JSTAR_dep$p8 <- car::recode(JSTAR_dep$q8_8, "1=3; 3=1; 4=0")
JSTAR_dep$p12 <- car::recode(JSTAR_dep$q8_12, "1=3; 3=1; 4=0")
JSTAR_dep$p16 <- car::recode(JSTAR_dep$q8_16, "1=3; 3=1; 4=0")

#direct items
JSTAR_dep$p1 <- car::recode(JSTAR_dep$q8_1, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p2 <- car::recode(JSTAR_dep$q8_2, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p3 <- car::recode(JSTAR_dep$q8_3, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p5 <- car::recode(JSTAR_dep$q8_5, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p6 <- car::recode(JSTAR_dep$q8_6, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p7 <- car::recode(JSTAR_dep$q8_7, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p9 <- car::recode(JSTAR_dep$q8_9, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p10 <- car::recode(JSTAR_dep$q8_10, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p11 <- car::recode(JSTAR_dep$q8_11, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p13 <- car::recode(JSTAR_dep$q8_13, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p14 <- car::recode(JSTAR_dep$q8_14, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p15 <- car::recode(JSTAR_dep$q8_15, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p17 <- car::recode(JSTAR_dep$q8_17, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p18 <- car::recode(JSTAR_dep$q8_18, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p19 <- car::recode(JSTAR_dep$q8_19, "1=0; 2=1; 3=2; 4=3")
JSTAR_dep$p20 <- car::recode(JSTAR_dep$q8_20, "1=0; 2=1; 3=2; 4=3")

JSTAR_dep$nmiss <- apply(JSTAR_dep[,22:41], MARGIN = 1, FUN = function(x) sum(is.na(x)))


JSTAR_dep$final_score <- apply(JSTAR_dep[,22:41], MARGIN = 1, FUN = function(x) sum(x, na.rm = TRUE))

JSTAR_dep$final_score[which(JSTAR_dep$nmiss>4)] <- 999

JSTAR_dep$final_score[which(JSTAR_dep$nmiss==3)] <- (JSTAR_dep$final_score[which(JSTAR_dep$nmiss==3)]/17)*20
JSTAR_dep$final_score[which(JSTAR_dep$nmiss==2)] <- (JSTAR_dep$final_score[which(JSTAR_dep$nmiss==2)]/18)*20
JSTAR_dep$final_score[which(JSTAR_dep$nmiss==1)] <- (JSTAR_dep$final_score[which(JSTAR_dep$nmiss==1)]/19)*20


JSTAR_cth_ds_w1 <- tibble(id=JSTAR_dep$id)
JSTAR_cth_ds_w1$depression <- car::recode(JSTAR_dep$final_score, "0:15.99999999=0; 16:900=1")
JSTAR_cth_ds_w1$depression <- labelled(JSTAR_cth_ds_w1[[2]], labels = c("no depression"=0, "depression"=1,  "Missing"=999, "Do not know"=998, "Refuse"=997, "Not applicable"=996, "Does not answer"=995,  "Not attempt not done"=994, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistical description of the new harmonised variable
```{r descript_cth1, echo=FALSE}
vari <- JSTAR_cth_ds_w1$depression
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = ds_label) 
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[1], caption = "Category")
kable(Categorical_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "Type of missing")
ggplot(JSTAR_cth_ds_w1, aes(x=factor(JSTAR_cth_ds_w1[[2]]))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab(ds_label) + ylab("Frequency")
```

#### Validation
```{r crosstabulation_cth1, echo=FALSE}
BeforeH <- c(sum(na.omit(JSTAR_dep$final_score)<16), sum(na.omit(JSTAR_dep$final_score)>=16 & na.omit(JSTAR_dep$final_score)<900), sum(na.omit(JSTAR_dep$final_score)==999))
AfterH <- table(JSTAR_cth_ds_w1[[2]], useNA = "ifany")
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("<16->0",">=16->1", "NA->999") 
kable(C)
```


```{r importOPAL_cth1, echo=FALSE}
#opal.assign.data(o, 'JSTAR_cth_ds_w1', JSTAR_cth_ds_w1)
#opal.symbol_import(o,'JSTAR_cth_ds_w1', project='_Athlos_Harm_Dataset')

label(JSTAR_cth_ds_w1$depression) <- ds_label_all
depression <- JSTAR_cth_ds_w1
save(depression, file = "../RData/cth_w1/depression.RData")
rm(depression, JSTAR_dep)

JSTAR_cth_m_ds_w1 <- JSTAR_cth_ds_w1
JSTAR_cth_m_ds_w1$depression <- car::recode(JSTAR_cth_m_ds_w1$depression, "c(991, 992, 993, 994, 995, 996, 997,998, 999)=NA")
#opal.assign.data(o, 'JSTAR_cth_m_ds_w1', JSTAR_cth_m_ds_w1)
#opal.symbol_import(o,'JSTAR_cth_m_ds_w1', project='_Athlos_Harm_Dataset')
```


# Quality estimation


The Center for Epidemiologic Studies Depression Scale (CES-D), 20-ITEM VERSION TEST, was used.
However, the final score variable was not available, so it was calculated by using the items.
The missing values were treated as follows: maximum 3 missing items were allowed > score the completed items divided by the number of items answered and multiplied by 20.




```{r closeRsession, echo=FALSE} 
opal.logout(o)
```