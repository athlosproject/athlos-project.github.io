---
title: "Age"
output:
  html_document:
    highlight: tango
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---
  
<!-- ########################################################## --> 

<!-- # Installation, loading packages -->
<!-- **R script:** -->

```{r setup, include=FALSE}
source("M:/WPs/WP1/Maelstrom/data_process/athlos-project.github.io/setup_iago.r")
```
<!-- ########################################################## --> 






# Description of DataSchema variable

The description of harmonised variable is the following:


* Short name: `age`
* Variable label: `age`
* Variable description: `Age of participant at each wave`
* Domain: `Socio-demographic and economic characteristics`
* Value type: `continuous`
* Category missings: 

**Code** | **Category Label**
----| ------------------
991 | CAPI/interviewer error
992 | Impute
993 | Disable to measure
994 | Not attempt/not done
995 | Does not answer
996 | Not applicable
997 | Refuse
998 | Do not know
999 | Missing


# Data process


## Finland

### Wave 1 

#### Study-specific variable description

| **Name** | `q1011_age` |
|----------|------------|
| **Label** | `age` |
| **Table name** | `Courage_Finland_w1` |
| **Description** |  |


```{r assign_fin, echo=F}
opal.assign.table.tibble(o, 'COURAGE_fin_w1_age','Courage.Courage_Finland_w1',
                         variables=list('q1011_age'), missings = TRUE)
```

```{r local_fin, echo=F}
COURAGE_fin_w1_age <- opal.execute(o,'COURAGE_fin_w1_age')
vari <- COURAGE_fin_w1_age$q1011_age
kable(Continuous_summary(vari, missing_values = NA)[3], caption = "q1011_age")
pander(Continuous_summary(vari, missing_values = NA)$summary, caption = "Summary")
ggplot(COURAGE_fin_w1_age, aes(q1011_age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable, but the missing values have to be recoded as follows:

* `NA into 999`


**R script:**

```{r harmo_fin}
COURAGE_ds_fin_w1 <- tibble(id=COURAGE_fin_w1_age$id)
COURAGE_ds_fin_w1$age <- car::recode(COURAGE_fin_w1_age$q1011_age, "NA=999")
COURAGE_ds_fin_w1$age <- labelled(COURAGE_ds_fin_w1$age, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=994, "Does not answer"=995,  "Not applicable"=996, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript_fin, echo=F}
vari <- COURAGE_ds_fin_w1$age
kable(Continuous_summary(var = vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = "age")
kable(Continuous_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "values")
pander(Continuous_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))$summary, caption = "Summary")
ggplot(COURAGE_ds_fin_w1, aes(age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency") 
```

#### Validation
```{r crosstabulation_fin, echo=F}
```





```{r importOPAL_fin, echo=F}

#opal.assign.data(o, 'COURAGE_ds_fin_w1', COURAGE_ds_fin_w1)
#opal.symbol_import(o,'COURAGE_ds_fin_w1', project='_Athlos_Harm_Dataset')

COURAGE_m_ds_fin_w1 <- COURAGE_ds_fin_w1
COURAGE_m_ds_fin_w1$age <- car::recode(COURAGE_m_ds_fin_w1$age, "c(991, 992, 993, 994, 995, 996, 997,998, 999)=NA")
#opal.assign.data(o, 'COURAGE_m_ds_fin_w1', COURAGE_m_ds_fin_w1)
#opal.symbol_import(o,'COURAGE_m_ds_fin_w1', project='_Athlos_Harm_Dataset')
```







## Poland

### Wave 1 

#### Study-specific variable description

| **Name** | `q1011_age` |
|----------|------------|
| **Label** | `age` |
| **Table name** | `Courage_Poland_w1` |
| **Description** |  |


```{r assign_pol1, echo=F}
opal.assign.table.tibble(o, 'COURAGE_pol_w1_age','Courage.Courage_Poland_w1',
                         variables=list('q1011_age'), missings = TRUE)
```

```{r local_pol1, echo=F}
COURAGE_pol_w1_age <- opal.execute(o,'COURAGE_pol_w1_age')
vari <- COURAGE_pol_w1_age$q1011_age
kable(Continuous_summary(vari, missing_values = NA)[2], caption = "q1011_age")
pander(Continuous_summary(vari, missing_values = NA)$summary, caption = "Summary")
ggplot(COURAGE_pol_w1_age, aes(q1011_age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonied variable is the same than the study-specific variable, but the missing values have to be recoded as follows:

* `NA into 999`


**R script:**

```{r harmo_pol1}
COURAGE_ds_pol_w1 <- tibble(id=COURAGE_pol_w1_age$id)
COURAGE_ds_pol_w1$age <- car::recode(COURAGE_pol_w1_age$q1011_age, "NA=999")
COURAGE_ds_pol_w1$age <- labelled(COURAGE_ds_pol_w1$age, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=994, "Does not answer"=995,  "Not applicable"=996, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript_pol1, echo=F}
vari <- COURAGE_ds_pol_w1$age
kable(Continuous_summary(var = vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = "age")
kable(Continuous_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "values")
pander(Continuous_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))$summary, caption = "Summary")
ggplot(COURAGE_ds_pol_w1, aes(age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency") 
```

#### Validation
```{r crosstabulation_pol1, echo=F}
```





```{r importOPAL_pol1, echo=F}

#opal.assign.data(o, 'COURAGE_ds_pol_w1', COURAGE_ds_pol_w1)
#opal.symbol_import(o,'COURAGE_ds_pol_w1', project='_Athlos_Harm_Dataset')

COURAGE_m_ds_pol_w1 <- COURAGE_ds_pol_w1
COURAGE_m_ds_pol_w1$age <- car::recode(COURAGE_m_ds_pol_w1$age, "c(991, 992, 993, 994, 995, 996, 997,998, 999)=NA")
#opal.assign.data(o, 'COURAGE_m_ds_pol_w1', COURAGE_m_ds_pol_w1)
#opal.symbol_import(o,'COURAGE_m_ds_pol_w1', project='_Athlos_Harm_Dataset')
```








### Wave 2 

#### Study-specific variable description

| **Name** | `q1011_age` |
|----------|------------|
| **Label** | `age` |
| **Table name** | `Courage_Poland_w1` |
| **Description** |  |


```{r assign_pol2, echo=F}
opal.assign.table.tibble(o, 'COURAGE_pol_w1_age','Courage.Courage_Poland_w1',
                         variables=list('q1011_age'), missings = TRUE)
opal.assign.table.tibble(o, 'COURAGE_pol_w2_id','Courage.Courage_Poland_w2',
                         variables=list('q0403b_first_02_s1'), missings = TRUE)
```

```{r local_pol2, echo=F}
COURAGE_pol_w1_age <- opal.execute(o,'COURAGE_pol_w1_age')
COURAGE_pol_w2_id <- opal.execute(o,'COURAGE_pol_w2_id')


Add_indiv <- function(old, new){
  
  new_2 <- matrix(rep(NA, dim(new)[1]*dim(new)[2] ), nrow = dim(new)[1])
  oldm <- as.matrix(old)
  
  for(i in 1:length(new$id)){
    if(sum(new$id[i]==old$id)>=1){
      new_2[i,] <- oldm[which(new$id[i]==old$id),]
    } else {
      new_2[i,] <- c(new$id[i], NA)
    }
  }
  
  new_22 <- data.frame(id=new_2[,1], q1011_age=as.numeric(new_2[,2]))
  new_22
}

COURAGE_pol_w2_age <- Add_indiv(old = COURAGE_pol_w1_age, new = COURAGE_pol_w2_id)

vari <- COURAGE_pol_w2_age$q1011_age
kable(Continuous_summary(vari, missing_values = c(-8))[3], caption = "q1011_age")
pander(Continuous_summary(vari, missing_values = c(-8))$summary, caption = "Summary")
ggplot(COURAGE_pol_w2_age, aes(q1011_age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable, but the missing values have to be recoded as follows:

* `NA into 999`


**R script:**

```{r harmo_pol2}
COURAGE_ds_pol_w2 <- tibble(id=COURAGE_pol_w2_age$id)
COURAGE_ds_pol_w2$age <- car::recode(COURAGE_pol_w2_age$q1011_age, "NA=999")
COURAGE_ds_pol_w2$age <- labelled(COURAGE_ds_pol_w2$age, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=994, "Does not answer"=995,  "Not applicable"=996, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript_pol2, echo=F}
vari <- COURAGE_ds_pol_w2$age
kable(Continuous_summary(var = vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = "age")
kable(Continuous_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "values")
pander(Continuous_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))$summary, caption = "Summary")
ggplot(COURAGE_ds_pol_w2, aes(age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency") 
```

#### Validation
```{r crosstabulation_pol2, echo=F}

```





```{r importOPAL_pol2, echo=F}

#opal.assign.data(o, 'COURAGE_ds_pol_w2', COURAGE_ds_pol_w2)
#opal.symbol_import(o,'COURAGE_ds_pol_w2', project='_Athlos_Harm_Dataset')

COURAGE_m_ds_pol_w2 <- COURAGE_ds_pol_w2
COURAGE_m_ds_pol_w2$age <- car::recode(COURAGE_m_ds_pol_w2$age, "c(991, 992, 993, 994, 995, 996, 997,998, 999)=NA")
#opal.assign.data(o, 'COURAGE_m_ds_pol_w2', COURAGE_m_ds_pol_w2)
#opal.symbol_import(o,'COURAGE_m_ds_pol_w2', project='_Athlos_Harm_Dataset')
```







## Spain

### Wave 1 

#### Study-specific variable description

| **Name** | `q1011_age` |
|----------|------------|
| **Label** | `age` |
| **Table name** | `Courage_Spain_w1` |
| **Description** |  |



```{r assign_spain1, echo=F}
opal.assign.table.tibble(o, 'COURAGE_spain_w1_age','Courage.Courage_Spain_w1',
                         variables=list('q1011_age'), missings = TRUE)
```

```{r local_spain1, echo=F}
COURAGE_spain_w1_age <- opal.execute(o,'COURAGE_spain_w1_age')
vari <- COURAGE_spain_w1_age$q1011_age
kable(Continuous_summary(vari, missing_values = NA)[2], caption = "q1011_age")
pander(Continuous_summary(vari, missing_values = NA)$summary, caption = "Summary")
ggplot(COURAGE_spain_w1_age, aes(q1011_age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable, but the missing values have to be recoded as follows:

* `NA into 999`


**R script:**

```{r harmo_spain1}
COURAGE_ds_spain_w1 <- tibble(id=COURAGE_spain_w1_age$id)
COURAGE_ds_spain_w1$age <- car::recode(COURAGE_spain_w1_age$q1011_age, "NA=999")
COURAGE_ds_spain_w1$age <- labelled(COURAGE_ds_spain_w1$age, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=994, "Does not answer"=995,  "Not applicable"=996, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript_spain1, echo=F}
vari <- COURAGE_ds_spain_w1$age
kable(Continuous_summary(var = vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = "age")
kable(Continuous_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "values")
pander(Continuous_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))$summary, caption = "Summary")
ggplot(COURAGE_ds_spain_w1, aes(age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency") 
```

#### Validation
```{r crosstabulation_spain1, echo=F}
```





```{r importOPAL_spain1, echo=F}

#opal.assign.data(o, 'COURAGE_ds_spain_w1', COURAGE_ds_spain_w1)
#opal.symbol_import(o,'COURAGE_ds_spain_w1', project='_Athlos_Harm_Dataset')

COURAGE_m_ds_spain_w1 <- COURAGE_ds_spain_w1
COURAGE_m_ds_spain_w1$age <- car::recode(COURAGE_m_ds_spain_w1$age, "c(991, 992, 993, 994, 995, 996, 997,998, 999)=NA")
#opal.assign.data(o, 'COURAGE_m_ds_spain_w1', COURAGE_m_ds_spain_w1)
#opal.symbol_import(o,'COURAGE_m_ds_spain_w1', project='_Athlos_Harm_Dataset')
```







### Wave 2 

#### Study-specific variable description

| **Name** | `yintw` |`mintw`|`mbirth`|`ybirth`|
|----------|------------|-|-|-|
| **Label** | `year of interview` | `month of interview` | `month of birth` |`year of birth`|
| **Table name** | `yintw`\* |`mintw`\*|`mbirth`\*|`ybirth`\*|
| **Missings** |`991 = CAPI/interviewer error; 992 = Impute; 993 = Disable to measure; 994 = Not attempt/not done; 995 = Does not answer; 996 = Not applicable; 997 = Refuse; 998 = Do not know; 999 = Missing`|`991 = CAPI/interviewer error; 992 = Impute; 993 = Disable to measure; 994 = Not attempt/not done; 995 = Does not answer; 996 = Not applicable; 997 = Refuse; 998 = Do not know; 999 = Missing`|`991 = CAPI/interviewer error; 992 = Impute; 993 = Disable to measure; 994 = Not attempt/not done; 995 = Does not answer; 996 = Not applicable; 997 = Refuse; 998 = Do not know; 999 = Missing`|`991 = CAPI/interviewer error; 992 = Impute; 993 = Disable to measure; 994 = Not attempt/not done; 995 = Does not answer; 996 = Not applicable; 997 = Refuse; 998 = Do not know; 999 = Missing`|
| **Description** |  |  |  |  |

\* These tables are not extracted from the database COURAGE, but from ATHLOS. They contain already harmonised variables.

<!--
Cuando se actualicen bbdd de ATHLOS, puesto que las variables de fecha de nacimiento son mbirth, ybirth (y dbirth), abajo tienen que ser actualizadas
-->


```{r assign_spain2, echo=F}
#opal.assign.table.tibble(o, 'COURAGE_spain_w2_age','_Athlos_Harm_Dataset.COURAGE_m_ds_spain_w2',variables=list('year_of_interview', 'month_of_interview', 'month_of_birth', 'year_of_birth'), missings = TRUE)
load("../RData/spain_w2/yintw.RData")
load("../RData/spain_w2/mintw.RData")
load("../RData/spain_w2/ybirth.RData")
load("../RData/spain_w2/mbirth.RData")
```

```{r local_spain2, echo=F}
#COURAGE_spain_w2_age <- opal.execute(o,'COURAGE_spain_w2_age')

COURAGE_spain_w2_age <- tibble(id=mbirth$id)
COURAGE_spain_w2_age$month_of_birth <- car::recode(mbirth$mbirth, "NA=999")
COURAGE_spain_w2_age$year_of_birth <- car::recode(ybirth$ybirth, "NA=999")
COURAGE_spain_w2_age$year_of_interview <- car::recode(yintw$yintw, "NA=999")
COURAGE_spain_w2_age$month_of_interview <- car::recode(mintw$mintw, "NA=999")




# COURAGE_spain_w2_age$month_of_birth <- car::recode(COURAGE_spain_w2_age$month_of_birth, "NA=999")
# COURAGE_spain_w2_age$year_of_birth <- car::recode(COURAGE_spain_w2_age$year_of_birth, "NA=999")
# COURAGE_spain_w2_age$year_of_interview <- car::recode(COURAGE_spain_w2_age$year_of_interview, "NA=999")
# COURAGE_spain_w2_age$month_of_interview <- car::recode(COURAGE_spain_w2_age$month_of_interview, "NA=999")



vari <- COURAGE_spain_w2_age$year_of_birth
kable(Continuous_summary(vari, missing_values = c(991,992,993,994,995,996,997,998,999))[3], caption = "year_of_birth")
pander(Continuous_summary(vari, missing_values = c(991,992,993,994,995,996,997,998,999))$summary, caption = "Summary")
ggplot(COURAGE_spain_w2_age, aes(year_of_birth)) + geom_histogram(stat="count", fill="steelblue") + xlab("Year of birth") + ylab("Frequency") + xlim(1900,1995)

vari <- COURAGE_spain_w2_age$year_of_interview
kable(Continuous_summary(vari, missing_values = c(991,992,993,994,995,996,997,998,999))[3], caption = "year_of_interview")
pander(Continuous_summary(vari, missing_values = c(991,992,993,994,995,996,997,998,999))$summary, caption = "Summary")
ggplot(COURAGE_spain_w2_age, aes(x=factor(year_of_interview))) + geom_histogram(stat="count", fill="steelblue") + xlab("Year of interview") + ylab("Frequency")

vari <- COURAGE_spain_w2_age$month_of_birth
kable(Continuous_summary(vari, missing_values = c(991,992,993,994,995,996,997,998,999))[3], caption = "month_of_birth")
pander(Continuous_summary(vari, missing_values = c(991,992,993,994,995,996,997,998,999))$summary, caption = "Summary")
ggplot(COURAGE_spain_w2_age, aes(x=factor(month_of_birth))) + geom_histogram(stat="count", fill="steelblue") + xlab("Month of birth") + ylab("Frequency") 

vari <- COURAGE_spain_w2_age$month_of_interview
kable(Continuous_summary(vari, missing_values = c(991,992,993,994,995,996,997,998,999))[3], caption = "month_of_interview")
pander(Continuous_summary(vari, missing_values = c(991,992,993,994,995,996,997,998,999))$summary, caption = "Summary")
ggplot(COURAGE_spain_w2_age, aes(x=factor(month_of_interview))) + geom_histogram(stat="count", fill="steelblue") + xlab("Month of interview") + ylab("Frequency")
```

#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable, but the missing values have to be recoded as follows:

* `NA into 999`


**R script:**

```{r harmo_spain2}
#function to compute the age
comp_age <- function(y_birth, m_birth, y_int, m_int, miss){
  #first, it's computed the age of all
  age <- NULL
  age[m_int<m_birth] <- y_int[m_int<m_birth]-y_birth[m_int<m_birth]-1
  age[m_int>=m_birth] <- y_int[m_int>=m_birth]-y_birth[m_int>=m_birth]
  age[m_birth>900] <- y_int[m_birth>900]-y_birth[m_birth>900]
  
  #It's emphasized the individues that has missing
  mis <- rep(0,length(y_birth))
  for(i in 1:length(miss)){
    mis[which(y_int==miss[i])] <- miss[i]
  }
  mis <- rep(0,length(y_birth))
  for(i in 1:length(miss)){
    mis[which(y_birth==miss[i])] <- miss[i]
  }
  
  age[mis!=0] <- mis[mis!=0]
  
  age
  
}

COURAGE_spain_w2_age$age <- comp_age(y_birth=COURAGE_spain_w2_age$year_of_birth , 
                                   m_birth=COURAGE_spain_w2_age$month_of_birth ,
                                   y_int=COURAGE_spain_w2_age$year_of_interview , 
                                   m_int=COURAGE_spain_w2_age$month_of_interview , 
                                   miss=c(991,992,993,994,995,996,997,998,999))


COURAGE_ds_spain_w2 <- tibble(id=COURAGE_spain_w2_age$id)
COURAGE_ds_spain_w2$age <- car::recode(COURAGE_spain_w2_age$age, "NA=999")
COURAGE_ds_spain_w2$age <- labelled(COURAGE_ds_spain_w2$age, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=994, "Does not answer"=995,  "Not applicable"=996, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript_spain2, echo=F}
vari <- COURAGE_ds_spain_w2$age
kable(Continuous_summary(var = vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[3], caption = "age")
kable(Continuous_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))[2], caption = "values")
pander(Continuous_summary(vari, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))$summary, caption = "Summary")
ggplot(COURAGE_ds_spain_w2, aes(age)) + geom_histogram(stat="count", fill="steelblue") + xlab("age") + ylab("Frequency") + xlim(0,120)
```

#### Validation
```{r crosstabulation_spain2, echo=F}
```





```{r importOPAL_spain2, echo=F}

#opal.assign.data(o, 'COURAGE_ds_spain_w2', COURAGE_ds_spain_w2)
#opal.symbol_import(o,'COURAGE_ds_spain_w2', project='_Athlos_Harm_Dataset')

COURAGE_m_ds_spain_w2 <- COURAGE_ds_spain_w2
COURAGE_m_ds_spain_w2$age <- car::recode(COURAGE_m_ds_spain_w2$age, "c(991, 992, 993, 994, 995, 996, 997,998, 999)=NA")
#opal.assign.data(o, 'COURAGE_m_ds_spain_w2', COURAGE_m_ds_spain_w2)
#opal.symbol_import(o,'COURAGE_m_ds_spain_w2', project='_Athlos_Harm_Dataset')
```




# Quality estimation
In Poland w2, age is imputed as the age in last wave + 4 which could introduce some bias.


```{r save, echo=FALSE}
age <- COURAGE_ds_spain_w1
save(age, file = "../RData/spain_w1/age.RData")
rm(age)

age <- COURAGE_ds_spain_w2
save(age, file = "../RData/spain_w2/age.RData")
rm(age)

age <- COURAGE_ds_pol_w1
save(age, file = "../RData/pol_w1/age.RData")
rm(age)

age <- COURAGE_ds_pol_w2
save(age, file = "../RData/pol_w2/age.RData")
rm(age)

age <- COURAGE_ds_fin_w1
save(age, file = "../RData/fin_w1/age.RData")
rm(age)
```

```{r closeRsession, echo=FALSE}
opal.logout(o)
```
