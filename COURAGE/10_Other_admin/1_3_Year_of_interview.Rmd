---
title: "Year of interview"
output:
  html_document:
    highlight: tango
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---
  
<!-- ########################################################## --> 

<!-- # Installation, loading packages -->
<!-- **R script:** -->

```{r setup, include=FALSE}
source("M:/WPs/WP1/Maelstrom/data_process/Rmds/setup_albert.r")
```
<!-- ########################################################## --> 


# Description of DataSchema variable

The description of harmonised variable is the following:
  
* Name: `yintw`
* Label: `year of interview`
* Type of variable: `countinous`
* Missings: 
    + `991 = CAPI/interviewer error`
    + `992 = Impute`
    + `993 = Disable to measure`
    + `994 = Not attempt/not done`
    + `995 = Does not answer`
    + `996 = Not applicable`
    + `997 = Refuse`
    + `998 = Do not know`
    + `999 = Missing`



### COURAGE - Finnish - Wave 1 

#### Study-specific variables

The study-specific variable elected to be harmonised is:

* Name: `q0006_date`
* Label: `Date final results`
* Type of variable: `countinous`


```{r assign_fin}
opal.assign.table.tibble(o, 'COURAGE_fin_w1_inter','Courage.Courage_Finland_w1',
                         variables=list('q0006_date'), missings = TRUE)
```

```{r local_fin}
COURAGE_fin_w1_inter <- opal.execute(o,'COURAGE_fin_w1_inter')
COURAGE_fin_w1_inter$yinter <- as.numeric(format(COURAGE_fin_w1_inter$q0006_date, '%Y'))
Categorical_summary(var = COURAGE_fin_w1_inter$yinter, missing_values = NA)
ggplot(COURAGE_fin_w1_inter, aes(x=factor(yinter))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```



#### Harmonisation algorithm
The harmonized variable is the same of the study-specific variable but the missing values have to be recoded as follows:

* `NA into 999`



R code of the ALGORITHM:

```{r harmo_fin}
COURAGE_ds_fin_w1 <- tibble(id=COURAGE_fin_w1_inter$id)
COURAGE_ds_fin_w1$yintw <- as.numeric(COURAGE_fin_w1_inter$yinter)
COURAGE_ds_fin_w1$yintw <- labelled(COURAGE_ds_fin_w1$yintw, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=994, "Does not answer"=995,  "Not applicable"=996, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript_fin}
Categorical_summary(var = COURAGE_ds_fin_w1$yintw, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(COURAGE_ds_fin_w1, aes(x=factor(yintw))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Validation
```{r crosstabulation_fin}
BeforeH <- table(COURAGE_fin_w1_inter$yinter, useNA = "ifany")
AfterH <- table(COURAGE_ds_fin_w1$yintw)
C <- rbind(BeforeH,AfterH)
colnames(C) <- names(AfterH)
C
```






### COURAGE - Polish - Wave 1 

#### Study-specific variables

The study-specific variable elected to be harmonised is:

* Name: `q0006_date`
* Label: `Date final results`
* Type of variable: `countinous`

```{r assign_pol1}
opal.assign.table.tibble(o, 'COURAGE_pol_w1_inter','Courage.Courage_Poland_w1',
                         variables=list('q0006_date'), missings = TRUE)
```

```{r local_pol1}
COURAGE_pol_w1_inter <- opal.execute(o,'COURAGE_pol_w1_inter')
COURAGE_pol_w1_inter$yinter <- as.numeric(format(COURAGE_pol_w1_inter$q0006_date, '%Y'))
Categorical_summary(var = COURAGE_pol_w1_inter$yinter, missing_values = NA)
ggplot(COURAGE_pol_w1_inter, aes(x=factor(yinter))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```


#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable, but the missing values have to be recoded as follows:

* `NA into 999`


R code of the ALGORITHM:

```{r harmo_pol1}
COURAGE_ds_pol_w1 <- tibble(id=COURAGE_pol_w1_inter$id)
COURAGE_ds_pol_w1$yintw <- as.numeric(COURAGE_pol_w1_inter$yinter)
COURAGE_ds_pol_w1$yintw <- labelled(COURAGE_ds_pol_w1$yintw, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=994, "Does not answer"=995,  "Not applicable"=996, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript_pol1}
Categorical_summary(var = COURAGE_ds_pol_w1$yintw, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(COURAGE_ds_pol_w1, aes(x=factor(yintw))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Validation
```{r crosstabulation_pol1}
BeforeH <- table(COURAGE_pol_w1_inter$yinter, useNA = "ifany")
AfterH <- table(COURAGE_ds_pol_w1$yintw)
C <- rbind(BeforeH,AfterH)
colnames(C) <- names(AfterH)
C
```









### COURAGE - Polish - Wave 2 

#### Study-specific variables

The study-specific variable elected to be harmonised is:

* Name: `q0006_date`
* Label: `Date final results`
* Type of variable: `countinous`

```{r assign_pol2}
opal.assign.table.tibble(o, 'COURAGE_pol_w2_id','Courage.Courage_Poland_w2',
                         variables=list('q1004_MMSE'), missings = TRUE)
```

```{r local_pol2}
COURAGE_pol_w2_id <- opal.execute(o,'COURAGE_pol_w2_id')
Continuous_summary(var = COURAGE_pol_w2_id$id, missing_values = NA)
```


#### Harmonisation algorithm
As we won't have the year of interview, it is going to be computed as 2015. 

R code of the ALGORITHM:

```{r harmo_pol2}
COURAGE_ds_pol_w2 <- tibble(id=COURAGE_pol_w2_id$id)
COURAGE_ds_pol_w2$yintw <- 2015
```

#### Statistics of the new harmonised variable
```{r descript_pol2}
Categorical_summary(var = COURAGE_ds_pol_w2$yintw, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(COURAGE_ds_pol_w2, aes(x=factor(yintw))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Validation
```{r crosstabulation_pol2}
```






### COURAGE - Spain - Wave 1 

#### Study-specific variables

The study-specific variable elected to be harmonised is:

* Name: `q0006_date`
* Label: `Date final results`
* Type of variable: `countinous`

```{r assign_spain1}
opal.assign.table.tibble(o, 'COURAGE_spain_w1_inter','Courage.Courage_Spain_w1',
                         variables=list('q0006_date'), missings = TRUE)
```

```{r local_spain1}
COURAGE_spain_w1_inter <- opal.execute(o,'COURAGE_spain_w1_inter')
COURAGE_spain_w1_inter$yinter <- as.numeric(format(COURAGE_spain_w1_inter$q0006_date, '%Y'))
Categorical_summary(var = COURAGE_spain_w1_inter$yinter, missing_values = NA)
ggplot(COURAGE_spain_w1_inter, aes(x=factor(yinter))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

The values larger than 1993 are considered missing since the interview was in 2011 and the participants had to be 18 years old as youngest.

#### Harmonisation algorithm
The harmonized variable is the same of the study-specific variable but the missing values have to be recoded as follows:

* `NA into 999`


R code of the ALGORITHM:

```{r harmo_spain1}
COURAGE_ds_spain_w1 <- tibble(id=COURAGE_spain_w1_inter$id)
COURAGE_ds_spain_w1$yintw <- as.numeric(COURAGE_spain_w1_inter$yinter)
COURAGE_ds_spain_w1$yintw <- labelled(COURAGE_ds_spain_w1$yintw, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=994, "Does not answer"=995,  "Not applicable"=996, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript_spain1}
Categorical_summary(var = COURAGE_ds_spain_w1$yintw, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(COURAGE_ds_spain_w1, aes(x=factor(yintw))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Validation
```{r crosstabulation_spain1}
BeforeH <- table(COURAGE_spain_w1_inter$yinter, useNA = "ifany")
AfterH <- table(COURAGE_ds_spain_w1$yintw)
C <- rbind(BeforeH,AfterH)
colnames(C) <- names(AfterH)
C
```








### COURAGE - Spain - Wave 2 

#### Study-specific variables

The study-specific variable elected to be harmonised is:

* Name: `q0006_date_s1`
* Label: `Date final results`
* Type of variable: `countinous`

```{r assign_spain2}
opal.assign.table.tibble(o, 'COURAGE_spain_w1_inter','Courage.Courage_Spain_w2_1',
                         variables=list('q0006_date_s1'), missings = TRUE)
```

```{r local_spain2}
COURAGE_spain_w1_inter <- opal.execute(o,'COURAGE_spain_w1_inter')
COURAGE_spain_w1_inter$yinter <- as.numeric(format(COURAGE_spain_w1_inter$q0006_date_s1, '%Y'))
Categorical_summary(var = COURAGE_spain_w1_inter$yinter, missing_values = NA)
ggplot(COURAGE_spain_w1_inter, aes(x=factor(yinter))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```


#### Harmonisation algorithm
The harmonized variable is the same than the study-specific variable, but the missing values have to be recoded as follow:

`NA into 999`


R code of the ALGORITHM:

```{r harmo_spain2}
COURAGE_ds_spain_w2 <- tibble(id=COURAGE_spain_w1_inter$id)
COURAGE_ds_spain_w2$yintw <- car::recode(COURAGE_spain_w1_inter$yinter, "NA=999")
COURAGE_ds_spain_w2$yintw <- labelled(COURAGE_ds_spain_w2$yintw, labels = c("Missing"=999, "Do not know"=998, "Refuse"=997, "Not attempt not done"=994, "Does not answer"=995,  "Not applicable"=996, "Disable to measure"=993, "Impute"=992, "CAPI interviewer error"=991))
```

#### Statistics of the new harmonised variable
```{r descript_spain2}
Categorical_summary(var = COURAGE_ds_spain_w2$yintw, missing_values = c(991, 992, 993, 994, 995, 996, 997, 998, 999))
ggplot(COURAGE_ds_spain_w2, aes(x=factor(yintw))) + geom_bar(stat="count", width=0.4, fill="steelblue") + xlab("Year of interview") + ylab("Frequency")
```

#### Validation
```{r crosstabulation_spain2}
BeforeH <- table(COURAGE_spain_w1_inter$yinter, useNA = "ifany")
AfterH <- table(COURAGE_ds_spain_w2$yintw)[c(2,3,1)]
C <- rbind(BeforeH,AfterH)
colnames(C) <- c("2014", "2015", "NA->999")
C
```


# Quality estimation

The date was the same as the study specific variable taking into account the wave time lapse information. 
In wave 1 in the spanish sample, The values larger than 1993 are considered missing since the interview was in 2011 and the participants had to be 18 years old as youngest.
We don not have date of interview in wave 2 in the polish sample, for harmonization purposes we assume is that of the wave (based on study time lapse information).

```{r save, echo=FALSE}
yintw <- COURAGE_ds_spain_w1
save(yintw, file = "../RData/spain_w1/yintw.RData")
rm(yintw)

yintw <- COURAGE_ds_spain_w2
save(yintw, file = "../RData/spain_w2/yintw.RData")
rm(yintw)

yintw <- COURAGE_ds_pol_w1
save(yintw, file = "../RData/pol_w1/yintw.RData")
rm(yintw)

yintw <- COURAGE_ds_pol_w2
save(yintw, file = "../RData/pol_w2/yintw.RData")
rm(yintw)

yintw <- COURAGE_ds_fin_w1
save(yintw, file = "../RData/fin_w1/yintw.RData")
rm(yintw)
```


```{r closeRsession, echo=FALSE} 
opal.logout(o)
```

